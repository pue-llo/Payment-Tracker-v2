<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tracker Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Dark Mode Only - Premium Dark Blue */
            --bg-page: #0a0f1a;
            --bg-header: #0d1320;
            --bg-primary: #111827;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-muted: #6e6e73;
            --border-color: #38383a;

            /* Primary & Accent */
            --primary: #0a84ff;
            --primary-hover: #409cff;
            --primary-bg: rgba(10, 132, 255, 0.15);

            /* Status Colors */
            --success: #30d158;
            --success-light: #4ade80;
            --success-bg: rgba(48, 209, 88, 0.15);
            --danger: #ff453a;
            --danger-light: #f87171;
            --danger-bg: rgba(255, 69, 58, 0.15);
            --warning: #ff9f0a;
            --warning-light: #fbbf24;
            --warning-bg: rgba(255, 159, 10, 0.15);
            --info: #64d2ff;
            --info-light: #7dd3fc;
            --info-bg: rgba(100, 210, 255, 0.15);

            /* Accent */
            --accent-gold: #ffd60a;
            --accent-indigo: #818cf8;
            --accent-violet: #a78bfa;
            --accent-cyan: #22d3ee;

            /* Shadows & Effects */
            --card-shadow: 0 2px 8px rgba(0,0,0,0.3);
            --header-shadow: 0 8px 32px rgba(0,0,0,0.4);
            --grid-dot-color: rgba(255, 255, 255, 0.12);

            /* Glass Header */
            --header-glass-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            --header-glass-border: rgba(255, 255, 255, 0.1);
            --header-accent-glow: rgba(99, 102, 241, 0.1);
            --tab-hover-bg: rgba(255, 255, 255, 0.05);
            --tab-active-bg: rgba(255, 255, 255, 0.1);
            --btn-glass-bg: rgba(255, 255, 255, 0.05);
            --btn-glass-hover: rgba(255, 255, 255, 0.1);

            /* Ring/SVG Stroke Colors */
            --ring-cyan: #22d3ee;
            --ring-green: #4ade80;
            --ring-amber: #fbbf24;
            --ring-red: #f87171;
            --ring-blue: #60a5fa;

            /* Progress Bar Colors */
            --progress-low: #ef4444;
            --progress-low-light: #f87171;
            --progress-medium: #f59e0b;
            --progress-medium-light: #fbbf24;
            --progress-high: #22c55e;
            --progress-high-light: #4ade80;

            /* Glassmorphism */
            --glass-bg: linear-gradient(135deg, rgba(15,23,42,0.95) 0%, rgba(30,41,59,0.9) 100%);
            --glass-border: rgba(255,255,255,0.1);
            --glass-shadow: 0 8px 32px rgba(0,0,0,0.4);
            --glass-card-bg: rgba(255,255,255,0.05);
            --glass-card-hover: rgba(255,255,255,0.08);
            --glass-accent: radial-gradient(ellipse at top left, rgba(99,102,241,0.15) 0%, transparent 50%);
            --glass-text: rgba(255,255,255,0.9);
            --glass-text-muted: rgba(255,255,255,0.6);

            /* Heatmap */
            --heatmap-empty-bg: rgba(255,255,255,0.05);
            --heatmap-empty-text: rgba(255,255,255,0.4);
            --heatmap-pending-1: rgba(239,68,68,0.2);
            --heatmap-pending-2: rgba(239,68,68,0.3);
            --heatmap-pending-3: rgba(239,68,68,0.4);
            --heatmap-pending-4: rgba(239,68,68,0.5);
            --heatmap-pending-5: rgba(239,68,68,0.6);
            --heatmap-pending-6: rgba(239,68,68,0.7);
            --heatmap-pending-7: rgba(220,38,38,0.85);
            --heatmap-pending-text: #fca5a5;
            --heatmap-pending-text-hi: #ffffff;
            --heatmap-paid-1: rgba(34,197,94,0.2);
            --heatmap-paid-2: rgba(34,197,94,0.3);
            --heatmap-paid-3: rgba(34,197,94,0.4);
            --heatmap-paid-4: rgba(34,197,94,0.5);
            --heatmap-paid-5: rgba(34,197,94,0.6);
            --heatmap-paid-6: rgba(34,197,94,0.7);
            --heatmap-paid-7: rgba(22,163,74,0.85);
            --heatmap-paid-text: #86efac;
            --heatmap-paid-text-hi: #ffffff;
            --heatmap-mixed-1: rgba(245,158,11,0.2);
            --heatmap-mixed-2: rgba(245,158,11,0.3);
            --heatmap-mixed-3: rgba(245,158,11,0.4);
            --heatmap-mixed-4: rgba(245,158,11,0.5);
            --heatmap-mixed-5: rgba(245,158,11,0.6);
            --heatmap-mixed-6: rgba(245,158,11,0.7);
            --heatmap-mixed-7: rgba(217,119,6,0.85);
            --heatmap-mixed-text: #fcd34d;
            --heatmap-mixed-text-hi: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-page);
            background-image: radial-gradient(circle, var(--grid-dot-color) 1px, transparent 1px);
            background-size: 24px 24px;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* S-Tier Glassmorphism Header */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem 2rem;
            background: transparent;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .site-header.header-hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .header-glass {
            position: relative;
            background: var(--header-glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--header-glass-border);
            box-shadow: var(--header-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .header-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top left, var(--header-accent-glow) 0%, transparent 50%);
            pointer-events: none;
        }

        .header-top {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--header-glass-border);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-brand-icon {
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .header-brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--btn-glass-bg);
            border: 1px solid var(--header-glass-border);
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: var(--btn-glass-hover);
            border-color: var(--header-glass-border);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Navigation Tabs - Glass Pills */
        .header-nav {
            position: relative;
            padding: 0.75rem 1.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tab-btn {
            position: relative;
            padding: 0.6rem 1.25rem;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            color: var(--text-secondary);
            background: var(--tab-hover-bg);
        }

        .tab-btn.active {
            color: var(--text-primary);
            background: var(--tab-active-bg);
            border: 1px solid var(--header-glass-border);
            font-weight: 600;
        }

        /* Main Content Area */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .tab-content {
            display: none;
            padding: 2rem 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Legacy header class support */
        .header {
            display: none;
        }

        /* Financial Goals Section */
        .goals-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .goal-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .goal-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .goal-icon {
            font-size: 1.2rem;
        }

        .goal-amount {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .goal-amount .current {
            font-weight: 600;
            color: var(--text-primary);
        }

        .goal-progress {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            position: relative;
        }

        /* Milestone markers */
        .goal-progress::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 25%;
            width: 2px;
            background: rgba(0, 0, 0, 0.15);
            z-index: 1;
        }

        .goal-progress::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .goal-progress-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
            border-radius: 6px;
        }

        .goal-progress-fill.on-track {
            background: linear-gradient(90deg, var(--success), #20c997);
        }

        .goal-progress-fill.close {
            background: linear-gradient(90deg, var(--warning), #ffca2c);
        }

        .goal-progress-fill.behind {
            background: linear-gradient(90deg, var(--danger), #ea868f);
        }

        .goal-status {
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .savings-input-group {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .savings-input-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .savings-input-row {
            display: flex;
            gap: 0.4rem;
        }

        .savings-input-row input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .savings-input-row button {
            padding: 0.4rem 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

        /* Hero Status Card - Combined Greeting & Alerts */
        .hero-status-card {
            margin-bottom: 1.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            overflow: hidden;
            box-shadow: var(--glass-shadow);
        }

        .hero-status-card.has-alerts {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .hero-main {
            padding: 1.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .hero-left {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .hero-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass-card-bg);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .hero-greeting {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .hero-greeting-text {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .hero-greeting-sub {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .hero-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .hero-stat-badge {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 1.1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hero-stat-badge:hover {
            transform: translateY(-2px);
        }

        .hero-stat-badge.overdue {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .hero-stat-badge.due-today {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .hero-stat-badge.all-clear {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .hero-stat-number {
            font-size: 1.25rem;
            font-weight: 800;
        }

        .hero-stat-label {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Alert Items List */
        .hero-alerts {
            border-top: 1px solid var(--glass-border);
            background: rgba(239, 68, 68, 0.05);
        }

        .hero-alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid rgba(239, 68, 68, 0.1);
        }

        .hero-alert-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #fca5a5;
        }

        .hero-alert-total {
            font-size: 1rem;
            font-weight: 700;
            color: #f87171;
        }

        .hero-alert-list {
            padding: 0.75rem 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .hero-alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.6rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .hero-alert-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .hero-alert-item-name {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .hero-alert-item-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
        }

        .hero-alert-item-badge.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .hero-alert-item-badge.due-today {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .hero-alert-item-amount {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            min-width: 80px;
            text-align: right;
        }

        .hero-view-all {
            padding: 0.5rem 1.25rem;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 10px;
            color: #fca5a5;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hero-view-all:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .hero-main {
                flex-direction: column;
                align-items: flex-start;
            }

            .hero-stats {
                width: 100%;
                flex-wrap: wrap;
            }

            .hero-stat-badge {
                flex: 1;
                justify-content: center;
            }
        }

        /* Command Center - Glassmorphism (uses CSS variables for theming) */
        .command-center {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .command-center::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-accent);
            pointer-events: none;
        }

        .command-center-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .command-center-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--glass-text);
            letter-spacing: 0.5px;
        }

        .command-center-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 280px;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        .command-card {
            background: var(--glass-card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .command-card:hover {
            background: var(--glass-card-hover);
            border-color: var(--glass-border);
            transform: translateY(-2px);
        }

        .command-card.urgent {
            border-left: 3px solid var(--danger);
            background: linear-gradient(135deg, var(--danger-bg) 0%, var(--glass-card-bg) 100%);
        }

        .command-card.upcoming {
            border-left: 3px solid var(--warning);
            background: linear-gradient(135deg, var(--warning-bg) 0%, var(--glass-card-bg) 100%);
        }

        .command-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .command-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--glass-text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .command-card-total {
            font-size: 2.75rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
            line-height: 1.1;
        }

        .command-card.urgent .command-card-total {
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--danger-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .command-card.upcoming .command-card-total {
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--warning-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .command-card-count {
            font-size: 0.75rem;
            color: var(--glass-text-muted);
            margin-top: 0.35rem;
            font-weight: 500;
        }

        .command-list {
            max-height: 160px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--glass-border);
        }

        .command-list::-webkit-scrollbar {
            width: 4px;
        }

        .command-list::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 2px;
        }

        .command-list::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 2px;
            transition: background 0.3s;
        }

        .command-list:hover::-webkit-scrollbar-thumb,
        .command-list.is-scrolling::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        .command-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .command-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.5rem;
            margin: 0 -0.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .command-list-item:hover {
            background: var(--glass-card-hover);
        }

        .command-list-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .command-list-item-name {
            font-weight: 500;
            color: var(--glass-text);
        }

        .command-list-item-due {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .command-list-item-due.overdue {
            color: var(--danger-light);
            font-weight: 600;
        }

        .command-list-item-due.today {
            color: var(--warning-light);
            font-weight: 600;
        }

        .command-list-item-amount {
            font-weight: 600;
            color: var(--danger);
        }

        .command-list-empty {
            text-align: center;
            padding: 1.25rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .command-list-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
        }
            background: radial-gradient(ellipse at top left, rgba(37, 99, 235, 0.06) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom right, rgba(219, 39, 119, 0.04) 0%, transparent 50%);
        }
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }
            border-left: 3px solid var(--danger);
            background: linear-gradient(135deg, var(--danger-bg) 0%, var(--bg-primary) 100%);
        }
            border-left: 3px solid var(--warning);
            background: linear-gradient(135deg, var(--warning-bg) 0%, var(--bg-primary) 100%);
        }
            color: var(--text-primary);
            text-shadow: none;
        }
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--danger) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--warning) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Goals Panel in Command Center - Glassmorphism */
        .goals-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .goals-panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .goals-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .goals-panel-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.75);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .goal-compact {
            margin-bottom: 1rem;
            padding: 0.75rem;
            margin-left: -0.75rem;
            margin-right: -0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: none;
        }

        .goal-compact:last-child {
            margin-bottom: 0;
        }

        .goal-compact:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .goal-compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .goal-compact-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }

        .goal-compact-percent {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .goal-compact-percent.low { color: #f87171; }
        .goal-compact-percent.medium { color: #fbbf24; }
        .goal-compact-percent.high { color: #4ade80; }

        .goal-compact-bar {
            height: 6px;
            background: var(--glass-card-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .goal-compact-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .goal-compact-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }
        .goal-compact-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .goal-compact-fill.high { background: linear-gradient(90deg, #22c55e, #4ade80); }


        .goal-compact-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.4rem;
        }

        .goal-compact-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .goal-compact.expanded .goal-compact-expand {
            max-height: 200px;
        }

        .goal-expand-content {
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .goal-expand-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .goal-expand-input input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        .goal-expand-input input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .goal-expand-input button {
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .goal-expand-input button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Fund Sources */
        .fund-sources {
            margin-top: 0.5rem;
        }

        .fund-source-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0;
            font-size: 0.75rem;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .fund-source-item:last-child {
            border-bottom: none;
        }

        .fund-source-icon {
            font-size: 0.85rem;
        }

        .fund-source-type {
            color: rgba(255, 255, 255, 0.6);
            min-width: 60px;
        }

        .fund-source-amount {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            flex: 1;
            text-align: right;
        }

        .fund-source-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.1rem 0.3rem;
            font-size: 0.75rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .fund-source-remove:hover {
            opacity: 1;
        }

        .fund-add-row {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fund-add-row select {
            flex: 1;
            padding: 0.35rem 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }

        .fund-add-row select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.12);
        }

        .fund-add-row input {
            width: 80px;
            padding: 0.35rem 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
        }

        .fund-add-row input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.12);
        }

        .fund-add-row input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .fund-add-row button {
            padding: 0.35rem 0.6rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8) 0%, rgba(22, 163, 74, 0.9) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fund-add-row button:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 1) 100%);
            transform: translateY(-1px);
        }

        .fund-total-row {
            display: flex;
            justify-content: space-between;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            border-top: 2px solid rgba(255, 255, 255, 0.15);
            font-weight: 700;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.95);
        }

        .goal-compact-sources {
            margin-top: 0.35rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .goal-compact-source-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.4rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .goal-compact-source-tag .amount {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Responsive Command Center */
        @media (max-width: 1024px) {
            .command-center-grid {
                grid-template-columns: 1fr 1fr;
            }

            .goals-panel {
                grid-column: span 2;
            }
        }

        @media (max-width: 640px) {
            .command-center-grid {
                grid-template-columns: 1fr;
            }

            .goals-panel {
                grid-column: span 1;
            }
        }

        /* Stats Grid - Sleek Design */
        /* ============================================
           S-TIER STATS RING CARDS
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-ring-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.25rem;
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-ring-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.5;
            pointer-events: none;
        }

        .stat-ring-card.cyan::before {
            background: radial-gradient(ellipse at top left, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
        }

        .stat-ring-card.green::before {
            background: radial-gradient(ellipse at top left, rgba(34, 197, 94, 0.15) 0%, transparent 50%);
        }

        .stat-ring-card.amber::before {
            background: radial-gradient(ellipse at top left, rgba(245, 158, 11, 0.15) 0%, transparent 50%);
        }

        .stat-ring-card.purple::before {
            background: radial-gradient(ellipse at top left, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
        }

        .stat-ring-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glass-shadow);
            border-color: var(--glass-border);
        }

        /* Ring Container */
        .stat-ring-visual {
            position: relative;
            width: 70px;
            height: 70px;
            flex-shrink: 0;
        }

        .stat-ring-visual svg {
            transform: rotate(-90deg);
            width: 70px;
            height: 70px;
        }

        .stat-ring-bg {
            fill: none;
            stroke: var(--glass-border);
            stroke-width: 6;
        }

        .stat-ring-progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            stroke-dasharray: 188.5;
            stroke-dashoffset: 188.5;
            transition: stroke-dashoffset 1s ease-out;
        }

        .stat-ring-progress.cyan { stroke: url(#statGradientCyan); }
        .stat-ring-progress.green { stroke: url(#statGradientGreen); }
        .stat-ring-progress.amber { stroke: url(#statGradientAmber); }
        .stat-ring-progress.purple { stroke: url(#statGradientPurple); }

        .stat-ring-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.25rem;
        }

        /* Content Area */
        .stat-ring-content {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 1;
        }

        .stat-ring-label {
            font-size: 0.7rem;
            color: var(--glass-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        .stat-ring-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            line-height: 1.1;
            margin-bottom: 0.35rem;
        }

        .stat-ring-card.cyan .stat-ring-value {
            background: linear-gradient(135deg, #ffffff 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-ring-card.green .stat-ring-value {
            background: linear-gradient(135deg, #ffffff 0%, #4ade80 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-ring-card.amber .stat-ring-value {
            background: linear-gradient(135deg, #ffffff 0%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-ring-card.purple .stat-ring-value {
            background: linear-gradient(135deg, #ffffff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-ring-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .stat-ring-emergency-note {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.5rem;
            padding: 0.35rem 0.65rem;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .stat-ring-emergency-note .emergency-icon {
            font-size: 0.75rem;
        }

        .stat-ring-emergency-note .emergency-text {
            color: rgba(252, 165, 165, 0.9);
        }

        .stat-ring-emergency-note #nextMonthEmergencyAmount {
            font-weight: 600;
            color: #fca5a5;
        }

        .stat-ring-percent {
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        .stat-ring-percent.cyan {
            background: rgba(6, 182, 212, 0.2);
            color: #22d3ee;
        }

        .stat-ring-percent.green {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .stat-ring-percent.amber {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .stat-ring-percent.purple {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-ring-card {
                padding: 1rem;
            }

            .stat-ring-visual {
                width: 60px;
                height: 60px;
            }

            .stat-ring-visual svg {
                width: 60px;
                height: 60px;
            }

            .stat-ring-value {
                font-size: 1.5rem;
            }
        }

        /* Week Summary */
        .week-summary-section {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .week-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .week-summary-header h3 {
            font-size: 1.25rem;
            margin: 0;
        }

        .week-summary-dates {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .week-summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .week-stat {
            text-align: center;
        }

        .week-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .week-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .week-payments-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .week-payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--border-color);
        }

        .week-payment-item.paid {
            opacity: 0.6;
            text-decoration: line-through;
            border-left-color: var(--success);
        }

        .week-payment-item.overdue {
            border-left-color: var(--danger);
        }

        .week-payment-item.today {
            border-left-color: var(--primary);
            background: rgba(13, 110, 253, 0.05);
        }

        .week-payment-info {
            flex: 1;
        }

        .week-payment-description {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .week-payment-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .week-payment-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Emergency expense styles in calendar views */
        .week-payment-item.emergency {
            border-left: none;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.03) 20%, transparent 50%);
            border: 1px solid rgba(239, 68, 68, 0.15);
            position: relative;
        }

        .week-payment-item.emergency::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            border-radius: 3px 0 0 3px;
        }

        .week-payment-item.emergency .week-payment-title {
            color: #fca5a5;
        }

        .week-day-content.has-emergency {
            border-color: rgba(239, 68, 68, 0.2);
        }

        .calendar-day.has-emergency {
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .calendar-day-amount.has-emergency {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
        }

        .calendar-day-indicator.has-emergency {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .calendar-agenda-item.emergency-item {
            border-left: none;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.03) 15%, transparent 40%);
            border: 1px solid rgba(239, 68, 68, 0.15);
            position: relative;
        }

        .calendar-agenda-item.emergency-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            border-radius: 4px 0 0 4px;
        }

        .calendar-agenda-item-status.emergency {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .calendar-agenda-item-amount.emergency {
            color: #fca5a5;
        }

        .agenda-tag.emergency {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .day-total.has-emergency {
            color: #fca5a5 !important;
        }

        .calendar-agenda-day.has-emergency {
            border-left: none;
        }

        /* Drawer emergency styles - matches regular card style */
        /* Override generic .emergency-item flex layout */
        .drawer-payment-item.emergency-item {
            display: block;
            align-items: initial;
            gap: initial;
            transform: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
            overflow: hidden;
        }

        .drawer-payment-item.emergency-item:hover {
            transform: none;
        }

        .drawer-payment-item.emergency-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .drawer-payment-title.emergency {
            color: #fca5a5;
        }

        .drawer-payment-amount.emergency.pending {
            color: #f87171;
        }

        .drawer-payment-amount.emergency.paid {
            color: #4ade80;
            text-decoration: line-through;
        }

        .drawer-stat-value.has-emergency {
            color: #fca5a5 !important;
        }

        .drawer-action-btn.emergency-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .drawer-action-btn.emergency-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .drawer-section-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            margin: 0.5rem 0;
        }

        .drawer-section-divider::before,
        .drawer-section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.3), transparent);
        }

        .drawer-section-divider span {
            font-size: 0.75rem;
            font-weight: 600;
            color: #fca5a5;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Heatmap - GitHub Style */
        /* ============================================
           S-TIER HEATMAP DESIGN
           ============================================ */
        .heatmap-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            margin-bottom: 2rem;
            overflow: hidden;
            position: relative;
        }

        .heatmap-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: var(--glass-accent);
            pointer-events: none;
        }

        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.75rem 1rem;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .heatmap-header h3 {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .heatmap-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .heatmap-month-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .heatmap-month-nav button {
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            padding: 0.5rem 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            color: var(--glass-text);
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .heatmap-month-nav button:hover {
            background: var(--glass-card-hover);
            border-color: var(--glass-border);
            color: var(--text-primary);
        }

        .heatmap-month-label {
            font-weight: 700;
            min-width: 120px;
            text-align: center;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .heatmap-filter {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-card-bg);
            color: var(--glass-text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .heatmap-filter:focus {
            outline: none;
            border-color: var(--glass-border);
        }

        .heatmap-info-wrapper {
            position: relative;
            display: inline-flex;
        }

        .heatmap-info-btn {
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--glass-text-muted);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .heatmap-info-btn:hover {
            background: var(--glass-card-hover);
            color: var(--text-primary);
        }

        .heatmap-legend-tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--glass-shadow);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            min-width: 220px;
        }

        .heatmap-info-wrapper:hover .heatmap-legend-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .heatmap-legend-tooltip h4 {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .heatmap-legend-section {
            margin-bottom: 0.75rem;
        }

        .heatmap-legend-section:last-child {
            margin-bottom: 0;
        }

        .heatmap-legend-label {
            font-size: 0.75rem;
            color: var(--glass-text-muted);
            margin-bottom: 0.35rem;
        }

        .heatmap-legend-row {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--glass-text-muted);
        }

        .heatmap-legend-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Ring Stats Row */
        .heatmap-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 0 1.75rem 1.25rem;
            position: relative;
            z-index: 1;
        }

        .heatmap-mini-stat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--glass-card-bg);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .heatmap-mini-ring {
            position: relative;
            width: 42px;
            height: 42px;
            flex-shrink: 0;
        }

        .heatmap-mini-ring svg {
            transform: rotate(-90deg);
            width: 42px;
            height: 42px;
        }

        .heatmap-mini-ring-bg {
            fill: none;
            stroke: var(--glass-border);
            stroke-width: 4;
        }

        .heatmap-mini-ring-progress {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 100.5;
            stroke-dashoffset: 100.5;
            transition: stroke-dashoffset 1s ease-out;
        }

        .heatmap-mini-ring-progress.blue { stroke: #3b82f6; }
        .heatmap-mini-ring-progress.green { stroke: #22c55e; }
        .heatmap-mini-ring-progress.amber { stroke: #f59e0b; }
        .heatmap-mini-ring-progress.purple { stroke: #8b5cf6; }

        .heatmap-mini-ring-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
        }

        .heatmap-mini-stat-content {
            min-width: 0;
        }

        .heatmap-mini-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .heatmap-mini-stat-label {
            font-size: 0.7rem;
            color: var(--glass-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .heatmap-body {
            display: flex;
            gap: 1.5rem;
            padding: 0 1.75rem 1.5rem;
            position: relative;
            z-index: 1;
        }

        .heatmap-grid-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: auto repeat(6, 1fr);
            gap: 4px;
            min-width: fit-content;
        }

        .heatmap-day-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .heatmap-week-header {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.25rem;
            font-weight: 600;
        }

        .heatmap-cell {
            min-width: 52px;
            height: 42px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }

        /* Subtle hover effect */
        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .heatmap-cell.today {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
        }

        .heatmap-cell-day {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .heatmap-cell-amount {
            font-size: 0.75rem;
            font-weight: 700;
        }

        .heatmap-cell.empty {
            background: rgba(255, 255, 255, 0.02);
            cursor: default;
        }

        .heatmap-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        /* Heatmap colors using CSS variables for theming */
        .heatmap-cell.pending-0 { background: var(--heatmap-empty-bg); color: var(--heatmap-empty-text); }
        .heatmap-cell.pending-1 { background: var(--heatmap-pending-1); color: var(--heatmap-pending-text); }
        .heatmap-cell.pending-2 { background: var(--heatmap-pending-2); color: var(--heatmap-pending-text); }
        .heatmap-cell.pending-3 { background: var(--heatmap-pending-3); color: var(--heatmap-pending-text); }
        .heatmap-cell.pending-4 { background: var(--heatmap-pending-4); color: var(--heatmap-pending-text-hi); }
        .heatmap-cell.pending-5 { background: var(--heatmap-pending-5); color: var(--heatmap-pending-text-hi); }
        .heatmap-cell.pending-6 { background: var(--heatmap-pending-6); color: var(--heatmap-pending-text-hi); }
        .heatmap-cell.pending-7 { background: var(--heatmap-pending-7); color: var(--heatmap-pending-text-hi); }

        .heatmap-cell.paid-0 { background: var(--heatmap-empty-bg); color: var(--heatmap-empty-text); }
        .heatmap-cell.paid-1 { background: var(--heatmap-paid-1); color: var(--heatmap-paid-text); }
        .heatmap-cell.paid-2 { background: var(--heatmap-paid-2); color: var(--heatmap-paid-text); }
        .heatmap-cell.paid-3 { background: var(--heatmap-paid-3); color: var(--heatmap-paid-text); }
        .heatmap-cell.paid-4 { background: var(--heatmap-paid-4); color: var(--heatmap-paid-text-hi); }
        .heatmap-cell.paid-5 { background: var(--heatmap-paid-5); color: var(--heatmap-paid-text-hi); }
        .heatmap-cell.paid-6 { background: var(--heatmap-paid-6); color: var(--heatmap-paid-text-hi); }
        .heatmap-cell.paid-7 { background: var(--heatmap-paid-7); color: var(--heatmap-paid-text-hi); }

        .heatmap-cell.mixed-0 { background: var(--heatmap-empty-bg); color: var(--heatmap-empty-text); }
        .heatmap-cell.mixed-1 { background: var(--heatmap-mixed-1); color: var(--heatmap-mixed-text); }
        .heatmap-cell.mixed-2 { background: var(--heatmap-mixed-2); color: var(--heatmap-mixed-text); }
        .heatmap-cell.mixed-3 { background: var(--heatmap-mixed-3); color: var(--heatmap-mixed-text); }
        .heatmap-cell.mixed-4 { background: var(--heatmap-mixed-4); color: var(--heatmap-mixed-text-hi); }
        .heatmap-cell.mixed-5 { background: var(--heatmap-mixed-5); color: var(--heatmap-mixed-text-hi); }
        .heatmap-cell.mixed-6 { background: var(--heatmap-mixed-6); color: var(--heatmap-mixed-text-hi); }
        .heatmap-cell.mixed-7 { background: var(--heatmap-mixed-7); color: var(--heatmap-mixed-text-hi); }




            background: rgba(0, 0, 0, 0.02);
            border: 1px solid var(--border-color);
        }
            color: var(--text-secondary);
        }

        .heatmap-week-totals {
            min-width: 130px;
            background: var(--glass-card-bg);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--glass-border);
        }

        .heatmap-week-totals h4 {
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
            color: var(--glass-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .heatmap-week-total-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--glass-border);
            color: var(--glass-text-muted);
        }

        .heatmap-week-total-item:last-child {
            border-bottom: none;
        }

        .heatmap-week-total-item.month-total {
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--glass-border);
            border-bottom: none;
        }

        .heatmap-footer {
            padding: 1rem 1.75rem 1.5rem;
            border-top: 1px solid var(--glass-border);
        }

        .heatmap-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .heatmap-stat {
            color: var(--glass-text-muted);
        }

        .heatmap-stat strong {
            color: var(--text-primary);
        }

        /* Day Details Drawer - Glassmorphism */
        .heatmap-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .heatmap-drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .heatmap-drawer {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            max-width: 90vw;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            box-shadow: var(--glass-shadow);
            border-left: 1px solid var(--glass-border);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .heatmap-drawer.open {
            right: 0;
        }

        .heatmap-drawer-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .heatmap-drawer-header h3 {
            margin: 0;
            font-size: 1.15rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .heatmap-drawer-close {
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--glass-text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heatmap-drawer-close:hover {
            background: var(--glass-card-hover);
            color: var(--text-primary);
            padding: 0.25rem;
            line-height: 1;
        }

        .heatmap-drawer-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.25rem;
        }

        .heatmap-drawer-total {
            background: var(--glass-card-bg);
            padding: 1.25rem;
            border-radius: 14px;
            margin-bottom: 1.25rem;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .heatmap-drawer-total-amount {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #f87171 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .heatmap-drawer-total-label {
            font-size: 0.85rem;
            color: var(--glass-text-muted);
            margin-top: 0.25rem;
        }

        .heatmap-drawer-payment {
            background: var(--glass-card-bg);
            padding: 1.25rem;
            border-radius: 14px;
            margin-bottom: 1rem;
            border: 1px solid var(--glass-border);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .heatmap-drawer-payment:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .heatmap-drawer-payment.emergency-item {
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }

        .heatmap-drawer-payment.emergency-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .heatmap-drawer-payment.emergency-item .heatmap-drawer-payment-name {
            color: #fca5a5;
        }

        .heatmap-drawer-payment.emergency-item .heatmap-drawer-payment-amount {
            color: #f87171;
        }

        .heatmap-drawer-payment.emergency-item.is-paid .heatmap-drawer-payment-amount {
            color: #4ade80;
            text-decoration: line-through;
        }

        .heatmap-drawer-payment.is-paid {
            opacity: 0.6;
        }

        .heatmap-drawer-payment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .heatmap-drawer-payment-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .heatmap-drawer-payment-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: #f87171;
        }

        .heatmap-drawer-payment.is-paid .heatmap-drawer-payment-amount {
            color: #4ade80;
            text-decoration: line-through;
        }

        .heatmap-drawer-payment-person {
            font-size: 0.85rem;
            color: var(--glass-text-muted);
            margin-bottom: 0.75rem;
        }

        .heatmap-drawer-payment-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .heatmap-drawer-payment-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.65rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .heatmap-drawer-payment-status.pending {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .heatmap-drawer-payment-status.paid {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        /* Action Buttons */
        .heatmap-drawer-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .drawer-action-btn {
            flex: 1;
            padding: 0.65rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Primary - Green with subtle fill */
        .drawer-action-btn.primary {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1.5px solid rgba(34, 197, 94, 0.5);
        }

        .drawer-action-btn.primary:hover {
            background: rgba(34, 197, 94, 0.25);
            border-color: rgba(34, 197, 94, 0.7);
        }

        /* Secondary - Glass purple fill */
        .drawer-action-btn.secondary {
            background: rgba(79, 70, 229, 0.35);
            color: #c4b5fd;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .drawer-action-btn.secondary:hover {
            background: rgba(79, 70, 229, 0.45);
            border-color: rgba(99, 102, 241, 0.5);
        }

        /* Danger/Undo - Red with subtle fill */
        .drawer-action-btn.undo,
        .drawer-action-btn.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1.5px solid rgba(239, 68, 68, 0.5);
        }

        .drawer-action-btn.undo:hover,
        .drawer-action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.7);
        }

        /* Partial Payment Input - unified styling for all drawers */
        .drawer-partial-input {
            /* Default hidden - shown via inline style="display: flex" when toggled */
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-partial-input input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .drawer-partial-input input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        .heatmap-drawer-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .heatmap-drawer-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        /* Upcoming Payments Section */
        .upcoming-section {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .upcoming-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            border: 2px solid transparent;
        }

        .upcoming-card.featured {
            border-color: var(--primary);
            background: rgba(13, 110, 253, 0.02);
        }

        .upcoming-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .upcoming-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .upcoming-total {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--danger);
        }

        .upcoming-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .upcoming-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upcoming-item.urgent {
            border-left-color: var(--danger);
            background: rgba(220, 53, 69, 0.05);
        }

        .upcoming-item.flagged {
            border-left-color: var(--warning);
            background: rgba(255, 193, 7, 0.05);
        }

        .upcoming-item-info {
            flex: 1;
        }

        .upcoming-item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .upcoming-item-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1rem;
        }

        .upcoming-item-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--danger);
        }

        .flag-indicator {
            font-size: 1.25rem;
            margin-right: 0.5rem;
        }

        /* Person Rankings */
        .person-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .person-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .person-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* ============================================
           S-TIER LEADERBOARD - TOP PEOPLE
           ============================================ */
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .leaderboard-item {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            cursor: default;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
            border-color: rgba(255, 215, 0, 0.2);
        }
        .leaderboard-item.rank-1:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.08));
            border-color: rgba(255, 215, 0, 0.3);
        }

        .leaderboard-rank {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-item.rank-1 .leaderboard-rank {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        .leaderboard-item.rank-2 .leaderboard-rank {
            background: linear-gradient(135deg, #E8E8E8, #A8A8A8);
            color: #1a1a2e;
        }
        .leaderboard-item.rank-3 .leaderboard-rank {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: white;
        }

        .leaderboard-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .leaderboard-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .leaderboard-amount {
            text-align: right;
        }

        .leaderboard-total {
            font-size: 1.125rem;
            font-weight: 700;
            color: #f87171;
        }

        .leaderboard-breakdown {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        /* Hover Tooltip - Smart Positioning */
        .leaderboard-tooltip {
            position: absolute;
            left: 50%;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            min-width: 220px;
            max-width: 300px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.25s ease;
            /* Default: tooltip above */
            bottom: calc(100% + 10px);
            transform: translateX(-50%) translateY(8px);
        }

        .leaderboard-tooltip::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            border: 7px solid transparent;
        }

        /* Arrow for top position (pointing down) */
        .leaderboard-tooltip:not(.tooltip-bottom)::after {
            top: 100%;
            border-top-color: rgba(255, 255, 255, 0.15);
        }

        /* Tooltip below variant */
        .leaderboard-tooltip.tooltip-bottom {
            bottom: auto;
            top: calc(100% + 10px);
            transform: translateX(-50%) translateY(-8px);
        }

        .leaderboard-tooltip.tooltip-bottom::after {
            bottom: 100%;
            top: auto;
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }

        /* Hover states - smooth slide */
        .leaderboard-item:hover .leaderboard-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .tooltip-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tooltip-count {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.08);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .tooltip-upcoming {
            margin-bottom: 0.5rem;
        }

        .tooltip-upcoming-label {
            font-size: 0.625rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .tooltip-upcoming-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .tooltip-upcoming-desc {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .tooltip-upcoming-amount {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #f87171;
            white-space: nowrap;
        }

        .tooltip-more-same {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .tooltip-others {
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .tooltip-others-label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.375rem;
        }

        .tooltip-other-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.1875rem 0;
            font-size: 0.8125rem;
        }

        .tooltip-other-desc {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .tooltip-other-amount {
            color: #f87171;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .tooltip-other-more {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: 0.25rem;
        }

        /* Calendar */
        /* ============================================
           S-TIER CALENDAR DESIGN
           ============================================ */
        .calendar-container {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 24px;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            position: relative;
        }

        .calendar-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: radial-gradient(ellipse at top left, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                        radial-gradient(ellipse at top right, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.75rem 1rem;
            position: relative;
            z-index: 1;
        }

        .calendar-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
        }

        .calendar-today-btn {
            padding: 0.4rem 0.85rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: #a5b4fc;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-today-btn:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #ffffff;
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .calendar-view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .calendar-view-btn {
            padding: 0.45rem 0.85rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-view-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .calendar-view-btn:hover:not(.active) {
            color: rgba(255, 255, 255, 0.8);
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }

        .calendar-nav .month-label {
            min-width: 140px;
            text-align: center;
            font-weight: 700;
            color: #ffffff;
            font-size: 1rem;
        }

        /* Mini Stats Row */
        .calendar-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 0 1.75rem 1.25rem;
            position: relative;
            z-index: 1;
        }

        .calendar-mini-stat {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 0.65rem 0.85rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .calendar-mini-ring {
            position: relative;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .calendar-mini-ring svg {
            transform: rotate(-90deg);
            width: 36px;
            height: 36px;
        }

        .calendar-mini-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 3;
        }

        .calendar-mini-ring-progress {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 82;
            stroke-dashoffset: 82;
            transition: stroke-dashoffset 1s ease-out;
        }

        .calendar-mini-ring-progress.blue { stroke: #3b82f6; }
        .calendar-mini-ring-progress.green { stroke: #22c55e; }
        .calendar-mini-ring-progress.amber { stroke: #f59e0b; }
        .calendar-mini-ring-progress.red { stroke: #ef4444; }

        .calendar-mini-ring-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem;
        }

        .calendar-mini-stat-content {
            min-width: 0;
        }

        .calendar-mini-stat-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #ffffff;
        }

        .calendar-mini-stat-value.has-emergency {
            color: #fca5a5;
            line-height: 1.2;
        }

        .calendar-mini-stat-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Calendar Body */
        .calendar-body {
            padding: 0 1.75rem 1.5rem;
            position: relative;
            z-index: 1;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 36px repeat(7, 1fr);
            gap: 6px;
        }

        .calendar-week-number {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.7rem;
            padding: 0.5rem 0;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 0.6rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.15);
            z-index: 5;
        }

        .calendar-day.other-month {
            opacity: 0.25;
        }

        .calendar-day.today {
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.15);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .calendar-day.has-pending {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .calendar-day.has-paid {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .calendar-day.has-mixed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .calendar-day.has-overdue {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            animation: pulse-overdue 2s infinite;
        }

        @keyframes pulse-overdue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        }

        .calendar-day.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .calendar-day.drag-over {
            background: rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
            transform: scale(1.05);
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .calendar-day.today .calendar-day-number {
            color: #ffffff;
        }

        .calendar-day-indicator {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .calendar-day-amount {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            padding: 0.2rem 0.3rem;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-day.has-pending .calendar-day-amount {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }

        .calendar-day.has-paid .calendar-day-amount {
            background: rgba(34, 197, 94, 0.8);
            color: white;
        }

        .calendar-day.has-mixed .calendar-day-amount {
            background: rgba(245, 158, 11, 0.8);
            color: white;
        }

        .calendar-day.today .calendar-day-amount {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        /* Status dots */
        .calendar-day-status {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
        }

        .calendar-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .calendar-status-dot.pending { background: #ef4444; }
        .calendar-status-dot.paid { background: #22c55e; }


        /* Week View */
        .calendar-week-view {
            display: none;
        }

        .calendar-week-view.active {
            display: block;
        }

        .calendar-month-view {
            display: block;
        }

        .calendar-month-view.hidden {
            display: none;
        }

        /* Agenda View */
        .calendar-agenda-view {
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .calendar-agenda-view.active {
            display: block;
        }

        .calendar-agenda-day {
            margin-bottom: 1rem;
        }

        .calendar-agenda-date {
            font-size: 0.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-agenda-date .day-total {
            color: #f87171;
            font-size: 0.85rem;
        }

        .calendar-agenda-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-agenda-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .calendar-agenda-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-agenda-item-status.pending { background: #ef4444; }
        .calendar-agenda-item-status.paid { background: #22c55e; }

        .calendar-agenda-item-info {
            flex: 1;
            min-width: 0;
        }

        .calendar-agenda-item-title {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .calendar-agenda-item-person {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .calendar-agenda-item-amount {
            font-weight: 700;
            font-size: 1rem;
            color: #f87171;
        }

        .calendar-agenda-item.is-paid .calendar-agenda-item-amount {
            color: #4ade80;
            text-decoration: line-through;
        }

        .calendar-agenda-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Agenda Sections */
        .agenda-section {
            margin-bottom: 0.5rem;
        }

        .agenda-section-header {
            text-align: center;
            padding: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .past-payments .calendar-agenda-day {
            opacity: 0.6;
        }

        .past-payments .calendar-agenda-item {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Now Marker */
        .agenda-now-marker {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem 0;
            margin: 0.5rem 0;
        }

        .agenda-now-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
        }

        .agenda-now-label {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        /* Agenda Tags */
        .agenda-date-tags {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agenda-tag {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agenda-tag.today {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .agenda-tag.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            animation: pulse-tag 2s infinite;
        }

        @keyframes pulse-tag {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .calendar-agenda-date.has-overdue {
            border-left: 3px solid #ef4444;
            padding-left: 0.75rem;
            margin-left: -0.75rem;
        }

        /* Overdue Item Styling */
        .calendar-agenda-item.is-overdue {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            position: relative;
        }

        .calendar-agenda-item.is-overdue::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ef4444;
            border-radius: 10px 0 0 10px;
        }

        .calendar-agenda-item-status.overdue {
            background: #ef4444;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        }

        .overdue-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            vertical-align: middle;
        }

        .calendar-agenda-item-amount.overdue {
            color: #f87171 !important;
            font-weight: 800;
        }

        .day-total.overdue {
            color: #f87171;
            font-weight: 700;
        }

        /* Today Styling */
        .calendar-agenda-day.is-today {
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
            padding: 0.75rem;
            margin: -0.25rem -0.5rem;
            border: 1px solid rgba(59, 130, 246, 0.15);
        }

        /* Agenda Item Actions */
        .agenda-item-actions {
            display: none;
            gap: 0.35rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .calendar-agenda-item:hover .agenda-item-actions {
            display: flex;
        }

        .agenda-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .agenda-action-btn.check {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .agenda-action-btn.check:hover {
            background: rgba(34, 197, 94, 0.3);
            transform: scale(1.05);
        }

        .agenda-action-btn.undo {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .agenda-action-btn.undo:hover {
            background: rgba(245, 158, 11, 0.3);
            transform: scale(1.05);
        }

        .agenda-action-btn.edit {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .agenda-action-btn.edit:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        /* Week View Grid */
        .week-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .week-header-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 0.5rem;
        }

        .week-day-header {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .week-day-header.today {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .week-day-name {
            display: block;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .week-day-date {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
        }

        .week-day-header.today .week-day-date {
            color: #3b82f6;
        }

        .week-content-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            min-height: 200px;
        }

        .week-day-content {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 0.5rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-day-content:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .week-day-content.today {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .week-day-content.drag-over {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .week-payment-item {
            padding: 0.4rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            cursor: grab;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .week-payment-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .week-payment-item.pending {
            border-left-color: #ef4444;
        }

        .week-payment-item.paid {
            border-left-color: #22c55e;
            opacity: 0.6;
        }

        .week-payment-item.overdue {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .week-payment-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .week-payment-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
            min-width: 0;
            gap: 0.25rem;
        }

        .week-payment-title {
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .week-payment-amount {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            flex-shrink: 0;
        }

        .week-payment-actions {
            display: none;
            gap: 0.25rem;
            margin-left: 0.35rem;
        }

        .week-payment-item:hover .week-payment-actions {
            display: flex;
        }

        .week-action-btn {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .week-action-btn.check {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .week-action-btn.check:hover {
            background: rgba(34, 197, 94, 0.4);
        }

        .week-action-btn.undo {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .week-action-btn.undo:hover {
            background: rgba(245, 158, 11, 0.4);
        }

        .week-action-btn.edit {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        .week-action-btn.edit:hover {
            background: rgba(99, 102, 241, 0.4);
        }

        .week-more {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.7rem;
            padding: 0.25rem;
        }

        .week-empty-add {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-empty-add:hover {
            color: rgba(99, 102, 241, 0.8);
        }

        /* Week Navigation Header */
        .week-nav-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1rem 0 1.25rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .week-nav-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }

        .week-nav-btn.today-btn {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
        }

        .week-nav-btn.today-btn:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #ffffff;
        }

        .week-nav-title {
            min-width: 200px;
            text-align: center;
        }

        .week-range {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
        }

        /* Quick Add Button */
        .calendar-day-add {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background: rgba(99, 102, 241, 0.8);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .calendar-day:not(.has-pending):not(.has-paid):not(.has-mixed):hover .calendar-day-add {
            display: flex;
            opacity: 1;
        }

        /* Calendar Drawer (slide-out panel) */
        .calendar-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
        }

        .calendar-drawer.active {
            right: 0;
        }

        .calendar-drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .calendar-drawer-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .drawer-date-day {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .drawer-date-full {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
        }

        .calendar-drawer-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-drawer-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }

        .calendar-drawer-stats {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-stat {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .drawer-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .drawer-stat-value.pending { color: #f87171; }
        .drawer-stat-value.paid { color: #4ade80; }

        .drawer-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .calendar-drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem 1.5rem;
        }

        .drawer-payment-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .drawer-payment-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .drawer-payment-item.is-paid {
            opacity: 0.6;
        }

        .drawer-payment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .drawer-payment-title {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95rem;
        }

        .drawer-payment-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .drawer-payment-amount.pending { color: #f87171; }
        .drawer-payment-amount.paid {
            color: #4ade80;
            text-decoration: line-through;
        }

        .drawer-payment-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .series-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.5rem;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.25);
            border-radius: 6px;
            font-size: 0.7rem;
            color: #a5b4fc;
            font-weight: 600;
        }

        .drawer-payment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Note: .drawer-partial-input and .drawer-action-btn styles are defined in the heatmap section above */

        .drawer-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .drawer-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .calendar-drawer-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .calendar-drawer-footer .btn {
            width: 100%;
        }

        /* Drawer backdrop */
        .calendar-drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .calendar-drawer-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.3);
        }
            background: var(--primary-bg);
            color: var(--primary);
            border: 1px solid rgba(37, 99, 235, 0.3);
        }
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Bulk Actions */
        .bulk-actions {
            display: none;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            align-items: center;
        }

        .bulk-actions.active {
            display: flex;
        }

        /* ============================================
           S-TIER PAYMENTS SECTION STYLES
           ============================================ */

        /* Quick Stats Summary Row */
        .payments-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payments-stat-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.85) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .payments-stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .payments-stat-ring {
            position: relative;
            width: 44px;
            height: 44px;
        }

        .payments-stat-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .payments-stat-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 3;
        }

        .payments-stat-ring-progress {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 100.53;
            stroke-dashoffset: 100.53;
            transition: stroke-dashoffset 0.6s ease;
        }

        .payments-stat-ring-progress.cyan { stroke: #22d3ee; }
        .payments-stat-ring-progress.green { stroke: #22c55e; }
        .payments-stat-ring-progress.amber { stroke: #f59e0b; }
        .payments-stat-ring-progress.red { stroke: #ef4444; }

        .payments-stat-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
        }

        .payments-stat-content {
            flex: 1;
            min-width: 0;
        }

        .payments-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
        }

        .payments-stat-value.green { color: #4ade80; }
        .payments-stat-value.amber { color: #fbbf24; }
        .payments-stat-value.red { color: #f87171; }

        .payments-stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.15rem;
        }


        /* Search & Filters Section */
        .payments-filter-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .payments-search-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .payments-search-wrapper {
            flex: 1;
            position: relative;
        }

        .payments-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            opacity: 0.5;
        }

        .payments-search-input {
            width: 100%;
            padding: 0.85rem 2.5rem 0.85rem 3rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .payments-search-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .payments-search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .payments-search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .payments-search-clear:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .payments-month-select {
            padding: 0.85rem 2.5rem 0.85rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 160px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' fill-opacity='0.5' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        .payments-month-select:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
        }

        .payments-add-btn {
            padding: 0.85rem 1.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .payments-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .payments-add-btn span {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Quick Filter Chips */
        .payments-filter-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-chip {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.85rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .filter-chip.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.2));
            border-color: rgba(99, 102, 241, 0.5);
            color: #ffffff;
        }

        .filter-chip.active .chip-count {
            background: rgba(99, 102, 241, 0.5);
        }

        .chip-icon {
            font-size: 0.85rem;
        }

        .chip-count {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.1rem 0.45rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .filter-chip-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.15);
            margin: 0 0.5rem;
        }

        .filter-chip-advanced {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.85rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip-advanced:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .advanced-filter-indicator {
            color: #6366f1;
            font-size: 0.6rem;
        }

        /* Advanced Filters Panel */
        .payments-advanced-filters {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .advanced-filter-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .advanced-filter-row:last-child {
            margin-bottom: 0;
        }

        .advanced-filter-group label {
            display: block;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .advanced-filter-group select,
        .advanced-filter-group input {
            width: 100%;
            padding: 0.65rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #ffffff;
            font-size: 0.85rem;
        }

        .advanced-filter-group select:focus,
        .advanced-filter-group input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
        }

        .amount-range-inputs,
        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .amount-range-inputs input,
        .date-range-inputs input {
            flex: 1;
        }

        .amount-range-inputs span,
        .date-range-inputs span {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }

        .clear-filters-btn {
            width: 100%;
            padding: 0.65rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            color: #f87171;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-filters-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Payments Table */
        .payments-table-container {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            overflow: hidden;
        }

        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payments-table thead {
            background: rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .payments-table th {
            padding: 1rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .payments-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .payments-table th.sortable:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .sort-icon {
            margin-left: 0.3rem;
            opacity: 0.5;
        }

        .payments-table th.sorted .sort-icon {
            opacity: 1;
            color: #6366f1;
        }

        .col-checkbox { width: 50px; text-align: center; }
        .col-status { width: 70px; text-align: center; }
        .col-description { min-width: 200px; }
        .col-person { min-width: 120px; }
        .col-amount { width: 120px; text-align: right; }
        .col-date { width: 130px; }
        .col-category { width: 110px; }
        .col-actions { width: 100px; text-align: center; }

        .payments-table tbody {
            max-height: calc(100vh - 450px);
            overflow-y: auto;
        }

        .payments-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .payments-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .payments-table tbody tr.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        .payments-table tbody tr.overdue {
            background: rgba(239, 68, 68, 0.05);
        }

        .payments-table tbody tr.paid {
            opacity: 0.6;
        }

        .payments-table td {
            padding: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            vertical-align: middle;
        }

        .payments-table td.col-checkbox {
            text-align: center;
        }

        .payments-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #6366f1;
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 0.85rem;
        }

        .status-indicator.pending {
            background: rgba(245, 158, 11, 0.2);
        }

        .status-indicator.paid {
            background: rgba(34, 197, 94, 0.2);
        }

        .status-indicator.overdue {
            background: rgba(239, 68, 68, 0.2);
            animation: pulse 2s infinite;
        }

        /* Description Cell */
        .payment-desc-cell {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .payment-desc-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .payment-desc-title .flag-icon {
            color: #f59e0b;
        }

        .payment-desc-title .recurring-icon {
            color: #22d3ee;
            font-size: 0.85rem;
        }

        .payment-desc-sub {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Amount Cell - Editable */
        .amount-cell {
            text-align: right;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .amount-cell.pending {
            color: #fbbf24;
        }

        .amount-cell.paid {
            color: #4ade80;
        }

        .amount-cell.overdue {
            color: #f87171;
        }

        .editable-field {
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .editable-field:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .editable-field.editing {
            background: rgba(0, 0, 0, 0.3);
        }

        .editable-field input {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100%;
            text-align: inherit;
        }

        .editable-field input:focus {
            outline: none;
        }

        /* Date Cell */
        .date-cell {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .date-cell-main {
            font-weight: 500;
        }

        .date-cell-relative {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .date-cell-relative.overdue {
            color: #f87171;
        }

        .date-cell-relative.today {
            color: #22d3ee;
        }

        /* Category Badge */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .category-badge.business {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.4rem;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .payments-table tbody tr:hover .action-buttons {
            opacity: 1;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .action-btn.check {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .action-btn.check:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .action-btn.edit {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
        }

        .action-btn.edit:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .action-btn.delete {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Empty State */
        .payments-empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .payments-empty-state .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .payments-empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .payments-empty-state p {
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 1.5rem;
        }

        /* Floating Bulk Actions Bar */
        .payments-bulk-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: bottom 0.3s ease;
        }

        .payments-bulk-bar.active {
            bottom: 2rem;
        }

        .bulk-bar-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .bulk-bar-count {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            padding-right: 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.15);
        }

        .bulk-bar-count span {
            color: #6366f1;
            font-size: 1.1rem;
        }

        .bulk-bar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .bulk-action-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bulk-action-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .bulk-action-btn.success {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .bulk-action-btn.success:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        .bulk-action-btn.warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .bulk-action-btn.warning:hover {
            background: rgba(245, 158, 11, 0.25);
        }

        .bulk-action-btn.danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .bulk-action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .bulk-bar-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .bulk-bar-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Month Group Header in Table */
        .month-group-header {
            background: rgba(0, 0, 0, 0.4) !important;
        }

        .month-group-header td {
            padding: 0.75rem 1rem !important;
            font-weight: 700;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .month-group-header .month-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .month-group-header .month-total {
            color: #fbbf24;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        }
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .payments-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .advanced-filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .payments-stats-row {
                grid-template-columns: 1fr;
            }

            .payments-search-container {
                flex-wrap: wrap;
            }

            .payments-search-wrapper {
                width: 100%;
            }

            .advanced-filter-row {
                grid-template-columns: 1fr;
            }

            .payments-table-container {
                overflow-x: auto;
            }

            .col-category,
            .col-person {
                display: none;
            }
        }

        /* Payments List - Legacy Support */
        .payments-list {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .month-divider {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .month-divider-total {
            font-size: 1.25rem;
            color: var(--danger);
        }

        .payments-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .payment-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.5rem;
            align-items: center;
            transition: background 0.2s;
        }

        .payment-item:hover {
            background: var(--bg-secondary);
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .payment-item.flagged {
            background: rgba(255, 193, 7, 0.05);
            border-left: 4px solid var(--warning);
        }

        .payment-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        .payment-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .payment-description {
            font-weight: 600;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .payment-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-business { background: #003366; color: #6eb4ff; }
        .badge-personal { background: #330066; color: #b366ff; }
        .badge-owed { background: #003300; color: #66ff66; }
        .badge-owing { background: #330000; color: #ff6666; }
        .badge-pending { background: rgba(255, 159, 10, 0.15); color: #fbbf24; }
        .badge-paid { background: rgba(48, 209, 88, 0.15); color: #4ade80; }

        .payment-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .payment-amount.positive { color: var(--success); }
        .payment-amount.negative { color: var(--danger); }

        .payment-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .action-btn.edit {
            background: var(--primary);
            color: white;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .action-btn.paid {
            background: var(--success);
            color: white;
        }

        .action-btn.flag {
            background: var(--warning);
            color: white;
        }

        .action-btn.unflag {
            background: var(--text-secondary);
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        /* ============================================
           S-TIER MODAL DESIGN
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 24px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--glass-border);
            background: var(--glass-accent);
        }

        .modal-header h2 {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header h2::before {
            content: '';
            font-size: 1.25rem;
            -webkit-text-fill-color: initial;
        }

        .close-btn {
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--glass-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        /* Edit Scope Modal Styles */
        .edit-scope-body {
            padding: 1.5rem 2rem 2rem;
        }

        .edit-scope-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .edit-scope-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .edit-scope-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .edit-scope-icon {
            font-size: 1.5rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            flex-shrink: 0;
        }

        .edit-scope-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .edit-scope-text strong {
            color: #ffffff;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .edit-scope-text span {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        #editScopeModal .modal-header h2::before {
            content: '';
        }

        #deleteScopeModal .modal-header h2::before {
            content: '';
        }

        .edit-scope-btn.delete-scope-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .edit-scope-btn.delete-scope-danger:hover strong {
            color: #f87171;
        }

        .modal-form-body {
            padding: 1.75rem 2rem;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-form-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-form-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .modal-form-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            border-radius: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--glass-text-muted);
        }

        .form-group label .required {
            color: #f87171;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: var(--glass-card-bg);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.08);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-group input::placeholder {
            color: var(--glass-text-muted);
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(255,255,255,0.5)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem;
        }

        .form-group select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Toggle/Checkbox Styling */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            background: var(--glass-card-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-group:hover {
            background: var(--glass-card-hover);
            border-color: var(--glass-border);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--glass-border);
            background: var(--glass-card-bg);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .checkbox-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-color: transparent;
        }

        .checkbox-group input[type="checkbox"]:checked::after {
            content: '';
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            height: 100%;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Expandable Fields */
        .expandable-fields {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            animation: expandIn 0.2s ease;
        }

        @keyframes expandIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.25rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.2);
        }

        .form-actions .btn {
            padding: 0.85rem 1.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .form-actions .btn:not(.btn-primary) {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        .form-actions .btn:not(.btn-primary):hover {
            background: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }

        .form-actions .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .form-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Input Icon Prefix */
        .input-with-icon {
            position: relative;
        }

        .input-with-icon .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }

        .input-with-icon input {
            padding-left: 2.75rem;
        }

        /* Emergency Modal Specific Styles */
        .modal-content.emergency-modal {
            max-width: 520px;
        }

        .modal-header.emergency-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.08) 100%);
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
        }

        .modal-header.emergency-header h2::before {
            display: none;
        }

        .modal-header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .modal-header-text h2 {
            margin-bottom: 0.15rem;
        }

        .modal-subtitle {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin: 0;
        }

        .emergency-section-card {
            background: rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .emergency-section-card .form-section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .section-icon {
            font-size: 1rem;
        }

        .required {
            color: #f87171;
        }

        .optional-label {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 400;
            font-size: 0.75rem;
        }

        .form-actions.emergency-actions {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(0, 0, 0, 0.2) 100%);
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: rgba(255, 255, 255, 0.7) !important;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            color: #ffffff !important;
        }

        .btn-emergency {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            border: none !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-emergency:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-icon {
            font-size: 1rem;
        }

        /* History */
        /* ============================================
           S-TIER HISTORY TAB STYLES
           ============================================ */
        .history-container {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            overflow: hidden;
        }

        .history-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.2);
        }

        .history-title {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .history-title-icon {
            font-size: 1.25rem;
        }

        .history-clear-btn {
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #f87171;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .history-list {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        /* Date Group Divider */
        .history-date-group {
            padding: 0.6rem 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .history-icon.paid {
            background: rgba(34, 197, 94, 0.15);
        }

        .history-icon.unpaid {
            background: rgba(245, 158, 11, 0.15);
        }

        .history-icon.added {
            background: rgba(59, 130, 246, 0.15);
        }

        .history-icon.edited {
            background: rgba(139, 92, 246, 0.15);
        }

        .history-icon.deleted {
            background: rgba(239, 68, 68, 0.15);
        }

        .history-icon.flagged {
            background: rgba(249, 115, 22, 0.15);
        }

        .history-icon.emergency {
            background: rgba(239, 68, 68, 0.15);
        }

        .history-icon.partial {
            background: rgba(6, 182, 212, 0.15);
        }

        .history-icon.default {
            background: rgba(107, 114, 128, 0.15);
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-action {
            font-weight: 600;
            font-size: 0.9rem;
            color: #ffffff;
            margin-bottom: 0.2rem;
        }

        .history-details {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* History Empty State */
        .history-empty {
            text-align: center;
            padding: 4rem 2rem;
        }

        .history-empty-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .history-empty h3 {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .history-empty p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* ==================== GOALS TAB STYLES ==================== */

        .goals-tab-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .goals-tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .goals-tab-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }

        .goals-tab-icon {
            font-size: 1.75rem;
        }

        .goals-add-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .goals-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .goals-add-btn span:first-child {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Focus Spotlight Area - Side by Side Layout */
        .goals-spotlight {
            margin-bottom: 2rem;
        }

        .spotlight-container {
            display: flex;
            border-radius: 24px;
            overflow: hidden;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .spotlight-image-side {
            width: 45%;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        .spotlight-image {
            width: 100%;
            height: 100%;
            min-height: 320px;
            object-fit: cover;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            transition: transform 0.5s ease;
        }

        .spotlight-container:hover .spotlight-image {
            transform: scale(1.02);
        }

        /* No-image placeholder for side layout */
        .spotlight-no-image-side {
            width: 100%;
            height: 100%;
            min-height: 320px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            opacity: 0.6;
        }

        .spotlight-no-image-side.investment {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.15) 100%);
        }

        .spotlight-no-image-side.achievement {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.15) 100%);
        }

        .spotlight-no-image-side.life {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(139, 92, 246, 0.15) 100%);
        }

        .spotlight-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .spotlight-category {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            width: fit-content;
        }

        .spotlight-category.investment {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .spotlight-category.achievement {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .spotlight-category.life {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .spotlight-name {
            font-size: 1.75rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .spotlight-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1.75rem;
            line-height: 1.6;
        }

        /* Stats row for side-by-side layout */
        .spotlight-stats-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .spotlight-stat {
            text-align: left;
        }

        .spotlight-stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.15rem;
        }

        .spotlight-stat-value.green {
            color: #4ade80;
        }

        .spotlight-stat-value.purple {
            color: #c084fc;
        }

        .spotlight-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .spotlight-progress-wrapper {
            margin-bottom: 1.5rem;
        }

        .spotlight-progress-bar {
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 7px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .spotlight-progress-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .spotlight-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.15), transparent);
            border-radius: 7px 7px 0 0;
        }

        .spotlight-progress-fill.investment {
            background: linear-gradient(90deg, #22c55e, #4ade80);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .spotlight-progress-fill.achievement {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .spotlight-progress-fill.life {
            background: linear-gradient(90deg, #a855f7, #c084fc);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .spotlight-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .spotlight-btn {
            padding: 0.7rem 1.25rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .spotlight-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.35);
        }

        .spotlight-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .spotlight-btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        .spotlight-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .spotlight-btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.7rem 1rem;
        }

        .spotlight-btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        /* Spotlight without image */
        /* Empty Spotlight State */
        .spotlight-empty {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spotlight-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .spotlight-empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .spotlight-empty-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 1.5rem;
        }

        .spotlight-empty-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.85rem 1.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .spotlight-empty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Section Label */
        .goals-section-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .goals-section-line {
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .goals-section-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Goals Grid */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        /* Goal Card */
        .goal-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .goal-card:hover {
            transform: translateY(-4px);
            border-color: var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .goal-card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .goal-card-no-image {
            width: 100%;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            opacity: 0.5;
        }

        .goal-card-no-image.investment {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.1) 100%);
        }

        .goal-card-no-image.achievement {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%);
        }

        .goal-card-no-image.life {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .goal-card-content {
            padding: 1rem;
        }

        .goal-card-category {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .goal-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .goal-card-progress {
            margin-bottom: 0.5rem;
        }

        .goal-card-progress-bar {
            height: 6px;
            background: var(--glass-card-bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .goal-card-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .goal-card-progress-fill.investment {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .goal-card-progress-fill.achievement {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .goal-card-progress-fill.life {
            background: linear-gradient(90deg, #a855f7, #c084fc);
        }

        .goal-card-amounts {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .goal-card-current {
            color: var(--glass-text);
            font-weight: 600;
        }

        .goal-card-percent {
            color: var(--glass-text-muted);
        }

        .goal-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .goal-card:hover .goal-card-actions {
            opacity: 1;
        }

        .goal-card-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-align: center;
        }

        .goal-card-btn-focus {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .goal-card-btn-focus:hover {
            transform: translateY(-1px);
        }

        .goal-card-btn-edit {
            background: var(--glass-card-bg);
            color: var(--glass-text);
        }

        .goal-card-btn-edit:hover {
            background: var(--glass-card-hover);
        }

        /* Goal Add Card */
        .goal-add-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.03) 100%);
            border: 2px dashed rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 260px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .goal-add-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .goal-add-card:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.08) 100%);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.15);
        }

        .goal-add-card:hover::before {
            opacity: 1;
        }

        .goal-add-card-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
            border-radius: 50%;
            font-size: 1.75rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .goal-add-card:hover .goal-add-card-icon {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            opacity: 0.4;
        }

        .goal-add-card-text {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .goal-add-card:hover .goal-add-card-text {
            color: rgba(255, 255, 255, 0.9);
        }

        .goal-add-card-hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.35);
            margin-top: 0.5rem;
        }

        /* Goal Modal Specific Styles */
        .goal-modal-content {
            max-width: 600px;
        }

        .goal-modal-header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .goal-modal-header .modal-header-content {
            flex: 1;
        }

        .goal-modal-header .modal-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.25rem;
        }

        /* Goal Image Upload */
        .goal-image-upload {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .goal-image-upload:hover {
            border-color: rgba(99, 102, 241, 0.4);
            background: rgba(99, 102, 241, 0.05);
        }

        .goal-image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            text-align: center;
        }

        .goal-image-placeholder .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .goal-image-placeholder .upload-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
        }

        .goal-image-placeholder .upload-hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .goal-image-preview {
            position: relative;
        }

        .goal-image-preview img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .goal-image-remove {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .goal-image-remove:hover {
            background: #ef4444;
            transform: scale(1.1);
        }

        /* Update Progress Modal */
        .progress-update-modal {
            text-align: center;
            padding: 1rem;
        }

        .progress-update-current {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .progress-update-target {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 1.5rem;
        }

        .progress-update-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .progress-update-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .spotlight-container {
                flex-direction: column;
            }

            .spotlight-image-side {
                width: 100%;
                padding: 1rem 1rem 0;
            }

            .spotlight-image {
                min-height: 220px;
            }

            .spotlight-no-image-side {
                min-height: 180px;
            }

            .spotlight-content {
                padding: 1.5rem;
            }

            .spotlight-stats-row {
                gap: 1.5rem;
            }

            .spotlight-stat-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .goals-tab-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .goals-add-btn {
                width: 100%;
                justify-content: center;
            }

            .spotlight-name {
                font-size: 1.35rem;
            }

            .spotlight-stats-row {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .spotlight-actions {
                flex-wrap: wrap;
            }

            .spotlight-actions .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }

            .goals-grid {
                grid-template-columns: 1fr;
            }
        }

            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }
            background: linear-gradient(135deg, var(--success-bg) 0%, rgba(22, 163, 74, 0.08) 100%);
        }
            background: linear-gradient(135deg, var(--warning-bg) 0%, rgba(217, 119, 6, 0.08) 100%);
        }
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(139, 92, 246, 0.08) 100%);
        }
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.3);
        }
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }
            background: rgba(168, 85, 247, 0.1);
            color: #7c3aed;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
            background: rgba(0, 0, 0, 0.08);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Light Mode Goal Cards */
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
        }
            border-color: var(--border-color);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
            background: linear-gradient(135deg, var(--success-bg) 0%, rgba(22, 163, 74, 0.05) 100%);
        }
            background: linear-gradient(135deg, var(--warning-bg) 0%, rgba(217, 119, 6, 0.05) 100%);
        }
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        }
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Light Mode Goal Add Card */
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.03) 0%, rgba(79, 70, 229, 0.02) 100%);
            border: 2px dashed rgba(37, 99, 235, 0.2);
        }
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.06) 0%, rgba(79, 70, 229, 0.04) 100%);
            border-color: rgba(37, 99, 235, 0.4);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.1);
        }

        /* Light Mode Goal Modal */
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(79, 70, 229, 0.05) 100%);
        }
            border: 2px dashed var(--border-color);
        }
            border-color: rgba(37, 99, 235, 0.4);
            background: rgba(37, 99, 235, 0.03);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 968px) {
            .upcoming-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .site-header {
                padding: 0.75rem 1rem;
            }

            .header-glass {
                border-radius: 16px;
            }

            .header-top {
                padding: 0.75rem 1rem;
            }

            .header-brand h1 {
                font-size: 1.1rem;
            }

            .header-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .header-nav {
                padding: 0.5rem 1rem;
            }

            .tabs {
                gap: 0.25rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 0.25rem;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                padding: 0.5rem 0.85rem;
                font-size: 0.8rem;
                white-space: nowrap;
                border-radius: 8px;
            }

            .main-content {
                padding: 0 1rem;
            }

            .tab-content {
                padding: 1.5rem 0;
            }

            .stats-grid,
            .goals-section {
                grid-template-columns: 1fr;
            }

            .payment-item {
                grid-template-columns: auto 1fr;
                gap: 1rem;
            }

            .payment-actions {
                grid-column: 2;
                margin-top: 1rem;
            }

            .heatmap-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .heatmap-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .heatmap-body {
                flex-direction: column;
            }

            .heatmap-week-totals {
                min-width: 100%;
                margin-top: 1rem;
            }

            .heatmap-cell {
                min-width: 40px;
                height: 35px;
            }

            .heatmap-cell-amount {
                font-size: 0.65rem;
            }

            .heatmap-drawer {
                width: 100%;
                max-width: 100vw;
            }

            .upcoming-section {
                grid-template-columns: 1fr;
            }

            .calendar-day-amount {
                font-size: 0.5rem;
                padding: 0.1rem 0.15rem;
            }

            .calendar-day-indicator {
                width: 1rem;
                height: 1rem;
                font-size: 0.6rem;
            }
        }

        /* Emergency Expenses Section */
        /* ============================================
           S-TIER EMERGENCY EXPENSES SECTION
           ============================================ */
        .emergency-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 24px;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .emergency-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: radial-gradient(ellipse at top left, rgba(239, 68, 68, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at top right, rgba(251, 146, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .emergency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.75rem 1rem;
            position: relative;
            z-index: 1;
        }

        .emergency-header-left h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-header-left h3 .pulse-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-emergency 2s infinite;
        }

        @keyframes pulse-emergency {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .emergency-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin: 0;
        }

        /* Time Period Toggle */
        .time-toggle-group {
            display: flex;
            gap: 0.25rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.25rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .time-toggle-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .time-toggle-btn:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .time-toggle-btn.active {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .emergency-header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .emergency-add-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.95) 100%);
            color: white;
            border: none;
            padding: 0.65rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .emergency-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Hero Stats Grid */
        .emergency-hero {
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 1.5rem;
            padding: 0 1.75rem 1.5rem;
            position: relative;
            z-index: 1;
        }

        .emergency-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .emergency-stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            text-align: center;
            transition: all 0.3s ease;
        }

        .emergency-stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .emergency-stat-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .emergency-stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .emergency-stat-card.total .emergency-stat-value {
            background: linear-gradient(135deg, #ffffff 0%, #f87171 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .emergency-stat-card.paid .emergency-stat-value {
            background: linear-gradient(135deg, #ffffff 0%, #4ade80 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .emergency-stat-card.unpaid .emergency-stat-value {
            background: linear-gradient(135deg, #ffffff 0%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Circular Progress Ring */
        .emergency-ring-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .emergency-ring {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .emergency-ring svg {
            transform: rotate(-90deg);
            width: 140px;
            height: 140px;
        }

        .emergency-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 12;
        }

        .emergency-ring-progress {
            fill: none;
            stroke: url(#emergencyGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 377;
            stroke-dashoffset: 377;
            transition: stroke-dashoffset 1s ease-out;
        }

        .emergency-ring-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .emergency-ring-percent {
            font-size: 1.75rem;
            font-weight: 800;
            color: #ffffff;
        }

        .emergency-ring-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Category Breakdown */
        .emergency-breakdown {
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            padding: 0.75rem 1.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .emergency-category-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            min-width: 80px;
        }

        .emergency-category-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .emergency-category-icon {
            font-size: 1rem;
            margin-bottom: 0.15rem;
        }

        .emergency-category-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.1rem;
        }

        .emergency-category-amount {
            font-weight: 700;
            font-size: 0.85rem;
            color: #ffffff;
        }

        .emergency-category-bar {
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.4rem;
            overflow: hidden;
        }

        .emergency-category-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .emergency-category-fill.medical { background: linear-gradient(90deg, #ef4444, #f87171); }
        .emergency-category-fill.car { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .emergency-category-fill.home { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .emergency-category-fill.appliance { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .emergency-category-fill.pet { background: linear-gradient(90deg, #ec4899, #f472b6); }
        .emergency-category-fill.travel { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        .emergency-category-fill.legal { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .emergency-category-fill.other { background: linear-gradient(90deg, #6b7280, #9ca3af); }

        /* Expense List Section */
        .emergency-list-section {
            padding: 0 1.75rem 1.5rem;
        }

        .emergency-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .emergency-list-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .emergency-list {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
        }

        .emergency-list::-webkit-scrollbar {
            width: 4px;
        }

        .emergency-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .emergency-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* Modern Expense Cards */
        .emergency-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .emergency-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ef4444, #dc2626);
            border-radius: 4px 0 0 4px;
        }

        .emergency-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .emergency-item.paid {
            opacity: 0.7;
        }

        .emergency-item.paid::before {
            background: linear-gradient(180deg, #22c55e, #16a34a);
        }

        .emergency-item:last-child {
            margin-bottom: 0;
        }

        .emergency-item-status {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .emergency-item-status.pending {
            background: rgba(239, 68, 68, 0.15);
        }

        .emergency-item-status.paid {
            background: rgba(34, 197, 94, 0.15);
        }

        .emergency-item-left {
            flex: 1;
            min-width: 0;
        }

        .emergency-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #ffffff;
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-item.paid .emergency-item-title {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .emergency-item-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .emergency-item-category {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .emergency-item-category.medical {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .emergency-item-category.car {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .emergency-item-category.home {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .emergency-item-category.appliance {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
        }

        .emergency-item-category.pet {
            background: rgba(236, 72, 153, 0.15);
            color: #f472b6;
        }

        .emergency-item-category.travel {
            background: rgba(6, 182, 212, 0.15);
            color: #22d3ee;
        }

        .emergency-item-category.legal {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .emergency-item-category.other {
            background: rgba(107, 114, 128, 0.15);
            color: #9ca3af;
        }

        .emergency-item-notes {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
            margin-top: 0.35rem;
            padding-left: 0.25rem;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        .emergency-item-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .emergency-item-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            min-width: 100px;
            text-align: right;
        }

        .emergency-item.paid .emergency-item-amount {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .emergency-item-actions {
            display: flex;
            gap: 0.35rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .emergency-item:hover .emergency-item-actions {
            opacity: 1;
        }

        .emergency-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        .emergency-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }

        .emergency-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .emergency-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .emergency-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .emergency-empty-text {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .emergency-empty-hint {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Paid Expenses Section - Minimalized */
        .emergency-paid-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .emergency-paid-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
            padding: 0 0.25rem;
        }

        .emergency-paid-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .emergency-paid-count {
            font-size: 0.65rem;
            color: rgba(34, 197, 94, 0.8);
            background: rgba(34, 197, 94, 0.1);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .emergency-paid-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .emergency-paid-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: rgba(34, 197, 94, 0.05);
            border: 1px solid rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .emergency-paid-item:hover {
            opacity: 1;
        }

        .emergency-paid-item-left {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            min-width: 0;
            flex: 1;
        }

        .emergency-paid-check {
            font-size: 0.75rem;
            color: #22c55e;
        }

        .emergency-paid-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .emergency-paid-meta {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.35);
            margin-left: 0.5rem;
            white-space: nowrap;
        }

        .emergency-paid-amount {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(34, 197, 94, 0.8);
            white-space: nowrap;
            margin-left: 0.75rem;
        }

        .emergency-paid-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .emergency-paid-item:hover .emergency-paid-actions {
            opacity: 1;
        }

        .emergency-paid-action-btn {
            background: transparent;
            border: none;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .emergency-paid-action-btn:hover {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .emergency-hero {
                grid-template-columns: 1fr;
            }

            .emergency-ring-container {
                order: -1;
                margin-bottom: 1rem;
            }

            .emergency-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 
           Phase 1B: Toast Notification Styles (v2.0)
            */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 420px;
            width: calc(100% - 2rem);
            pointer-events: none;
        }

        .toast-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.97);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.05);
            color: var(--text-primary);
            font-size: 0.9rem;
            pointer-events: all;
            animation: toastSlideIn 0.3s ease;
            transition: all 0.3s ease;
        }

        .toast-item.toast-exit {
            animation: toastSlideOut 0.3s ease forwards;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .toast-success { border-left: 3px solid var(--success); }
        .toast-error { border-left: 3px solid var(--danger); }
        .toast-warning { border-left: 3px solid var(--warning); }
        .toast-confirm { border-left: 3px solid var(--primary); }
        .toast-undo { border-left: 3px solid var(--accent-violet); }
        .toast-info { border-left: 3px solid var(--info); }

        .toast-icon { font-size: 1.1rem; flex-shrink: 0; }
        .toast-message { flex: 1; line-height: 1.4; }

        .toast-actions {
            display: flex;
            gap: 0.4rem;
            flex-shrink: 0;
        }

        .toast-btn {
            padding: 0.3rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .toast-btn-confirm {
            background: var(--success);
            color: #fff;
        }
        .toast-btn-confirm:hover { background: var(--success-light); }

        .toast-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        .toast-btn-cancel:hover { background: rgba(255, 255, 255, 0.15); }

        .toast-btn-undo {
            background: var(--accent-violet);
            color: #fff;
        }
        .toast-btn-undo:hover { background: var(--accent-indigo); }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.25rem;
            line-height: 1;
            flex-shrink: 0;
            transition: color 0.15s;
        }
        .toast-close:hover { color: var(--text-primary); }

        /* 
           Phase 2A: Inline Editing Styles (v2.0)
            */
        .inline-edit-input {
            background: var(--bg-secondary);
            border: 2px solid var(--primary);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 0.3rem 0.5rem;
            font-size: 0.9rem;
            width: 100%;
            max-width: 140px;
            outline: none;
            font-family: inherit;
        }

        .inline-edit-input:focus {
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
        }

        .editable-field {
            cursor: pointer;
            position: relative;
            transition: background 0.15s;
            border-radius: 4px;
            padding: 2px 4px;
        }

        .editable-field:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .editable-field:hover::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -4px;
            font-size: 0.6rem;
            opacity: 0.6;
        }

        .editable-field.editing::after {
            display: none;
        }

        /* 
           Phase 3: Charts & Insights Styles (v2.0)
            */
        .charts-section {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-canvas-container {
            position: relative;
            width: 100%;
            height: 250px;
        }

        .chart-canvas-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .insights-strip {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            scrollbar-width: thin;
        }

        .insight-card {
            flex: 0 0 auto;
            min-width: 220px;
            max-width: 280px;
            padding: 1rem;
            border-radius: 12px;
            background: var(--glass-card-bg);
            border: 1px solid var(--glass-border);
            cursor: default;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .insight-card .insight-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
        }

        .insight-card .insight-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .insight-card .insight-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Cash Flow Projection */
        .cashflow-section {
            margin-bottom: 1.5rem;
        }

        .cashflow-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 1rem 1.25rem;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: background 0.15s;
        }

        .cashflow-toggle:hover { background: var(--bg-secondary); }

        .cashflow-toggle h3 {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cashflow-body {
            display: none;
            padding: 1.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }

        .cashflow-body.expanded {
            display: block;
        }

        /* 
           Phase 4C: Agenda View Styles (v2.0)
            */
        .agenda-group {
            margin-bottom: 1rem;
        }

        .agenda-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .agenda-group-header:hover { background: var(--bg-tertiary); }

        .agenda-group-header .group-label {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agenda-group-header .group-total {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .agenda-group-items {
            padding-left: 0.5rem;
        }

        .agenda-group-items.collapsed {
            display: none;
        }

        .agenda-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.35rem;
            background: var(--glass-card-bg);
            border: 1px solid transparent;
            transition: all 0.15s;
        }

        .agenda-item:hover {
            background: var(--glass-card-hover);
            border-color: var(--glass-border);
        }

        .agenda-item.overdue { border-left: 3px solid var(--danger); }
        .agenda-item.today { border-left: 3px solid var(--primary); background: rgba(10, 132, 255, 0.05); }
        .agenda-item.paid { opacity: 0.5; }
        .agenda-item.paid .agenda-item-desc { text-decoration: line-through; }

        .agenda-item-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 0;
        }

        .agenda-item-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 60px;
        }

        .agenda-item-desc {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agenda-item-person {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .agenda-item-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .agenda-item-amount {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .agenda-item-actions {
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .agenda-item:hover .agenda-item-actions { opacity: 1; }

        .agenda-action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.15s;
        }

        .agenda-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        /* 
           Phase 4B: Drag-to-Reschedule Styles (v2.0)
            */
        .calendar-cell.drag-over {
            background: rgba(10, 132, 255, 0.15) !important;
            border-color: var(--primary) !important;
            box-shadow: inset 0 0 0 2px var(--primary);
        }

        .payment-chip {
            cursor: grab;
            transition: opacity 0.15s;
        }

        .payment-chip.dragging {
            opacity: 0.4;
        }

        /* 
           Phase 5A: Command Palette (Global Search) Styles (v2.0)
            */
        .command-palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 10001;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
        }

        .command-palette-overlay.active {
            display: flex;
        }

        .command-palette {
            width: 100%;
            max-width: 560px;
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        .command-palette-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            gap: 0.75rem;
        }

        .command-palette-input-wrapper .search-icon {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .command-palette-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .command-palette-input::placeholder {
            color: var(--text-muted);
        }

        .command-palette-kbd {
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-family: inherit;
        }

        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .command-palette-group {
            margin-bottom: 0.5rem;
        }

        .command-palette-group-label {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .command-palette-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .command-palette-item:hover,
        .command-palette-item.active {
            background: rgba(255, 255, 255, 0.08);
        }

        .command-palette-item .item-icon { font-size: 1rem; flex-shrink: 0; }
        .command-palette-item .item-text { flex: 1; min-width: 0; }
        .command-palette-item .item-title { font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .command-palette-item .item-subtitle { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .command-palette-item .item-meta { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); flex-shrink: 0; }

        .command-palette-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .command-palette-footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .command-palette-footer kbd {
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.08);
            font-family: inherit;
        }

        /* 
           Phase 5B: Payment Templates Styles (v2.0)
            */
        .template-dropdown {
            position: relative;
            display: inline-block;
        }

        .template-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 250px;
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            z-index: 200;
            padding: 0.4rem;
            margin-top: 0.25rem;
        }

        .template-dropdown-menu.active { display: block; }

        .template-menu-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-primary);
            transition: background 0.1s;
        }

        .template-menu-item:hover { background: rgba(255, 255, 255, 0.08); }

        .template-menu-item .template-name { flex: 1; }
        .template-menu-item .template-amount { color: var(--text-secondary); font-size: 0.8rem; }

        .template-menu-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            margin: 0.25rem 0;
        }

        /* 
           Phase 5D: Mobile Card Layout (v2.0)
            */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }

            .insights-strip {
                gap: 0.5rem;
            }

            .insight-card {
                min-width: 180px;
            }

            .command-palette {
                max-width: calc(100% - 2rem);
            }

            /* Mobile payment cards */
            .payments-table-wrapper.mobile-cards .payment-table { display: none; }

            .mobile-payment-card {
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 0.5rem;
                transition: all 0.15s;
            }

            .mobile-payment-card:hover {
                border-color: rgba(255, 255, 255, 0.15);
            }

            .mobile-payment-card.overdue {
                border-left: 3px solid var(--danger);
            }

            .mobile-payment-card.paid {
                opacity: 0.6;
            }

            .mobile-card-top {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.5rem;
            }

            .mobile-card-desc {
                font-weight: 600;
                font-size: 0.95rem;
            }

            .mobile-card-amount {
                font-weight: 700;
                font-size: 1.05rem;
            }

            .mobile-card-meta {
                display: flex;
                gap: 0.75rem;
                font-size: 0.8rem;
                color: var(--text-secondary);
                margin-bottom: 0.75rem;
            }

            .mobile-card-actions {
                display: flex;
                gap: 0.4rem;
            }

            .mobile-card-actions button {
                flex: 1;
                padding: 0.45rem;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-secondary);
                color: var(--text-secondary);
                cursor: pointer;
                font-size: 0.8rem;
                transition: all 0.15s;
            }

            .mobile-card-actions button:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
        }

        /* Keyboard shortcut hint */
        .shortcut-hint {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .shortcut-hint.visible { opacity: 1; }
    </style>
</head>
<body>
    <!-- S-Tier Glassmorphism Header -->
    <header class="site-header">
        <div class="header-glass">
            <div class="header-top">
                <div class="header-brand">
                    <span class="header-brand-icon"></span>
                    <h1>Payment Tracker Pro</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportData()" title="Export Data"></button>
                    <button class="header-btn" onclick="importData()" title="Import (Replace)"></button>
                    <button class="header-btn" onclick="importDataMerge()" title="Import (Merge)"></button>
                </div>
            </div>
            <nav class="header-nav">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
                    <button class="tab-btn" onclick="switchTab('calendar')">Calendar</button>
                    <button class="tab-btn" onclick="switchTab('payments')">Payments</button>
                    <button class="tab-btn" onclick="switchTab('goals')">Goals</button>
                    <button class="tab-btn" onclick="switchTab('history')">History</button>
                </div>
            </nav>
        </div>
    </header>
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">

    <main class="main-content">

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <!-- Hero Status Card - Combined Greeting & Alerts -->
        <div id="heroStatusCard" class="hero-status-card"></div>

        <!-- Command Center - Hero Section -->
        <div class="command-center">
            <div class="command-center-header">
                <h2> Payment Command Center</h2>
            </div>
            <div class="command-center-grid">
                <!-- Next 7 Days -->
                <div class="command-card urgent">
                    <div class="command-card-header">
                        <span class="command-card-title"> Next 7 Days</span>
                    </div>
                    <div class="command-card-total" id="cmd7Total">$0.00</div>
                    <div class="command-card-count" id="cmd7Count">0 payments due</div>
                    <div class="command-list" id="cmd7List">
                        <div class="command-list-empty">No payments in next 7 days</div>
                    </div>
                </div>

                <!-- Next 30 Days -->
                <div class="command-card upcoming">
                    <div class="command-card-header">
                        <span class="command-card-title"> Next 30 Days</span>
                    </div>
                    <div class="command-card-total" id="cmd30Total">$0.00</div>
                    <div class="command-card-count" id="cmd30Count">0 payments due</div>
                    <div class="command-list" id="cmd30List">
                        <div class="command-list-empty">No payments in next 30 days</div>
                    </div>
                </div>

                <!-- Goals Panel -->
                <div class="goals-panel">
                    <div class="goals-panel-header">
                        <span class="goals-panel-title"> Savings Goals</span>
                    </div>

                    <!-- 2-Month Goal -->
                    <div class="goal-compact" id="goal2Month" onclick="toggleGoalExpand('goal2Month')">
                        <div class="goal-compact-header">
                            <span class="goal-compact-label"> 2-Month Buffer</span>
                            <span class="goal-compact-percent" id="twoMonthPercent">0%</span>
                        </div>
                        <div class="goal-compact-bar">
                            <div class="goal-compact-fill" id="twoMonthFill" style="width: 0%"></div>
                        </div>
                        <div class="goal-compact-details">
                            <span id="twoMonthCurrent">$0</span>
                            <span>of <span id="twoMonthGoal">$0</span></span>
                        </div>
                        <div class="goal-compact-sources" id="twoMonthSourceTags"></div>
                        <div class="goal-compact-expand">
                            <div class="goal-expand-content">
                                <div class="fund-sources" id="twoMonthSources"></div>
                                <div class="fund-add-row" onclick="event.stopPropagation()">
                                    <select id="twoMonthFundType">
                                        <option value="Cash"> Cash</option>
                                        <option value="USDC"> USDC</option>
                                        <option value="Bitcoin"> Bitcoin</option>
                                        <option value="ETH"> ETH</option>
                                        <option value="Savings"> Savings</option>
                                        <option value="Stocks"> Stocks</option>
                                        <option value="Other"> Other</option>
                                    </select>
                                    <input type="number" id="twoMonthFundAmount" placeholder="$0" step="0.01" min="0">
                                    <button onclick="event.stopPropagation(); addFundSource('twoMonth')">+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 6-Month Goal -->
                    <div class="goal-compact" id="goal6Month" onclick="toggleGoalExpand('goal6Month')">
                        <div class="goal-compact-header">
                            <span class="goal-compact-label"> 6-Month Emergency</span>
                            <span class="goal-compact-percent" id="sixMonthPercent">0%</span>
                        </div>
                        <div class="goal-compact-bar">
                            <div class="goal-compact-fill" id="sixMonthFill" style="width: 0%"></div>
                        </div>
                        <div class="goal-compact-details">
                            <span id="sixMonthCurrent">$0</span>
                            <span>of <span id="sixMonthGoal">$0</span></span>
                        </div>
                        <div class="goal-compact-sources" id="sixMonthSourceTags"></div>
                        <div class="goal-compact-expand">
                            <div class="goal-expand-content">
                                <div class="fund-sources" id="sixMonthSources"></div>
                                <div class="fund-add-row" onclick="event.stopPropagation()">
                                    <select id="sixMonthFundType">
                                        <option value="Cash"> Cash</option>
                                        <option value="USDC"> USDC</option>
                                        <option value="Bitcoin"> Bitcoin</option>
                                        <option value="ETH"> ETH</option>
                                        <option value="Savings"> Savings</option>
                                        <option value="Stocks"> Stocks</option>
                                        <option value="Other"> Other</option>
                                    </select>
                                    <input type="number" id="sixMonthFundAmount" placeholder="$0" step="0.01" min="0">
                                    <button onclick="event.stopPropagation(); addFundSource('sixMonth')">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Ring Cards - S-Tier Design -->
        <svg width="0" height="0" style="position: absolute;">
            <defs>
                <linearGradient id="statGradientCyan" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#06b6d4"/>
                    <stop offset="100%" style="stop-color:#22d3ee"/>
                </linearGradient>
                <linearGradient id="statGradientGreen" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#22c55e"/>
                    <stop offset="100%" style="stop-color:#4ade80"/>
                </linearGradient>
                <linearGradient id="statGradientAmber" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#f59e0b"/>
                    <stop offset="100%" style="stop-color:#fbbf24"/>
                </linearGradient>
                <linearGradient id="statGradientPurple" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#8b5cf6"/>
                    <stop offset="100%" style="stop-color:#a78bfa"/>
                </linearGradient>
            </defs>
        </svg>

        <div class="stats-grid">
            <!-- This Month Card -->
            <div class="stat-ring-card cyan">
                <div class="stat-ring-visual">
                    <svg viewBox="0 0 70 70">
                        <circle class="stat-ring-bg" cx="35" cy="35" r="30"/>
                        <circle class="stat-ring-progress cyan" id="thisMonthRing" cx="35" cy="35" r="30"/>
                    </svg>
                    <div class="stat-ring-icon"></div>
                </div>
                <div class="stat-ring-content">
                    <div class="stat-ring-label">This Month</div>
                    <div class="stat-ring-value" id="thisMonthTotal">$0</div>
                    <div class="stat-ring-meta">
                        <span id="thisMonthCount">0 payments</span>
                    </div>
                </div>
            </div>

            <!-- Paid Card -->
            <div class="stat-ring-card green">
                <div class="stat-ring-visual">
                    <svg viewBox="0 0 70 70">
                        <circle class="stat-ring-bg" cx="35" cy="35" r="30"/>
                        <circle class="stat-ring-progress green" id="paidRing" cx="35" cy="35" r="30"/>
                    </svg>
                    <div class="stat-ring-icon"></div>
                </div>
                <div class="stat-ring-content">
                    <div class="stat-ring-label">Paid</div>
                    <div class="stat-ring-value" id="paidThisMonth">$0</div>
                    <div class="stat-ring-meta">
                        <span id="paidCount">0 of 0</span>
                        <span class="stat-ring-percent green" id="paidProgress">0%</span>
                    </div>
                </div>
            </div>

            <!-- Remaining Card -->
            <div class="stat-ring-card amber">
                <div class="stat-ring-visual">
                    <svg viewBox="0 0 70 70">
                        <circle class="stat-ring-bg" cx="35" cy="35" r="30"/>
                        <circle class="stat-ring-progress amber" id="remainingRing" cx="35" cy="35" r="30"/>
                    </svg>
                    <div class="stat-ring-icon"></div>
                </div>
                <div class="stat-ring-content">
                    <div class="stat-ring-label">Remaining</div>
                    <div class="stat-ring-value" id="remainingThisMonth">$0</div>
                    <div class="stat-ring-meta">
                        <span id="remainingCount">0 pending</span>
                    </div>
                </div>
            </div>

            <!-- Next Month Card -->
            <div class="stat-ring-card purple">
                <div class="stat-ring-visual">
                    <svg viewBox="0 0 70 70">
                        <circle class="stat-ring-bg" cx="35" cy="35" r="30"/>
                        <circle class="stat-ring-progress purple" id="nextMonthRing" cx="35" cy="35" r="30"/>
                    </svg>
                    <div class="stat-ring-icon"></div>
                </div>
                <div class="stat-ring-content">
                    <div class="stat-ring-label">Next Month</div>
                    <div class="stat-ring-value" id="nextMonthTotal">$0</div>
                    <div class="stat-ring-meta">
                        <span id="nextMonthCount">0 payments</span>
                    </div>
                    <div class="stat-ring-emergency-note" id="nextMonthEmergencyNote" style="display: none;">
                        <span class="emergency-icon"></span>
                        <span class="emergency-text">Incl. <span id="nextMonthEmergencyAmount">$0</span> emergency</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Expenses Section - S-Tier Design -->
        <div class="emergency-section">
            <!-- SVG Gradient Definition -->
            <svg width="0" height="0" style="position: absolute;">
                <defs>
                    <linearGradient id="emergencyGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#22c55e"/>
                        <stop offset="100%" style="stop-color:#4ade80"/>
                    </linearGradient>
                </defs>
            </svg>

            <div class="emergency-header">
                <div class="emergency-header-left">
                    <h3><span class="pulse-dot"></span> Emergency Expenses</h3>
                    <p class="emergency-subtitle">Track unexpected costs and emergencies</p>
                </div>
                <div class="emergency-header-controls">
                    <div class="time-toggle-group" id="emergencyTimeToggle">
                        <button class="time-toggle-btn active" data-period="this-month" onclick="setEmergencyPeriod('this-month')">This Month</button>
                        <button class="time-toggle-btn" data-period="next-month" onclick="setEmergencyPeriod('next-month')">Next Month</button>
                        <button class="time-toggle-btn" data-period="3-months" onclick="setEmergencyPeriod('3-months')">3 Months</button>
                    </div>
                    <button class="emergency-add-btn" onclick="openEmergencyModal()">+ Add Expense</button>
                </div>
            </div>

            <div class="emergency-hero">
                <div class="emergency-stats">
                    <div class="emergency-stat-card total">
                        <div class="emergency-stat-label">Total Expenses</div>
                        <div class="emergency-stat-value" id="emergencyTotal">$0</div>
                    </div>
                    <div class="emergency-stat-card paid">
                        <div class="emergency-stat-label">Paid Off</div>
                        <div class="emergency-stat-value" id="emergencyPaid">$0</div>
                    </div>
                    <div class="emergency-stat-card unpaid">
                        <div class="emergency-stat-label">Remaining</div>
                        <div class="emergency-stat-value" id="emergencyUnpaid">$0</div>
                    </div>
                </div>

                <div class="emergency-ring-container">
                    <div class="emergency-ring">
                        <svg viewBox="0 0 140 140">
                            <circle class="emergency-ring-bg" cx="70" cy="70" r="60"/>
                            <circle class="emergency-ring-progress" id="emergencyRingProgress" cx="70" cy="70" r="60"/>
                        </svg>
                        <div class="emergency-ring-center">
                            <div class="emergency-ring-percent" id="emergencyRingPercent">0%</div>
                            <div class="emergency-ring-label">Paid</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="emergency-breakdown" id="emergencyBreakdown">
                <!-- Category breakdown cards render here -->
            </div>

            <div class="emergency-list-section">
                <div class="emergency-list-header">
                    <span class="emergency-list-title">Recent Expenses</span>
                </div>
                <div class="emergency-list" id="emergencyList">
                    <!-- Expense cards render here -->
                </div>

                <!-- Paid Expenses Section -->
                <div id="emergencyPaidSection"></div>
            </div>
        </div>

        <!-- Payment Heatmap - S-Tier Design -->
        <div class="heatmap-card">
            <div class="heatmap-header">
                <h3> Payment Heatmap</h3>
                <div class="heatmap-controls">
                    <div class="heatmap-info-wrapper">
                        <button class="heatmap-info-btn" title="Legend"></button>
                        <div class="heatmap-legend-tooltip">
                            <h4>Color Legend</h4>
                            <div class="heatmap-legend-section">
                                <div class="heatmap-legend-label">Pending (Red)</div>
                                <div class="heatmap-legend-row">
                                    <div class="heatmap-legend-box" style="background:rgba(239,68,68,0.2)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(239,68,68,0.4)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(239,68,68,0.6)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(239,68,68,0.8)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(220,38,38,0.9)"></div>
                                    <span>$0  $500+</span>
                                </div>
                            </div>
                            <div class="heatmap-legend-section">
                                <div class="heatmap-legend-label">Paid (Green)</div>
                                <div class="heatmap-legend-row">
                                    <div class="heatmap-legend-box" style="background:rgba(34,197,94,0.2)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(34,197,94,0.4)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(34,197,94,0.6)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(34,197,94,0.8)"></div>
                                    <div class="heatmap-legend-box" style="background:rgba(22,163,74,0.9)"></div>
                                    <span>$0  $500+</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="heatmap-month-nav">
                        <button onclick="heatmapPrevMonth()"></button>
                        <span class="heatmap-month-label" id="heatmapMonthLabel">Jan 2024</span>
                        <button onclick="heatmapNextMonth()"></button>
                    </div>
                    <select class="heatmap-filter" id="heatmapFilter" onchange="renderHeatmap()">
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
            </div>

            <!-- Mini Stats Row with Rings -->
            <div class="heatmap-stats-row">
                <div class="heatmap-mini-stat">
                    <div class="heatmap-mini-ring">
                        <svg viewBox="0 0 42 42">
                            <circle class="heatmap-mini-ring-bg" cx="21" cy="21" r="16"/>
                            <circle class="heatmap-mini-ring-progress blue" id="heatmapRingTotal" cx="21" cy="21" r="16"/>
                        </svg>
                        <div class="heatmap-mini-ring-icon"></div>
                    </div>
                    <div class="heatmap-mini-stat-content">
                        <div class="heatmap-mini-stat-value" id="heatmapStatTotal">$0</div>
                        <div class="heatmap-mini-stat-label">Month Total</div>
                    </div>
                </div>
                <div class="heatmap-mini-stat">
                    <div class="heatmap-mini-ring">
                        <svg viewBox="0 0 42 42">
                            <circle class="heatmap-mini-ring-bg" cx="21" cy="21" r="16"/>
                            <circle class="heatmap-mini-ring-progress green" id="heatmapRingPaid" cx="21" cy="21" r="16"/>
                        </svg>
                        <div class="heatmap-mini-ring-icon"></div>
                    </div>
                    <div class="heatmap-mini-stat-content">
                        <div class="heatmap-mini-stat-value" id="heatmapStatPaid">$0</div>
                        <div class="heatmap-mini-stat-label">Paid</div>
                    </div>
                </div>
                <div class="heatmap-mini-stat">
                    <div class="heatmap-mini-ring">
                        <svg viewBox="0 0 42 42">
                            <circle class="heatmap-mini-ring-bg" cx="21" cy="21" r="16"/>
                            <circle class="heatmap-mini-ring-progress amber" id="heatmapRingHeaviest" cx="21" cy="21" r="16"/>
                        </svg>
                        <div class="heatmap-mini-ring-icon"></div>
                    </div>
                    <div class="heatmap-mini-stat-content">
                        <div class="heatmap-mini-stat-value" id="heatmapStatHeaviest">-</div>
                        <div class="heatmap-mini-stat-label">Heaviest Day</div>
                    </div>
                </div>
                <div class="heatmap-mini-stat">
                    <div class="heatmap-mini-ring">
                        <svg viewBox="0 0 42 42">
                            <circle class="heatmap-mini-ring-bg" cx="21" cy="21" r="16"/>
                            <circle class="heatmap-mini-ring-progress purple" id="heatmapRingAvg" cx="21" cy="21" r="16"/>
                        </svg>
                        <div class="heatmap-mini-ring-icon"></div>
                    </div>
                    <div class="heatmap-mini-stat-content">
                        <div class="heatmap-mini-stat-value" id="heatmapStatAvg">$0</div>
                        <div class="heatmap-mini-stat-label">Avg/Day</div>
                    </div>
                </div>
            </div>

            <div class="heatmap-body">
                <div class="heatmap-grid-container">
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                </div>
                <div class="heatmap-week-totals" id="heatmapWeekTotals"></div>
            </div>
            <div class="heatmap-footer">
                <div class="heatmap-stats" id="heatmapStats"></div>
            </div>
        </div>

        <!-- Heatmap Day Drawer -->
        <div class="heatmap-drawer-overlay" id="heatmapDrawerOverlay" onclick="closeHeatmapDrawer()"></div>
        <div class="heatmap-drawer" id="heatmapDrawer">
            <div class="heatmap-drawer-header">
                <h3 id="heatmapDrawerTitle">Payments for Jan 15</h3>
                <button class="heatmap-drawer-close" onclick="closeHeatmapDrawer()">&times;</button>
            </div>
            <div class="heatmap-drawer-body" id="heatmapDrawerBody"></div>
        </div>

        <!-- Top Creditors -->
        <div class="upcoming-section" style="grid-template-columns: 1fr;">
            <div class="person-card">
                <h3> Top 5 People I'm Paying</h3>
                <div class="person-list" id="topPersonList"></div>
            </div>
        </div>

    </div>

    <!-- Calendar Tab -->
    <div id="calendar" class="tab-content">
        <div class="calendar-container">
            <!-- Header with view toggle and navigation -->
            <div class="calendar-header">
                <div class="calendar-header-left">
                    <div class="calendar-view-toggle">
                        <button class="calendar-view-btn active" data-view="month" onclick="switchCalendarView('month')">Month</button>
                        <button class="calendar-view-btn" data-view="week" onclick="switchCalendarView('week')">Week</button>
                        <button class="calendar-view-btn" data-view="agenda" onclick="switchCalendarView('agenda')">Agenda</button>
                    </div>
                </div>
                <div class="calendar-nav">
                    <button onclick="previousMonth()"></button>
                    <span class="month-label" id="calendarTitle">January 2024</span>
                    <button onclick="nextMonth()"></button>
                    <button onclick="today()" style="margin-left: 0.5rem;">Today</button>
                    <div style="margin-left: auto; display: flex; gap: 0.3rem;">
                        <button onclick="exportICS('pending')" class="header-btn" title="Export pending to calendar" style="width:auto;padding:0.4rem 0.75rem;font-size:0.75rem;border-radius:8px;"> Export ICS</button>
                    </div>
                </div>
            </div>

            <!-- Mini Stats Row -->
            <div class="calendar-stats-row">
                <div class="calendar-mini-stat">
                    <div class="calendar-mini-ring">
                        <svg viewBox="0 0 40 40">
                            <circle class="calendar-mini-ring-bg" cx="20" cy="20" r="13"/>
                            <circle class="calendar-mini-ring-progress blue" id="calStatTotalRing" cx="20" cy="20" r="13"/>
                        </svg>
                        <span class="calendar-mini-ring-icon"></span>
                    </div>
                    <div class="calendar-mini-stat-content">
                        <div class="calendar-mini-stat-value" id="calStatTotal">$0</div>
                        <div class="calendar-mini-stat-label">This Month</div>
                    </div>
                </div>
                <div class="calendar-mini-stat">
                    <div class="calendar-mini-ring">
                        <svg viewBox="0 0 40 40">
                            <circle class="calendar-mini-ring-bg" cx="20" cy="20" r="13"/>
                            <circle class="calendar-mini-ring-progress green" id="calStatPaidRing" cx="20" cy="20" r="13"/>
                        </svg>
                        <span class="calendar-mini-ring-icon"></span>
                    </div>
                    <div class="calendar-mini-stat-content">
                        <div class="calendar-mini-stat-value" id="calStatPaid">$0</div>
                        <div class="calendar-mini-stat-label">Paid</div>
                    </div>
                </div>
                <div class="calendar-mini-stat">
                    <div class="calendar-mini-ring">
                        <svg viewBox="0 0 40 40">
                            <circle class="calendar-mini-ring-bg" cx="20" cy="20" r="13"/>
                            <circle class="calendar-mini-ring-progress amber" id="calStatRemainingRing" cx="20" cy="20" r="13"/>
                        </svg>
                        <span class="calendar-mini-ring-icon"></span>
                    </div>
                    <div class="calendar-mini-stat-content">
                        <div class="calendar-mini-stat-value" id="calStatRemaining">$0</div>
                        <div class="calendar-mini-stat-label">Remaining</div>
                    </div>
                </div>
                <div class="calendar-mini-stat">
                    <div class="calendar-mini-ring">
                        <svg viewBox="0 0 40 40">
                            <circle class="calendar-mini-ring-bg" cx="20" cy="20" r="13"/>
                            <circle class="calendar-mini-ring-progress red" id="calStatOverdueRing" cx="20" cy="20" r="13"/>
                        </svg>
                        <span class="calendar-mini-ring-icon"></span>
                    </div>
                    <div class="calendar-mini-stat-content">
                        <div class="calendar-mini-stat-value" id="calStatOverdue">$0</div>
                        <div class="calendar-mini-stat-label">Overdue</div>
                    </div>
                </div>
            </div>

            <!-- Calendar Body -->
            <div class="calendar-body">
                <!-- Month View -->
                <div class="calendar-month-view" id="calendarMonthView">
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <!-- Week View -->
                <div class="calendar-week-view" id="calendarWeekView">
                    <div id="weekViewContent"></div>
                </div>

                <!-- Agenda View -->
                <div class="calendar-agenda-view" id="calendarAgendaView">
                    <div id="agendaViewContent"></div>
                </div>
            </div>
        </div>

        <!-- Calendar Day Drawer (slide-out panel) -->
        <div class="calendar-drawer" id="calendarDrawer">
            <div class="calendar-drawer-header">
                <div class="calendar-drawer-title" id="calendarDrawerTitle">
                    <span class="drawer-date-day" id="drawerDayName">Monday</span>
                    <span class="drawer-date-full" id="drawerDateFull">January 15, 2024</span>
                </div>
                <button class="calendar-drawer-close" onclick="closeCalendarDrawer()"></button>
            </div>
            <div class="calendar-drawer-stats" id="calendarDrawerStats"></div>
            <div class="calendar-drawer-content" id="calendarDrawerContent"></div>
            <div class="calendar-drawer-footer">
                <button class="btn btn-primary" onclick="quickAddFromDrawer()">+ Add Payment</button>
            </div>
        </div>
        <div class="calendar-drawer-backdrop" id="calendarDrawerBackdrop" onclick="closeCalendarDrawer()"></div>
    </div>

    <!-- Payments Tab - S-Tier Design -->
    <div id="payments" class="tab-content">
        <!-- Quick Stats Summary -->
        <div class="payments-stats-row">
            <div class="payments-stat-card">
                <div class="payments-stat-ring">
                    <svg viewBox="0 0 40 40">
                        <circle class="payments-stat-ring-bg" cx="20" cy="20" r="16"/>
                        <circle class="payments-stat-ring-progress cyan" id="payStatTotalRing" cx="20" cy="20" r="16"/>
                    </svg>
                    <span class="payments-stat-icon"></span>
                </div>
                <div class="payments-stat-content">
                    <div class="payments-stat-value" id="payStatTotal">$0</div>
                    <div class="payments-stat-label">Total Due</div>
                </div>
            </div>
            <div class="payments-stat-card">
                <div class="payments-stat-ring">
                    <svg viewBox="0 0 40 40">
                        <circle class="payments-stat-ring-bg" cx="20" cy="20" r="16"/>
                        <circle class="payments-stat-ring-progress green" id="payStatPaidRing" cx="20" cy="20" r="16"/>
                    </svg>
                    <span class="payments-stat-icon"></span>
                </div>
                <div class="payments-stat-content">
                    <div class="payments-stat-value green" id="payStatPaid">$0</div>
                    <div class="payments-stat-label"><span id="payStatPaidCount">0</span> Paid</div>
                </div>
            </div>
            <div class="payments-stat-card">
                <div class="payments-stat-ring">
                    <svg viewBox="0 0 40 40">
                        <circle class="payments-stat-ring-bg" cx="20" cy="20" r="16"/>
                        <circle class="payments-stat-ring-progress amber" id="payStatPendingRing" cx="20" cy="20" r="16"/>
                    </svg>
                    <span class="payments-stat-icon"></span>
                </div>
                <div class="payments-stat-content">
                    <div class="payments-stat-value amber" id="payStatPending">$0</div>
                    <div class="payments-stat-label"><span id="payStatPendingCount">0</span> Pending</div>
                </div>
            </div>
            <div class="payments-stat-card">
                <div class="payments-stat-ring">
                    <svg viewBox="0 0 40 40">
                        <circle class="payments-stat-ring-bg" cx="20" cy="20" r="16"/>
                        <circle class="payments-stat-ring-progress red" id="payStatOverdueRing" cx="20" cy="20" r="16"/>
                    </svg>
                    <span class="payments-stat-icon"></span>
                </div>
                <div class="payments-stat-content">
                    <div class="payments-stat-value red" id="payStatOverdue">$0</div>
                    <div class="payments-stat-label"><span id="payStatOverdueCount">0</span> Overdue</div>
                </div>
            </div>
        </div>

        <!-- Search & Filters Section -->
        <div class="payments-filter-section">
            <!-- Search Bar -->
            <div class="payments-search-container">
                <div class="payments-search-wrapper">
                    <span class="payments-search-icon"></span>
                    <input type="text" class="payments-search-input" id="searchBox" placeholder="Search payments, people, categories..." oninput="filterPayments()">
                    <button class="payments-search-clear" id="searchClearBtn" onclick="clearSearch()" style="display: none;"></button>
                </div>
                <select class="payments-month-select" id="monthFilter" onchange="filterPayments()">
                    <option value="all">All Months</option>
                </select>
                <button class="payments-add-btn" onclick="showAddModal()">
                    <span>+</span> Add Payment
                </button>
            </div>

            <!-- Quick Filter Chips -->
            <div class="payments-filter-chips">
                <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">All</span>
                    <span class="chip-count" id="chipCountAll">0</span>
                </button>
                <button class="filter-chip" data-filter="pending" onclick="setFilter('pending')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">Pending</span>
                    <span class="chip-count" id="chipCountPending">0</span>
                </button>
                <button class="filter-chip" data-filter="paid" onclick="setFilter('paid')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">Paid</span>
                    <span class="chip-count" id="chipCountPaid">0</span>
                </button>
                <button class="filter-chip" data-filter="overdue" onclick="setFilter('overdue')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">Overdue</span>
                    <span class="chip-count" id="chipCountOverdue">0</span>
                </button>
                <button class="filter-chip" data-filter="flagged" onclick="setFilter('flagged')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">Flagged</span>
                    <span class="chip-count" id="chipCountFlagged">0</span>
                </button>
                <button class="filter-chip" data-filter="recurring" onclick="setFilter('recurring')">
                    <span class="chip-icon"></span>
                    <span class="chip-label">Recurring</span>
                    <span class="chip-count" id="chipCountRecurring">0</span>
                </button>
                <div class="filter-chip-divider"></div>
                <button class="filter-chip-advanced" onclick="toggleAdvancedFilters()">
                    <span> Advanced</span>
                    <span class="advanced-filter-indicator" id="advancedFilterIndicator" style="display: none;"></span>
                </button>
            </div>

            <!-- Advanced Filters Panel (Collapsible) -->
            <div class="payments-advanced-filters" id="advancedFiltersPanel" style="display: none;">
                <div class="advanced-filter-row">
                    <div class="advanced-filter-group">
                        <label>Type</label>
                        <select id="filterType" onchange="filterPayments()">
                            <option value="all">All Types</option>
                            <option value="i-owe"> I Owe</option>
                            <option value="owed-to-me"> Owed to Me</option>
                        </select>
                    </div>
                    <div class="advanced-filter-group">
                        <label>Category</label>
                        <select id="filterCategory" onchange="filterPayments()">
                            <option value="all">All Categories</option>
                            <option value="Personal"> Personal</option>
                            <option value="Business"> Business</option>
                        </select>
                    </div>
                    <div class="advanced-filter-group">
                        <label>Person</label>
                        <select id="filterPerson" onchange="filterPayments()">
                            <option value="all">All People</option>
                        </select>
                    </div>
                </div>
                <div class="advanced-filter-row">
                    <div class="advanced-filter-group">
                        <label>Amount Range</label>
                        <div class="amount-range-inputs">
                            <input type="number" id="filterAmountMin" placeholder="Min $" onchange="filterPayments()">
                            <span>to</span>
                            <input type="number" id="filterAmountMax" placeholder="Max $" onchange="filterPayments()">
                        </div>
                    </div>
                    <div class="advanced-filter-group">
                        <label>Date Range</label>
                        <div class="date-range-inputs">
                            <input type="date" id="filterDateFrom" onchange="filterPayments()">
                            <span>to</span>
                            <input type="date" id="filterDateTo" onchange="filterPayments()">
                        </div>
                    </div>
                    <div class="advanced-filter-group">
                        <button class="clear-filters-btn" onclick="clearAllFilters()">
                             Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="payments-table-container">
            <table class="payments-table" id="paymentsTable">
                <thead>
                    <tr>
                        <th class="col-checkbox">
                            <input type="checkbox" id="selectAllPayments" onchange="toggleSelectAll(this)">
                        </th>
                        <th class="col-status">Status</th>
                        <th class="col-description sortable" onclick="sortPayments('description')">
                            Description
                            <span class="sort-icon" id="sortIconDescription"></span>
                        </th>
                        <th class="col-person sortable" onclick="sortPayments('person')">
                            Person
                            <span class="sort-icon" id="sortIconPerson"></span>
                        </th>
                        <th class="col-amount sortable" onclick="sortPayments('amount')">
                            Amount
                            <span class="sort-icon" id="sortIconAmount"></span>
                        </th>
                        <th class="col-date sortable" onclick="sortPayments('dueDate')">
                            Due Date
                            <span class="sort-icon" id="sortIconDueDate"></span>
                        </th>
                        <th class="col-category">Category</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="paymentsList">
                </tbody>
            </table>

            <!-- Empty State -->
            <div class="payments-empty-state" id="paymentsEmptyState" style="display: none;">
                <div class="empty-state-icon"></div>
                <h3>No payments found</h3>
                <p>Try adjusting your filters or add a new payment</p>
                <button class="btn btn-primary" onclick="showAddModal()">+ Add Payment</button>
            </div>
        </div>

        <!-- Floating Bulk Actions Bar -->
        <div class="payments-bulk-bar" id="bulkActionsBar">
            <div class="bulk-bar-content">
                <div class="bulk-bar-count">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="bulk-bar-actions">
                    <button class="bulk-action-btn success" onclick="bulkMarkPaid()">
                        <span></span> Mark Paid
                    </button>
                    <button class="bulk-action-btn warning" onclick="bulkMarkUnpaid()">
                        <span></span> Mark Unpaid
                    </button>
                    <button class="bulk-action-btn" onclick="bulkReschedule()">
                        <span></span> Reschedule
                    </button>
                    <button class="bulk-action-btn danger" onclick="bulkDelete()">
                        <span></span> Delete
                    </button>
                </div>
                <button class="bulk-bar-close" onclick="clearSelection()"></button>
            </div>
        </div>
    </div>

    <!-- History Tab - S-Tier Design -->
    <div id="history" class="tab-content">
        <div class="history-container">
            <div class="history-header-bar">
                <div class="history-title">
                    <span class="history-title-icon"></span>
                    <span>Activity Log</span>
                </div>
                <button class="history-clear-btn" onclick="clearHistory()">Clear All</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <!-- Goals Tab - Focus Spotlight Design -->
    <div id="goals" class="tab-content">
        <div class="goals-tab-container">
            <!-- Header -->
            <div class="goals-tab-header">
                <div class="goals-tab-title">
                    <span class="goals-tab-icon"></span>
                    <span>My Goals</span>
                </div>
                <button class="goals-add-btn" onclick="openGoalModal()">
                    <span>+</span> Add Goal
                </button>
            </div>

            <!-- Focus Spotlight Area -->
            <div class="goals-spotlight" id="goalsSpotlight">
                <!-- Will be populated by JS - shows focused goal or empty state -->
            </div>

            <!-- Other Goals Grid -->
            <div class="goals-section-label" id="otherGoalsLabel" style="display: none;">
                <span class="goals-section-line"></span>
                <span class="goals-section-text">Other Goals</span>
                <span class="goals-section-line"></span>
            </div>
            <div class="goals-grid" id="goalsGrid">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>

    </main><!-- End main-content -->

    <!-- Goal Modal -->
    <div class="modal" id="goalModal">
        <div class="modal-content goal-modal-content">
            <div class="modal-header goal-modal-header">
                <div class="modal-header-content">
                    <h2 id="goalModalTitle">Add New Goal</h2>
                    <p class="modal-subtitle">Define your dream and track your progress</p>
                </div>
                <button class="close-btn" onclick="closeGoalModal()"></button>
            </div>
            <form id="goalForm" onsubmit="saveGoal(event)">
                <div class="modal-form-body">
                    <!-- Image Upload Section -->
                    <div class="form-section">
                        <div class="form-section-title"> Goal Image</div>
                        <div class="goal-image-upload" id="goalImageUpload" onclick="document.getElementById('goalImageInput').click()">
                            <div class="goal-image-preview" id="goalImagePreview" style="display: none;">
                                <img id="goalPreviewImg" src="" alt="Goal preview">
                                <button type="button" class="goal-image-remove" onclick="event.stopPropagation(); removeGoalImage()"></button>
                            </div>
                            <div class="goal-image-placeholder" id="goalImagePlaceholder">
                                <span class="upload-icon"></span>
                                <span class="upload-text">Click or drag to upload</span>
                                <span class="upload-hint">Recommended: 16:9 ratio, max 2MB</span>
                            </div>
                        </div>
                        <input type="file" id="goalImageInput" accept="image/*" style="display: none;" onchange="handleGoalImageUpload(event)">
                    </div>

                    <!-- Goal Details Section -->
                    <div class="form-section">
                        <div class="form-section-title"> Goal Details</div>
                        <div class="form-group">
                            <label>Goal Name <span class="required">*</span></label>
                            <input type="text" id="goalName" placeholder="e.g., Dream Home, Tesla Model 3, Japan Trip" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="goalDescription" placeholder="Describe your goal and why it matters to you..." rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Category & Target Section -->
                    <div class="form-section">
                        <div class="form-section-title"> Category & Target</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category <span class="required">*</span></label>
                                <select id="goalCategory" required>
                                    <option value="investment"> Investment Goal</option>
                                    <option value="achievement"> Achievement</option>
                                    <option value="life"> Life Goal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Target Date</label>
                                <input type="date" id="goalTargetDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Target Amount <span class="required">*</span></label>
                                <input type="number" id="goalTargetAmount" placeholder="100000" min="1" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Current Progress</label>
                                <input type="number" id="goalCurrentAmount" placeholder="0" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="form-section">
                        <div class="form-section-title"> Notes</div>
                        <div class="form-group">
                            <textarea id="goalNotes" placeholder="Any additional notes, strategies, or reminders..." rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Save Goal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Scope Modal (for recurring payments) -->
    <div class="modal" id="editScopeModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Edit Recurring Payment</h2>
                <button class="close-btn" onclick="closeEditScopeModal()"></button>
            </div>
            <div class="edit-scope-body">
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.25rem; font-size: 0.95rem;">
                    This is a recurring payment. How would you like to apply your changes?
                </p>
                <div class="edit-scope-options">
                    <button type="button" class="edit-scope-btn" onclick="editThisEventOnly()">
                        <div class="edit-scope-icon"></div>
                        <div class="edit-scope-text">
                            <strong>This event only</strong>
                            <span>Only change this specific occurrence</span>
                        </div>
                    </button>
                    <button type="button" class="edit-scope-btn" onclick="editAllFutureEvents()">
                        <div class="edit-scope-icon"></div>
                        <div class="edit-scope-text">
                            <strong>All future events</strong>
                            <span>Change this and all upcoming occurrences</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Scope Modal (for recurring payments) -->
    <div class="modal" id="deleteScopeModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="border-color: rgba(239, 68, 68, 0.3);">
                <h2 style="color: #f87171;">Delete Recurring Payment</h2>
                <button class="close-btn" onclick="closeDeleteScopeModal()"></button>
            </div>
            <div class="edit-scope-body">
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.25rem; font-size: 0.95rem;">
                    This is a recurring payment. What would you like to delete?
                </p>
                <div class="edit-scope-options">
                    <button type="button" class="edit-scope-btn" onclick="deleteThisEventOnly()">
                        <div class="edit-scope-icon"></div>
                        <div class="edit-scope-text">
                            <strong>This event only</strong>
                            <span>Only delete this specific occurrence</span>
                        </div>
                    </button>
                    <button type="button" class="edit-scope-btn delete-scope-danger" onclick="deleteAllFutureEvents()">
                        <div class="edit-scope-icon"></div>
                        <div class="edit-scope-text">
                            <strong>All future events</strong>
                            <span>Delete this and all upcoming occurrences</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Payment</h2>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <div class="template-dropdown">
                        <button type="button" class="header-btn" onclick="toggleTemplateDropdown()" title="Templates" style="width:auto;padding:0.4rem 0.6rem;font-size:0.8rem;border-radius:8px;"> Templates</button>
                        <div class="template-dropdown-menu" id="templateDropdownMenu"></div>
                    </div>
                    <button class="close-btn" onclick="closeModal()"></button>
                </div>
            </div>
            <form id="paymentForm" onsubmit="savePayment(event)">
                <div class="modal-form-body">
                    <!-- Basic Info Section -->
                    <div class="form-section">
                        <div class="form-section-title">Payment Details</div>
                        <div class="form-group">
                            <label>Description <span class="required">*</span></label>
                            <input type="text" id="description" placeholder="What is this payment for?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount <span class="required">*</span></label>
                                <div class="input-with-icon">
                                    <span class="input-icon">$</span>
                                    <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Due Date <span class="required">*</span></label>
                                <input type="date" id="dueDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Who & Category Section -->
                    <div class="form-section">
                        <div class="form-section-title">Who & Category</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Person <span class="required">*</span></label>
                                <input type="text" id="person" placeholder="Who are you paying?" required>
                            </div>
                            <div class="form-group">
                                <label>Type <span class="required">*</span></label>
                                <select id="type" required>
                                    <option value="i-owe"> I Owe</option>
                                    <option value="owed-to-me"> Owed to Me</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category <span class="required">*</span></label>
                                <select id="category" onchange="toggleBusinessName()" required>
                                    <option value="Personal"> Personal</option>
                                    <option value="Business"> Business</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sub-Category</label>
                                <input type="text" id="subcategory" placeholder="e.g., Rent, Loan">
                            </div>
                        </div>
                        <div class="form-group" id="businessNameGroup" style="display: none;">
                            <label>Business Name</label>
                            <input type="text" id="businessName" placeholder="Company or business name">
                        </div>
                    </div>

                    <!-- Options Section -->
                    <div class="form-section">
                        <div class="form-section-title">Options</div>
                        <div class="form-group">
                            <div class="checkbox-group" onclick="document.getElementById('isPartialPayment').click()">
                                <input type="checkbox" id="isPartialPayment" onchange="togglePartialPayment()" onclick="event.stopPropagation()">
                                <label onclick="event.stopPropagation()"> Enable Partial Payments</label>
                            </div>
                        </div>

                        <div id="partialPaymentFields" class="expandable-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Total Amount</label>
                                    <div class="input-with-icon">
                                        <span class="input-icon">$</span>
                                        <input type="number" id="totalAmount" step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Amount Paid</label>
                                    <div class="input-with-icon">
                                        <span class="input-icon">$</span>
                                        <input type="number" id="amountPaid" step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group" onclick="document.getElementById('isRecurring').click()">
                                <input type="checkbox" id="isRecurring" onchange="toggleRecurring()" onclick="event.stopPropagation()">
                                <label onclick="event.stopPropagation()"> Recurring Payment</label>
                            </div>
                        </div>

                        <div id="recurringFields" class="expandable-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Frequency</label>
                                    <select id="recurringFrequency">
                                        <option value="monthly"> Monthly</option>
                                        <option value="biweekly"> Every 2 Weeks</option>
                                        <option value="weekly"> Weekly</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Create Ahead</label>
                                    <select id="recurringMonthsAhead">
                                        <option value="1">1 month</option>
                                        <option value="2" selected>2 months</option>
                                        <option value="3">3 months</option>
                                        <option value="6">6 months</option>
                                        <option value="12">12 months</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emergency Expense Modal - S-Tier Design -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content emergency-modal">
            <div class="modal-header emergency-header">
                <div class="modal-header-content">
                    <div class="modal-header-icon"></div>
                    <div class="modal-header-text">
                        <h2 id="emergencyModalTitle">Add Emergency Expense</h2>
                        <p class="modal-subtitle">Track unexpected costs and emergencies</p>
                    </div>
                </div>
                <button class="close-btn" onclick="closeEmergencyModal()"></button>
            </div>
            <form id="emergencyForm" onsubmit="saveEmergencyExpense(event)">
                <div class="modal-form-body">
                    <!-- Expense Details Section -->
                    <div class="form-section emergency-section-card">
                        <div class="form-section-title">
                            <span class="section-icon"></span>
                            Expense Details
                        </div>
                        <div class="form-group">
                            <label>Description <span class="required">*</span></label>
                            <input type="text" id="emergencyDescription" placeholder="What happened?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount <span class="required">*</span></label>
                                <div class="input-with-icon">
                                    <span class="input-icon">$</span>
                                    <input type="number" id="emergencyAmount" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Date <span class="required">*</span></label>
                                <input type="date" id="emergencyDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Category & Status Section -->
                    <div class="form-section emergency-section-card">
                        <div class="form-section-title">
                            <span class="section-icon"></span>
                            Category & Status
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category <span class="required">*</span></label>
                                <select id="emergencyCategory" required>
                                    <option value="medical"> Medical / Health</option>
                                    <option value="car"> Car / Vehicle</option>
                                    <option value="home"> Home Repair</option>
                                    <option value="appliance"> Appliance</option>
                                    <option value="pet"> Pet Emergency</option>
                                    <option value="travel"> Travel / Stranded</option>
                                    <option value="legal"> Legal / Fines</option>
                                    <option value="other"> Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status <span class="required">*</span></label>
                                <select id="emergencyStatus" required>
                                    <option value="pending"> Pending (Not Paid)</option>
                                    <option value="paid"> Paid / Resolved</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="form-section emergency-section-card">
                        <div class="form-section-title">
                            <span class="section-icon"></span>
                            Additional Notes
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Notes <span class="optional-label">(Optional)</span></label>
                            <textarea id="emergencyNotes" rows="3" placeholder="Add any additional details, insurance info, receipts location, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions emergency-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEmergencyModal()">Cancel</button>
                    <button type="submit" class="btn btn-emergency">
                        <span class="btn-icon"></span>
                        Save Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Day Modal -->
    <div class="modal" id="dayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dayModalTitle">Payments</h2>
                <button class="close-btn" onclick="closeDayModal()">&times;</button>
            </div>
            <div id="dayPaymentsList"></div>
        </div>
    </div>

    <!-- Toast Container (v2.0) -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Command Palette Overlay (v2.0 - Phase 5A) -->
    <div class="command-palette-overlay" id="commandPalette">
        <div class="command-palette">
            <div class="command-palette-input-wrapper">
                <span class="search-icon"></span>
                <input type="text" class="command-palette-input" id="commandPaletteInput" 
                       placeholder="Search payments, expenses, goals..." 
                       oninput="handleCommandPaletteSearch(this.value)"
                       onkeydown="handleCommandPaletteKeydown(event)">
                <span class="command-palette-kbd">ESC</span>
            </div>
            <div class="command-palette-results" id="commandPaletteResults">
                <div class="command-palette-empty">Type to search across all your data...</div>
            </div>
            <div class="command-palette-footer">
                <span><kbd></kbd> Navigate</span>
                <span><kbd></kbd> Open</span>
                <span><kbd>esc</kbd> Close</span>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcut Hint (v2.0) -->
    <div class="shortcut-hint" id="shortcutHint"></div>

    <script>
        let data = {
            payments: [],
            history: [],
            twoMonthSavings: 0,
            sixMonthSavings: 0,
            twoMonthFundSources: [],
            sixMonthFundSources: [],
            emergencyExpenses: [],
            goals: [],
            focusedGoalId: null,
            templates: [] // v2.0 Phase 5B
        };

        const fundIcons = {
            'Cash': '',
            'USDC': '',
            'Bitcoin': '',
            'ETH': '',
            'Savings': '',
            'Stocks': '',
            'Other': ''
        };

        // Format money with commas and 2 decimal places
        function formatMoney(amount, decimals = 2) {
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        let currentFilter = 'all';
        let selectedPayments = new Set();
        let editingPaymentId = null;
        let editingEmergencyId = null;
        let currentDate = new Date();
        let currentActiveTab = 'dashboard';
        let scrollPositions = {};
        let heatmapDate = new Date(); // For heatmap month navigation
        let emergencyTimePeriod = localStorage.getItem('emergencyTimePeriod') || 'this-month';

        // 
        // Phase 1A: Event Bus System (v2.0)
        // 
        const EventBus = {
            _listeners: {},
            on(event, callback) {
                if (!this._listeners[event]) this._listeners[event] = [];
                this._listeners[event].push(callback);
                return () => this.off(event, callback); // Return unsubscribe function
            },
            off(event, callback) {
                if (!this._listeners[event]) return;
                this._listeners[event] = this._listeners[event].filter(cb => cb !== callback);
            },
            emit(event, data) {
                if (!this._listeners[event]) return;
                this._listeners[event].forEach(cb => {
                    try { cb(data); } catch (e) { console.error(`EventBus error on "${event}":`, e); }
                });
            }
        };

        // 
        // Phase 1B: Toast Notification System (v2.0)
        // 
        let toastQueue = [];
        let activeToasts = [];
        const MAX_TOASTS = 4;

        function showToast(message, type = 'info', options = {}) {
            const id = Date.now() + Math.random();
            const toast = {
                id,
                message,
                type, // 'success', 'error', 'warning', 'confirm', 'undo', 'info'
                timeout: options.timeout || (type === 'confirm' ? 0 : type === 'undo' ? 5000 : 3000),
                onConfirm: options.onConfirm || null,
                onCancel: options.onCancel || null,
                onUndo: options.onUndo || null,
            };

            activeToasts.push(toast);
            renderToasts();

            if (toast.timeout > 0) {
                setTimeout(() => dismissToast(id), toast.timeout);
            }

            return id;
        }

        function dismissToast(id) {
            const el = document.querySelector(`.toast-item[data-toast-id="${id}"]`);
            if (el) {
                el.classList.add('toast-exit');
                setTimeout(() => {
                    activeToasts = activeToasts.filter(t => t.id !== id);
                    renderToasts();
                }, 300);
            } else {
                activeToasts = activeToasts.filter(t => t.id !== id);
            }
        }

        function renderToasts() {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            container.innerHTML = activeToasts.slice(-MAX_TOASTS).map(toast => {
                const iconMap = {
                    success: '', error: '', warning: '',
                    confirm: '', undo: '', info: ''
                };
                const icon = iconMap[toast.type] || '';

                let actionsHtml = '';
                if (toast.type === 'confirm') {
                    actionsHtml = `
                        <div class="toast-actions">
                            <button class="toast-btn toast-btn-confirm" onclick="handleToastConfirm(${toast.id})">Yes</button>
                            <button class="toast-btn toast-btn-cancel" onclick="handleToastCancel(${toast.id})">No</button>
                        </div>`;
                } else if (toast.type === 'undo') {
                    actionsHtml = `
                        <div class="toast-actions">
                            <button class="toast-btn toast-btn-undo" onclick="handleToastUndo(${toast.id})">Undo</button>
                        </div>`;
                }

                return `
                    <div class="toast-item toast-${toast.type}" data-toast-id="${toast.id}">
                        <span class="toast-icon">${icon}</span>
                        <span class="toast-message">${toast.message}</span>
                        ${actionsHtml}
                        <button class="toast-close" onclick="dismissToast(${toast.id})"></button>
                    </div>`;
            }).join('');
        }

        function handleToastConfirm(id) {
            const toast = activeToasts.find(t => t.id === id);
            if (toast && toast.onConfirm) toast.onConfirm();
            dismissToast(id);
        }

        function handleToastCancel(id) {
            const toast = activeToasts.find(t => t.id === id);
            if (toast && toast.onCancel) toast.onCancel();
            dismissToast(id);
        }

        function handleToastUndo(id) {
            const toast = activeToasts.find(t => t.id === id);
            if (toast && toast.onUndo) toast.onUndo();
            dismissToast(id);
        }

        // Initialize
        function init() {
            console.log('Initializing Payment Tracker...');
            loadData();
            console.log('Data loaded:', data.payments.length, 'payments');
            renderDashboard();
            renderPayments();
            renderGoals();
            renderHistory();
            renderCalendar();
            setupGoalImageDragDrop();
            setupScrollHeader();
            setupScrollbarFade();
            initEmergencyTimeToggle();

            // Restore last active tab from localStorage
            const savedTab = localStorage.getItem('paymentTrackerActiveTab');
            if (savedTab && ['dashboard', 'calendar', 'payments', 'goals', 'history'].includes(savedTab)) {
                switchTab(savedTab, true);
            }

            console.log('Initialization complete');
        }

        // Initialize emergency time period toggle
        function initEmergencyTimeToggle() {
            const toggleGroup = document.getElementById('emergencyTimeToggle');
            if (!toggleGroup) return;

            // Set active state from saved preference
            const buttons = toggleGroup.querySelectorAll('.time-toggle-btn');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === emergencyTimePeriod);
            });
        }

        // Set emergency expenses time period
        function setEmergencyPeriod(period) {
            emergencyTimePeriod = period;
            localStorage.setItem('emergencyTimePeriod', period);

            // Update toggle button states
            const toggleGroup = document.getElementById('emergencyTimeToggle');
            if (toggleGroup) {
                const buttons = toggleGroup.querySelectorAll('.time-toggle-btn');
                buttons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === period);
                });
            }

            // Re-render emergency expenses
            renderEmergencyExpenses();
        }

        // Hide header on scroll down, show on scroll up
        function setupScrollHeader() {
            const header = document.querySelector('.site-header');
            let lastScrollY = window.scrollY;
            let ticking = false;

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        const currentScrollY = window.scrollY;

                        // Only hide after scrolling past header height
                        if (currentScrollY > 100) {
                            if (currentScrollY > lastScrollY) {
                                // Scrolling down - hide header
                                header.classList.add('header-hidden');
                            } else {
                                // Scrolling up - show header
                                header.classList.remove('header-hidden');
                            }
                        } else {
                            // At top of page - always show
                            header.classList.remove('header-hidden');
                        }

                        lastScrollY = currentScrollY;
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        }

        // Show scrollbar when scrolling, hide when at rest
        function setupScrollbarFade() {
            document.querySelectorAll('.command-list').forEach(list => {
                let scrollTimeout;
                list.addEventListener('scroll', () => {
                    list.classList.add('is-scrolling');
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        list.classList.remove('is-scrolling');
                    }, 1000);
                });
            });
        }

        // Auto-link recurring payments that share the same description, person, and amount
        function autoLinkRecurringPayments() {
            // Find all recurring payments without a recurringGroupId
            const unlinkedRecurring = data.payments.filter(p =>
                p.isRecurring && !p.recurringGroupId
            );

            if (unlinkedRecurring.length === 0) return;

            // Group by description + person + amount (normalized)
            const groups = {};
            unlinkedRecurring.forEach(payment => {
                const key = `${payment.description.toLowerCase().trim()}|${payment.person.toLowerCase().trim()}|${parseFloat(payment.amount).toFixed(2)}`;
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(payment);
            });

            // Assign recurringGroupId to each group with 2+ payments
            let linkedCount = 0;
            Object.keys(groups).forEach(key => {
                const group = groups[key];
                if (group.length >= 2) {
                    const groupId = `recurring_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    group.forEach(payment => {
                        payment.recurringGroupId = groupId;
                        linkedCount++;
                    });
                }
            });

            if (linkedCount > 0) {
                console.log(` Auto-linked ${linkedCount} recurring payments into groups`);
                saveData();
            }
        }

        // Get count of payments in a recurring group
        function getRecurringGroupCount(payment) {
            if (!payment.recurringGroupId) return 1;
            return data.payments.filter(p => p.recurringGroupId === payment.recurringGroupId).length;
        }

        // Get all payments in a recurring group
        function getRecurringGroupPayments(groupId) {
            if (!groupId) return [];
            return data.payments.filter(p => p.recurringGroupId === groupId)
                .sort((a, b) => a.dueDate.localeCompare(b.dueDate));
        }

        // Local Storage
        function loadData() {
            const saved = localStorage.getItem('paymentTrackerData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Migrate old data structure if needed
                    if (parsed.personal || parsed.business) {
                        data.payments = [
                            ...(parsed.personal?.payments || []),
                            ...(parsed.business?.payments || [])
                        ];
                        data.history = [];
                        data.twoMonthSavings = 0;
                        data.sixMonthSavings = 0;
                    } else {
                        data = parsed;
                    }

                    // Ensure data integrity
                    if (!data.payments) data.payments = [];
                    if (!data.history) data.history = [];
                    if (!data.twoMonthSavings) data.twoMonthSavings = 0;
                    if (!data.sixMonthSavings) data.sixMonthSavings = 0;
                    if (!data.emergencyExpenses) data.emergencyExpenses = [];
                    if (!data.goals) data.goals = [];
                    if (!data.focusedGoalId) data.focusedGoalId = null;
                    if (!data.templates) data.templates = []; // v2.0 Phase 5B

                    // Ensure all payments have required properties and normalize data
                    data.payments.forEach(p => {
                        if (p.isFlagged === undefined) p.isFlagged = false;
                        if (p.isRecurring === undefined) p.isRecurring = false;

                        // Normalize date format to YYYY-MM-DD if needed
                        if (p.dueDate && !p.dueDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const parsedDate = new Date(p.dueDate);
                            if (!isNaN(parsedDate)) {
                                p.dueDate = parsedDate.toISOString().split('T')[0];
                            }
                        }
                    });

                    // Auto-link recurring payments that don't have a groupId
                    autoLinkRecurringPayments();

                    console.log(' Data loaded:', data.payments.length, 'payments');
                    if (data.payments.length > 0) {
                        console.log(' Sample payment:', {
                            description: data.payments[0].description,
                            amount: data.payments[0].amount,
                            dueDate: data.payments[0].dueDate,
                            type: data.payments[0].type,
                            status: data.payments[0].status
                        });
                    }
                } catch (error) {
                    console.error(' Error loading data:', error);
                    data = {
                        payments: [],
                        history: [],
                        twoMonthSavings: 0,
                        sixMonthSavings: 0
                    };
                }
            } else {
                console.log(' No saved data - starting fresh');
            }
        }

        function saveData() {
            // Phase 1C: Auto-backup rotation (keep last 3 versions)
            try {
                localStorage.removeItem('paymentTrackerData_backup_3');
                const b2 = localStorage.getItem('paymentTrackerData_backup_2');
                if (b2) localStorage.setItem('paymentTrackerData_backup_3', b2);
                const b1 = localStorage.getItem('paymentTrackerData_backup_1');
                if (b1) localStorage.setItem('paymentTrackerData_backup_2', b1);
                const current = localStorage.getItem('paymentTrackerData');
                if (current) localStorage.setItem('paymentTrackerData_backup_1', current);
            } catch (e) {
                console.warn('Backup rotation failed:', e);
            }
            localStorage.setItem('paymentTrackerData', JSON.stringify(data));
        }

        function addHistory(action, details) {
            data.history.unshift({
                id: Date.now(),
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
            // Keep only last 100 history items
            if (data.history.length > 100) {
                data.history = data.history.slice(0, 100);
            }
            saveData();
        }

        // Tabs
        function switchTab(tabName, fromInit = false) {
            // Save scroll position of current tab before switching
            if (currentActiveTab === 'payments') {
                const paymentsList = document.getElementById('paymentsList');
                if (paymentsList) {
                    scrollPositions.payments = paymentsList.scrollTop;
                }
            }

            // Switch tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Update tab button styling
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                if (btn.textContent.toLowerCase() === tabName ||
                    (tabName === 'dashboard' && btn.textContent === 'Dashboard') ||
                    (tabName === 'calendar' && btn.textContent === 'Calendar') ||
                    (tabName === 'payments' && btn.textContent === 'Payments') ||
                    (tabName === 'goals' && btn.textContent === 'Goals') ||
                    (tabName === 'history' && btn.textContent === 'History')) {
                    btn.classList.add('active');
                }
            });

            // Update current tab tracker
            currentActiveTab = tabName;

            // Save to localStorage to persist on page refresh
            localStorage.setItem('paymentTrackerActiveTab', tabName);

            // Render the new tab - Force complete re-render for dashboard
            if (tabName === 'dashboard') {
                console.log(' Switching to Dashboard - forcing full render');
                console.log(' Current data:', data.payments.length, 'payments');
                renderDashboard();
            }
            if (tabName === 'calendar') renderCalendar();
            if (tabName === 'payments') renderPayments();
            if (tabName === 'goals') renderGoals();
            if (tabName === 'history') renderHistory();

            // Restore scroll position if available
            if (tabName === 'payments' && scrollPositions.payments) {
                setTimeout(() => {
                    const paymentsList = document.getElementById('paymentsList');
                    if (paymentsList) {
                        paymentsList.scrollTop = scrollPositions.payments;
                    }
                }, 0);
            }
        }

        // Smart refresh - refreshes all views to ensure data consistency
        function smartRefresh() {
            // Save scroll position before refresh
            if (currentActiveTab === 'payments') {
                const paymentsList = document.getElementById('paymentsList');
                if (paymentsList) {
                    scrollPositions.payments = paymentsList.scrollTop;
                }
            }

            // Always refresh all views to ensure data stays in sync
            renderDashboard();
            renderCalendar();
            renderPayments();
            renderGoals();
            renderHistory();

            // Restore scroll position if on payments tab
            if (currentActiveTab === 'payments') {
                setTimeout(() => {
                    const paymentsList = document.getElementById('paymentsList');
                    if (paymentsList && scrollPositions.payments !== undefined) {
                        paymentsList.scrollTop = scrollPositions.payments;
                    }
                }, 0);
            }

            // Re-setup scrollbar fade for newly rendered lists
            setupScrollbarFade();
        }

        // Financial Goals
        function updateTwoMonthSavings() {
            const input = document.getElementById('twoMonthSavings');
            const value = parseFloat(input.value) || 0;
            if (value < 0) {
                showToast('Savings amount cannot be negative', 'error');
                return;
            }
            data.twoMonthSavings = value;
            saveData();
            renderSavingsGoals();
            input.value = '';
        }

        function updateSixMonthSavings() {
            const input = document.getElementById('sixMonthSavings');
            const value = parseFloat(input.value) || 0;
            if (value < 0) {
                showToast('Savings amount cannot be negative', 'error');
                return;
            }
            data.sixMonthSavings = value;
            saveData();
            renderSavingsGoals();
            input.value = '';
        }

        // Toggle goal expand/collapse
        function toggleGoalExpand(goalId) {
            const el = document.getElementById(goalId);
            if (el) {
                el.classList.toggle('expanded');
            }
        }

        // Fund source management
        function addFundSource(goalType) {
            const typeEl = document.getElementById(`${goalType}FundType`);
            const amountEl = document.getElementById(`${goalType}FundAmount`);

            if (!typeEl || !amountEl) return;

            const fundType = typeEl.value;
            const amount = parseFloat(amountEl.value) || 0;

            if (amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            // Initialize arrays if needed
            if (!data[`${goalType}FundSources`]) {
                data[`${goalType}FundSources`] = [];
            }

            // Check if this fund type already exists
            const existing = data[`${goalType}FundSources`].find(s => s.type === fundType);
            if (existing) {
                existing.amount += amount;
            } else {
                data[`${goalType}FundSources`].push({ type: fundType, amount: amount });
            }

            // Update total savings
            data[`${goalType}Savings`] = data[`${goalType}FundSources`].reduce((sum, s) => sum + s.amount, 0);

            amountEl.value = '';
            saveData();
            renderSavingsGoals();
        }

        function removeFundSource(goalType, fundType) {
            if (!data[`${goalType}FundSources`]) return;

            data[`${goalType}FundSources`] = data[`${goalType}FundSources`].filter(s => s.type !== fundType);
            data[`${goalType}Savings`] = data[`${goalType}FundSources`].reduce((sum, s) => sum + s.amount, 0);

            saveData();
            renderSavingsGoals();
        }

        function renderFundSources(goalType) {
            const sourcesEl = document.getElementById(`${goalType}Sources`);
            const tagsEl = document.getElementById(`${goalType}SourceTags`);

            if (!sourcesEl) return;

            const sources = data[`${goalType}FundSources`] || [];

            if (sources.length === 0) {
                sourcesEl.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; padding: 0.5rem;">No funds added yet</div>';
                if (tagsEl) tagsEl.innerHTML = '';
                return;
            }

            // Render expanded list
            sourcesEl.innerHTML = sources.map(s => `
                <div class="fund-source-item">
                    <span class="fund-source-icon">${fundIcons[s.type] || ''}</span>
                    <span class="fund-source-type">${s.type}</span>
                    <span class="fund-source-amount">$${s.amount.toLocaleString()}</span>
                    <button class="fund-source-remove" onclick="event.stopPropagation(); removeFundSource('${goalType}', '${s.type}')" title="Remove"></button>
                </div>
            `).join('');

            // Render compact tags
            if (tagsEl) {
                tagsEl.innerHTML = sources.map(s => `
                    <span class="goal-compact-source-tag">
                        ${fundIcons[s.type] || ''} ${s.type}: <span class="amount">$${s.amount >= 1000 ? (s.amount/1000).toFixed(1) + 'k' : s.amount.toFixed(0)}</span>
                    </span>
                `).join('');
            }
        }

        function renderSavingsGoals() {
            // Check if DOM elements exist
            if (!document.getElementById('twoMonthCurrent') || !document.getElementById('sixMonthCurrent')) return;

            // Initialize fund sources if needed (migration from old format)
            if (!data.twoMonthFundSources) data.twoMonthFundSources = [];
            if (!data.sixMonthFundSources) data.sixMonthFundSources = [];

            // If old savings exist but no fund sources, migrate
            if (data.twoMonthSavings > 0 && data.twoMonthFundSources.length === 0) {
                data.twoMonthFundSources = [{ type: 'Cash', amount: data.twoMonthSavings }];
            }
            if (data.sixMonthSavings > 0 && data.sixMonthFundSources.length === 0) {
                data.sixMonthFundSources = [{ type: 'Cash', amount: data.sixMonthSavings }];
            }

            // Calculate totals from fund sources
            data.twoMonthSavings = data.twoMonthFundSources.reduce((sum, s) => sum + s.amount, 0);
            data.sixMonthSavings = data.sixMonthFundSources.reduce((sum, s) => sum + s.amount, 0);

            // Calculate actual monthly totals for upcoming months
            const today = new Date();
            const monthlyTotals = {};

            // Group all pending "I Owe" payments by month
            data.payments.forEach(payment => {
                if (payment.type === 'i-owe' && payment.status === 'pending') {
                    const month = payment.dueDate.substring(0, 7);
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);
                    monthlyTotals[month] = (monthlyTotals[month] || 0) + amount;
                }
            });

            // Get upcoming 6 months to calculate average
            const upcomingMonths = [];
            for (let i = 0; i < 6; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                upcomingMonths.push(monthStr);
            }

            // Calculate average from upcoming months
            const upcomingTotals = upcomingMonths.map(month => monthlyTotals[month] || 0);
            const monthsWithPayments = upcomingTotals.filter(total => total > 0);
            const avgMonthlyBills = monthsWithPayments.length > 0
                ? monthsWithPayments.reduce((a, b) => a + b, 0) / monthsWithPayments.length
                : upcomingTotals.reduce((a, b) => a + b, 0) / upcomingTotals.length;

            // 2 Month Goal - Compact Display
            const twoMonthGoal = avgMonthlyBills * 2;
            const twoMonthProgress = twoMonthGoal > 0 ? (data.twoMonthSavings / twoMonthGoal) * 100 : 0;
            const twoMonthCapped = Math.min(twoMonthProgress, 100);

            document.getElementById('twoMonthCurrent').textContent = `$${data.twoMonthSavings.toLocaleString()}`;
            document.getElementById('twoMonthGoal').textContent = `$${twoMonthGoal.toLocaleString(undefined, {maximumFractionDigits: 0})}`;

            const twoMonthPercentEl = document.getElementById('twoMonthPercent');
            const twoMonthFill = document.getElementById('twoMonthFill');
            if (twoMonthPercentEl && twoMonthFill) {
                twoMonthPercentEl.textContent = `${twoMonthCapped.toFixed(0)}%`;
                twoMonthPercentEl.className = 'goal-compact-percent ' +
                    (twoMonthProgress >= 75 ? 'high' : twoMonthProgress >= 40 ? 'medium' : 'low');
                twoMonthFill.style.width = `${twoMonthCapped}%`;
                twoMonthFill.className = 'goal-compact-fill ' +
                    (twoMonthProgress >= 75 ? 'high' : twoMonthProgress >= 40 ? 'medium' : 'low');
            }

            // Render 2-month fund sources
            renderFundSources('twoMonth');

            // 6 Month Goal - Compact Display
            const sixMonthGoal = avgMonthlyBills * 6;
            const sixMonthProgress = sixMonthGoal > 0 ? (data.sixMonthSavings / sixMonthGoal) * 100 : 0;
            const sixMonthCapped = Math.min(sixMonthProgress, 100);

            document.getElementById('sixMonthCurrent').textContent = `$${data.sixMonthSavings.toLocaleString()}`;
            document.getElementById('sixMonthGoal').textContent = `$${sixMonthGoal.toLocaleString(undefined, {maximumFractionDigits: 0})}`;

            const sixMonthPercentEl = document.getElementById('sixMonthPercent');
            const sixMonthFill = document.getElementById('sixMonthFill');
            if (sixMonthPercentEl && sixMonthFill) {
                sixMonthPercentEl.textContent = `${sixMonthCapped.toFixed(0)}%`;
                sixMonthPercentEl.className = 'goal-compact-percent ' +
                    (sixMonthProgress >= 75 ? 'high' : sixMonthProgress >= 40 ? 'medium' : 'low');
                sixMonthFill.style.width = `${sixMonthCapped}%`;
                sixMonthFill.className = 'goal-compact-fill ' +
                    (sixMonthProgress >= 75 ? 'high' : sixMonthProgress >= 40 ? 'medium' : 'low');
            }

            // Render 6-month fund sources
            renderFundSources('sixMonth');
        }

        // Command Center rendering
        function renderCommandCenter() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const in7Days = new Date(today);
            in7Days.setDate(in7Days.getDate() + 7);

            const in30Days = new Date(today);
            in30Days.setDate(in30Days.getDate() + 30);

            // Get pending payments
            const pendingPayments = data.payments.filter(p =>
                p.type === 'i-owe' && p.status === 'pending'
            ).map(p => {
                const dueDate = new Date(p.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const amount = p.isPartialPayment
                    ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                    : parseFloat(p.amount);
                return { ...p, dueDateObj: dueDate, calculatedAmount: amount };
            }).sort((a, b) => a.dueDateObj - b.dueDateObj);

            // Next 7 days
            const next7 = pendingPayments.filter(p => p.dueDateObj >= today && p.dueDateObj <= in7Days);
            const total7 = next7.reduce((sum, p) => sum + p.calculatedAmount, 0);

            const cmd7Total = document.getElementById('cmd7Total');
            const cmd7Count = document.getElementById('cmd7Count');
            const cmd7List = document.getElementById('cmd7List');

            if (cmd7Total) cmd7Total.textContent = `$${formatMoney(total7)}`;
            if (cmd7Count) cmd7Count.textContent = `${next7.length} payment${next7.length !== 1 ? 's' : ''} due`;

            if (cmd7List) {
                if (next7.length > 0) {
                    cmd7List.innerHTML = next7.slice(0, 5).map(p => {
                        const daysUntil = Math.ceil((p.dueDateObj - today) / (1000 * 60 * 60 * 24));
                        let dueClass = '';
                        let dueText = '';
                        if (daysUntil < 0) {
                            dueClass = 'overdue';
                            dueText = `${Math.abs(daysUntil)}d overdue`;
                        } else if (daysUntil === 0) {
                            dueClass = 'today';
                            dueText = 'Today';
                        } else if (daysUntil === 1) {
                            dueText = 'Tomorrow';
                        } else {
                            dueText = `In ${daysUntil}d`;
                        }
                        return `
                            <div class="command-list-item">
                                <div class="command-list-item-left">
                                    <span class="command-list-item-name">${p.description}</span>
                                    <span class="command-list-item-due ${dueClass}">${dueText}</span>
                                </div>
                                <span class="command-list-item-amount">$${formatMoney(p.calculatedAmount)}</span>
                            </div>
                        `;
                    }).join('');
                    if (next7.length > 5) {
                        cmd7List.innerHTML += `<div class="command-list-item" style="justify-content: center; color: var(--text-secondary);">+${next7.length - 5} more</div>`;
                    }
                } else {
                    cmd7List.innerHTML = '<div class="command-list-empty"> All clear for the next 7 days!</div>';
                }
            }

            // Next 30 days (excluding first 7)
            const next30 = pendingPayments.filter(p => p.dueDateObj > in7Days && p.dueDateObj <= in30Days);
            const total30 = next30.reduce((sum, p) => sum + p.calculatedAmount, 0);

            const cmd30Total = document.getElementById('cmd30Total');
            const cmd30Count = document.getElementById('cmd30Count');
            const cmd30List = document.getElementById('cmd30List');

            if (cmd30Total) cmd30Total.textContent = `$${formatMoney(total30)}`;
            if (cmd30Count) cmd30Count.textContent = `${next30.length} payment${next30.length !== 1 ? 's' : ''} due`;

            if (cmd30List) {
                if (next30.length > 0) {
                    cmd30List.innerHTML = next30.slice(0, 5).map(p => {
                        const daysUntil = Math.ceil((p.dueDateObj - today) / (1000 * 60 * 60 * 24));
                        return `
                            <div class="command-list-item">
                                <div class="command-list-item-left">
                                    <span class="command-list-item-name">${p.description}</span>
                                    <span class="command-list-item-due">In ${daysUntil}d</span>
                                </div>
                                <span class="command-list-item-amount">$${formatMoney(p.calculatedAmount)}</span>
                            </div>
                        `;
                    }).join('');
                    if (next30.length > 5) {
                        cmd30List.innerHTML += `<div class="command-list-item" style="justify-content: center; color: var(--text-secondary);">+${next30.length - 5} more</div>`;
                    }
                } else {
                    cmd30List.innerHTML = '<div class="command-list-empty">No payments in days 8-30</div>';
                }
            }
        }

        // Hero Status Card - Combined Greeting & Alerts
        function renderHeroStatus() {
            const container = document.getElementById('heroStatusCard');
            if (!container) return;

            // Get time-based greeting
            const hour = new Date().getHours();
            let greeting, icon;
            if (hour < 12) {
                greeting = 'Good Morning';
                icon = '';
            } else if (hour < 17) {
                greeting = 'Good Afternoon';
                icon = '';
            } else {
                greeting = 'Good Evening';
                icon = '';
            }

            // Calculate due today, overdue counts and amounts
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            let dueTodayCount = 0;
            let dueTodayTotal = 0;
            let overdueCount = 0;
            let overdueTotal = 0;
            let alertItems = [];

            // Process payments
            data.payments.forEach(p => {
                if (p.status === 'paid') return;
                const dueDate = new Date(p.dueDate + 'T00:00:00');
                dueDate.setHours(0, 0, 0, 0);
                const amount = parseFloat(p.amount) || 0;

                if (p.dueDate === todayStr) {
                    dueTodayCount++;
                    dueTodayTotal += amount;
                    alertItems.push({
                        name: p.description,
                        amount: amount,
                        daysOverdue: 0,
                        type: 'due-today'
                    });
                } else if (dueDate < today) {
                    overdueCount++;
                    overdueTotal += amount;
                    alertItems.push({
                        name: p.description,
                        amount: amount,
                        daysOverdue: Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)),
                        type: 'overdue'
                    });
                }
            });

            // Process emergency expenses
            if (data.emergencyExpenses) {
                data.emergencyExpenses.forEach(expense => {
                    if (expense.status === 'paid' || !expense.date) return;
                    const expenseDate = new Date(expense.date + 'T00:00:00');
                    expenseDate.setHours(0, 0, 0, 0);
                    const amount = parseFloat(expense.amount) || 0;

                    if (expense.date === todayStr) {
                        dueTodayCount++;
                        dueTodayTotal += amount;
                        alertItems.push({
                            name: expense.description + ' ',
                            amount: amount,
                            daysOverdue: 0,
                            type: 'due-today'
                        });
                    } else if (expenseDate < today) {
                        overdueCount++;
                        overdueTotal += amount;
                        alertItems.push({
                            name: expense.description + ' ',
                            amount: amount,
                            daysOverdue: Math.floor((today - expenseDate) / (1000 * 60 * 60 * 24)),
                            type: 'overdue'
                        });
                    }
                });
            }

            // Sort items: overdue first (by days), then due today
            alertItems.sort((a, b) => {
                if (a.type === 'overdue' && b.type !== 'overdue') return -1;
                if (a.type !== 'overdue' && b.type === 'overdue') return 1;
                return b.daysOverdue - a.daysOverdue;
            });

            const totalNeedsAttention = overdueCount + dueTodayCount;
            const totalAmount = overdueTotal + dueTodayTotal;
            const hasAlerts = totalNeedsAttention > 0;

            // Build stat badges
            let statBadgesHtml = '';
            if (overdueCount > 0) {
                statBadgesHtml += `
                    <div class="hero-stat-badge overdue" onclick="switchTab('payments')">
                        <span class="hero-stat-number">${overdueCount}</span>
                        <span class="hero-stat-label">overdue</span>
                    </div>
                `;
            }
            if (dueTodayCount > 0) {
                statBadgesHtml += `
                    <div class="hero-stat-badge due-today" onclick="switchTab('payments')">
                        <span class="hero-stat-number">${dueTodayCount}</span>
                        <span class="hero-stat-label">due today</span>
                    </div>
                `;
            }
            if (!hasAlerts) {
                statBadgesHtml = `
                    <div class="hero-stat-badge all-clear">
                        <span></span>
                        <span class="hero-stat-label">All caught up!</span>
                    </div>
                `;
            }

            // Build alert items list (show top 4)
            let alertsHtml = '';
            if (hasAlerts) {
                const topItems = alertItems.slice(0, 4);
                const itemsHtml = topItems.map(item => `
                    <div class="hero-alert-item">
                        <span class="hero-alert-item-name">${item.name}</span>
                        <span class="hero-alert-item-badge ${item.type}">${item.daysOverdue === 0 ? 'Due today' : item.daysOverdue + 'd overdue'}</span>
                        <span class="hero-alert-item-amount">$${formatMoney(item.amount)}</span>
                    </div>
                `).join('');

                alertsHtml = `
                    <div class="hero-alerts">
                        <div class="hero-alert-header">
                            <span class="hero-alert-title"> ${totalNeedsAttention} payment${totalNeedsAttention !== 1 ? 's' : ''} need attention</span>
                            <span class="hero-alert-total">$${formatMoney(totalAmount)}</span>
                        </div>
                        <div class="hero-alert-list">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }

            // Greeting subtext
            const subText = hasAlerts
                ? `You have ${totalNeedsAttention} payment${totalNeedsAttention !== 1 ? 's' : ''} needing attention`
                : `You're all caught up on payments`;

            container.className = `hero-status-card${hasAlerts ? ' has-alerts' : ''}`;
            container.innerHTML = `
                <div class="hero-main">
                    <div class="hero-left">
                        <div class="hero-icon">${icon}</div>
                        <div class="hero-greeting">
                            <span class="hero-greeting-text">${greeting}, Kevin</span>
                            <span class="hero-greeting-sub">${subText}</span>
                        </div>
                    </div>
                    <div class="hero-stats">
                        ${statBadgesHtml}
                    </div>
                </div>
                ${alertsHtml}
            `;
        }

        // Dashboard
        function renderDashboard() {
            renderHeroStatus();
            renderCommandCenter();
            renderSavingsGoals();
            renderStats();
            renderInsightsDashboard();  // v2.0 Phase 3C
            renderChartsDashboard();    // v2.0 Phase 3A/3B
            renderEmergencyExpenses();
            renderHeatmap();
            renderUpcoming();
            renderTopPersons();
            renderCashflowDashboard();  // v2.0 Phase 3D
        }

        // v2.0: Inject insights strip into dashboard
        function renderInsightsDashboard() {
            let strip = document.getElementById('insightsStrip');
            if (!strip) {
                // Create insights container if not in HTML
                const statsGrid = document.querySelector('#dashboard .stats-grid');
                if (statsGrid) {
                    const container = document.createElement('div');
                    container.id = 'insightsStrip';
                    container.className = 'insights-strip';
                    statsGrid.parentNode.insertBefore(container, statsGrid.nextSibling);
                    strip = container;
                }
            }
            if (strip) renderInsights();
        }

        // v2.0: Inject charts into dashboard
        function renderChartsDashboard() {
            let chartsSection = document.getElementById('chartsSection');
            if (!chartsSection) {
                const insightsStrip = document.getElementById('insightsStrip');
                const insertAfter = insightsStrip || document.querySelector('#dashboard .stats-grid');
                if (insertAfter) {
                    chartsSection = document.createElement('div');
                    chartsSection.id = 'chartsSection';
                    chartsSection.className = 'charts-section';
                    chartsSection.innerHTML = `
                        <div class="chart-card">
                            <h3> Monthly Spend Trend</h3>
                            <div class="chart-canvas-container">
                                <canvas id="trendChartCanvas"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3> Category Breakdown</h3>
                            <div class="chart-canvas-container">
                                <canvas id="donutChartCanvas"></canvas>
                            </div>
                        </div>`;
                    insertAfter.parentNode.insertBefore(chartsSection, insertAfter.nextSibling);
                }
            }
            renderCharts();
        }

        // v2.0: Inject cashflow projection into dashboard
        function renderCashflowDashboard() {
            let cashflowSection = document.getElementById('cashflowSection');
            if (!cashflowSection) {
                const topPersons = document.querySelector('#dashboard .upcoming-section');
                const insertAfter = topPersons || document.querySelector('#dashboard .charts-section');
                if (insertAfter) {
                    cashflowSection = document.createElement('div');
                    cashflowSection.id = 'cashflowSection';
                    cashflowSection.className = 'cashflow-section';
                    cashflowSection.innerHTML = `
                        <div class="cashflow-toggle" onclick="toggleCashflow()">
                            <h3> Cash Flow Projection (3 Months)</h3>
                            <span style="color:var(--text-muted);"></span>
                        </div>
                        <div class="cashflow-body" id="cashflowBody">
                            <div class="chart-canvas-container">
                                <canvas id="cashflowChartCanvas"></canvas>
                            </div>
                        </div>`;
                    insertAfter.parentNode.insertBefore(cashflowSection, insertAfter.nextSibling);
                }
            }
        }

        // Legacy function - now handled by renderHeroStatus
        function renderOverdueAlert(total, count, items) {
            // No longer needed - Hero Status Card handles this
        }

        function renderStats() {
            const thisMonthTotalEl = document.getElementById('thisMonthTotal');
            const paidThisMonthEl = document.getElementById('paidThisMonth');
            const paidProgressEl = document.getElementById('paidProgress');
            const remainingThisMonthEl = document.getElementById('remainingThisMonth');
            const nextMonthTotalEl = document.getElementById('nextMonthTotal');

            if (!thisMonthTotalEl || !paidThisMonthEl || !paidProgressEl ||
                !remainingThisMonthEl || !nextMonthTotalEl) return;

            // Ensure data.payments exists
            if (!data || !data.payments || !Array.isArray(data.payments)) {
                console.error('Data not loaded properly:', data);
                return;
            }

            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const nextMonthStr = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;

            let thisMonthTotal = 0;
            let paidThisMonth = 0;
            let nextMonthTotal = 0;
            let thisMonthCount = 0;
            let paidCount = 0;
            let pendingCount = 0;
            let nextMonthCount = 0;
            let nextMonthEmergencyTotal = 0;
            let thisMonthEmergencyTotal = 0;
            let thisMonthEmergencyPaid = 0;
            let overdueTotal = 0;
            let overdueCount = 0;
            let overdueItems = [];

            data.payments.forEach(payment => {
                if (payment.type === 'i-owe') {
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    const paymentMonth = payment.dueDate.substring(0, 7);
                    const dueDate = new Date(payment.dueDate + 'T00:00:00');

                    // Check for overdue (past due date and still pending)
                    if (payment.status === 'pending' && dueDate < today) {
                        overdueTotal += amount;
                        overdueCount++;
                        overdueItems.push({
                            name: payment.description,
                            amount: amount,
                            daysOverdue: Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))
                        });
                    }

                    // This month calculations
                    if (paymentMonth === currentMonth) {
                        thisMonthCount++;
                        if (payment.status === 'pending') {
                            thisMonthTotal += amount;
                            pendingCount++;
                        } else if (payment.status === 'paid') {
                            thisMonthTotal += parseFloat(payment.amount);
                            paidThisMonth += parseFloat(payment.amount);
                            paidCount++;
                        }
                    }

                    // Next month calculations
                    if (paymentMonth === nextMonthStr && payment.status === 'pending') {
                        nextMonthTotal += amount;
                        nextMonthCount++;
                    }
                }
            });

            // Calculate emergency expenses for THIS month and NEXT month
            if (data.emergencyExpenses && data.emergencyExpenses.length > 0) {
                data.emergencyExpenses.forEach(expense => {
                    if (expense.date) {
                        const expenseMonth = expense.date.substring(0, 7);
                        const expenseDate = new Date(expense.date + 'T00:00:00');
                        const expenseAmount = parseFloat(expense.amount) || 0;

                        // Check for overdue emergency expenses
                        if (expense.status === 'pending' && expenseDate < today) {
                            overdueTotal += expenseAmount;
                            overdueCount++;
                            overdueItems.push({
                                name: expense.description + ' (Emergency)',
                                amount: expenseAmount,
                                daysOverdue: Math.floor((today - expenseDate) / (1000 * 60 * 60 * 24))
                            });
                        }

                        // This month emergency expenses
                        if (expenseMonth === currentMonth) {
                            if (expense.status === 'pending') {
                                thisMonthEmergencyTotal += expenseAmount;
                            } else if (expense.status === 'paid') {
                                thisMonthEmergencyPaid += expenseAmount;
                            }
                        }

                        // Next month emergency expenses (pending only)
                        if (expenseMonth === nextMonthStr && expense.status === 'pending') {
                            nextMonthEmergencyTotal += expenseAmount;
                        }
                    }
                });
            }

            // Add emergency expenses to totals
            thisMonthTotal += thisMonthEmergencyTotal + thisMonthEmergencyPaid;
            paidThisMonth += thisMonthEmergencyPaid;
            const nextMonthCombinedTotal = nextMonthTotal + nextMonthEmergencyTotal;

            // Render overdue alert
            renderOverdueAlert(overdueTotal, overdueCount, overdueItems);

            const remaining = Math.max(0, thisMonthTotal - paidThisMonth);
            const progressPercent = thisMonthTotal > 0 ? (paidThisMonth / thisMonthTotal * 100) : 0;
            const remainingPercent = thisMonthTotal > 0 ? (remaining / thisMonthTotal * 100) : 0;

            // Update values with formatMoney
            thisMonthTotalEl.textContent = `$${formatMoney(thisMonthTotal)}`;
            paidThisMonthEl.textContent = `$${formatMoney(paidThisMonth)}`;
            remainingThisMonthEl.textContent = `$${formatMoney(remaining)}`;
            nextMonthTotalEl.textContent = `$${formatMoney(nextMonthCombinedTotal)}`;

            // Update emergency expenses note
            const emergencyNoteEl = document.getElementById('nextMonthEmergencyNote');
            const emergencyAmountEl = document.getElementById('nextMonthEmergencyAmount');
            if (emergencyNoteEl && emergencyAmountEl) {
                if (nextMonthEmergencyTotal > 0) {
                    emergencyNoteEl.style.display = 'flex';
                    emergencyAmountEl.textContent = `$${formatMoney(nextMonthEmergencyTotal)}`;
                } else {
                    emergencyNoteEl.style.display = 'none';
                }
            }

            // Update progress text
            paidProgressEl.textContent = `${progressPercent.toFixed(0)}%`;

            // Update counts
            const thisMonthCountEl = document.getElementById('thisMonthCount');
            const paidCountEl = document.getElementById('paidCount');
            const remainingCountEl = document.getElementById('remainingCount');
            const nextMonthCountEl = document.getElementById('nextMonthCount');

            if (thisMonthCountEl) thisMonthCountEl.textContent = `${thisMonthCount} payment${thisMonthCount !== 1 ? 's' : ''}`;
            if (paidCountEl) paidCountEl.textContent = `${paidCount} of ${thisMonthCount}`;
            if (remainingCountEl) remainingCountEl.textContent = `${pendingCount} pending`;
            if (nextMonthCountEl) nextMonthCountEl.textContent = `${nextMonthCount} payment${nextMonthCount !== 1 ? 's' : ''}`;

            // Update ring progress indicators
            const circumference = 2 * Math.PI * 30; // r=30 for the stat rings

            // This Month ring - always full
            const thisMonthRing = document.getElementById('thisMonthRing');
            if (thisMonthRing) {
                thisMonthRing.style.strokeDasharray = circumference;
                thisMonthRing.style.strokeDashoffset = 0; // Full ring
            }

            // Paid ring - based on progress
            const paidRing = document.getElementById('paidRing');
            if (paidRing) {
                paidRing.style.strokeDasharray = circumference;
                const paidOffset = circumference - (progressPercent / 100) * circumference;
                paidRing.style.strokeDashoffset = paidOffset;
            }

            // Remaining ring - based on remaining percent
            const remainingRing = document.getElementById('remainingRing');
            if (remainingRing) {
                remainingRing.style.strokeDasharray = circumference;
                const remainingOffset = circumference - (remainingPercent / 100) * circumference;
                remainingRing.style.strokeDashoffset = remainingOffset;
            }

            // Next Month ring - compare to this month (includes emergency expenses)
            const nextMonthRing = document.getElementById('nextMonthRing');
            if (nextMonthRing) {
                const nextMonthPercent = thisMonthTotal > 0 ? Math.min(100, (nextMonthCombinedTotal / thisMonthTotal * 100)) : 0;
                nextMonthRing.style.strokeDasharray = circumference;
                const nextMonthOffset = circumference - (nextMonthPercent / 100) * circumference;
                nextMonthRing.style.strokeDashoffset = nextMonthOffset;
            }

            // Update remaining card style based on status (now using ring card)
            const remainingCard = remainingThisMonthEl.closest('.stat-ring-card');
            if (remainingCard && remaining === 0 && thisMonthTotal > 0) {
                // All paid - show success state
                remainingCard.classList.remove('amber');
                remainingCard.classList.add('green');
            }
        }

        function renderEmergencyExpenses() {
            const totalEl = document.getElementById('emergencyTotal');
            const paidEl = document.getElementById('emergencyPaid');
            const unpaidEl = document.getElementById('emergencyUnpaid');
            const ringProgress = document.getElementById('emergencyRingProgress');
            const ringPercent = document.getElementById('emergencyRingPercent');
            const breakdownEl = document.getElementById('emergencyBreakdown');
            const listEl = document.getElementById('emergencyList');

            // Null check
            if (!totalEl || !paidEl || !unpaidEl || !breakdownEl || !listEl) return;

            // Get date range based on selected time period
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            let startDate, endDate;

            if (emergencyTimePeriod === 'this-month') {
                startDate = new Date(currentYear, currentMonth, 1);
                endDate = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);
            } else if (emergencyTimePeriod === 'next-month') {
                startDate = new Date(currentYear, currentMonth + 1, 1);
                endDate = new Date(currentYear, currentMonth + 2, 0, 23, 59, 59);
            } else if (emergencyTimePeriod === '3-months') {
                startDate = new Date(currentYear, currentMonth, 1);
                endDate = new Date(currentYear, currentMonth + 3, 0, 23, 59, 59);
            }

            // Filter expenses by date range
            const filteredExpenses = data.emergencyExpenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });

            // Calculate totals from filtered expenses
            let total = 0;
            let paid = 0;
            let unpaid = 0;

            filteredExpenses.forEach(e => {
                const amount = parseFloat(e.amount);
                total += amount;

                // Default to 'pending' if no status
                if (!e.status) e.status = 'pending';

                if (e.status === 'paid') {
                    paid += amount;
                } else {
                    unpaid += amount;
                }
            });

            totalEl.textContent = `$${formatMoney(total, 0)}`;
            paidEl.textContent = `$${formatMoney(paid, 0)}`;
            unpaidEl.textContent = `$${formatMoney(unpaid, 0)}`;

            // Update ring progress
            const paidPercent = total > 0 ? Math.round((paid / total) * 100) : 0;
            const circumference = 2 * Math.PI * 60; // 2r where r=60
            const offset = circumference - (paidPercent / 100) * circumference;

            if (ringProgress) {
                ringProgress.style.strokeDasharray = circumference;
                ringProgress.style.strokeDashoffset = offset;
            }
            if (ringPercent) {
                ringPercent.textContent = `${paidPercent}%`;
            }

            // Calculate category breakdown - include all categories (from filtered expenses)
            const categoryTotals = {
                medical: 0,
                car: 0,
                home: 0,
                appliance: 0,
                pet: 0,
                travel: 0,
                legal: 0,
                other: 0
            };

            filteredExpenses.forEach(e => {
                const category = e.category || 'other';
                if (categoryTotals.hasOwnProperty(category)) {
                    categoryTotals[category] += parseFloat(e.amount) || 0;
                } else {
                    categoryTotals.other += parseFloat(e.amount) || 0;
                }
            });

            // Category config - include all categories
            const categoryConfig = {
                medical: { icon: '', label: 'Medical' },
                car: { icon: '', label: 'Vehicle' },
                home: { icon: '', label: 'Home' },
                appliance: { icon: '', label: 'Appliance' },
                pet: { icon: '', label: 'Pet' },
                travel: { icon: '', label: 'Travel' },
                legal: { icon: '', label: 'Legal' },
                other: { icon: '', label: 'Other' }
            };

            // Render category breakdown cards with progress bars (only show categories with amounts > 0)
            const nonZeroCategories = Object.entries(categoryTotals).filter(([_, amount]) => amount > 0);
            const maxCategoryAmount = Math.max(...nonZeroCategories.map(([_, amt]) => amt), 1);

            if (nonZeroCategories.length === 0) {
                breakdownEl.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.25); font-size: 0.8rem; padding: 1.5rem 1rem;"></div>';
            } else {
                breakdownEl.innerHTML = nonZeroCategories
                    .sort((a, b) => b[1] - a[1]) // Sort by amount descending
                    .map(([category, amount]) => {
                        const config = categoryConfig[category] || categoryConfig.other;
                        const barWidth = (amount / maxCategoryAmount) * 100;
                        return `
                            <div class="emergency-category-card">
                                <div class="emergency-category-icon">${config.icon}</div>
                                <div class="emergency-category-label">${config.label}</div>
                                <div class="emergency-category-amount">$${formatMoney(amount, 0)}</div>
                                <div class="emergency-category-bar">
                                    <div class="emergency-category-fill ${category}" style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            // Separate pending and paid expenses
            const pendingExpenses = filteredExpenses
                .filter(e => e.status !== 'paid')
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Paid expenses: always show last 3 months (looking backwards)
            const threeMonthsAgo = new Date(currentYear, currentMonth - 2, 1);
            const paidExpenses = data.emergencyExpenses
                .filter(e => {
                    if (e.status !== 'paid') return false;
                    const expenseDate = new Date(e.date);
                    return expenseDate >= threeMonthsAgo;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Get period label for empty state
            const periodLabels = {
                'this-month': 'this month',
                'next-month': 'next month',
                '3-months': 'these 3 months'
            };
            const periodLabel = periodLabels[emergencyTimePeriod] || 'this period';

            // Render pending expenses (main list)
            if (pendingExpenses.length === 0) {
                listEl.innerHTML = `
                    <div class="emergency-empty" style="padding: 2rem 1rem;">
                        <div style="color: rgba(255,255,255,0.35); font-size: 0.85rem;">No pending expenses for ${periodLabel}</div>
                    </div>
                `;
            } else {
                listEl.innerHTML = pendingExpenses.slice(0, 15).map(expense => {
                    const date = new Date(expense.date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });

                    const config = categoryConfig[expense.category] || categoryConfig.other;
                    const categoryClass = expense.category || 'other';

                    return `
                        <div class="emergency-item">
                            <div class="emergency-item-status pending"></div>
                            <div class="emergency-item-left">
                                <div class="emergency-item-title">${expense.description}</div>
                                <div class="emergency-item-meta">
                                    <span>${formattedDate}</span>
                                    <span class="emergency-item-category ${categoryClass}">
                                        ${config.icon} ${config.label}
                                    </span>
                                </div>
                                ${expense.notes ? `<div class="emergency-item-notes">${expense.notes}</div>` : ''}
                            </div>
                            <div class="emergency-item-right">
                                <div class="emergency-item-amount">$${formatMoney(expense.amount)}</div>
                                <div class="emergency-item-actions">
                                    <button class="emergency-action-btn" onclick="toggleEmergencyStatus(${expense.id})" title="Mark Paid"></button>
                                    <button class="emergency-action-btn" onclick="editEmergencyExpense(${expense.id})" title="Edit"></button>
                                    <button class="emergency-action-btn delete" onclick="deleteEmergencyExpense(${expense.id})" title="Delete"></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render paid expenses section
            const paidSectionEl = document.getElementById('emergencyPaidSection');
            if (paidSectionEl) {
                if (paidExpenses.length === 0) {
                    paidSectionEl.innerHTML = '';
                } else {
                    paidSectionEl.innerHTML = `
                        <div class="emergency-paid-section">
                            <div class="emergency-paid-header">
                                <div class="emergency-paid-title">
                                    <span></span> Paid <span style="font-weight: 400; opacity: 0.6;"> Last 3 Months</span>
                                </div>
                                <div class="emergency-paid-count">${paidExpenses.length} expense${paidExpenses.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="emergency-paid-list">
                                ${paidExpenses.slice(0, 10).map(expense => {
                                    const date = new Date(expense.date);
                                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    const config = categoryConfig[expense.category] || categoryConfig.other;

                                    return `
                                        <div class="emergency-paid-item">
                                            <div class="emergency-paid-item-left">
                                                <span class="emergency-paid-check"></span>
                                                <span class="emergency-paid-desc">${expense.description}</span>
                                                <span class="emergency-paid-meta">${config.icon} ${formattedDate}</span>
                                            </div>
                                            <span class="emergency-paid-amount">$${formatMoney(expense.amount)}</span>
                                            <div class="emergency-paid-actions">
                                                <button class="emergency-paid-action-btn" onclick="toggleEmergencyStatus(${expense.id})" title="Mark Unpaid"></button>
                                                <button class="emergency-paid-action-btn" onclick="deleteEmergencyExpense(${expense.id})" title="Delete"></button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${paidExpenses.length > 10 ? `<div style="text-align: center; color: rgba(255,255,255,0.3); font-size: 0.75rem; padding: 0.5rem;">+${paidExpenses.length - 10} more paid</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function renderWeekSummary() {
            const weekDatesEl = document.getElementById('weekDates');
            const weekTotalEl = document.getElementById('weekTotal');
            const weekPaidEl = document.getElementById('weekPaid');
            const weekRemainingEl = document.getElementById('weekRemaining');
            const weekComparisonEl = document.getElementById('weekComparison');
            const weekPaymentsListEl = document.getElementById('weekPaymentsList');

            if (!weekDatesEl || !weekTotalEl || !weekPaidEl || !weekRemainingEl || !weekComparisonEl || !weekPaymentsListEl) return;

            // Get current week's date range (Sunday to Saturday)
            const today = new Date();
            const currentDay = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - currentDay);
            weekStart.setHours(0, 0, 0, 0);

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            // Last week for comparison
            const lastWeekStart = new Date(weekStart);
            lastWeekStart.setDate(weekStart.getDate() - 7);
            const lastWeekEnd = new Date(weekEnd);
            lastWeekEnd.setDate(weekEnd.getDate() - 7);

            // Format dates for display
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            weekDatesEl.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;

            // Calculate this week's totals
            let thisWeekTotal = 0;
            let thisWeekPaid = 0;
            let lastWeekTotal = 0;
            const thisWeekPayments = [];

            data.payments.forEach(payment => {
                if (payment.type === 'i-owe') {
                    const paymentDate = new Date(payment.dueDate + 'T00:00:00');
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    // This week
                    if (paymentDate >= weekStart && paymentDate <= weekEnd) {
                        thisWeekPayments.push(payment);
                        if (payment.status === 'pending') {
                            thisWeekTotal += amount;
                        } else if (payment.status === 'paid') {
                            thisWeekTotal += parseFloat(payment.amount);
                            thisWeekPaid += parseFloat(payment.amount);
                        }
                    }

                    // Last week (for comparison)
                    if (paymentDate >= lastWeekStart && paymentDate <= lastWeekEnd) {
                        lastWeekTotal += parseFloat(payment.amount);
                    }
                }
            });

            const thisWeekRemaining = thisWeekTotal - thisWeekPaid;

            // Display totals
            weekTotalEl.textContent = `$${formatMoney(thisWeekTotal)}`;
            weekPaidEl.textContent = `$${formatMoney(thisWeekPaid)}`;
            weekRemainingEl.textContent = `$${formatMoney(thisWeekRemaining)}`;

            // Comparison with last week
            if (lastWeekTotal > 0) {
                const change = ((thisWeekTotal - lastWeekTotal) / lastWeekTotal) * 100;
                const arrow = change > 0 ? '' : '';
                const color = change < 0 ? 'var(--success)' : 'var(--danger)';
                weekComparisonEl.innerHTML = `<span style="color: ${color};">${arrow} ${Math.abs(change).toFixed(0)}%</span>`;
            } else {
                weekComparisonEl.textContent = 'N/A';
            }

            // Render this week's payments
            if (thisWeekPayments.length === 0) {
                weekPaymentsListEl.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">No payments due this week</div>';
            } else {
                const todayStr = today.toISOString().split('T')[0];
                thisWeekPayments.sort((a, b) => a.dueDate.localeCompare(b.dueDate));

                weekPaymentsListEl.innerHTML = thisWeekPayments.map(payment => {
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    const paymentDate = new Date(payment.dueDate);
                    const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][paymentDate.getDay()];

                    let itemClass = 'week-payment-item';
                    if (payment.status === 'paid') itemClass += ' paid';
                    else if (payment.dueDate < todayStr) itemClass += ' overdue';
                    else if (payment.dueDate === todayStr) itemClass += ' today';

                    return `
                        <div class="${itemClass}" onclick="editPayment(${payment.id})">
                            <div class="week-payment-info">
                                <div class="week-payment-description">${payment.description}</div>
                                <div class="week-payment-meta">${dayName}, ${paymentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}  ${payment.person}</div>
                            </div>
                            <div class="week-payment-amount">$${formatMoney(amount)}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Heatmap navigation functions
        function heatmapPrevMonth() {
            heatmapDate.setMonth(heatmapDate.getMonth() - 1);
            renderHeatmap();
        }

        function heatmapNextMonth() {
            heatmapDate.setMonth(heatmapDate.getMonth() + 1);
            renderHeatmap();
        }

        function openHeatmapDrawer(dateStr, dayPayments, total) {
            const overlay = document.getElementById('heatmapDrawerOverlay');
            const drawer = document.getElementById('heatmapDrawer');
            const title = document.getElementById('heatmapDrawerTitle');
            const body = document.getElementById('heatmapDrawerBody');

            // Get emergency expenses for this date
            const dayEmergencies = (data.emergencyExpenses || []).filter(e => e.date === dateStr);

            const date = new Date(dateStr);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            title.textContent = `Payments for ${monthNames[date.getMonth()]} ${date.getDate()}`;

            let html = '';
            const totalItems = dayPayments.length + dayEmergencies.length;

            if (totalItems > 0) {
                // Calculate pending total (including emergency expenses)
                let pendingTotal = 0;
                dayPayments.forEach(p => {
                    if (p.status === 'pending') {
                        const amt = p.isPartialPayment
                            ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                            : parseFloat(p.amount);
                        pendingTotal += amt;
                    }
                });
                dayEmergencies.forEach(e => {
                    if (e.status !== 'paid') {
                        pendingTotal += parseFloat(e.amount || 0);
                    }
                });

                // Calculate total including emergencies
                const emergencyTotal = dayEmergencies.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                const combinedTotal = total + emergencyTotal;

                html += `
                    <div class="heatmap-drawer-total">
                        <div class="heatmap-drawer-total-amount">$${formatMoney(combinedTotal)}</div>
                        <div class="heatmap-drawer-total-label">${totalItems} item${totalItems > 1 ? 's' : ''}${pendingTotal > 0 ? `  $${formatMoney(pendingTotal)} pending` : ''}${dayEmergencies.length > 0 ? ' ' : ''}</div>
                    </div>
                `;

                // Render regular payments
                dayPayments.forEach(p => {
                    const amount = p.isPartialPayment
                        ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                        : parseFloat(p.amount);
                    const isPaid = p.status === 'paid';

                    html += `
                        <div class="drawer-payment-item ${isPaid ? 'is-paid' : ''}" id="drawer-payment-${p.id}">
                            <div class="drawer-payment-header">
                                <div class="drawer-payment-title">
                                    ${p.isFlagged ? ' ' : ''}${p.isRecurring ? ' ' : ''}${p.description}
                                </div>
                                <div class="drawer-payment-amount ${isPaid ? 'paid' : 'pending'}">
                                    $${formatMoney(amount)}
                                </div>
                            </div>
                            <div class="drawer-payment-meta">
                                <span> ${p.person}</span>
                                <span>${p.category || 'Other'}</span>
                                ${p.isPartialPayment ? `<span style="color: rgba(255,255,255,0.5);">$${formatMoney(p.amountPaid)} of $${formatMoney(p.totalAmount)} paid</span>` : ''}
                            </div>
                            <div class="drawer-payment-actions">
                                ${isPaid ? `
                                    <button class="drawer-action-btn danger" onclick="drawerMarkUnpaid(${p.id}, '${dateStr}')">Mark Unpaid</button>
                                    <button class="drawer-action-btn secondary" onclick="editPayment(${p.id}); closeHeatmapDrawer();">Edit</button>
                                ` : `
                                    <button class="drawer-action-btn primary" onclick="drawerMarkPaid(${p.id}, '${dateStr}')">Mark Paid</button>
                                    <button class="drawer-action-btn secondary" onclick="drawerTogglePartial(${p.id})">Partial</button>
                                    <button class="drawer-action-btn secondary" onclick="editPayment(${p.id}); closeHeatmapDrawer();">Edit</button>
                                `}
                            </div>
                            <div class="drawer-partial-input" id="drawer-partial-${p.id}" style="display: none;">
                                <input type="number" id="drawer-partial-amount-${p.id}" placeholder="Amount paid" step="0.01" min="0.01" max="${amount}">
                                <button class="drawer-action-btn primary" onclick="drawerMarkPartial(${p.id}, ${amount}, '${dateStr}')">Apply</button>
                                <button class="drawer-action-btn secondary" onclick="drawerTogglePartial(${p.id})">Cancel</button>
                            </div>
                        </div>
                    `;
                });

                // Render emergency expenses
                if (dayEmergencies.length > 0) {
                    if (dayPayments.length > 0) {
                        html += `<div class="drawer-section-divider"><span> Emergency Expenses</span></div>`;
                    }

                    const categoryIcons = { medical: '', car: '', home: '', appliance: '', pet: '', travel: '', legal: '', other: '' };
                    const categoryNames = { medical: 'Medical', car: 'Car/Vehicle', home: 'Home Repair', appliance: 'Appliance', pet: 'Pet', travel: 'Travel', legal: 'Legal', other: 'Other' };

                    dayEmergencies.forEach(e => {
                        const amount = parseFloat(e.amount || 0);
                        const isPaid = e.status === 'paid';
                        const categoryIcon = categoryIcons[e.category] || '';
                        const categoryName = categoryNames[e.category] || 'Emergency';

                        html += `
                            <div class="drawer-payment-item emergency-item ${isPaid ? 'is-paid' : ''}">
                                <div class="drawer-payment-header">
                                    <div class="drawer-payment-title emergency">
                                        ${categoryIcon} ${e.description}
                                    </div>
                                    <div class="drawer-payment-amount emergency ${isPaid ? 'paid' : 'pending'}">
                                        $${formatMoney(amount)}
                                    </div>
                                </div>
                                <div class="drawer-payment-meta">
                                    <span> ${categoryName}</span>
                                </div>
                                <div class="drawer-payment-actions">
                                    ${isPaid ? `
                                        <button class="drawer-action-btn danger" onclick="quickMarkEmergencyUnpaid('${e.id}'); refreshHeatmapDrawer('${dateStr}');">Mark Unpaid</button>
                                        <button class="drawer-action-btn secondary" onclick="editEmergencyExpense('${e.id}'); closeHeatmapDrawer();">Edit</button>
                                    ` : `
                                        <button class="drawer-action-btn primary" onclick="quickMarkEmergencyPaid('${e.id}'); refreshHeatmapDrawer('${dateStr}');">Mark Paid</button>
                                        <button class="drawer-action-btn secondary" onclick="heatmapToggleEmergencyPartial('${e.id}')">Partial</button>
                                        <button class="drawer-action-btn secondary" onclick="editEmergencyExpense('${e.id}'); closeHeatmapDrawer();">Edit</button>
                                    `}
                                </div>
                                <div class="drawer-partial-input" id="heatmap-emergency-partial-${e.id}" style="display: none;">
                                    <input type="number" id="heatmap-emergency-partial-amount-${e.id}" placeholder="Amount paid" step="0.01" min="0.01" max="${amount}">
                                    <button class="drawer-action-btn primary" onclick="heatmapApplyEmergencyPartial('${e.id}', ${amount}, '${dateStr}')">Apply</button>
                                    <button class="drawer-action-btn secondary" onclick="heatmapToggleEmergencyPartial('${e.id}')">Cancel</button>
                                </div>
                            </div>
                        `;
                    });
                }
            } else {
                html = `
                    <div class="heatmap-drawer-empty">
                        <div class="heatmap-drawer-empty-icon"></div>
                        <div>No payments scheduled for this day</div>
                    </div>
                `;
            }

            body.innerHTML = html;
            overlay.classList.add('open');
            drawer.classList.add('open');
        }

        // Refresh heatmap drawer after marking emergency paid/unpaid
        function refreshHeatmapDrawer(dateStr) {
            const dayPayments = data.payments.filter(p => p.dueDate === dateStr && p.type === 'i-owe');
            const total = dayPayments.reduce((sum, p) => {
                const amt = p.isPartialPayment ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid)) : parseFloat(p.amount);
                return sum + amt;
            }, 0);
            openHeatmapDrawer(dateStr, dayPayments, total);
            renderHeatmap();
            renderEmergencyExpenses();
        }

        function heatmapToggleEmergencyPartial(expenseId) {
            const partialInput = document.getElementById(`heatmap-emergency-partial-${expenseId}`);
            if (partialInput) {
                const isHidden = partialInput.style.display === 'none' || partialInput.style.display === '';
                partialInput.style.display = isHidden ? 'flex' : 'none';
                if (isHidden) {
                    const input = document.getElementById(`heatmap-emergency-partial-amount-${expenseId}`);
                    if (input) input.focus();
                }
            }
        }

        function heatmapApplyEmergencyPartial(expenseId, totalAmount, dateStr) {
            const amountInput = document.getElementById(`heatmap-emergency-partial-amount-${expenseId}`);
            if (!amountInput) return;

            const paidAmount = parseFloat(amountInput.value);
            if (isNaN(paidAmount) || paidAmount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            const expense = data.emergencyExpenses.find(e => e.id == expenseId);
            if (!expense) return;

            if (paidAmount >= totalAmount) {
                expense.status = 'paid';
                addHistory('Marked Paid', `Emergency: ${expense.description} - $${expense.amount}`);
            } else {
                expense.amount = totalAmount - paidAmount;
                addHistory('Partial Payment', `Emergency: ${expense.description} - $${paidAmount} paid`);
            }

            saveData();
            refreshHeatmapDrawer(dateStr);
        }

        function drawerTogglePartial(paymentId) {
            const partialInput = document.getElementById(`drawer-partial-${paymentId}`);
            if (partialInput) {
                const isHidden = partialInput.style.display === 'none' || partialInput.style.display === '';
                partialInput.style.display = isHidden ? 'flex' : 'none';
                if (isHidden) {
                    const input = document.getElementById(`drawer-partial-amount-${paymentId}`);
                    if (input) input.focus();
                }
            }
        }

        function drawerMarkPaid(paymentId, dateStr) {
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'paid';
                saveData();
                addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
                refreshDrawerAndHeatmap(dateStr);
            }
        }

        function drawerMarkUnpaid(paymentId, dateStr) {
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'pending';
                saveData();
                addHistory('Marked Unpaid', `${payment.description} - $${payment.amount}`);
                refreshDrawerAndHeatmap(dateStr);
            }
        }

        function drawerMarkPartial(paymentId, remainingAmount, dateStr) {
            const input = document.getElementById(`drawer-partial-amount-${paymentId}`);
            if (!input) return;

            const partialAmount = parseFloat(input.value);
            if (isNaN(partialAmount) || partialAmount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            if (partialAmount > remainingAmount) {
                showToast(`Amount cannot exceed remaining balance of $${formatMoney(remainingAmount)}`, 'error');
                return;
            }

            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                // Convert to partial payment if not already
                if (!payment.isPartialPayment) {
                    payment.isPartialPayment = true;
                    payment.totalAmount = payment.amount;
                    payment.amountPaid = 0;
                }

                payment.amountPaid = parseFloat(payment.amountPaid) + partialAmount;

                // If fully paid, mark as paid
                if (payment.amountPaid >= parseFloat(payment.totalAmount)) {
                    payment.status = 'paid';
                    addHistory('Fully Paid', `${payment.description} - $${formatMoney(payment.totalAmount)}`);
                } else {
                    addHistory('Partial Payment', `${payment.description} - $${formatMoney(partialAmount)} ($${formatMoney(payment.amountPaid)} of $${formatMoney(payment.totalAmount)})`);
                }

                saveData();
                refreshDrawerAndHeatmap(dateStr);
            }
        }

        function refreshDrawerAndHeatmap(dateStr) {
            // Re-render heatmap
            renderHeatmap();
            renderStats();
            renderCommandCenter();

            // Re-open drawer with updated data
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();

            // Rebuild payments for this day
            const dayPayments = data.payments.filter(p => {
                const pDate = new Date(p.dueDate);
                return p.type === 'i-owe' &&
                       pDate.getFullYear() === year &&
                       pDate.getMonth() === month &&
                       pDate.getDate() === day;
            });

            let total = 0;
            dayPayments.forEach(p => {
                const amount = p.isPartialPayment
                    ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                    : parseFloat(p.amount);
                total += amount;
            });

            openHeatmapDrawer(dateStr, dayPayments, total);
        }

        function closeHeatmapDrawer() {
            document.getElementById('heatmapDrawerOverlay').classList.remove('open');
            document.getElementById('heatmapDrawer').classList.remove('open');
        }

        function renderHeatmap() {
            const heatmapGrid = document.getElementById('heatmapGrid');
            const heatmapStats = document.getElementById('heatmapStats');
            const heatmapWeekTotals = document.getElementById('heatmapWeekTotals');
            const heatmapMonthLabel = document.getElementById('heatmapMonthLabel');
            const filterEl = document.getElementById('heatmapFilter');

            if (!heatmapGrid || !heatmapStats) return;

            const filter = filterEl ? filterEl.value : 'all';
            const year = heatmapDate.getFullYear();
            const month = heatmapDate.getMonth();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            if (heatmapMonthLabel) {
                heatmapMonthLabel.textContent = `${monthNames[month]} ${year}`;
            }

            // Get first day and days in month
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday

            // Build day data for this specific month
            const dayData = {};
            const dayPayments = {}; // Store actual payment objects for drawer

            data.payments.forEach(payment => {
                if (payment.type === 'i-owe') {
                    const paymentDate = new Date(payment.dueDate);
                    if (paymentDate.getFullYear() === year && paymentDate.getMonth() === month) {
                        // Apply filter
                        if (filter === 'pending' && payment.status !== 'pending') return;
                        if (filter === 'paid' && payment.status !== 'paid') return;

                        const day = paymentDate.getDate();
                        const amount = payment.isPartialPayment
                            ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                            : parseFloat(payment.amount);

                        if (!dayData[day]) {
                            dayData[day] = { pending: 0, paid: 0, total: 0, count: 0 };
                            dayPayments[day] = [];
                        }

                        if (payment.status === 'pending') {
                            dayData[day].pending += amount;
                        } else {
                            dayData[day].paid += amount;
                        }
                        dayData[day].total += amount;
                        dayData[day].count++;
                        dayPayments[day].push(payment);
                    }
                }
            });

            // Find max for intensity calculation
            const maxTotal = Math.max(...Object.values(dayData).map(d => d.total), 100);

            // Calculate weeks needed (max 6 rows for any month)
            const totalCells = startDayOfWeek + daysInMonth;
            const weeksNeeded = Math.ceil(totalCells / 7);

            // Build GitHub-style grid (days as rows, weeks as columns)
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();

            let html = '';
            // Header row with week numbers
            html += '<div class="heatmap-day-label"></div>'; // Empty corner
            for (let w = 1; w <= weeksNeeded; w++) {
                html += `<div class="heatmap-week-header">W${w}</div>`;
            }

            // Week totals tracking
            const weekTotals = Array(weeksNeeded).fill(0);

            // Build grid: each row is a day of week (Sun-Sat)
            for (let dow = 0; dow < 7; dow++) {
                html += `<div class="heatmap-day-label">${dayNames[dow]}</div>`;

                for (let week = 0; week < weeksNeeded; week++) {
                    const cellIndex = week * 7 + dow;
                    const dayNum = cellIndex - startDayOfWeek + 1;

                    if (dayNum < 1 || dayNum > daysInMonth) {
                        html += '<div class="heatmap-cell empty"></div>';
                    } else {
                        const dayInfo = dayData[dayNum] || { pending: 0, paid: 0, total: 0, count: 0 };
                        weekTotals[week] += dayInfo.total;

                        // Determine color class based on filter and amounts
                        let colorClass = '';
                        let intensity = 0;

                        if (dayInfo.total > 0) {
                            intensity = Math.min(7, Math.ceil((dayInfo.total / maxTotal) * 7));

                            if (filter === 'pending') {
                                colorClass = `pending-${intensity}`;
                            } else if (filter === 'paid') {
                                colorClass = `paid-${intensity}`;
                            } else {
                                // Mixed: show based on which is higher
                                if (dayInfo.pending > dayInfo.paid) {
                                    colorClass = `pending-${intensity}`;
                                } else if (dayInfo.paid > dayInfo.pending) {
                                    colorClass = `paid-${intensity}`;
                                } else {
                                    colorClass = `mixed-${intensity}`;
                                }
                            }
                        } else {
                            colorClass = filter === 'paid' ? 'paid-0' : filter === 'pending' ? 'pending-0' : 'mixed-0';
                        }

                        const isToday = isCurrentMonth && dayNum === todayDate;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                        const payments = dayPayments[dayNum] || [];

                        html += `
                            <div class="heatmap-cell ${colorClass} ${isToday ? 'today' : ''}"
                                 onclick="openHeatmapDrawer('${dateStr}', ${JSON.stringify(payments).replace(/"/g, '&quot;')}, ${dayInfo.total})"
                                 title="${dayInfo.count} payment(s): $${formatMoney(dayInfo.total)}">
                                <span class="heatmap-cell-day">${dayNum}</span>
                                ${dayInfo.total > 0 ? `<span class="heatmap-cell-amount">$${dayInfo.total >= 1000 ? Math.round(dayInfo.total/1000) + 'k' : Math.round(dayInfo.total)}</span>` : ''}
                            </div>
                        `;
                    }
                }
            }

            heatmapGrid.innerHTML = html;
            heatmapGrid.style.gridTemplateColumns = `auto repeat(${weeksNeeded}, 1fr)`;

            // Week totals sidebar
            if (heatmapWeekTotals) {
                let totalsHtml = '<h4>Week Totals</h4>';
                let monthTotal = 0;
                weekTotals.forEach((total, i) => {
                    monthTotal += total;
                    totalsHtml += `
                        <div class="heatmap-week-total-item">
                            <span>Week ${i + 1}</span>
                            <span>$${formatMoney(total, 0)}</span>
                        </div>
                    `;
                });
                totalsHtml += `
                    <div class="heatmap-week-total-item month-total">
                        <span>Month</span>
                        <span>$${formatMoney(monthTotal, 0)}</span>
                    </div>
                `;
                heatmapWeekTotals.innerHTML = totalsHtml;
            }

            // Calculate totals for mini stats
            const days = Object.keys(dayData).map(Number);
            let monthTotalAmount = 0;
            let monthPaidAmount = 0;

            Object.values(dayData).forEach(d => {
                monthTotalAmount += d.total;
                monthPaidAmount += d.paid;
            });

            // Update mini stat ring indicators
            const circumference = 2 * Math.PI * 16; // r=16 for mini rings

            const heatmapStatTotal = document.getElementById('heatmapStatTotal');
            const heatmapStatPaid = document.getElementById('heatmapStatPaid');
            const heatmapStatHeaviest = document.getElementById('heatmapStatHeaviest');
            const heatmapStatAvg = document.getElementById('heatmapStatAvg');
            const heatmapRingTotal = document.getElementById('heatmapRingTotal');
            const heatmapRingPaid = document.getElementById('heatmapRingPaid');
            const heatmapRingHeaviest = document.getElementById('heatmapRingHeaviest');
            const heatmapRingAvg = document.getElementById('heatmapRingAvg');

            if (heatmapStatTotal) heatmapStatTotal.textContent = `$${formatMoney(monthTotalAmount, 0)}`;
            if (heatmapStatPaid) heatmapStatPaid.textContent = `$${formatMoney(monthPaidAmount, 0)}`;

            // Total ring - always full
            if (heatmapRingTotal) {
                heatmapRingTotal.style.strokeDasharray = circumference;
                heatmapRingTotal.style.strokeDashoffset = 0;
            }

            // Paid ring - based on paid percentage
            const paidPercent = monthTotalAmount > 0 ? (monthPaidAmount / monthTotalAmount) * 100 : 0;
            if (heatmapRingPaid) {
                heatmapRingPaid.style.strokeDasharray = circumference;
                heatmapRingPaid.style.strokeDashoffset = circumference - (paidPercent / 100) * circumference;
            }

            // Stats and heaviest day
            if (days.length > 0) {
                const heaviestDay = days.reduce((a, b) => dayData[a].total > dayData[b].total ? a : b);
                const avgPerDay = monthTotalAmount / daysInMonth;

                if (heatmapStatHeaviest) heatmapStatHeaviest.textContent = `${heaviestDay}${ordinalSuffix(heaviestDay)}`;
                if (heatmapStatAvg) heatmapStatAvg.textContent = `$${formatMoney(avgPerDay, 0)}`;

                // Heaviest ring - based on heaviest vs total
                const heaviestPercent = monthTotalAmount > 0 ? (dayData[heaviestDay].total / monthTotalAmount) * 100 : 0;
                if (heatmapRingHeaviest) {
                    heatmapRingHeaviest.style.strokeDasharray = circumference;
                    heatmapRingHeaviest.style.strokeDashoffset = circumference - (heaviestPercent / 100) * circumference;
                }

                // Avg ring - based on days with bills vs total days
                const daysWithBillsPercent = (days.length / daysInMonth) * 100;
                if (heatmapRingAvg) {
                    heatmapRingAvg.style.strokeDasharray = circumference;
                    heatmapRingAvg.style.strokeDashoffset = circumference - (daysWithBillsPercent / 100) * circumference;
                }

                heatmapStats.innerHTML = `
                    <div class="heatmap-stat"> Days with bills: <strong>${days.length} of ${daysInMonth}</strong></div>
                `;
            } else {
                if (heatmapStatHeaviest) heatmapStatHeaviest.textContent = '-';
                if (heatmapStatAvg) heatmapStatAvg.textContent = '$0';
                heatmapStats.innerHTML = '<div class="heatmap-stat" style="color: rgba(255,255,255,0.4);">No payments this month</div>';
            }
        }

        function ordinalSuffix(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function renderUpcoming() {
            const next7TotalEl = document.getElementById('next7Total');
            const next7ListEl = document.getElementById('next7List');
            const next30TotalEl = document.getElementById('next30Total');
            const next30ListEl = document.getElementById('next30List');

            if (!next7TotalEl || !next7ListEl || !next30TotalEl || !next30ListEl) return;

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const in7Days = new Date();
            in7Days.setDate(in7Days.getDate() + 7);
            const in7DaysStr = in7Days.toISOString().split('T')[0];

            const in30Days = new Date();
            in30Days.setDate(in30Days.getDate() + 30);
            const in30DaysStr = in30Days.toISOString().split('T')[0];

            // Next 7 days
            const next7 = data.payments
                .filter(p => p.status === 'pending' && p.type === 'i-owe' &&
                            p.dueDate >= todayStr && p.dueDate <= in7DaysStr)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            let next7Total = 0;
            let next7Html = '';

            if (next7.length === 0) {
                next7Html = '<div class="empty-state"><p>No payments due in the next 7 days</p></div>';
            } else {
                next7.forEach(payment => {
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);
                    next7Total += amount;

                    const daysUntil = Math.ceil((new Date(payment.dueDate) - today) / (1000 * 60 * 60 * 24));
                    const isUrgent = daysUntil <= 3;

                    next7Html += `
                        <div class="upcoming-item ${isUrgent ? 'urgent' : ''} ${payment.isFlagged ? 'flagged' : ''}">
                            <div class="upcoming-item-info">
                                ${payment.isFlagged ? '<span class="flag-indicator"></span>' : ''}
                                <div class="upcoming-item-title">${payment.description}</div>
                                <div class="upcoming-item-meta">
                                    <span> ${payment.person}</span>
                                    <span> ${new Date(payment.dueDate + 'T00:00:00').toLocaleDateString()} (${daysUntil}d)</span>
                                </div>
                            </div>
                            <div class="upcoming-item-amount">$${formatMoney(amount)}</div>
                        </div>
                    `;
                });
            }

            next7TotalEl.textContent = `$${formatMoney(next7Total)}`;
            next7ListEl.innerHTML = next7Html;

            // Next 30 days
            const next30 = data.payments
                .filter(p => p.status === 'pending' && p.type === 'i-owe' &&
                            p.dueDate >= todayStr && p.dueDate <= in30DaysStr)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 10); // Limit to 10 items

            let next30Total = data.payments
                .filter(p => p.status === 'pending' && p.type === 'i-owe' &&
                            p.dueDate >= todayStr && p.dueDate <= in30DaysStr)
                .reduce((sum, p) => {
                    const amt = p.isPartialPayment
                        ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                        : parseFloat(p.amount);
                    return sum + amt;
                }, 0);

            let next30Html = '';

            if (next30.length === 0) {
                next30Html = '<div class="empty-state"><p>No payments due in the next 30 days</p></div>';
            } else {
                next30.forEach(payment => {
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    const daysUntil = Math.ceil((new Date(payment.dueDate) - today) / (1000 * 60 * 60 * 24));

                    next30Html += `
                        <div class="upcoming-item ${payment.isFlagged ? 'flagged' : ''}">
                            <div class="upcoming-item-info">
                                ${payment.isFlagged ? '<span class="flag-indicator"></span>' : ''}
                                <div class="upcoming-item-title">${payment.description}</div>
                                <div class="upcoming-item-meta">
                                    <span> ${payment.person}</span>
                                    <span> ${new Date(payment.dueDate + 'T00:00:00').toLocaleDateString()} (${daysUntil}d)</span>
                                </div>
                            </div>
                            <div class="upcoming-item-amount">$${formatMoney(amount)}</div>
                        </div>
                    `;
                });
            }

            next30TotalEl.textContent = `$${formatMoney(next30Total)}`;
            next30ListEl.innerHTML = next30Html;
        }

        function renderTopPersons() {
            const topPersonList = document.getElementById('topPersonList');

            if (!topPersonList) return;

            const personTotals = {};
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            data.payments.forEach(payment => {
                if (payment.status === 'pending' && payment.type === 'i-owe') {
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    const dueDate = new Date(payment.dueDate + 'T00:00:00');
                    const isThisMonth = dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear;
                    const isThisYear = dueDate.getFullYear() === currentYear;

                    if (!personTotals[payment.person]) {
                        personTotals[payment.person] = {
                            total: 0,
                            monthlyTotal: 0,
                            yearlyTotal: 0,
                            count: 0,
                            payments: []
                        };
                    }
                    personTotals[payment.person].total += amount;
                    personTotals[payment.person].count++;
                    personTotals[payment.person].payments.push({
                        description: payment.description,
                        amount: amount,
                        dueDate: payment.dueDate
                    });

                    if (isThisMonth) {
                        personTotals[payment.person].monthlyTotal += amount;
                    }
                    if (isThisYear) {
                        personTotals[payment.person].yearlyTotal += amount;
                    }
                }
            });

            const topPersons = Object.entries(personTotals)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 5);

            let html = '';
            if (topPersons.length === 0) {
                html = '<div class="empty-state"><p>No pending payments</p></div>';
            } else {
                html = '<div class="leaderboard">';
                topPersons.forEach(([person, personData], index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';

                    // Sort payments by due date to find upcoming
                    const sortedPayments = [...personData.payments].sort((a, b) =>
                        new Date(a.dueDate) - new Date(b.dueDate)
                    );

                    // Get the upcoming payment (soonest)
                    const upcomingPayment = sortedPayments[0];

                    // Group payments by description to find duplicates
                    const paymentGroups = {};
                    sortedPayments.forEach(p => {
                        if (!paymentGroups[p.description]) {
                            paymentGroups[p.description] = { count: 0, totalAmount: 0 };
                        }
                        paymentGroups[p.description].count++;
                        paymentGroups[p.description].totalAmount += p.amount;
                    });

                    // Build tooltip content
                    const upcomingGroup = paymentGroups[upcomingPayment.description];
                    const samePaymentCount = upcomingGroup.count - 1; // Exclude the upcoming one

                    // Get other different payments (not the upcoming type)
                    const otherPayments = Object.entries(paymentGroups)
                        .filter(([desc]) => desc !== upcomingPayment.description)
                        .slice(0, 3); // Show max 3 other payment types

                    const remainingOtherTypes = Object.keys(paymentGroups).length - 1 - otherPayments.length;

                    // Build tooltip HTML
                    let tooltipContent = `
                        <div class="tooltip-header">
                            <span class="tooltip-title">Payments</span>
                            <span class="tooltip-count">${personData.count} upcoming</span>
                        </div>
                        <div class="tooltip-upcoming">
                            <div class="tooltip-upcoming-label">Next Due</div>
                            <div class="tooltip-upcoming-item">
                                <span class="tooltip-upcoming-desc">${upcomingPayment.description}</span>
                                <span class="tooltip-upcoming-amount">$${formatMoney(upcomingPayment.amount)}</span>
                            </div>
                            ${samePaymentCount > 0 ? `<div class="tooltip-more-same">+${samePaymentCount} more of this payment</div>` : ''}
                        </div>
                    `;

                    // Add other payment types if they exist
                    if (otherPayments.length > 0) {
                        tooltipContent += `<div class="tooltip-others">
                            <div class="tooltip-others-label">Other Payments</div>`;

                        otherPayments.forEach(([desc, group]) => {
                            tooltipContent += `
                                <div class="tooltip-other-item">
                                    <span class="tooltip-other-desc">${desc}${group.count > 1 ? ` (${group.count})` : ''}</span>
                                    <span class="tooltip-other-amount">$${formatMoney(group.totalAmount)}</span>
                                </div>
                            `;
                        });

                        if (remainingOtherTypes > 0) {
                            tooltipContent += `<div class="tooltip-other-more">+${remainingOtherTypes} more type${remainingOtherTypes > 1 ? 's' : ''}...</div>`;
                        }

                        tooltipContent += `</div>`;
                    }

                    html += `
                        <div class="leaderboard-item ${rankClass}" onmouseenter="positionTooltip(this)">
                            <div class="leaderboard-rank">#${rank}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${person}</div>
                                <div class="leaderboard-meta">
                                    <span>${personData.count} payment${personData.count !== 1 ? 's' : ''}</span>
                                    <span>Mo: $${formatMoney(personData.monthlyTotal)}</span>
                                    <span>Yr: $${formatMoney(personData.yearlyTotal)}</span>
                                </div>
                            </div>
                            <div class="leaderboard-amount">
                                <div class="leaderboard-total">$${formatMoney(personData.total)}</div>
                            </div>
                            <div class="leaderboard-tooltip">
                                ${tooltipContent}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            topPersonList.innerHTML = html;
        }

        // Smart tooltip positioning - shows above or below based on available space
        function positionTooltip(item) {
            const tooltip = item.querySelector('.leaderboard-tooltip');
            if (!tooltip) return;

            const itemRect = item.getBoundingClientRect();
            const tooltipHeight = 150; // Approximate tooltip height
            const spaceAbove = itemRect.top;
            const spaceBelow = window.innerHeight - itemRect.bottom;

            // If not enough space above, show below
            if (spaceAbove < tooltipHeight && spaceBelow > spaceAbove) {
                tooltip.classList.add('tooltip-bottom');
            } else {
                tooltip.classList.remove('tooltip-bottom');
            }
        }

        // Calendar
        function renderCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');

            if (!calendarTitle || !calendarGrid) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            calendarTitle.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const prevDaysInMonth = prevLastDay.getDate();

            // Calculate max day amount for color scaling (including emergency expenses)
            let maxDayAmount = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayPayments = data.payments.filter(p => p.dueDate === dateStr);
                const dayEmergencies = (data.emergencyExpenses || []).filter(e => e.date === dateStr);
                const dayTotal = dayPayments
                    .filter(p => p.status === 'pending' && p.type === 'i-owe')
                    .reduce((sum, p) => {
                        const amount = p.isPartialPayment
                            ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                            : parseFloat(p.amount);
                        return sum + amount;
                    }, 0);
                const emergencyTotal = dayEmergencies
                    .filter(e => e.status === 'pending')
                    .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                const combinedTotal = dayTotal + emergencyTotal;
                if (combinedTotal > maxDayAmount) maxDayAmount = combinedTotal;
            }

            let calendarHTML = '';
            const dayHeaders = ['Week', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });

            // Helper to get week number
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            }

            // Previous month days
            let weekTotal = 0;
            let weekStart = true;
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDaysInMonth - i;
                if (weekStart) {
                    const weekDate = new Date(year, month - 1, day);
                    const weekNum = getWeekNumber(weekDate);
                    calendarHTML += `<div class="calendar-week-number">${weekNum}</div>`;
                    weekStart = false;
                }
                calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // Current month days
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateObj = new Date(year, month, day);
                const dayOfWeek = currentDateObj.getDay();

                // Add week number on Sunday
                if (dayOfWeek === 0 || (day === 1 && startDay > 0)) {
                    if (day > 1 || startDay === 0) {
                        const weekNum = getWeekNumber(currentDateObj);
                        calendarHTML += `<div class="calendar-week-number">${weekNum}</div>`;
                    }
                }

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayPayments = data.payments.filter(p => p.dueDate === dateStr);
                const dayEmergencies = (data.emergencyExpenses || []).filter(e => e.date === dateStr);
                const hasOverdue = dayPayments.some(p => p.status === 'pending' && p.dueDate < todayStr) ||
                                   dayEmergencies.some(e => e.status === 'pending' && e.date < todayStr);
                const hasFlagged = dayPayments.some(p => p.isFlagged && p.status === 'pending');
                const hasPaid = dayPayments.some(p => p.status === 'paid') || dayEmergencies.some(e => e.status === 'paid');
                const hasEmergency = dayEmergencies.some(e => e.status === 'pending');

                // Calculate total amount for the day (only "I Owe" pending payments + emergency expenses)
                const dayTotal = dayPayments
                    .filter(p => p.status === 'pending' && p.type === 'i-owe')
                    .reduce((sum, p) => {
                        const amount = p.isPartialPayment
                            ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                            : parseFloat(p.amount);
                        return sum + amount;
                    }, 0);
                const dayEmergencyTotal = dayEmergencies
                    .filter(e => e.status === 'pending')
                    .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                const dayCombinedTotal = dayTotal + dayEmergencyTotal;
                const totalItemCount = dayPayments.length + dayEmergencies.length;

                // Color coding based on amount (using combined total)
                let amountClass = '';
                if (dayCombinedTotal > 0 && maxDayAmount > 0) {
                    const ratio = dayCombinedTotal / maxDayAmount;
                    if (ratio > 0.7) amountClass = ' amount-high';
                    else if (ratio > 0.3) amountClass = ' amount-medium';
                    else amountClass = ' amount-low';
                }

                let classes = 'calendar-day';
                if (dateStr === todayStr) classes += ' today';
                else if (hasOverdue) classes += ' has-overdue';
                else if (hasFlagged) classes += ' has-flagged';
                else if (hasEmergency) classes += ' has-emergency';
                else if (hasPaid && dayCombinedTotal === 0) classes += ' all-paid';

                // Add class for has-pending/has-paid/has-mixed for quick-add visibility
                if (totalItemCount > 0) {
                    if (dayCombinedTotal > 0 && hasPaid) classes += ' has-mixed';
                    else if (dayCombinedTotal > 0) classes += ' has-pending';
                    else if (hasPaid) classes += ' has-paid';
                }

                classes += amountClass;

                calendarHTML += `
                    <div class="${classes}"
                        onclick="showDayPayments('${dateStr}')"
                        ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)"
                        ondrop="handleDrop(event, '${dateStr}')">
                        ${dayCombinedTotal > 0 ? `<div class="calendar-day-amount ${hasEmergency ? 'has-emergency' : ''}">$${formatMoney(dayCombinedTotal, 0)}</div>` : ''}
                        <div class="calendar-day-number">${day}</div>
                        ${totalItemCount > 0 ? `<div class="calendar-day-indicator ${hasEmergency ? 'has-emergency' : ''}">${totalItemCount}${hasEmergency ? '' : ''}</div>` : ''}
                        ${hasPaid && dayCombinedTotal === 0 ? `<div style="font-size: 0.7rem; opacity: 0.5;"></div>` : ''}
                        <div class="calendar-day-add" onclick="event.stopPropagation(); quickAddForDate('${dateStr}')">+</div>
                    </div>
                `;
            }

            // Next month days
            const remainingDays = 42 - (startDay + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                const nextMonthDate = new Date(year, month + 1, day);
                const dayOfWeek = nextMonthDate.getDay();

                if (dayOfWeek === 0) {
                    const weekNum = getWeekNumber(nextMonthDate);
                    calendarHTML += `<div class="calendar-week-number">${weekNum}</div>`;
                }

                calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            calendarGrid.innerHTML = calendarHTML;

            // Update the mini stats row
            updateCalendarStats();
        }

        function previousMonth() {
            // Set day to 1 first to avoid month rollover issues (e.g., Jan 31 -> "Feb 31" -> Mar 3)
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            // Set day to 1 first to avoid month rollover issues (e.g., Jan 31 -> "Feb 31" -> Mar 3)
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function today() {
            currentDate = new Date();
            currentDate.setDate(1); // Use first of month for consistent navigation
            renderCalendar();
        }

        // Calendar View State
        let currentCalendarView = 'month';
        let currentDrawerDate = null;
        let draggedPayment = null;

        function switchCalendarView(view) {
            currentCalendarView = view;

            // Update toggle buttons
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Toggle views
            const monthView = document.getElementById('calendarMonthView');
            const weekView = document.getElementById('calendarWeekView');
            const agendaView = document.getElementById('calendarAgendaView');

            if (monthView) monthView.classList.toggle('hidden', view !== 'month');
            if (weekView) weekView.classList.toggle('active', view === 'week');
            if (agendaView) agendaView.classList.toggle('active', view === 'agenda');

            // Render the appropriate view
            if (view === 'week') renderWeekView();
            else if (view === 'agenda') renderAgendaView();
        }

        // Week view date tracking
        let currentWeekDate = new Date();

        function renderWeekView() {
            const weekViewContent = document.getElementById('weekViewContent');
            if (!weekViewContent) return;

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const startOfWeek = new Date(currentWeekDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            // Format week range for display
            const startMonth = startOfWeek.toLocaleDateString('en-US', { month: 'short' });
            const endMonth = endOfWeek.toLocaleDateString('en-US', { month: 'short' });
            const startDay = startOfWeek.getDate();
            const endDay = endOfWeek.getDate();
            const year = startOfWeek.getFullYear();

            let weekRangeText;
            if (startMonth === endMonth) {
                weekRangeText = `${startMonth} ${startDay} - ${endDay}, ${year}`;
            } else {
                weekRangeText = `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
            }

            // Week navigation header
            let html = `
                <div class="week-nav-header">
                    <button class="week-nav-btn" onclick="previousWeek()"> Prev</button>
                    <div class="week-nav-title">
                        <span class="week-range">${weekRangeText}</span>
                    </div>
                    <button class="week-nav-btn" onclick="nextWeek()">Next </button>
                    <button class="week-nav-btn today-btn" onclick="goToCurrentWeek()">This Week</button>
                </div>
            `;

            html += '<div class="week-grid">';

            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            html += '<div class="week-header-row">';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                const dateStr = dayDate.toISOString().split('T')[0];
                const isToday = dateStr === todayStr;

                html += `<div class="week-day-header ${isToday ? 'today' : ''}">
                    <span class="week-day-name">${dayNames[i]}</span>
                    <span class="week-day-date">${dayDate.getDate()}</span>
                </div>`;
            }
            html += '</div>';

            // Day contents
            html += '<div class="week-content-row">';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                const dateStr = dayDate.toISOString().split('T')[0];
                const dayPayments = data.payments.filter(p => p.dueDate === dateStr);
                const dayEmergencies = (data.emergencyExpenses || []).filter(e => e.date === dateStr);
                const isToday = dateStr === todayStr;
                const hasEmergency = dayEmergencies.some(e => e.status === 'pending');

                html += `<div class="week-day-content ${isToday ? 'today' : ''} ${hasEmergency ? 'has-emergency' : ''}"
                    onclick="openCalendarDrawer('${dateStr}')"
                    ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${dateStr}')">`;

                // Combine payments and emergencies into one list, payments first
                const allItems = [];
                dayPayments.forEach(p => allItems.push({ type: 'payment', data: p }));
                dayEmergencies.forEach(e => allItems.push({ type: 'emergency', data: e }));

                allItems.slice(0, 4).forEach(item => {
                    if (item.type === 'payment') {
                        const payment = item.data;
                        const isPaid = payment.status === 'paid';
                        const isOverdue = !isPaid && payment.dueDate < todayStr;
                        const amount = payment.isPartialPayment
                            ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                            : parseFloat(payment.amount);

                        html += `<div class="week-payment-item ${isPaid ? 'paid' : 'pending'} ${isOverdue ? 'overdue' : ''}"
                            draggable="true" ondragstart="handleDragStart(event, '${payment.id}')">
                            <div class="week-payment-info">
                                <span class="week-payment-title">${payment.description}</span>
                                <span class="week-payment-amount">$${formatMoney(amount, 0)}</span>
                            </div>
                            <div class="week-payment-actions" onclick="event.stopPropagation();">
                                ${isPaid ? `
                                    <button class="week-action-btn undo" onclick="quickMarkUnpaid('${payment.id}')" title="Mark Unpaid"></button>
                                ` : `
                                    <button class="week-action-btn check" onclick="quickMarkPaid('${payment.id}')" title="Mark Paid"></button>
                                `}
                                <button class="week-action-btn edit" onclick="editPaymentFromView('${payment.id}')" title="Edit"></button>
                            </div>
                        </div>`;
                    } else {
                        const expense = item.data;
                        const isPaid = expense.status === 'paid';
                        const isOverdue = !isPaid && expense.date < todayStr;
                        const amount = parseFloat(expense.amount || 0);

                        html += `<div class="week-payment-item emergency ${isPaid ? 'paid' : 'pending'} ${isOverdue ? 'overdue' : ''}">
                            <div class="week-payment-info">
                                <span class="week-payment-title"> ${expense.description}</span>
                                <span class="week-payment-amount">$${formatMoney(amount, 0)}</span>
                            </div>
                            <div class="week-payment-actions" onclick="event.stopPropagation();">
                                ${isPaid ? `
                                    <button class="week-action-btn undo" onclick="quickMarkEmergencyUnpaid('${expense.id}')" title="Mark Unpaid"></button>
                                ` : `
                                    <button class="week-action-btn check" onclick="quickMarkEmergencyPaid('${expense.id}')" title="Mark Paid"></button>
                                `}
                                <button class="week-action-btn edit" onclick="editEmergencyExpense('${expense.id}')" title="Edit"></button>
                            </div>
                        </div>`;
                    }
                });

                if (allItems.length > 4) {
                    html += `<div class="week-more">+${allItems.length - 4} more</div>`;
                }

                if (allItems.length === 0) {
                    html += `<div class="week-empty-add" onclick="event.stopPropagation(); quickAddForDate('${dateStr}')">+ Add</div>`;
                }

                html += '</div>';
            }
            html += '</div></div>';

            weekViewContent.innerHTML = html;
        }

        function previousWeek() {
            currentWeekDate.setDate(currentWeekDate.getDate() - 7);
            renderWeekView();
        }

        function nextWeek() {
            currentWeekDate.setDate(currentWeekDate.getDate() + 7);
            renderWeekView();
        }

        function goToCurrentWeek() {
            currentWeekDate = new Date();
            renderWeekView();
        }

        function renderAgendaView() {
            const agendaContent = document.getElementById('agendaViewContent');
            if (!agendaContent) return;

            const todayStr = new Date().toISOString().split('T')[0];

            // Get all payments and emergency expenses, combine them
            const allPayments = [...data.payments].map(p => ({ ...p, itemType: 'payment', dateField: p.dueDate }));
            const allEmergencies = [...(data.emergencyExpenses || [])].map(e => ({ ...e, itemType: 'emergency', dateField: e.date }));
            const allItems = [...allPayments, ...allEmergencies].sort((a, b) => new Date(a.dateField) - new Date(b.dateField));

            if (allItems.length === 0) {
                agendaContent.innerHTML = `
                    <div class="calendar-agenda-empty">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <p>No payments scheduled</p>
                    </div>`;
                return;
            }

            // Split into past (paid OR before today) and upcoming (pending AND today or future)
            const pastItems = allItems.filter(item =>
                item.status === 'paid' || (item.status === 'pending' && item.dateField < todayStr)
            );
            const upcomingItems = allItems.filter(item =>
                item.status === 'pending' && item.dateField >= todayStr
            );

            // Group items by date
            function groupByDate(items) {
                const grouped = {};
                items.forEach(item => {
                    const dateKey = item.dateField;
                    if (!grouped[dateKey]) grouped[dateKey] = [];
                    grouped[dateKey].push(item);
                });
                return grouped;
            }

            // Render a day group (handles both payments and emergency expenses)
            function renderDayGroup(dateStr, items, isPastSection) {
                const date = new Date(dateStr + 'T00:00:00');
                const isOverdue = dateStr < todayStr;
                const isToday = dateStr === todayStr;
                const hasEmergency = items.some(item => item.itemType === 'emergency' && item.status === 'pending');

                const dayTotal = items
                    .filter(item => item.status === 'pending')
                    .reduce((sum, item) => {
                        if (item.itemType === 'payment') {
                            const amt = item.isPartialPayment
                                ? (parseFloat(item.totalAmount) - parseFloat(item.amountPaid))
                                : parseFloat(item.amount);
                            return sum + amt;
                        } else {
                            return sum + parseFloat(item.amount || 0);
                        }
                    }, 0);

                let dayHtml = `<div class="calendar-agenda-day ${isPastSection ? 'past-section' : ''} ${isToday ? 'is-today' : ''} ${hasEmergency ? 'has-emergency' : ''}">
                    <div class="calendar-agenda-date ${isOverdue && dayTotal > 0 ? 'has-overdue' : ''}">
                        <span>${date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</span>
                        <div class="agenda-date-tags">
                            ${isToday ? '<span class="agenda-tag today">Today</span>' : ''}
                            ${hasEmergency ? '<span class="agenda-tag emergency"> Emergency</span>' : ''}
                            ${isOverdue && dayTotal > 0 ? '<span class="agenda-tag overdue">Overdue</span>' : ''}
                            ${dayTotal > 0 ? `<span class="day-total ${isOverdue ? 'overdue' : ''} ${hasEmergency ? 'has-emergency' : ''}">$${formatMoney(dayTotal)}</span>` : ''}
                        </div>
                    </div>`;

                items.forEach(item => {
                    const isPaid = item.status === 'paid';
                    const dateField = item.itemType === 'payment' ? item.dueDate : item.date;
                    const isItemOverdue = !isPaid && dateField < todayStr;

                    if (item.itemType === 'payment') {
                        const payment = item;
                        const amount = payment.isPartialPayment
                            ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                            : parseFloat(payment.amount);

                        dayHtml += `<div class="calendar-agenda-item ${isPaid ? 'is-paid' : ''} ${isItemOverdue ? 'is-overdue' : ''}">
                            <div class="calendar-agenda-item-status ${isPaid ? 'paid' : (isItemOverdue ? 'overdue' : 'pending')}"></div>
                            <div class="calendar-agenda-item-info" onclick="openCalendarDrawer('${dateStr}')">
                                <div class="calendar-agenda-item-title">
                                    ${payment.isFlagged ? ' ' : ''}${payment.description}
                                    ${isItemOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}
                                </div>
                                <div class="calendar-agenda-item-person">${payment.person}</div>
                            </div>
                            <div class="calendar-agenda-item-amount ${isItemOverdue ? 'overdue' : ''}">${isPaid ? ' ' : ''}$${formatMoney(amount)}</div>
                            <div class="agenda-item-actions">
                                ${isPaid ? `
                                    <button class="agenda-action-btn undo" onclick="quickMarkUnpaid('${payment.id}')" title="Mark Unpaid"></button>
                                ` : `
                                    <button class="agenda-action-btn check" onclick="quickMarkPaid('${payment.id}')" title="Mark Paid"></button>
                                `}
                                <button class="agenda-action-btn edit" onclick="editPaymentFromView('${payment.id}')" title="Edit"></button>
                            </div>
                        </div>`;
                    } else {
                        // Emergency expense
                        const expense = item;
                        const amount = parseFloat(expense.amount || 0);
                        const categoryIcons = { medical: '', car: '', home: '', appliance: '', pet: '', travel: '', legal: '', other: '' };
                        const categoryIcon = categoryIcons[expense.category] || '';

                        dayHtml += `<div class="calendar-agenda-item emergency-item ${isPaid ? 'is-paid' : ''} ${isItemOverdue ? 'is-overdue' : ''}">
                            <div class="calendar-agenda-item-status emergency ${isPaid ? 'paid' : (isItemOverdue ? 'overdue' : 'pending')}"></div>
                            <div class="calendar-agenda-item-info" onclick="openCalendarDrawer('${dateStr}')">
                                <div class="calendar-agenda-item-title">
                                     ${expense.description}
                                    ${isItemOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}
                                </div>
                                <div class="calendar-agenda-item-person">${categoryIcon} ${expense.category || 'Emergency'}</div>
                            </div>
                            <div class="calendar-agenda-item-amount emergency ${isItemOverdue ? 'overdue' : ''}">${isPaid ? ' ' : ''}$${formatMoney(amount)}</div>
                            <div class="agenda-item-actions">
                                ${isPaid ? `
                                    <button class="agenda-action-btn undo" onclick="quickMarkEmergencyUnpaid('${expense.id}')" title="Mark Unpaid"></button>
                                ` : `
                                    <button class="agenda-action-btn check" onclick="quickMarkEmergencyPaid('${expense.id}')" title="Mark Paid"></button>
                                `}
                                <button class="agenda-action-btn edit" onclick="editEmergencyExpense('${expense.id}')" title="Edit"></button>
                            </div>
                        </div>`;
                    }
                });

                dayHtml += '</div>';
                return dayHtml;
            }

            let html = '';

            // Past section (scroll up to see)
            const pastGrouped = groupByDate(pastItems);
            const pastDates = Object.keys(pastGrouped).sort();

            if (pastDates.length > 0) {
                html += '<div class="agenda-section past-payments">';
                html += '<div class="agenda-section-header"> Past & Completed</div>';
                pastDates.forEach(dateStr => {
                    html += renderDayGroup(dateStr, pastGrouped[dateStr], true);
                });
                html += '</div>';
            }

            // Divider - "Now" marker
            html += '<div class="agenda-now-marker" id="agendaNowMarker">';
            html += '<div class="agenda-now-line"></div>';
            html += '<span class="agenda-now-label">Upcoming</span>';
            html += '<div class="agenda-now-line"></div>';
            html += '</div>';

            // Upcoming section
            const upcomingGrouped = groupByDate(upcomingItems);
            const upcomingDates = Object.keys(upcomingGrouped).sort();

            if (upcomingDates.length > 0) {
                html += '<div class="agenda-section upcoming-payments">';
                upcomingDates.forEach(dateStr => {
                    html += renderDayGroup(dateStr, upcomingGrouped[dateStr], false);
                });
                html += '</div>';
            } else {
                html += `
                    <div class="agenda-section upcoming-payments">
                        <div class="calendar-agenda-empty" style="padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <p>No upcoming payments!</p>
                        </div>
                    </div>`;
            }

            agendaContent.innerHTML = html;

            // Auto-scroll to the "Now" marker so upcoming is visible first
            setTimeout(() => {
                const nowMarker = document.getElementById('agendaNowMarker');
                if (nowMarker) {
                    nowMarker.scrollIntoView({ behavior: 'auto', block: 'start' });
                }
            }, 50);
        }

        function showDayPayments(dateStr) {
            openCalendarDrawer(dateStr);
        }

        function openCalendarDrawer(dateStr) {
            currentDrawerDate = dateStr;
            const drawer = document.getElementById('calendarDrawer');
            const backdrop = document.getElementById('calendarDrawerBackdrop');
            if (!drawer || !backdrop) return;

            const date = new Date(dateStr + 'T00:00:00');
            const dayPayments = data.payments.filter(p => p.dueDate === dateStr);
            const dayEmergencies = (data.emergencyExpenses || []).filter(e => e.date === dateStr);
            const todayStr = new Date().toISOString().split('T')[0];
            const hasEmergencies = dayEmergencies.length > 0;

            // Set header
            document.getElementById('drawerDayName').textContent = date.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('drawerDateFull').textContent = date.toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });

            // Calculate stats (including emergency expenses)
            const pendingPayments = dayPayments
                .filter(p => p.status === 'pending')
                .reduce((sum, p) => {
                    const amt = p.isPartialPayment
                        ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                        : parseFloat(p.amount);
                    return sum + amt;
                }, 0);
            const pendingEmergencies = dayEmergencies
                .filter(e => e.status === 'pending')
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const pendingTotal = pendingPayments + pendingEmergencies;

            const paidPayments = dayPayments
                .filter(p => p.status === 'paid')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const paidEmergencies = dayEmergencies
                .filter(e => e.status === 'paid')
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const paidTotal = paidPayments + paidEmergencies;

            document.getElementById('calendarDrawerStats').innerHTML = `
                <div class="drawer-stat">
                    <div class="drawer-stat-value pending ${hasEmergencies ? 'has-emergency' : ''}">$${formatMoney(pendingTotal)}</div>
                    <div class="drawer-stat-label">Pending${hasEmergencies && pendingEmergencies > 0 ? ' ' : ''}</div>
                </div>
                <div class="drawer-stat">
                    <div class="drawer-stat-value paid">$${formatMoney(paidTotal)}</div>
                    <div class="drawer-stat-label">Paid</div>
                </div>`;

            // Build payment list (including emergency expenses)
            let contentHtml = '';
            const totalItems = dayPayments.length + dayEmergencies.length;

            if (totalItems === 0) {
                contentHtml = `
                    <div class="drawer-empty">
                        <div class="drawer-empty-icon"></div>
                        <p>No payments for this day</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Click the button below to add one!</p>
                    </div>`;
            } else {
                // Render regular payments first
                dayPayments.forEach(payment => {
                    const isPaid = payment.status === 'paid';
                    const isOverdue = !isPaid && payment.dueDate < todayStr;
                    const amount = payment.isPartialPayment
                        ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                        : parseFloat(payment.amount);

                    const seriesCount = payment.recurringGroupId ? getRecurringGroupCount(payment) : 0;
                    const seriesBadge = seriesCount > 1 ? `<span class="series-badge" title="${seriesCount} payments in series"> ${seriesCount}</span>` : '';

                    contentHtml += `
                        <div class="drawer-payment-item ${isPaid ? 'is-paid' : ''}"
                            draggable="true" ondragstart="handleDragStart(event, '${payment.id}')">
                            <div class="drawer-payment-header">
                                <div class="drawer-payment-title">
                                    ${payment.isFlagged ? ' ' : ''}${payment.isRecurring ? ' ' : ''}${payment.description}
                                </div>
                                <div class="drawer-payment-amount ${isPaid ? 'paid' : 'pending'}">
                                    $${formatMoney(amount)}
                                </div>
                            </div>
                            <div class="drawer-payment-meta">
                                <span> ${payment.person}</span>
                                <span>${payment.category}</span>
                                ${seriesBadge}
                                ${isOverdue ? '<span style="color: #f87171;"> Overdue</span>' : ''}
                            </div>
                            <div class="drawer-payment-actions" id="drawerActions_${payment.id}">
                                ${isPaid ? `
                                    <button class="drawer-action-btn danger" onclick="calDrawerMarkUnpaid('${payment.id}')">Mark Unpaid</button>
                                    <button class="drawer-action-btn secondary" onclick="editPaymentFromDrawer('${payment.id}')">Edit</button>
                                ` : `
                                    <button class="drawer-action-btn primary" onclick="calDrawerMarkPaid('${payment.id}')">Mark Paid</button>
                                    <button class="drawer-action-btn secondary" onclick="calDrawerTogglePartial('${payment.id}')">Partial</button>
                                    <button class="drawer-action-btn secondary" onclick="editPaymentFromDrawer('${payment.id}')">Edit</button>
                                `}
                            </div>
                            <div class="drawer-partial-input" id="drawerPartial_${payment.id}" style="display: none;">
                                <input type="number" id="drawerPartialAmount_${payment.id}" placeholder="Amount paid" step="0.01" min="0.01" max="${amount}">
                                <button class="drawer-action-btn primary" onclick="calDrawerApplyPartial('${payment.id}', ${amount})">Apply</button>
                                <button class="drawer-action-btn secondary" onclick="calDrawerTogglePartial('${payment.id}')">Cancel</button>
                            </div>
                        </div>`;
                });

                // Render emergency expenses with distinct styling
                if (dayEmergencies.length > 0 && dayPayments.length > 0) {
                    contentHtml += `<div class="drawer-section-divider"><span> Emergency Expenses</span></div>`;
                }

                dayEmergencies.forEach(expense => {
                    const isPaid = expense.status === 'paid';
                    const isOverdue = !isPaid && expense.date < todayStr;
                    const amount = parseFloat(expense.amount || 0);
                    const categoryIcons = { medical: '', car: '', home: '', appliance: '', pet: '', travel: '', legal: '', other: '' };
                    const categoryIcon = categoryIcons[expense.category] || '';
                    const categoryNames = { medical: 'Medical', car: 'Car/Vehicle', home: 'Home Repair', appliance: 'Appliance', pet: 'Pet', travel: 'Travel', legal: 'Legal', other: 'Other' };
                    const categoryName = categoryNames[expense.category] || 'Emergency';

                    contentHtml += `
                        <div class="drawer-payment-item emergency-item ${isPaid ? 'is-paid' : ''}">
                            <div class="drawer-payment-header">
                                <div class="drawer-payment-title emergency">
                                    ${categoryIcon} ${expense.description}
                                </div>
                                <div class="drawer-payment-amount emergency ${isPaid ? 'paid' : 'pending'}">
                                    $${formatMoney(amount)}
                                </div>
                            </div>
                            <div class="drawer-payment-meta">
                                <span> ${categoryName}</span>
                                ${isOverdue ? '<span style="color: #f87171;"> Overdue</span>' : ''}
                            </div>
                            <div class="drawer-payment-actions">
                                ${isPaid ? `
                                    <button class="drawer-action-btn danger" onclick="quickMarkEmergencyUnpaid('${expense.id}')">Mark Unpaid</button>
                                    <button class="drawer-action-btn secondary" onclick="editEmergencyExpense('${expense.id}')">Edit</button>
                                ` : `
                                    <button class="drawer-action-btn primary" onclick="quickMarkEmergencyPaid('${expense.id}')">Mark Paid</button>
                                    <button class="drawer-action-btn secondary" onclick="calDrawerToggleEmergencyPartial('${expense.id}')">Partial</button>
                                    <button class="drawer-action-btn secondary" onclick="editEmergencyExpense('${expense.id}')">Edit</button>
                                `}
                            </div>
                            <div class="drawer-partial-input" id="drawerEmergencyPartial_${expense.id}" style="display: none;">
                                <input type="number" id="drawerEmergencyPartialAmount_${expense.id}" placeholder="Amount paid" step="0.01" min="0.01" max="${amount}">
                                <button class="drawer-action-btn primary" onclick="calDrawerApplyEmergencyPartial('${expense.id}', ${amount})">Apply</button>
                                <button class="drawer-action-btn secondary" onclick="calDrawerToggleEmergencyPartial('${expense.id}')">Cancel</button>
                            </div>
                        </div>`;
                });
            }

            document.getElementById('calendarDrawerContent').innerHTML = contentHtml;

            // Show drawer
            drawer.classList.add('active');
            backdrop.classList.add('active');
        }

        function closeCalendarDrawer() {
            const drawer = document.getElementById('calendarDrawer');
            const backdrop = document.getElementById('calendarDrawerBackdrop');
            if (drawer) drawer.classList.remove('active');
            if (backdrop) backdrop.classList.remove('active');
            currentDrawerDate = null;
        }

        function calDrawerMarkPaid(paymentId) {
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'paid';
                saveData();
                addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
                refreshCalendarDrawer();
            }
        }

        function calDrawerMarkUnpaid(paymentId) {
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'pending';
                saveData();
                addHistory('Marked Unpaid', `${payment.description} - $${payment.amount}`);
                refreshCalendarDrawer();
            }
        }

        function calDrawerTogglePartial(paymentId) {
            const partialDiv = document.getElementById(`drawerPartial_${paymentId}`);
            const actionsDiv = document.getElementById(`drawerActions_${paymentId}`);
            if (partialDiv && actionsDiv) {
                const isHidden = partialDiv.style.display === 'none';
                partialDiv.style.display = isHidden ? 'flex' : 'none';
                actionsDiv.style.display = isHidden ? 'none' : 'flex';
            }
        }

        function calDrawerApplyPartial(paymentId, remainingAmount) {
            const amountInput = document.getElementById(`drawerPartialAmount_${paymentId}`);
            if (!amountInput) return;

            const paidAmount = parseFloat(amountInput.value);
            if (isNaN(paidAmount) || paidAmount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (!payment) return;

            if (paidAmount >= remainingAmount) {
                // Fully paid
                payment.status = 'paid';
                if (payment.isPartialPayment) {
                    payment.amountPaid = payment.totalAmount;
                }
                addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
            } else {
                // Partial payment
                if (!payment.isPartialPayment) {
                    payment.isPartialPayment = true;
                    payment.totalAmount = payment.amount;
                    payment.amountPaid = paidAmount;
                } else {
                    payment.amountPaid = parseFloat(payment.amountPaid) + paidAmount;
                }
                payment.amount = payment.totalAmount - payment.amountPaid;
                addHistory('Partial Payment', `${payment.description} - $${paidAmount} paid`);
            }

            saveData();
            refreshCalendarDrawer();
        }

        // Emergency expense partial payment functions
        function calDrawerToggleEmergencyPartial(expenseId) {
            const partialDiv = document.getElementById(`drawerEmergencyPartial_${expenseId}`);
            if (partialDiv) {
                const isHidden = partialDiv.style.display === 'none';
                partialDiv.style.display = isHidden ? 'flex' : 'none';
            }
        }

        function calDrawerApplyEmergencyPartial(expenseId, totalAmount) {
            const amountInput = document.getElementById(`drawerEmergencyPartialAmount_${expenseId}`);
            if (!amountInput) return;

            const paidAmount = parseFloat(amountInput.value);
            if (isNaN(paidAmount) || paidAmount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            const expense = data.emergencyExpenses.find(e => e.id == expenseId);
            if (!expense) return;

            if (paidAmount >= totalAmount) {
                // Fully paid
                expense.status = 'paid';
                addHistory('Marked Paid', `Emergency: ${expense.description} - $${expense.amount}`);
            } else {
                // Partial payment - reduce the amount
                expense.amount = totalAmount - paidAmount;
                addHistory('Partial Payment', `Emergency: ${expense.description} - $${paidAmount} paid`);
            }

            saveData();
            refreshCalendarDrawer();
            renderEmergencyExpenses();
        }

        function refreshCalendarDrawer() {
            renderCalendar();
            updateCalendarStats();
            renderStats();
            renderCommandCenter();
            // Also refresh the current view if not month
            if (currentCalendarView === 'week') renderWeekView();
            if (currentCalendarView === 'agenda') renderAgendaView();
            // Re-open drawer with updated data
            if (currentDrawerDate) {
                openCalendarDrawer(currentDrawerDate);
            }
        }

        function updateCalendarStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const todayStr = new Date().toISOString().split('T')[0];

            // Get payments for the month
            const monthPayments = data.payments.filter(p =>
                p.dueDate.startsWith(monthStr) && p.type === 'i-owe'
            );

            // Get emergency expenses for the month
            const monthEmergencies = (data.emergencyExpenses || []).filter(e =>
                e.date && e.date.startsWith(monthStr)
            );

            // Calculate payment totals
            const paymentTotal = monthPayments.reduce((sum, p) => {
                if (p.isPartialPayment) return sum + parseFloat(p.totalAmount);
                return sum + parseFloat(p.amount);
            }, 0);

            const paymentPaid = monthPayments
                .filter(p => p.status === 'paid')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);

            const paymentRemaining = monthPayments
                .filter(p => p.status === 'pending')
                .reduce((sum, p) => {
                    const amt = p.isPartialPayment
                        ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                        : parseFloat(p.amount);
                    return sum + amt;
                }, 0);

            const paymentOverdue = monthPayments
                .filter(p => p.status === 'pending' && p.dueDate < todayStr)
                .reduce((sum, p) => {
                    const amt = p.isPartialPayment
                        ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                        : parseFloat(p.amount);
                    return sum + amt;
                }, 0);

            // Calculate emergency expense totals
            const emergencyTotal = monthEmergencies.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            const emergencyPaid = monthEmergencies
                .filter(e => e.status === 'paid')
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            const emergencyRemaining = monthEmergencies
                .filter(e => e.status === 'pending')
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            const emergencyOverdue = monthEmergencies
                .filter(e => e.status === 'pending' && e.date < todayStr)
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            // Combined totals
            const total = paymentTotal + emergencyTotal;
            const paid = paymentPaid + emergencyPaid;
            const remaining = paymentRemaining + emergencyRemaining;
            const overdue = paymentOverdue + emergencyOverdue;
            const hasEmergency = emergencyRemaining > 0;

            // Update values
            const totalEl = document.getElementById('calStatTotal');
            const paidEl = document.getElementById('calStatPaid');
            const remainingEl = document.getElementById('calStatRemaining');
            const overdueEl = document.getElementById('calStatOverdue');

            if (totalEl) totalEl.textContent = `$${formatMoney(total, 0)}`;
            if (paidEl) paidEl.textContent = `$${formatMoney(paid, 0)}`;
            if (remainingEl) {
                remainingEl.textContent = `$${formatMoney(remaining, 0)}`;
                // Add emergency indicator if there are pending emergencies
                if (hasEmergency) {
                    remainingEl.classList.add('has-emergency');
                } else {
                    remainingEl.classList.remove('has-emergency');
                }
            }
            if (overdueEl) overdueEl.textContent = `$${formatMoney(overdue, 0)}`;

            // Update rings
            const circumference = 2 * Math.PI * 13;
            const totalRing = document.getElementById('calStatTotalRing');
            const paidRing = document.getElementById('calStatPaidRing');
            const remainingRing = document.getElementById('calStatRemainingRing');
            const overdueRing = document.getElementById('calStatOverdueRing');

            if (total > 0) {
                if (totalRing) totalRing.style.strokeDashoffset = 0;
                if (paidRing) paidRing.style.strokeDashoffset = circumference * (1 - paid / total);
                if (remainingRing) remainingRing.style.strokeDashoffset = circumference * (1 - remaining / total);
            }
            if (remainingRing && remaining > 0) {
                if (overdueRing) overdueRing.style.strokeDashoffset = circumference * (1 - (remaining > 0 ? overdue / remaining : 0));
            }
        }

        function quickAddFromDrawer() {
            closeCalendarDrawer();
            if (currentDrawerDate) {
                quickAddForDate(currentDrawerDate);
            } else {
                showAddModal();
            }
        }

        function editPaymentFromDrawer(paymentId) {
            const dateToReopen = currentDrawerDate;
            closeCalendarDrawer();
            editPayment(paymentId);
            // Store the date so we can reopen the drawer after saving
            window.drawerDateAfterEdit = dateToReopen;
        }

        // Quick action functions for all calendar views
        function quickMarkPaid(paymentId) {
            // Convert to number for comparison (IDs are from Date.now())
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'paid';
                saveData();
                addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
                refreshAllCalendarViews();
            }
        }

        function quickMarkUnpaid(paymentId) {
            // Convert to number for comparison (IDs are from Date.now())
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            const payment = data.payments.find(p => p.id === id || p.id === paymentId);
            if (payment) {
                payment.status = 'pending';
                saveData();
                addHistory('Marked Unpaid', `${payment.description} - $${payment.amount}`);
                refreshAllCalendarViews();
            }
        }

        function editPaymentFromView(paymentId) {
            // Convert to number for comparison (IDs are from Date.now())
            const id = typeof paymentId === 'string' ? parseInt(paymentId) : paymentId;
            editPayment(id);
            // Store the current view so we can refresh after saving
            window.calendarViewAfterEdit = currentCalendarView;
        }

        // Emergency expense quick actions for calendar views
        function quickMarkEmergencyPaid(expenseId) {
            const id = typeof expenseId === 'string' ? parseInt(expenseId) : expenseId;
            const expense = (data.emergencyExpenses || []).find(e => e.id === id || e.id === expenseId);
            if (expense) {
                expense.status = 'paid';
                saveData();
                addHistory('Emergency Paid', ` ${expense.description} - $${expense.amount}`);
                refreshAllCalendarViews();
                renderEmergencyExpenses();
            }
        }

        function quickMarkEmergencyUnpaid(expenseId) {
            const id = typeof expenseId === 'string' ? parseInt(expenseId) : expenseId;
            const expense = (data.emergencyExpenses || []).find(e => e.id === id || e.id === expenseId);
            if (expense) {
                expense.status = 'pending';
                saveData();
                addHistory('Emergency Unpaid', ` ${expense.description} - $${expense.amount}`);
                refreshAllCalendarViews();
                renderEmergencyExpenses();
            }
        }

        function refreshAllCalendarViews() {
            renderCalendar();
            updateCalendarStats();
            renderStats();
            renderCommandCenter();
            if (currentCalendarView === 'week') renderWeekView();
            if (currentCalendarView === 'agenda') renderAgendaView();
        }

        function quickAddForDate(dateStr) {
            showAddModal();
            setTimeout(() => {
                const dueDateInput = document.getElementById('dueDate');
                if (dueDateInput) dueDateInput.value = dateStr;
            }, 100);
        }

        // Drag and drop functionality
        function handleDragStart(event, paymentId) {
            draggedPayment = paymentId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', paymentId);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newDateStr) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedPayment) return;

            const id = typeof draggedPayment === 'string' ? parseInt(draggedPayment) : draggedPayment;
            const payment = data.payments.find(p => p.id === id || p.id === draggedPayment);
            if (payment && payment.dueDate !== newDateStr) {
                const oldDate = payment.dueDate;
                payment.dueDate = newDateStr;
                saveData();
                addHistory('Rescheduled', `${payment.description} from ${oldDate} to ${newDateStr}`);

                renderCalendar();
                updateCalendarStats();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'agenda') renderAgendaView();
            }

            draggedPayment = null;
        }

        function closeDayModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        // Payments
        // Payments sorting state
        let currentSortField = 'dueDate';
        let currentSortDirection = 'asc';

        function renderPayments() {
            const searchBox = document.getElementById('searchBox');
            const monthFilterSelect = document.getElementById('monthFilter');
            const paymentsList = document.getElementById('paymentsList');
            const emptyState = document.getElementById('paymentsEmptyState');
            const tableContainer = document.querySelector('.payments-table-container');

            // If elements don't exist, tab isn't loaded yet
            if (!searchBox || !monthFilterSelect || !paymentsList) return;

            const searchTerm = searchBox.value.toLowerCase();
            const selectedMonth = monthFilterSelect.value;
            const today = new Date().toISOString().split('T')[0];

            // Show/hide search clear button
            const clearBtn = document.getElementById('searchClearBtn');
            if (clearBtn) {
                clearBtn.style.display = searchTerm ? 'flex' : 'none';
            }

            // Populate month filter dropdown
            const uniqueMonths = [...new Set(data.payments.map(p => p.dueDate.substring(0, 7)))].sort();
            const currentSelection = monthFilterSelect.value;

            let monthOptions = '<option value="all">All Months</option>';
            uniqueMonths.forEach(month => {
                const date = new Date(month + '-01T00:00:00');
                const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                monthOptions += `<option value="${month}">${monthName}</option>`;
            });
            monthFilterSelect.innerHTML = monthOptions;
            monthFilterSelect.value = currentSelection || 'all';

            // Populate person filter dropdown
            populatePersonFilter();

            // Get advanced filters
            const filterType = document.getElementById('filterType')?.value || 'all';
            const filterCategory = document.getElementById('filterCategory')?.value || 'all';
            const filterPerson = document.getElementById('filterPerson')?.value || 'all';
            const filterAmountMin = parseFloat(document.getElementById('filterAmountMin')?.value) || 0;
            const filterAmountMax = parseFloat(document.getElementById('filterAmountMax')?.value) || Infinity;
            const filterDateFrom = document.getElementById('filterDateFrom')?.value || '';
            const filterDateTo = document.getElementById('filterDateTo')?.value || '';

            // Filter payments
            let payments = data.payments.filter(payment => {
                const amount = payment.isPartialPayment
                    ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                    : parseFloat(payment.amount);

                const matchesSearch = !searchTerm ||
                    payment.description.toLowerCase().includes(searchTerm) ||
                    payment.person.toLowerCase().includes(searchTerm) ||
                    payment.category.toLowerCase().includes(searchTerm) ||
                    (payment.businessName && payment.businessName.toLowerCase().includes(searchTerm)) ||
                    (payment.subcategory && payment.subcategory.toLowerCase().includes(searchTerm));

                const matchesFilter = currentFilter === 'all' ||
                    (currentFilter === 'pending' && payment.status === 'pending') ||
                    (currentFilter === 'paid' && payment.status === 'paid') ||
                    (currentFilter === 'overdue' && payment.status === 'pending' && payment.dueDate < today) ||
                    (currentFilter === 'flagged' && payment.isFlagged) ||
                    (currentFilter === 'recurring' && payment.isRecurring);

                const matchesMonth = selectedMonth === 'all' || payment.dueDate.startsWith(selectedMonth);
                const matchesType = filterType === 'all' || payment.type === filterType;
                const matchesCategory = filterCategory === 'all' || payment.category === filterCategory;
                const matchesPerson = filterPerson === 'all' || payment.person === filterPerson;
                const matchesAmountRange = amount >= filterAmountMin && amount <= filterAmountMax;
                const matchesDateRange = (!filterDateFrom || payment.dueDate >= filterDateFrom) &&
                                         (!filterDateTo || payment.dueDate <= filterDateTo);

                return matchesSearch && matchesFilter && matchesMonth && matchesType &&
                       matchesCategory && matchesPerson && matchesAmountRange && matchesDateRange;
            });

            // Sort payments
            payments = sortPaymentsList(payments);

            // Update stats and chip counts
            updatePaymentsStats(payments);
            updateChipCounts();

            // Handle empty state
            if (payments.length === 0) {
                paymentsList.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                if (tableContainer) tableContainer.querySelector('thead').style.display = 'none';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (tableContainer) tableContainer.querySelector('thead').style.display = '';

            let html = '';

            // Group by month if "All Months" is selected
            if (selectedMonth === 'all') {
                const paymentsByMonth = {};
                payments.forEach(payment => {
                    const month = payment.dueDate.substring(0, 7);
                    if (!paymentsByMonth[month]) paymentsByMonth[month] = [];
                    paymentsByMonth[month].push(payment);
                });

                Object.keys(paymentsByMonth).sort().forEach(month => {
                    const monthPayments = paymentsByMonth[month];
                    const date = new Date(month + '-01T00:00:00');
                    const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

                    const monthTotal = monthPayments
                        .filter(p => p.status === 'pending' && p.type === 'i-owe')
                        .reduce((sum, p) => {
                            const amt = p.isPartialPayment
                                ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid))
                                : parseFloat(p.amount);
                            return sum + amt;
                        }, 0);

                    // Month group header row
                    html += `<tr class="month-group-header">
                        <td colspan="8">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="month-name"> ${monthName}</span>
                                <span class="month-total">$${formatMoney(monthTotal)}</span>
                            </div>
                        </td>
                    </tr>`;

                    monthPayments.forEach(payment => {
                        html += renderPaymentRow(payment, today);
                    });
                });
            } else {
                payments.forEach(payment => {
                    html += renderPaymentRow(payment, today);
                });
            }

            paymentsList.innerHTML = html;
            updateBulkActions();
            updateSortIcons();
        }

        function renderPaymentRow(payment, today) {
            const isSelected = selectedPayments.has(payment.id);
            const amount = payment.isPartialPayment
                ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                : parseFloat(payment.amount);
            const isPaid = payment.status === 'paid';
            const isOverdue = !isPaid && payment.dueDate < today;

            // Format date
            const dueDate = new Date(payment.dueDate + 'T00:00:00');
            const dateStr = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Relative date
            const todayDate = new Date(today);
            const diffDays = Math.ceil((dueDate - todayDate) / (1000 * 60 * 60 * 24));
            let relativeDate = '';
            let relativeDateClass = '';
            if (diffDays === 0) {
                relativeDate = 'Today';
                relativeDateClass = 'today';
            } else if (diffDays === 1) {
                relativeDate = 'Tomorrow';
            } else if (diffDays === -1) {
                relativeDate = 'Yesterday';
                relativeDateClass = isOverdue ? 'overdue' : '';
            } else if (diffDays < 0) {
                relativeDate = `${Math.abs(diffDays)} days ago`;
                relativeDateClass = isOverdue ? 'overdue' : '';
            } else if (diffDays <= 7) {
                relativeDate = `In ${diffDays} days`;
            }

            // Status
            let statusIcon = '';
            let statusClass = 'pending';
            if (isPaid) {
                statusIcon = '';
                statusClass = 'paid';
            } else if (isOverdue) {
                statusIcon = '';
                statusClass = 'overdue';
            }

            // Amount class
            let amountClass = 'pending';
            if (isPaid) amountClass = 'paid';
            else if (isOverdue) amountClass = 'overdue';

            // Row classes
            let rowClasses = [];
            if (isSelected) rowClasses.push('selected');
            if (isOverdue) rowClasses.push('overdue');
            if (isPaid) rowClasses.push('paid');

            return `
                <tr class="${rowClasses.join(' ')}" data-id="${payment.id}">
                    <td class="col-checkbox">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection(${payment.id})">
                    </td>
                    <td class="col-status">
                        <div class="status-indicator ${statusClass}">${statusIcon}</div>
                    </td>
                    <td class="col-description">
                        <div class="payment-desc-cell">
                            <div class="payment-desc-title">
                                ${payment.isFlagged ? '<span class="flag-icon"></span>' : ''}
                                ${payment.isRecurring ? '<span class="recurring-icon"></span>' : ''}
                                ${payment.description}
                            </div>
                            ${payment.subcategory ? `<div class="payment-desc-sub">${payment.subcategory}</div>` : ''}
                        </div>
                    </td>
                    <td class="col-person">${payment.person}</td>
                    <td class="col-amount">
                        <div class="amount-cell ${amountClass} editable-field" onclick="startEditAmount(${payment.id}, ${amount})">
                            ${payment.type === 'owed-to-me' ? '+' : ''}$${formatMoney(amount)}
                        </div>
                    </td>
                    <td class="col-date">
                        <div class="date-cell editable-field" onclick="startEditDate(${payment.id}, '${payment.dueDate}')">
                            <div class="date-cell-main">${dateStr}</div>
                            ${relativeDate ? `<div class="date-cell-relative ${relativeDateClass}">${relativeDate}</div>` : ''}
                        </div>
                    </td>
                    <td class="col-category">
                        <div class="category-badge ${payment.category.toLowerCase()}">${payment.category === 'Business' ? '' : ''} ${payment.category}</div>
                    </td>
                    <td class="col-actions">
                        <div class="action-buttons">
                            ${!isPaid ? `
                                <button class="action-btn check" onclick="markAsPaid(${payment.id})" title="Mark Paid"></button>
                            ` : `
                                <button class="action-btn check" onclick="markAsUnpaid(${payment.id})" title="Mark Unpaid" style="background: rgba(245, 158, 11, 0.15); color: #fbbf24;"></button>
                            `}
                            <button class="action-btn edit" onclick="editPayment(${payment.id})" title="Edit"></button>
                            <button class="action-btn delete" onclick="deletePayment(${payment.id})" title="Delete"></button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function sortPaymentsList(payments) {
            return payments.sort((a, b) => {
                let valA, valB;
                switch (currentSortField) {
                    case 'description':
                        valA = a.description.toLowerCase();
                        valB = b.description.toLowerCase();
                        break;
                    case 'person':
                        valA = a.person.toLowerCase();
                        valB = b.person.toLowerCase();
                        break;
                    case 'amount':
                        valA = a.isPartialPayment ? (parseFloat(a.totalAmount) - parseFloat(a.amountPaid)) : parseFloat(a.amount);
                        valB = b.isPartialPayment ? (parseFloat(b.totalAmount) - parseFloat(b.amountPaid)) : parseFloat(b.amount);
                        break;
                    case 'dueDate':
                    default:
                        valA = new Date(a.dueDate);
                        valB = new Date(b.dueDate);
                        break;
                }
                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function sortPayments(field) {
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            renderPayments();
        }

        function updateSortIcons() {
            document.querySelectorAll('.payments-table th.sortable').forEach(th => {
                th.classList.remove('sorted');
            });
            const fields = ['description', 'person', 'amount', 'dueDate'];
            fields.forEach(field => {
                const icon = document.getElementById(`sortIcon${field.charAt(0).toUpperCase() + field.slice(1)}`);
                if (icon) {
                    if (field === currentSortField) {
                        icon.textContent = currentSortDirection === 'asc' ? '' : '';
                        icon.closest('th').classList.add('sorted');
                    } else {
                        icon.textContent = '';
                    }
                }
            });
        }

        function updatePaymentsStats(filteredPayments) {
            const today = new Date().toISOString().split('T')[0];

            // Calculate totals from filtered payments (only "I Owe")
            const iOwePayments = filteredPayments.filter(p => p.type === 'i-owe');

            const totalDue = iOwePayments.reduce((sum, p) => {
                const amt = p.isPartialPayment ? parseFloat(p.totalAmount) : parseFloat(p.amount);
                return sum + amt;
            }, 0);

            const paidTotal = iOwePayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const paidCount = iOwePayments.filter(p => p.status === 'paid').length;

            const pendingTotal = iOwePayments.filter(p => p.status === 'pending').reduce((sum, p) => {
                const amt = p.isPartialPayment ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid)) : parseFloat(p.amount);
                return sum + amt;
            }, 0);
            const pendingCount = iOwePayments.filter(p => p.status === 'pending').length;

            const overdueTotal = iOwePayments.filter(p => p.status === 'pending' && p.dueDate < today).reduce((sum, p) => {
                const amt = p.isPartialPayment ? (parseFloat(p.totalAmount) - parseFloat(p.amountPaid)) : parseFloat(p.amount);
                return sum + amt;
            }, 0);
            const overdueCount = iOwePayments.filter(p => p.status === 'pending' && p.dueDate < today).length;

            // Update stat values
            const totalEl = document.getElementById('payStatTotal');
            const paidEl = document.getElementById('payStatPaid');
            const pendingEl = document.getElementById('payStatPending');
            const overdueEl = document.getElementById('payStatOverdue');
            const paidCountEl = document.getElementById('payStatPaidCount');
            const pendingCountEl = document.getElementById('payStatPendingCount');
            const overdueCountEl = document.getElementById('payStatOverdueCount');

            if (totalEl) totalEl.textContent = `$${formatMoney(totalDue)}`;
            if (paidEl) paidEl.textContent = `$${formatMoney(paidTotal)}`;
            if (pendingEl) pendingEl.textContent = `$${formatMoney(pendingTotal)}`;
            if (overdueEl) overdueEl.textContent = `$${formatMoney(overdueTotal)}`;
            if (paidCountEl) paidCountEl.textContent = paidCount;
            if (pendingCountEl) pendingCountEl.textContent = pendingCount;
            if (overdueCountEl) overdueCountEl.textContent = overdueCount;

            // Update rings
            const circumference = 2 * Math.PI * 16;
            const totalRing = document.getElementById('payStatTotalRing');
            const paidRing = document.getElementById('payStatPaidRing');
            const pendingRing = document.getElementById('payStatPendingRing');
            const overdueRing = document.getElementById('payStatOverdueRing');

            if (totalRing) {
                totalRing.style.strokeDasharray = circumference;
                totalRing.style.strokeDashoffset = 0;
            }
            if (totalDue > 0) {
                if (paidRing) {
                    paidRing.style.strokeDasharray = circumference;
                    paidRing.style.strokeDashoffset = circumference * (1 - paidTotal / totalDue);
                }
                if (pendingRing) {
                    pendingRing.style.strokeDasharray = circumference;
                    pendingRing.style.strokeDashoffset = circumference * (1 - pendingTotal / totalDue);
                }
            }
            if (pendingTotal > 0 && overdueRing) {
                overdueRing.style.strokeDasharray = circumference;
                overdueRing.style.strokeDashoffset = circumference * (1 - overdueTotal / pendingTotal);
            }
        }

        function updateChipCounts() {
            const today = new Date().toISOString().split('T')[0];
            const all = data.payments.length;
            const pending = data.payments.filter(p => p.status === 'pending').length;
            const paid = data.payments.filter(p => p.status === 'paid').length;
            const overdue = data.payments.filter(p => p.status === 'pending' && p.dueDate < today).length;
            const flagged = data.payments.filter(p => p.isFlagged).length;
            const recurring = data.payments.filter(p => p.isRecurring).length;

            const countAll = document.getElementById('chipCountAll');
            const countPending = document.getElementById('chipCountPending');
            const countPaid = document.getElementById('chipCountPaid');
            const countOverdue = document.getElementById('chipCountOverdue');
            const countFlagged = document.getElementById('chipCountFlagged');
            const countRecurring = document.getElementById('chipCountRecurring');

            if (countAll) countAll.textContent = all;
            if (countPending) countPending.textContent = pending;
            if (countPaid) countPaid.textContent = paid;
            if (countOverdue) countOverdue.textContent = overdue;
            if (countFlagged) countFlagged.textContent = flagged;
            if (countRecurring) countRecurring.textContent = recurring;
        }

        function populatePersonFilter() {
            const select = document.getElementById('filterPerson');
            if (!select) return;

            const currentValue = select.value;
            const uniquePeople = [...new Set(data.payments.map(p => p.person))].sort();

            let options = '<option value="all">All People</option>';
            uniquePeople.forEach(person => {
                options += `<option value="${person}">${person}</option>`;
            });
            select.innerHTML = options;
            select.value = currentValue || 'all';
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFiltersPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        function clearAllFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterPerson').value = 'all';
            document.getElementById('filterAmountMin').value = '';
            document.getElementById('filterAmountMax').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            filterPayments();
        }

        function clearSearch() {
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.value = '';
                filterPayments();
            }
        }

        function toggleSelectAll(checkbox) {
            const rows = document.querySelectorAll('#paymentsList tr[data-id]');
            rows.forEach(row => {
                const id = parseInt(row.dataset.id);
                if (checkbox.checked) {
                    selectedPayments.add(id);
                } else {
                    selectedPayments.delete(id);
                }
                const rowCheckbox = row.querySelector('input[type="checkbox"]');
                if (rowCheckbox) rowCheckbox.checked = checkbox.checked;
                row.classList.toggle('selected', checkbox.checked);
            });
            updateBulkActions();
        }

        // 
        // Phase 2A: True Inline Editing (v2.0)
        // 
        function startEditAmount(paymentId, currentAmount) {
            const cell = document.querySelector(`tr[data-id="${paymentId}"] .amount-cell`);
            if (!cell) return editPayment(paymentId); // Fallback to modal

            // Already editing?
            if (cell.classList.contains('editing')) return;
            cell.classList.add('editing');

            const originalHtml = cell.innerHTML;
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.value = currentAmount;
            input.className = 'inline-edit-input';

            const save = () => {
                const newAmount = parseFloat(input.value);
                if (isNaN(newAmount) || newAmount < 0) {
                    cell.innerHTML = originalHtml;
                    cell.classList.remove('editing');
                    return;
                }
                const payment = data.payments.find(p => p.id === paymentId);
                if (payment && newAmount !== currentAmount) {
                    payment.amount = newAmount;
                    if (!payment.isPartialPayment) payment.totalAmount = newAmount;
                    addHistory('Edited Amount', `${payment.description}: $${currentAmount}  $${newAmount}`);
                    EventBus.emit('payment:updated', { payment, changes: { amount: newAmount } });
                    saveData();
                    smartRefresh();
                    showToast(`Amount updated to $${formatMoney(newAmount)}`, 'success');
                } else {
                    cell.innerHTML = originalHtml;
                    cell.classList.remove('editing');
                }
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); save(); }
                if (e.key === 'Escape') { cell.innerHTML = originalHtml; cell.classList.remove('editing'); }
                if (e.key === 'Tab') { e.preventDefault(); save(); }
            });
            input.addEventListener('blur', save);

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function startEditDate(paymentId, currentDate) {
            const cell = document.querySelector(`tr[data-id="${paymentId}"] .date-cell`);
            if (!cell) return editPayment(paymentId); // Fallback to modal

            if (cell.classList.contains('editing')) return;
            cell.classList.add('editing');

            const originalHtml = cell.innerHTML;
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentDate;
            input.className = 'inline-edit-input';

            const save = () => {
                const newDate = input.value;
                if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                    cell.innerHTML = originalHtml;
                    cell.classList.remove('editing');
                    return;
                }
                const payment = data.payments.find(p => p.id === paymentId);
                if (payment && newDate !== currentDate) {
                    payment.dueDate = newDate;
                    addHistory('Rescheduled', `${payment.description}: ${currentDate}  ${newDate}`);
                    EventBus.emit('payment:updated', { payment, changes: { dueDate: newDate } });
                    saveData();
                    smartRefresh();
                    showToast(`Date updated to ${newDate}`, 'success');
                } else {
                    cell.innerHTML = originalHtml;
                    cell.classList.remove('editing');
                }
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); save(); }
                if (e.key === 'Escape') { cell.innerHTML = originalHtml; cell.classList.remove('editing'); }
            });
            input.addEventListener('blur', save);

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        function markAsUnpaid(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            const oldStatus = payment.status;
            payment.status = 'pending';
            addHistory('Marked Unpaid', `${payment.description} - $${payment.amount}`);
            EventBus.emit('payment:statusChanged', { payment, oldStatus });
            saveData();
            smartRefresh();
        }

        function bulkMarkUnpaid() {
            showToast(`Mark ${selectedPayments.size} payment(s) as unpaid?`, 'confirm', {
                onConfirm: () => {
                    selectedPayments.forEach(id => {
                        const payment = data.payments.find(p => p.id === id);
                        if (payment && payment.status === 'paid') {
                            payment.status = 'pending';
                            EventBus.emit('payment:statusChanged', { payment, oldStatus: 'paid' });
                            addHistory('Marked Unpaid (Bulk)', `${payment.description}`);
                        }
                    });
                    saveData();
                    clearSelection();
                    showToast('Payments marked as unpaid', 'success');
                }
            });
        }

        function bulkReschedule() {
            const newDate = prompt('Enter new due date (YYYY-MM-DD):');
            if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                if (newDate) showToast('Invalid date format. Please use YYYY-MM-DD', 'error');
                return;
            }

            selectedPayments.forEach(id => {
                const payment = data.payments.find(p => p.id === id);
                if (payment) {
                    payment.dueDate = newDate;
                    addHistory('Rescheduled (Bulk)', `${payment.description} to ${newDate}`);
                }
            });

            saveData();
            clearSelection();
        }

        function filterPayments() {
            renderPayments();
        }

        function setFilter(filter) {
            currentFilter = filter;
            // Update chip active states
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });
            // Legacy support for old filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderPayments();
        }

        function toggleFlag(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            payment.isFlagged = !payment.isFlagged;
            addHistory(payment.isFlagged ? 'Flagged' : 'Unflagged',
                      `${payment.description} - $${payment.amount}`);
            saveData();
            smartRefresh(); // Stay on current tab with auto-refresh
        }

        // Selection
        function toggleSelection(id) {
            if (selectedPayments.has(id)) {
                selectedPayments.delete(id);
            } else {
                selectedPayments.add(id);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkBar = document.getElementById('bulkActionsBar');
            const selectAllCheckbox = document.getElementById('selectAllPayments');

            if (selectedPayments.size > 0) {
                if (bulkBar) bulkBar.classList.add('active');
                document.getElementById('selectedCount').textContent = selectedPayments.size;
            } else {
                if (bulkBar) bulkBar.classList.remove('active');
            }

            // Update select all checkbox state
            if (selectAllCheckbox) {
                const totalRows = document.querySelectorAll('#paymentsList tr[data-id]').length;
                selectAllCheckbox.checked = totalRows > 0 && selectedPayments.size === totalRows;
                selectAllCheckbox.indeterminate = selectedPayments.size > 0 && selectedPayments.size < totalRows;
            }
        }

        function clearSelection() {
            selectedPayments.clear();
            const selectAllCheckbox = document.getElementById('selectAllPayments');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            renderPayments();
        }

        function bulkMarkPaid() {
            showToast(`Mark ${selectedPayments.size} payment(s) as paid?`, 'confirm', {
                onConfirm: () => {
                    selectedPayments.forEach(id => {
                        const payment = data.payments.find(p => p.id === id);
                        if (payment && payment.status === 'pending') {
                            payment.status = 'paid';
                            if (payment.isPartialPayment) {
                                payment.amountPaid = parseFloat(payment.totalAmount);
                            }
                            EventBus.emit('payment:statusChanged', { payment, oldStatus: 'pending' });
                            addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
                        }
                    });
                    selectedPayments.clear();
                    saveData();
                    smartRefresh();
                    showToast('Payments marked as paid', 'success');
                }
            });
        }

        function bulkDelete() {
            showToast(`Delete ${selectedPayments.size} payment(s)?`, 'confirm', {
                onConfirm: () => {
                    const deletedPayments = [];
                    selectedPayments.forEach(id => {
                        const payment = data.payments.find(p => p.id === id);
                        if (payment) {
                            deletedPayments.push({...payment});
                            addHistory('Deleted', `${payment.description} - $${payment.amount}`);
                            data.payments = data.payments.filter(p => p.id !== id);
                        }
                    });
                    selectedPayments.clear();
                    saveData();
                    smartRefresh();
                    showToast(`${deletedPayments.length} payment(s) deleted`, 'undo', {
                        onUndo: () => {
                            data.payments.push(...deletedPayments);
                            saveData();
                            smartRefresh();
                            showToast('Payments restored', 'success');
                        }
                    });
                }
            });
        }

        // Modal
        function showAddModal() {
            editingPaymentId = null;
            document.getElementById('modalTitle').textContent = 'Add Payment';
            document.getElementById('paymentForm').reset();
            document.getElementById('businessNameGroup').style.display = 'none';
            document.getElementById('partialPaymentFields').style.display = 'none';
            document.getElementById('recurringFields').style.display = 'none';
            document.getElementById('paymentModal').classList.add('active');
        }

        // Store pending edit info for recurring scope selection
        let pendingEditPaymentId = null;
        let editScope = 'single'; // 'single' or 'future'

        function editPayment(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            // Check if this is a recurring payment (has recurringGroupId or isRecurring)
            if (payment.isRecurring || payment.recurringGroupId) {
                // Show scope selection modal first
                pendingEditPaymentId = numId;
                document.getElementById('editScopeModal').classList.add('active');
            } else {
                // Not recurring, edit directly
                openEditModal(numId);
            }
        }

        function closeEditScopeModal() {
            document.getElementById('editScopeModal').classList.remove('active');
            pendingEditPaymentId = null;
        }

        function editThisEventOnly() {
            editScope = 'single';
            const paymentId = pendingEditPaymentId; // Save before closing
            document.getElementById('editScopeModal').classList.remove('active');
            openEditModal(paymentId);
        }

        function editAllFutureEvents() {
            editScope = 'future';
            const paymentId = pendingEditPaymentId; // Save before closing
            document.getElementById('editScopeModal').classList.remove('active');
            openEditModal(paymentId);
        }

        function openEditModal(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            editingPaymentId = numId;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            document.getElementById('modalTitle').textContent = 'Edit Payment';
            document.getElementById('description').value = payment.description;
            document.getElementById('person').value = payment.person;
            document.getElementById('amount').value = payment.amount;
            document.getElementById('dueDate').value = payment.dueDate;
            document.getElementById('category').value = payment.category;
            document.getElementById('businessName').value = payment.businessName || '';
            document.getElementById('subcategory').value = payment.subcategory || '';
            document.getElementById('type').value = payment.type;
            document.getElementById('isPartialPayment').checked = payment.isPartialPayment;
            document.getElementById('isRecurring').checked = payment.isRecurring || false;

            toggleBusinessName();
            togglePartialPayment();
            toggleRecurring();

            if (payment.isPartialPayment) {
                document.getElementById('totalAmount').value = payment.totalAmount;
                document.getElementById('amountPaid').value = payment.amountPaid;
            }

            if (payment.isRecurring) {
                document.getElementById('recurringFrequency').value = payment.recurringFrequency || 'monthly';
                document.getElementById('recurringMonthsAhead').value = payment.recurringMonthsAhead || 2;
            }

            document.getElementById('paymentModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.remove('active');
            editingPaymentId = null;
            editScope = 'single'; // Reset edit scope
            pendingEditPaymentId = null;
            window.drawerDateAfterEdit = null; // Clear drawer date when modal is closed
        }

        function toggleBusinessName() {
            const category = document.getElementById('category').value;
            const businessNameGroup = document.getElementById('businessNameGroup');
            businessNameGroup.style.display = category === 'Business' ? 'block' : 'none';
        }

        function togglePartialPayment() {
            const isPartial = document.getElementById('isPartialPayment').checked;
            document.getElementById('partialPaymentFields').style.display = isPartial ? 'block' : 'none';
        }

        function toggleRecurring() {
            const isRecurring = document.getElementById('isRecurring').checked;
            document.getElementById('recurringFields').style.display = isRecurring ? 'block' : 'none';
        }

        function createRecurringPayments(basePayment, monthsAhead) {
            const frequency = basePayment.recurringFrequency || 'monthly';
            const createdPayments = [];

            // Create a recurring group ID if the base payment doesn't have one
            const recurringGroupId = basePayment.recurringGroupId || `recurring_${Date.now()}`;
            basePayment.recurringGroupId = recurringGroupId;

            let currentDate = new Date(basePayment.dueDate + 'T00:00:00');
            const endDate = new Date(currentDate);
            endDate.setMonth(endDate.getMonth() + monthsAhead);

            // Store the original day of month for monthly recurrence
            const originalDayOfMonth = currentDate.getDate();

            while (currentDate < endDate) {
                // Calculate next date based on frequency
                if (frequency === 'weekly') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (frequency === 'biweekly') {
                    currentDate.setDate(currentDate.getDate() + 14);
                } else { // monthly
                    // Advance to next month
                    const targetYear = currentDate.getFullYear();
                    const targetMonth = currentDate.getMonth() + 1;

                    // Get the last day of the target month
                    const lastDayOfMonth = new Date(targetYear, targetMonth + 1, 0).getDate();

                    // Use the original day, or the last day of month if it doesn't exist
                    const targetDay = Math.min(originalDayOfMonth, lastDayOfMonth);

                    // Set the new date
                    currentDate = new Date(targetYear, targetMonth, targetDay);
                }

                if (currentDate >= endDate) break;

                // Check if payment already exists for this date
                const dateStr = currentDate.toISOString().split('T')[0];
                const exists = data.payments.some(p =>
                    p.dueDate === dateStr &&
                    p.description === basePayment.description &&
                    p.person === basePayment.person
                );

                if (!exists) {
                    const newPayment = {
                        ...basePayment,
                        id: Date.now() + createdPayments.length, // Unique integer ID
                        dueDate: dateStr,
                        status: 'pending',
                        recurringGroupId: recurringGroupId
                    };
                    delete newPayment.recurringMonthsAhead; // Don't copy this
                    createdPayments.push(newPayment);
                }
            }

            return createdPayments;
        }

        function savePayment(event) {
            event.preventDefault();

            try {
                const payment = {
                    id: editingPaymentId || Date.now(),
                    description: document.getElementById('description').value,
                    person: document.getElementById('person').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    dueDate: document.getElementById('dueDate').value,
                    category: document.getElementById('category').value,
                    businessName: document.getElementById('businessName').value,
                    subcategory: document.getElementById('subcategory').value,
                    type: document.getElementById('type').value,
                    status: 'pending',
                    isPartialPayment: document.getElementById('isPartialPayment').checked,
                    totalAmount: 0,
                    amountPaid: 0,
                    isFlagged: false,
                    isRecurring: document.getElementById('isRecurring').checked,
                    recurringFrequency: document.getElementById('recurringFrequency').value,
                    recurringMonthsAhead: parseInt(document.getElementById('recurringMonthsAhead').value)
                };

                // Preserve flag status if editing
                if (editingPaymentId) {
                    const existing = data.payments.find(p => p.id === editingPaymentId);
                    if (existing) {
                        payment.isFlagged = existing.isFlagged;
                        payment.status = existing.status;
                    }
                }

                if (payment.isPartialPayment) {
                    payment.totalAmount = parseFloat(document.getElementById('totalAmount').value) || payment.amount;
                    payment.amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;

                    if (payment.amountPaid > payment.totalAmount) {
                        showToast('Amount paid cannot exceed total amount', 'error');
                        return;
                    }
                } else {
                    payment.totalAmount = payment.amount;
                    payment.amountPaid = 0;
                }

                if (editingPaymentId) {
                    const existingPayment = data.payments.find(p => p.id === editingPaymentId);
                    const index = data.payments.findIndex(p => p.id === editingPaymentId);

                    // Preserve the recurringGroupId
                    if (existingPayment && existingPayment.recurringGroupId) {
                        payment.recurringGroupId = existingPayment.recurringGroupId;
                    }

                    if (editScope === 'future' && existingPayment && existingPayment.recurringGroupId) {
                        // Edit this and all future events in the recurring group
                        const currentDate = existingPayment.dueDate;
                        const groupId = existingPayment.recurringGroupId;

                        // Get fields that should be updated (not date-specific)
                        const updateFields = {
                            description: payment.description,
                            person: payment.person,
                            amount: payment.amount,
                            category: payment.category,
                            businessName: payment.businessName,
                            subcategory: payment.subcategory,
                            type: payment.type,
                            isPartialPayment: payment.isPartialPayment,
                            totalAmount: payment.totalAmount,
                            amountPaid: payment.amountPaid,
                            isRecurring: payment.isRecurring,
                            recurringFrequency: payment.recurringFrequency
                        };

                        let updatedCount = 0;
                        data.payments.forEach((p, i) => {
                            if (p.recurringGroupId === groupId && p.dueDate >= currentDate) {
                                // Update with new values but keep original date and status
                                Object.assign(data.payments[i], updateFields);
                                updatedCount++;
                            }
                        });

                        addHistory('Edited Future Events', `${updatedCount} occurrences of "${payment.description}" updated`);
                    } else {
                        // Edit this event only
                        if (editScope === 'single' && existingPayment && existingPayment.recurringGroupId) {
                            // Remove from recurring group when editing single event
                            delete payment.recurringGroupId;
                            payment.isRecurring = false;
                        }
                        data.payments[index] = payment;
                        addHistory('Edited', `${payment.description} - $${payment.amount}`);
                    }

                    // Reset edit scope
                    editScope = 'single';
                } else {
                    data.payments.push(payment);
                    addHistory('Added', `${payment.description} - $${payment.amount}`);

                    // Auto-create recurring payments
                    if (payment.isRecurring) {
                        const recurringPayments = createRecurringPayments(payment, payment.recurringMonthsAhead);
                        data.payments.push(...recurringPayments);
                        addHistory('Recurring Payments Created',
                            `${recurringPayments.length} future instances of "${payment.description}"`);
                    }
                }

                saveData();
                closeModal();
                if (editingPaymentId) {
                    EventBus.emit('payment:updated', { payment });
                } else {
                    EventBus.emit('payment:added', { payment });
                }
                smartRefresh(); // Stay on current tab with auto-refresh
                showToast(editingPaymentId ? 'Payment updated' : 'Payment added', 'success');

                // Refresh calendar views if we were editing from a calendar view
                if (window.calendarViewAfterEdit) {
                    setTimeout(() => {
                        refreshAllCalendarViews();
                        window.calendarViewAfterEdit = null;
                    }, 100);
                }

                // Reopen calendar drawer if we were editing from it
                if (window.drawerDateAfterEdit) {
                    setTimeout(() => {
                        openCalendarDrawer(window.drawerDateAfterEdit);
                        window.drawerDateAfterEdit = null;
                    }, 100);
                }
            } catch (error) {
                console.error('Error saving payment:', error);
                showToast('Error saving payment. Please try again.', 'error');
            }
        }

        function markAsPaid(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            const oldStatus = payment.status;
            payment.status = 'paid';
            if (payment.isPartialPayment) {
                payment.amountPaid = parseFloat(payment.totalAmount);
            }

            addHistory('Marked Paid', `${payment.description} - $${payment.amount}`);
            EventBus.emit('payment:statusChanged', { payment, oldStatus });
            saveData();
            smartRefresh();
            showToast(`"${payment.description}" marked as paid`, 'undo', {
                onUndo: () => {
                    payment.status = oldStatus;
                    if (payment.isPartialPayment) {
                        payment.amountPaid = 0;
                    }
                    saveData();
                    smartRefresh();
                    showToast('Payment restored to unpaid', 'success');
                }
            });
        }

        // Store pending delete info
        let pendingDeletePaymentId = null;

        function deletePayment(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (!payment) return;

            // Check if this is a recurring payment
            if (payment.isRecurring || payment.recurringGroupId) {
                // Show scope selection modal
                pendingDeletePaymentId = numId;
                document.getElementById('deleteScopeModal').classList.add('active');
            } else {
                // Not recurring, delete directly with confirmation
                showToast('Delete this payment?', 'confirm', {
                    onConfirm: () => performDeletePayment(numId)
                });
            }
        }

        function closeDeleteScopeModal() {
            document.getElementById('deleteScopeModal').classList.remove('active');
            pendingDeletePaymentId = null;
        }

        function deleteThisEventOnly() {
            const paymentId = pendingDeletePaymentId;
            closeDeleteScopeModal();

            const payment = data.payments.find(p => p.id === paymentId);
            if (payment) {
                addHistory('Deleted', `${payment.description} - $${payment.amount}`);
                data.payments = data.payments.filter(p => p.id !== paymentId);
                saveData();
                smartRefresh();
            }
        }

        function deleteAllFutureEvents() {
            const paymentId = pendingDeletePaymentId;
            closeDeleteScopeModal();

            const payment = data.payments.find(p => p.id === paymentId);
            if (!payment || !payment.recurringGroupId) {
                // No group, just delete this one
                performDeletePayment(paymentId);
                return;
            }

            const currentDate = payment.dueDate;
            const groupId = payment.recurringGroupId;

            // Find and delete all future payments in the group
            const toDelete = data.payments.filter(p =>
                p.recurringGroupId === groupId && p.dueDate >= currentDate
            );

            toDelete.forEach(p => {
                data.payments = data.payments.filter(pay => pay.id !== p.id);
            });

            addHistory('Deleted Future Events', `${toDelete.length} occurrences of "${payment.description}" deleted`);
            saveData();
            smartRefresh();
        }

        function performDeletePayment(id) {
            const numId = typeof id === 'string' ? parseInt(id) : id;
            const payment = data.payments.find(p => p.id === numId || p.id === id);
            if (payment) {
                const deletedPayment = {...payment};
                addHistory('Deleted', `${payment.description} - $${payment.amount}`);
                data.payments = data.payments.filter(p => p.id !== numId && p.id !== id);
                EventBus.emit('payment:deleted', { paymentId: numId });
                saveData();
                smartRefresh();
                showToast(`"${deletedPayment.description}" deleted`, 'undo', {
                    onUndo: () => {
                        data.payments.push(deletedPayment);
                        saveData();
                        smartRefresh();
                        showToast('Payment restored', 'success');
                    }
                });
            }
        }

        // Emergency Expense Modal Functions
        function openEmergencyModal(id = null) {
            const modal = document.getElementById('emergencyModal');
            const form = document.getElementById('emergencyForm');
            const modalTitle = document.getElementById('emergencyModalTitle');

            form.reset();
            editingEmergencyId = id;

            if (id) {
                // Edit mode - populate form with existing data
                const expense = data.emergencyExpenses.find(e => e.id === id);
                if (expense) {
                    document.getElementById('emergencyDescription').value = expense.description;
                    document.getElementById('emergencyCategory').value = expense.category;
                    document.getElementById('emergencyAmount').value = expense.amount;
                    document.getElementById('emergencyDate').value = expense.date;
                    document.getElementById('emergencyNotes').value = expense.notes || '';
                    document.getElementById('emergencyStatus').value = expense.status || 'pending';
                    modalTitle.textContent = 'Edit Emergency Expense';
                }
            } else {
                // Add mode - set defaults
                document.getElementById('emergencyDate').valueAsDate = new Date();
                document.getElementById('emergencyStatus').value = 'pending';
                modalTitle.textContent = 'Add Emergency Expense';
            }

            modal.classList.add('active');
        }

        function closeEmergencyModal() {
            document.getElementById('emergencyModal').classList.remove('active');
            document.getElementById('emergencyForm').reset();
            editingEmergencyId = null;
        }

        function editEmergencyExpense(id) {
            openEmergencyModal(id);
        }

        function saveEmergencyExpense(event) {
            event.preventDefault();

            const description = document.getElementById('emergencyDescription').value.trim();
            const category = document.getElementById('emergencyCategory').value;
            const amount = parseFloat(document.getElementById('emergencyAmount').value);
            const date = document.getElementById('emergencyDate').value;
            const notes = document.getElementById('emergencyNotes').value.trim();
            const status = document.getElementById('emergencyStatus').value;

            if (editingEmergencyId) {
                // Edit existing expense
                const expense = data.emergencyExpenses.find(e => e.id === editingEmergencyId);
                if (expense) {
                    expense.description = description;
                    expense.category = category;
                    expense.amount = amount;
                    expense.date = date;
                    expense.notes = notes;
                    expense.status = status;
                    addHistory('emergency-edited', `Edited emergency expense: ${description} - $${formatMoney(amount)}`);
                }
                editingEmergencyId = null;
            } else {
                // Create new expense
                const expense = {
                    id: Date.now(),
                    description: description,
                    category: category,
                    amount: amount,
                    date: date,
                    notes: notes,
                    status: status,
                    createdAt: Date.now()
                };
                data.emergencyExpenses.push(expense);
                addHistory('emergency-added', `Added emergency expense: ${description} - $${formatMoney(amount)}`);
            }

            saveData();
            closeEmergencyModal();
            smartRefresh();
        }

        function deleteEmergencyExpense(id) {
            const expense = data.emergencyExpenses.find(e => e.id === id);
            if (!expense) return;

            showToast(`Delete emergency expense: ${expense.description}?`, 'confirm', {
                onConfirm: () => {
                    const deleted = {...expense};
                    data.emergencyExpenses = data.emergencyExpenses.filter(e => e.id !== id);
                    saveData();
                    addHistory('emergency-deleted', `Deleted emergency expense: ${expense.description}`);
                    EventBus.emit('emergency:changed', { expense: deleted });
                    smartRefresh();
                    showToast('Emergency expense deleted', 'undo', {
                        onUndo: () => {
                            data.emergencyExpenses.push(deleted);
                            saveData();
                            smartRefresh();
                            showToast('Emergency expense restored', 'success');
                        }
                    });
                }
            });
        }

        function toggleEmergencyStatus(id) {
            const expense = data.emergencyExpenses.find(e => e.id === id);
            if (!expense) return;

            expense.status = expense.status === 'paid' ? 'pending' : 'paid';
            saveData();
            addHistory('emergency-status-changed', `Marked "${expense.description}" as ${expense.status}`);
            smartRefresh();
        }

        // History
        function renderHistory() {
            const historyList = document.getElementById('historyList');

            if (!historyList) return;

            if (data.history.length === 0) {
                historyList.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon"></div>
                        <div class="history-empty-title">No Activity Yet</div>
                        <div class="history-empty-text">Your payment activity will appear here</div>
                    </div>
                `;
                return;
            }

            // Action icon mapping
            const actionIcons = {
                'Payment Added': { icon: '', class: 'added' },
                'Payment Edited': { icon: '', class: 'edited' },
                'Payment Deleted': { icon: '', class: 'deleted' },
                'Payment Paid': { icon: '', class: 'paid' },
                'Payment Unpaid': { icon: '', class: 'unpaid' },
                'Emergency Added': { icon: '', class: 'emergency' },
                'Emergency Edited': { icon: '', class: 'edited' },
                'Emergency Deleted': { icon: '', class: 'deleted' },
                'Emergency Paid': { icon: '', class: 'paid' },
                'Data Imported': { icon: '', class: 'imported' },
                'Data Exported': { icon: '', class: 'exported' }
            };

            // Group items by date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const groups = {
                today: [],
                yesterday: [],
                earlier: []
            };

            data.history.forEach(item => {
                const itemDate = new Date(item.timestamp);
                itemDate.setHours(0, 0, 0, 0);

                if (itemDate.getTime() === today.getTime()) {
                    groups.today.push(item);
                } else if (itemDate.getTime() === yesterday.getTime()) {
                    groups.yesterday.push(item);
                } else {
                    groups.earlier.push(item);
                }
            });

            let html = '';

            // Render each group
            const renderGroup = (items, label) => {
                if (items.length === 0) return '';

                let groupHtml = `<div class="history-date-group">${label}</div>`;

                items.forEach(item => {
                    const date = new Date(item.timestamp);
                    const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    const actionConfig = actionIcons[item.action] || { icon: '', class: 'default' };

                    groupHtml += `
                        <div class="history-item">
                            <div class="history-icon ${actionConfig.class}">${actionConfig.icon}</div>
                            <div class="history-content">
                                <div class="history-action-text">${item.action}</div>
                                <div class="history-details-text">${item.details}</div>
                            </div>
                            <div class="history-time">${timeStr}</div>
                        </div>
                    `;
                });

                return groupHtml;
            };

            html += renderGroup(groups.today, 'Today');
            html += renderGroup(groups.yesterday, 'Yesterday');
            html += renderGroup(groups.earlier, 'Earlier');

            historyList.innerHTML = html;
        }

        function clearHistory() {
            showToast('Clear all history? This cannot be undone.', 'confirm', {
                onConfirm: () => {
                    data.history = [];
                    saveData();
                    renderHistory();
                    showToast('History cleared', 'success');
                }
            });
        }

        // ==================== GOALS FUNCTIONS ====================

        let editingGoalId = null;
        let goalImageData = null;

        const categoryConfig = {
            investment: { icon: '', label: 'Investment', emoji: '' },
            achievement: { icon: '', label: 'Achievement', emoji: '' },
            life: { icon: '', label: 'Life Goal', emoji: '' }
        };

        function renderGoals() {
            const spotlight = document.getElementById('goalsSpotlight');
            const grid = document.getElementById('goalsGrid');
            const otherLabel = document.getElementById('otherGoalsLabel');

            if (!spotlight || !grid) return;

            // Ensure goals array exists
            if (!data.goals) data.goals = [];

            // Find focused goal
            const focusedGoal = data.goals.find(g => g.id === data.focusedGoalId);
            const otherGoals = data.goals.filter(g => g.id !== data.focusedGoalId);

            // Render spotlight area
            if (data.goals.length === 0) {
                // Empty state - no goals
                spotlight.innerHTML = `
                    <div class="spotlight-empty">
                        <div class="spotlight-empty-icon"></div>
                        <div class="spotlight-empty-title">What are you working towards?</div>
                        <div class="spotlight-empty-text">Upload an image of your dream and start tracking your journey to achieving it.</div>
                        <button class="spotlight-empty-btn" onclick="openGoalModal()">
                            <span>+</span> Create First Goal
                        </button>
                    </div>
                `;
                otherLabel.style.display = 'none';
                grid.innerHTML = '';
            } else if (focusedGoal) {
                // Render focused goal in spotlight
                const progress = focusedGoal.targetAmount > 0
                    ? Math.min(100, (focusedGoal.currentAmount / focusedGoal.targetAmount) * 100)
                    : 0;
                const cat = categoryConfig[focusedGoal.category] || categoryConfig.life;

                spotlight.innerHTML = `
                    <div class="spotlight-container">
                        <div class="spotlight-image-side">
                            ${focusedGoal.image
                                ? `<img src="${focusedGoal.image}" alt="${focusedGoal.name}" class="spotlight-image">`
                                : `<div class="spotlight-no-image-side ${focusedGoal.category}">${cat.emoji}</div>`
                            }
                        </div>
                        <div class="spotlight-content">
                            <div class="spotlight-category ${focusedGoal.category}">
                                <span>${cat.icon}</span>
                                <span>${cat.label}</span>
                            </div>
                            <div class="spotlight-name">${focusedGoal.name}</div>
                            ${focusedGoal.description
                                ? `<div class="spotlight-description">${focusedGoal.description}</div>`
                                : ''}
                            <div class="spotlight-stats-row">
                                <div class="spotlight-stat">
                                    <div class="spotlight-stat-value green">$${focusedGoal.currentAmount.toLocaleString()}</div>
                                    <div class="spotlight-stat-label">Saved</div>
                                </div>
                                <div class="spotlight-stat">
                                    <div class="spotlight-stat-value purple">${progress.toFixed(0)}%</div>
                                    <div class="spotlight-stat-label">Progress</div>
                                </div>
                                <div class="spotlight-stat">
                                    <div class="spotlight-stat-value">$${focusedGoal.targetAmount.toLocaleString()}</div>
                                    <div class="spotlight-stat-label">Target</div>
                                </div>
                            </div>
                            <div class="spotlight-progress-wrapper">
                                <div class="spotlight-progress-bar">
                                    <div class="spotlight-progress-fill ${focusedGoal.category}" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="spotlight-actions">
                                <button class="spotlight-btn spotlight-btn-primary" onclick="openUpdateProgressModal(${focusedGoal.id})">
                                     Update
                                </button>
                                <button class="spotlight-btn spotlight-btn-secondary" onclick="editGoal(${focusedGoal.id})">
                                     Edit
                                </button>
                                <button class="spotlight-btn spotlight-btn-danger" onclick="deleteGoal(${focusedGoal.id})">
                                    
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Show other goals section if there are other goals
                if (otherGoals.length > 0) {
                    otherLabel.style.display = 'flex';
                } else {
                    otherLabel.style.display = 'none';
                }
            } else if (data.goals.length > 0) {
                // No focused goal but goals exist - show prompt
                spotlight.innerHTML = `
                    <div class="spotlight-empty">
                        <div class="spotlight-empty-icon"></div>
                        <div class="spotlight-empty-title">Set a Focus Goal</div>
                        <div class="spotlight-empty-text">Click "Set as Focus" on any goal below to feature it here.</div>
                    </div>
                `;
                otherLabel.style.display = 'flex';
            }

            // Render goal cards
            let gridHtml = '';

            // Render other goals (or all goals if no focused)
            const goalsToShow = focusedGoal ? otherGoals : data.goals;

            goalsToShow.forEach(goal => {
                const progress = goal.targetAmount > 0
                    ? Math.min(100, (goal.currentAmount / goal.targetAmount) * 100)
                    : 0;
                const cat = categoryConfig[goal.category] || categoryConfig.life;

                gridHtml += `
                    <div class="goal-card" onclick="setFocusGoal(${goal.id})">
                        ${goal.image
                            ? `<img src="${goal.image}" alt="${goal.name}" class="goal-card-image">`
                            : `<div class="goal-card-no-image ${goal.category}">${cat.emoji}</div>`
                        }
                        <div class="goal-card-content">
                            <div class="goal-card-category spotlight-category ${goal.category}">
                                <span>${cat.icon}</span>
                                <span>${cat.label}</span>
                            </div>
                            <div class="goal-card-name">${goal.name}</div>
                            <div class="goal-card-progress">
                                <div class="goal-card-progress-bar">
                                    <div class="goal-card-progress-fill ${goal.category}" style="width: ${progress}%"></div>
                                </div>
                                <div class="goal-card-amounts">
                                    <span class="goal-card-current">$${goal.currentAmount.toLocaleString()}</span>
                                    <span class="goal-card-percent">${progress.toFixed(0)}%</span>
                                </div>
                            </div>
                            <div class="goal-card-actions" onclick="event.stopPropagation()">
                                <button class="goal-card-btn goal-card-btn-focus" onclick="setFocusGoal(${goal.id})">
                                     Set Focus
                                </button>
                                <button class="goal-card-btn goal-card-btn-edit" onclick="editGoal(${goal.id})">
                                    
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add "Add Goal" card
            gridHtml += `
                <div class="goal-add-card" onclick="openGoalModal()">
                    <div class="goal-add-card-icon"></div>
                    <div class="goal-add-card-text">Add New Goal</div>
                    <div class="goal-add-card-hint">Track your dreams</div>
                </div>
            `;

            grid.innerHTML = gridHtml;
        }

        function openGoalModal() {
            editingGoalId = null;
            goalImageData = null;
            document.getElementById('goalForm').reset();
            document.getElementById('goalModalTitle').textContent = 'Add New Goal';
            document.getElementById('goalImagePreview').style.display = 'none';
            document.getElementById('goalImagePlaceholder').style.display = 'flex';
            document.getElementById('goalCurrentAmount').value = '0';
            document.getElementById('goalModal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
            editingGoalId = null;
            goalImageData = null;
        }

        function handleGoalImageUpload(event) {
            const file = event.target.files ? event.target.files[0] : event;
            if (!file) return;

            processGoalImage(file);
        }

        function processGoalImage(file) {
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image is too large. Please choose an image under 2MB.', 'warning');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress image
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Calculate new dimensions (max 800px width)
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 800;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Get compressed data
                    goalImageData = canvas.toDataURL('image/jpeg', 0.7);

                    // Show preview
                    document.getElementById('goalPreviewImg').src = goalImageData;
                    document.getElementById('goalImagePreview').style.display = 'block';
                    document.getElementById('goalImagePlaceholder').style.display = 'none';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Setup drag and drop for goal image upload
        function setupGoalImageDragDrop() {
            const uploadZone = document.getElementById('goalImageUpload');
            if (!uploadZone) return;

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'rgba(99, 102, 241, 0.6)';
                uploadZone.style.background = 'rgba(99, 102, 241, 0.1)';
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '';
                uploadZone.style.background = '';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '';
                uploadZone.style.background = '';

                const file = e.dataTransfer.files[0];
                if (file) {
                    processGoalImage(file);
                }
            });
        }

        function removeGoalImage() {
            goalImageData = null;
            document.getElementById('goalImageInput').value = '';
            document.getElementById('goalImagePreview').style.display = 'none';
            document.getElementById('goalImagePlaceholder').style.display = 'flex';
        }

        function saveGoal(event) {
            event.preventDefault();

            const name = document.getElementById('goalName').value.trim();
            const description = document.getElementById('goalDescription').value.trim();
            const category = document.getElementById('goalCategory').value;
            const targetDate = document.getElementById('goalTargetDate').value;
            const targetAmount = parseFloat(document.getElementById('goalTargetAmount').value) || 0;
            const currentAmount = parseFloat(document.getElementById('goalCurrentAmount').value) || 0;
            const notes = document.getElementById('goalNotes').value.trim();

            if (!name || targetAmount <= 0) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            if (editingGoalId) {
                // Update existing goal
                const goal = data.goals.find(g => g.id === editingGoalId);
                if (goal) {
                    goal.name = name;
                    goal.description = description;
                    goal.category = category;
                    goal.targetDate = targetDate;
                    goal.targetAmount = targetAmount;
                    goal.currentAmount = currentAmount;
                    goal.notes = notes;
                    if (goalImageData) {
                        goal.image = goalImageData;
                    }
                    goal.updatedAt = new Date().toISOString();

                    addHistory('Goal Edited', `Updated goal "${name}"`);
                }
            } else {
                // Create new goal
                const newGoal = {
                    id: Date.now(),
                    name,
                    description,
                    category,
                    targetDate,
                    targetAmount,
                    currentAmount,
                    notes,
                    image: goalImageData,
                    createdAt: new Date().toISOString()
                };

                data.goals.push(newGoal);

                // Auto-focus if it's the first goal
                if (data.goals.length === 1) {
                    data.focusedGoalId = newGoal.id;
                }

                addHistory('Goal Added', `Created new goal "${name}"`);
            }

            saveData();
            closeGoalModal();
            renderGoals();
        }

        function editGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            if (!goal) return;

            editingGoalId = id;
            goalImageData = goal.image || null;

            document.getElementById('goalModalTitle').textContent = 'Edit Goal';
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalDescription').value = goal.description || '';
            document.getElementById('goalCategory').value = goal.category;
            document.getElementById('goalTargetDate').value = goal.targetDate || '';
            document.getElementById('goalTargetAmount').value = goal.targetAmount;
            document.getElementById('goalCurrentAmount').value = goal.currentAmount;
            document.getElementById('goalNotes').value = goal.notes || '';

            if (goal.image) {
                document.getElementById('goalPreviewImg').src = goal.image;
                document.getElementById('goalImagePreview').style.display = 'block';
                document.getElementById('goalImagePlaceholder').style.display = 'none';
            } else {
                document.getElementById('goalImagePreview').style.display = 'none';
                document.getElementById('goalImagePlaceholder').style.display = 'flex';
            }

            document.getElementById('goalModal').classList.add('active');
        }

        function deleteGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            if (!goal) return;

            showToast(`Delete goal "${goal.name}"?`, 'confirm', {
                onConfirm: () => {
                    const deleted = {...goal};
                    data.goals = data.goals.filter(g => g.id !== id);
                    if (data.focusedGoalId === id) {
                        data.focusedGoalId = data.goals.length > 0 ? data.goals[0].id : null;
                    }
                    addHistory('Goal Deleted', `Removed goal "${goal.name}"`);
                    EventBus.emit('goal:changed', { goal: deleted });
                    saveData();
                    renderGoals();
                    showToast('Goal deleted', 'undo', {
                        onUndo: () => {
                            data.goals.push(deleted);
                            data.focusedGoalId = deleted.id;
                            saveData();
                            renderGoals();
                            showToast('Goal restored', 'success');
                        }
                    });
                }
            });
        }

        function setFocusGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            if (!goal) return;

            data.focusedGoalId = id;
            saveData();
            renderGoals();

            // Scroll to top to show spotlight
            document.getElementById('goals').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openUpdateProgressModal(id) {
            const goal = data.goals.find(g => g.id === id);
            if (!goal) return;

            const newAmount = prompt(
                `Update Progress for "${goal.name}"\n\nCurrent: $${goal.currentAmount.toLocaleString()}\nTarget: $${goal.targetAmount.toLocaleString()}\n\nEnter new amount:`,
                goal.currentAmount
            );

            if (newAmount === null) return;

            const amount = parseFloat(newAmount);
            if (isNaN(amount) || amount < 0) {
                showToast('Please enter a valid amount.', 'error');
                return;
            }

            const oldAmount = goal.currentAmount;
            goal.currentAmount = amount;
            goal.updatedAt = new Date().toISOString();

            const diff = amount - oldAmount;
            const diffStr = diff >= 0 ? `+$${diff.toLocaleString()}` : `-$${Math.abs(diff).toLocaleString()}`;
            addHistory('Goal Progress', `${goal.name}: ${diffStr} (now $${amount.toLocaleString()})`);

            saveData();
            renderGoals();

            // Check if goal completed
            if (amount >= goal.targetAmount && oldAmount < goal.targetAmount) {
                setTimeout(() => {
                    showToast(` Congratulations! You've reached your goal: "${goal.name}"!`, 'success', { timeout: 6000 });
                }, 300);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;

            return date.toLocaleDateString();
        }

        // Export/Import Functions
        function exportData() {
            try {
                // Create export object with metadata
                const exportObj = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    data: data
                };

                // Convert to JSON
                const dataStr = JSON.stringify(exportObj, null, 2);

                // Create blob and download
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                // Use current date for filename
                const dateStr = new Date().toISOString().split('T')[0];
                link.download = `payment-tracker-backup-${dateStr}.json`;
                link.href = url;
                link.click();

                URL.revokeObjectURL(url);

                showToast('Data exported successfully! Keep the file safe.', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        }

        function importData() {
            showToast('Import will replace ALL current data. Continue?', 'confirm', {
                onConfirm: () => document.getElementById('importFile').click()
            });
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedObj = JSON.parse(e.target.result);

                    // Validate structure
                    let importedData;
                    if (importedObj.version && importedObj.data) {
                        // New format with metadata
                        importedData = importedObj.data;
                    } else if (importedObj.payments) {
                        // Direct data format
                        importedData = importedObj;
                    } else {
                        throw new Error('Invalid data format');
                    }

                    // Validate required fields
                    if (!Array.isArray(importedData.payments)) {
                        throw new Error('Invalid payments data');
                    }

                    // Ensure all payments have required fields
                    importedData.payments.forEach(p => {
                        if (!p.id || !p.description || !p.person || !p.dueDate) {
                            throw new Error('Payment missing required fields');
                        }
                        // Add default values for new fields if missing
                        if (p.isFlagged === undefined) p.isFlagged = false;
                        if (!p.category) p.category = 'Personal';
                        if (!p.type) p.type = 'i-owe';
                        if (!p.status) p.status = 'pending';
                    });

                    // Set defaults for optional fields
                    if (!importedData.history) importedData.history = [];
                    if (importedData.twoMonthSavings === undefined) importedData.twoMonthSavings = 0;
                    if (importedData.sixMonthSavings === undefined) importedData.sixMonthSavings = 0;

                    // Import successful
                    data = importedData;
                    saveData();
                    renderDashboard();
                    renderPayments();
                    renderHistory();
                    renderCalendar();

                    EventBus.emit('data:imported', {});
                    showToast(`Import successful! ${data.payments.length} payments imported.`, 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showToast(`Error importing data: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // 
        // Phase 2C: Keyboard Shortcuts (v2.0)
        // 
        function handleGlobalKeyboard(e) {
            const tag = document.activeElement?.tagName?.toLowerCase();
            const isTyping = tag === 'input' || tag === 'textarea' || document.activeElement?.contentEditable === 'true';

            // Escape always works - close modals/drawers/toasts/command palette
            if (e.key === 'Escape') {
                const commandPalette = document.getElementById('commandPalette');
                if (commandPalette?.classList.contains('active')) {
                    closeCommandPalette();
                    return;
                }
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    return;
                }
                // Dismiss newest toast
                if (activeToasts.length > 0) {
                    dismissToast(activeToasts[activeToasts.length - 1].id);
                    return;
                }
            }

            // Ctrl+K / Cmd+K  Command Palette
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openCommandPalette();
                return;
            }

            // Don't trigger shortcuts while typing
            if (isTyping) return;

            // /  Focus search
            if (e.key === '/') {
                e.preventDefault();
                const searchInput = document.getElementById('searchInput') || document.getElementById('paymentSearch');
                if (searchInput) {
                    if (currentActiveTab !== 'payments') switchTab('payments');
                    setTimeout(() => searchInput.focus(), 100);
                }
                return;
            }

            // N  New payment
            if (e.key === 'n' || e.key === 'N') {
                e.preventDefault();
                showAddModal();
                return;
            }

            // 1-5  Switch tabs
            const tabMap = { '1': 'dashboard', '2': 'calendar', '3': 'payments', '4': 'goals', '5': 'history' };
            if (tabMap[e.key]) {
                e.preventDefault();
                switchTab(tabMap[e.key]);
                return;
            }

            // Arrow keys for calendar navigation
            if (currentActiveTab === 'calendar') {
                if (e.key === 'ArrowLeft') { e.preventDefault(); prevMonth(); return; }
                if (e.key === 'ArrowRight') { e.preventDefault(); nextMonth(); return; }
            }

            // ?  Show shortcut hint
            if (e.key === '?') {
                e.preventDefault();
                showShortcutHint();
                return;
            }
        }

        function showShortcutHint() {
            const hint = document.getElementById('shortcutHint');
            if (!hint) return;
            hint.textContent = 'N: New payment  /: Search  1-5: Switch tabs  : Calendar months  Ctrl+K: Command palette  ?: This help';
            hint.classList.add('visible');
            setTimeout(() => hint.classList.remove('visible'), 4000);
        }

        // 
        // Phase 3A: Monthly Spend Trend Chart (v2.0)
        // 
        let trendChart = null;
        let donutChart = null;
        let cashflowChart = null;

        function renderCharts() {
            renderTrendChart();
            renderDonutChart();
            renderInsights();
        }

        function renderTrendChart() {
            const canvas = document.getElementById('trendChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const months = getLastNMonths(6);
            const owedData = [];
            const paidData = [];

            months.forEach(m => {
                const monthPayments = data.payments.filter(p =>
                    p.dueDate && p.dueDate.startsWith(m.key) && p.type === 'i-owe'
                );
                owedData.push(monthPayments.reduce((s, p) => s + parseFloat(p.amount || 0), 0));
                paidData.push(monthPayments.filter(p => p.status === 'paid')
                    .reduce((s, p) => s + parseFloat(p.amount || 0), 0));
            });

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        {
                            label: 'Total Owed',
                            data: owedData,
                            backgroundColor: 'rgba(129, 140, 248, 0.4)',
                            borderColor: 'rgba(129, 140, 248, 1)',
                            borderWidth: 1,
                            borderRadius: 6,
                            order: 2
                        },
                        {
                            label: 'Total Paid',
                            data: paidData,
                            type: 'line',
                            borderColor: 'rgba(52, 211, 153, 1)',
                            backgroundColor: 'rgba(52, 211, 153, 0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(52, 211, 153, 1)',
                            fill: true,
                            tension: 0.3,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.5)' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255,255,255,0.5)',
                                callback: v => '$' + v.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        // Phase 3B: Category Breakdown Donut
        function renderDonutChart() {
            const canvas = document.getElementById('donutChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const catTotals = {};
            data.payments.filter(p => p.type === 'i-owe').forEach(p => {
                const cat = p.subcategory || 'Uncategorized';
                catTotals[cat] = (catTotals[cat] || 0) + parseFloat(p.amount || 0);
            });

            const labels = Object.keys(catTotals);
            const values = Object.values(catTotals);
            const colors = [
                'rgba(129, 140, 248, 0.8)', 'rgba(52, 211, 153, 0.8)',
                'rgba(251, 191, 36, 0.8)', 'rgba(248, 113, 113, 0.8)',
                'rgba(34, 211, 238, 0.8)', 'rgba(167, 139, 250, 0.8)',
                'rgba(253, 186, 116, 0.8)', 'rgba(134, 239, 172, 0.8)',
                'rgba(147, 197, 253, 0.8)', 'rgba(252, 165, 165, 0.8)'
            ];

            if (donutChart) donutChart.destroy();
            if (labels.length === 0) {
                canvas.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:0.85rem;">No category data yet</div>';
                return;
            }

            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: 'rgba(17, 24, 39, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'rgba(255,255,255,0.7)',
                                font: { size: 11 },
                                padding: 12,
                                usePointStyle: true,
                                pointStyleWidth: 8
                            }
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const category = labels[idx];
                            // Switch to payments tab filtered by this category
                            switchTab('payments');
                            setTimeout(() => {
                                const searchInput = document.getElementById('paymentSearch');
                                if (searchInput) {
                                    searchInput.value = category;
                                    filterPayments();
                                }
                            }, 100);
                        }
                    }
                }
            });
        }

        function getLastNMonths(n) {
            const months = [];
            const now = new Date();
            for (let i = n - 1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleDateString('en-US', { month: 'short' })
                });
            }
            return months;
        }

        // Phase 3C: Smart Insights
        function renderInsights() {
            const container = document.getElementById('insightsStrip');
            if (!container) return;

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const insights = [];

            // Due in 48 hours
            const in48h = new Date(today.getTime() + 48 * 60 * 60 * 1000).toISOString().split('T')[0];
            const dueSoon = data.payments.filter(p =>
                p.type === 'i-owe' && p.status === 'pending' &&
                p.dueDate >= todayStr && p.dueDate <= in48h
            );
            if (dueSoon.length > 0) {
                const total = dueSoon.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
                insights.push({
                    label: 'Due in 48 Hours',
                    value: `${dueSoon.length} payment${dueSoon.length > 1 ? 's' : ''}`,
                    detail: `Totaling $${formatMoney(total)}`,
                    color: 'var(--warning)'
                });
            }

            // Month comparison
            const curMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const prevDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const prevMonth = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
            const curTotal = data.payments.filter(p => p.dueDate?.startsWith(curMonth) && p.type === 'i-owe')
                .reduce((s, p) => s + parseFloat(p.amount || 0), 0);
            const prevTotal = data.payments.filter(p => p.dueDate?.startsWith(prevMonth) && p.type === 'i-owe')
                .reduce((s, p) => s + parseFloat(p.amount || 0), 0);

            if (prevTotal > 0) {
                const pctChange = ((curTotal - prevTotal) / prevTotal * 100).toFixed(0);
                const direction = curTotal > prevTotal ? 'higher' : 'lower';
                const arrow = curTotal > prevTotal ? '' : '';
                const color = curTotal > prevTotal ? 'var(--danger)' : 'var(--success)';
                insights.push({
                    label: 'vs Last Month',
                    value: `${arrow} ${Math.abs(pctChange)}%`,
                    detail: `Bills are ${direction} this month`,
                    color
                });
            }

            // Payment progress this month
            const curMonthPayments = data.payments.filter(p =>
                p.dueDate?.startsWith(curMonth) && p.type === 'i-owe'
            );
            const paidCount = curMonthPayments.filter(p => p.status === 'paid').length;
            const totalCount = curMonthPayments.length;
            if (totalCount > 0) {
                const pct = Math.round(paidCount / totalCount * 100);
                insights.push({
                    label: 'Monthly Progress',
                    value: `${pct}% complete`,
                    detail: `${paidCount} of ${totalCount} payments paid`,
                    color: pct >= 75 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--info)'
                });
            }

            // Top spending category
            const catTotals = {};
            data.payments.filter(p => p.type === 'i-owe' && p.dueDate?.startsWith(curMonth))
                .forEach(p => {
                    const cat = p.subcategory || 'Uncategorized';
                    catTotals[cat] = (catTotals[cat] || 0) + parseFloat(p.amount || 0);
                });
            const topCat = Object.entries(catTotals).sort((a, b) => b[1] - a[1])[0];
            if (topCat) {
                insights.push({
                    label: 'Top Category',
                    value: topCat[0],
                    detail: `$${formatMoney(topCat[1])} this month`,
                    color: 'var(--accent-violet)'
                });
            }

            // Overdue count
            const overdue = data.payments.filter(p =>
                p.type === 'i-owe' && p.status === 'pending' && p.dueDate < todayStr
            );
            if (overdue.length > 0) {
                const overdueTotal = overdue.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
                insights.push({
                    label: 'Overdue',
                    value: `${overdue.length} payment${overdue.length > 1 ? 's' : ''}`,
                    detail: `$${formatMoney(overdueTotal)} past due`,
                    color: 'var(--danger)'
                });
            }

            container.innerHTML = insights.length === 0 ?
                '<div class="insight-card"><div class="insight-label">All Clear</div><div class="insight-value"></div><div class="insight-detail">No notable insights right now</div></div>' :
                insights.map(i => `
                    <div class="insight-card">
                        <div class="insight-label">${i.label}</div>
                        <div class="insight-value" style="color: ${i.color}">${i.value}</div>
                        <div class="insight-detail">${i.detail}</div>
                    </div>
                `).join('');
        }

        // Phase 3D: Cash Flow Projection
        function toggleCashflow() {
            const body = document.getElementById('cashflowBody');
            if (!body) return;
            body.classList.toggle('expanded');
            if (body.classList.contains('expanded')) {
                renderCashflowChart();
            }
        }

        function renderCashflowChart() {
            const canvas = document.getElementById('cashflowChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const months = [];
            const now = new Date();

            // Project 3 months ahead
            for (let i = 0; i < 3; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                const owed = data.payments.filter(p =>
                    p.dueDate?.startsWith(key) && p.type === 'i-owe' && p.status === 'pending'
                ).reduce((s, p) => s + parseFloat(p.amount || 0), 0);

                const incoming = data.payments.filter(p =>
                    p.dueDate?.startsWith(key) && p.type === 'owed-to-me' && p.status === 'pending'
                ).reduce((s, p) => s + parseFloat(p.amount || 0), 0);

                months.push({ key, label, owed, incoming, net: incoming - owed });
            }

            if (cashflowChart) cashflowChart.destroy();
            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        {
                            label: 'Outgoing',
                            data: months.map(m => m.owed),
                            backgroundColor: 'rgba(248, 113, 113, 0.5)',
                            borderColor: 'rgba(248, 113, 113, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Incoming',
                            data: months.map(m => m.incoming),
                            backgroundColor: 'rgba(52, 211, 153, 0.5)',
                            borderColor: 'rgba(52, 211, 153, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Net',
                            data: months.map(m => m.net),
                            type: 'line',
                            borderColor: 'rgba(129, 140, 248, 1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: months.map(m =>
                                m.net >= 0 ? 'rgba(52, 211, 153, 1)' : 'rgba(248, 113, 113, 1)'
                            ),
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.5)' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255,255,255,0.5)',
                                callback: v => '$' + v.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        // 
        // Phase 4A: Live Calendar Cell Updates (v2.0)
        // 
        function updateCalendarCell(dateStr) {
            const cell = document.querySelector(`.calendar-cell[data-date="${dateStr}"]`);
            if (!cell) return;

            const dayPayments = data.payments.filter(p => p.dueDate === dateStr);
            const pending = dayPayments.filter(p => p.status === 'pending');
            const paid = dayPayments.filter(p => p.status === 'paid');
            const totalPending = pending.reduce((s, p) => s + parseFloat(p.amount || 0), 0);

            // Update dots
            let dotsHtml = '';
            if (paid.length > 0) dotsHtml += '<span class="cal-dot paid"></span>';
            if (pending.length > 0) dotsHtml += '<span class="cal-dot pending"></span>';

            const dotsContainer = cell.querySelector('.cal-dots');
            if (dotsContainer) dotsContainer.innerHTML = dotsHtml;

            // Update amount badge
            const amountBadge = cell.querySelector('.cal-amount');
            if (amountBadge) {
                if (totalPending > 0) {
                    amountBadge.textContent = '$' + formatMoney(totalPending, 0);
                    amountBadge.style.display = '';
                } else if (paid.length > 0 && pending.length === 0) {
                    amountBadge.textContent = '';
                    amountBadge.style.display = '';
                } else {
                    amountBadge.style.display = 'none';
                }
            }
        }

        // Register EventBus listener for live calendar cell updates
        EventBus.on('payment:statusChanged', ({ payment }) => {
            if (payment.dueDate) updateCalendarCell(payment.dueDate);
        });
        EventBus.on('payment:updated', ({ payment, changes }) => {
            if (payment.dueDate) updateCalendarCell(payment.dueDate);
            if (changes?.dueDate) updateCalendarCell(changes.dueDate);
        });

        // 
        // Phase 4B: Drag-to-Reschedule (v2.0)
        // 
        let draggedPaymentId = null;
        let dragSourceDate = null;

        function calCellDragStart(e, paymentId, dateStr) {
            draggedPaymentId = paymentId;
            dragSourceDate = dateStr;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', paymentId);
            setTimeout(() => {
                const el = e.target;
                if (el) el.classList.add('dragging');
            }, 0);
        }

        function calCellDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.calendar-cell.drag-over').forEach(c => c.classList.remove('drag-over'));
            draggedPaymentId = null;
            dragSourceDate = null;
        }

        function calCellDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const cell = e.target.closest('.calendar-cell');
            if (cell && cell.dataset.date) {
                cell.classList.add('drag-over');
            }
        }

        function calCellDragLeave(e) {
            const cell = e.target.closest('.calendar-cell');
            if (cell) cell.classList.remove('drag-over');
        }

        function calCellDrop(e) {
            e.preventDefault();
            const cell = e.target.closest('.calendar-cell');
            if (!cell || !cell.dataset.date || !draggedPaymentId) return;

            cell.classList.remove('drag-over');
            const newDate = cell.dataset.date;
            if (newDate === dragSourceDate) return;

            const payment = data.payments.find(p => p.id === draggedPaymentId);
            if (!payment) return;

            const oldDate = payment.dueDate;
            payment.dueDate = newDate;
            addHistory('Rescheduled', `${payment.description}: ${oldDate}  ${newDate}`);
            EventBus.emit('payment:updated', { payment, changes: { dueDate: newDate } });
            saveData();

            // Update both cells
            updateCalendarCell(oldDate);
            updateCalendarCell(newDate);
            renderCalendar();

            showToast(`Moved "${payment.description}" to ${newDate}`, 'undo', {
                onUndo: () => {
                    payment.dueDate = oldDate;
                    saveData();
                    renderCalendar();
                    showToast('Reschedule undone', 'success');
                }
            });
        }

        // 
        // Phase 4D: ICS Calendar Export (v2.0)
        // 
        function exportICS(scope = 'pending') {
            let payments;
            if (scope === 'pending') {
                payments = data.payments.filter(p => p.status === 'pending' && p.type === 'i-owe');
            } else if (scope === 'month') {
                const monthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                payments = data.payments.filter(p => p.dueDate?.startsWith(monthStr) && p.type === 'i-owe');
            } else {
                payments = data.payments.filter(p => p.type === 'i-owe');
            }

            if (payments.length === 0) {
                showToast('No payments to export', 'warning');
                return;
            }

            let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Payment Tracker Pro//EN\r\nCALSCALE:GREGORIAN\r\n';

            payments.forEach(p => {
                const dateStr = p.dueDate.replace(/-/g, '');
                const uid = `payment-${p.id}@paymenttracker`;
                const summary = `${p.description} - $${formatMoney(p.amount)}`;
                const description = `Due to: ${p.person} | Category: ${p.category || 'Personal'}${p.subcategory ? ' > ' + p.subcategory : ''}`;

                ics += `BEGIN:VEVENT\r\nDTSTART;VALUE=DATE:${dateStr}\r\nSUMMARY:${summary}\r\nDESCRIPTION:${description}\r\nUID:${uid}\r\nSTATUS:${p.status === 'paid' ? 'COMPLETED' : 'CONFIRMED'}\r\nEND:VEVENT\r\n`;
            });

            ics += 'END:VCALENDAR\r\n';

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `payment-tracker-${scope}-${new Date().toISOString().split('T')[0]}.ics`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            showToast(`Exported ${payments.length} payments to calendar file`, 'success');
        }

        // 
        // Phase 5A: Global Search / Command Palette (v2.0)
        // 
        let commandPaletteIndex = 0;
        let commandPaletteResults = [];

        function openCommandPalette() {
            const overlay = document.getElementById('commandPalette');
            if (!overlay) return;
            overlay.classList.add('active');
            const input = document.getElementById('commandPaletteInput');
            if (input) { input.value = ''; input.focus(); }
            commandPaletteIndex = 0;
            document.getElementById('commandPaletteResults').innerHTML =
                '<div class="command-palette-empty">Type to search across all your data...</div>';
        }

        function closeCommandPalette() {
            const overlay = document.getElementById('commandPalette');
            if (overlay) overlay.classList.remove('active');
        }

        function handleCommandPaletteSearch(query) {
            const resultsContainer = document.getElementById('commandPaletteResults');
            if (!resultsContainer) return;

            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = '<div class="command-palette-empty">Type to search across all your data...</div>';
                commandPaletteResults = [];
                return;
            }

            const q = query.toLowerCase().trim();
            const results = [];

            // Search payments
            data.payments.forEach(p => {
                if (p.description?.toLowerCase().includes(q) ||
                    p.person?.toLowerCase().includes(q) ||
                    p.subcategory?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'payment',
                        icon: p.status === 'paid' ? '' : p.type === 'owed-to-me' ? '' : '',
                        title: p.description,
                        subtitle: `${p.person}  ${p.dueDate}  ${p.status}`,
                        meta: `$${formatMoney(p.amount)}`,
                        action: () => { closeCommandPalette(); editPayment(p.id); }
                    });
                }
            });

            // Search emergency expenses
            data.emergencyExpenses?.forEach(e => {
                if (e.description?.toLowerCase().includes(q) ||
                    e.category?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'emergency',
                        icon: '',
                        title: e.description,
                        subtitle: `${e.category}  ${e.date}  ${e.status}`,
                        meta: `$${formatMoney(e.amount)}`,
                        action: () => { closeCommandPalette(); openEmergencyModal(e.id); }
                    });
                }
            });

            // Search goals
            data.goals?.forEach(g => {
                if (g.name?.toLowerCase().includes(q) ||
                    g.description?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'goal',
                        icon: '',
                        title: g.name,
                        subtitle: g.description || g.category,
                        meta: `$${formatMoney(g.currentAmount || 0)} / $${formatMoney(g.targetAmount)}`,
                        action: () => { closeCommandPalette(); switchTab('goals'); }
                    });
                }
            });

            commandPaletteResults = results;
            commandPaletteIndex = 0;

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="command-palette-empty">No results found</div>';
                return;
            }

            // Group by type
            const grouped = {};
            results.forEach(r => {
                if (!grouped[r.type]) grouped[r.type] = [];
                grouped[r.type].push(r);
            });

            const typeLabels = { payment: 'Payments', emergency: 'Emergency Expenses', goal: 'Goals' };
            let html = '';
            let idx = 0;
            Object.entries(grouped).forEach(([type, items]) => {
                html += `<div class="command-palette-group">
                    <div class="command-palette-group-label">${typeLabels[type] || type} (${items.length})</div>`;
                items.slice(0, 8).forEach(item => {
                    html += `<div class="command-palette-item ${idx === commandPaletteIndex ? 'active' : ''}" 
                                 data-idx="${idx}" onclick="commandPaletteResults[${idx}].action()">
                        <span class="item-icon">${item.icon}</span>
                        <div class="item-text">
                            <div class="item-title">${item.title}</div>
                            <div class="item-subtitle">${item.subtitle}</div>
                        </div>
                        <span class="item-meta">${item.meta}</span>
                    </div>`;
                    idx++;
                });
                html += '</div>';
            });

            resultsContainer.innerHTML = html;
        }

        function handleCommandPaletteKeydown(e) {
            if (e.key === 'Escape') {
                closeCommandPalette();
                return;
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                commandPaletteIndex = Math.min(commandPaletteIndex + 1, commandPaletteResults.length - 1);
                updateCommandPaletteSelection();
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                commandPaletteIndex = Math.max(commandPaletteIndex - 1, 0);
                updateCommandPaletteSelection();
            }
            if (e.key === 'Enter' && commandPaletteResults.length > 0) {
                e.preventDefault();
                commandPaletteResults[commandPaletteIndex]?.action();
            }
        }

        function updateCommandPaletteSelection() {
            document.querySelectorAll('.command-palette-item').forEach((el, i) => {
                el.classList.toggle('active', i === commandPaletteIndex);
            });
            const activeEl = document.querySelector('.command-palette-item.active');
            if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
        }

        // Close command palette on overlay click
        document.addEventListener('click', (e) => {
            const overlay = document.getElementById('commandPalette');
            if (overlay?.classList.contains('active') && e.target === overlay) {
                closeCommandPalette();
            }
        });

        // 
        // Phase 5B: Payment Templates (v2.0)
        // 
        function saveAsTemplate(paymentId) {
            const payment = data.payments.find(p => p.id === paymentId);
            if (!payment) return;

            const template = {
                id: Date.now(),
                name: payment.description,
                description: payment.description,
                person: payment.person,
                amount: payment.amount,
                category: payment.category,
                businessName: payment.businessName || '',
                subcategory: payment.subcategory || '',
                type: payment.type
            };

            data.templates.push(template);
            saveData();
            showToast(`Template "${template.name}" saved`, 'success');
        }

        function deleteTemplate(templateId) {
            data.templates = data.templates.filter(t => t.id !== templateId);
            saveData();
            showToast('Template deleted', 'success');
            renderTemplateDropdown();
        }

        function applyTemplate(templateId) {
            const template = data.templates.find(t => t.id === templateId);
            if (!template) return;

            // Open add modal and pre-fill with template data
            showAddModal();
            setTimeout(() => {
                const fields = {
                    description: template.description,
                    person: template.person,
                    amount: template.amount,
                    category: template.category,
                    businessName: template.businessName,
                    subcategory: template.subcategory,
                    type: template.type
                };
                Object.entries(fields).forEach(([key, value]) => {
                    const el = document.getElementById(key);
                    if (el && value !== undefined) el.value = value;
                });
                // Set today's date as default
                const dateEl = document.getElementById('dueDate');
                if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];

                // Trigger category change to show/hide business name
                const catEl = document.getElementById('category');
                if (catEl) catEl.dispatchEvent(new Event('change'));
            }, 50);

            showToast(`Template "${template.name}" applied`, 'info');
        }

        function renderTemplateDropdown() {
            const menu = document.getElementById('templateDropdownMenu');
            if (!menu) return;

            if (!data.templates || data.templates.length === 0) {
                menu.innerHTML = '<div class="template-menu-item" style="color:var(--text-muted);cursor:default;">No templates saved yet</div>';
                return;
            }

            menu.innerHTML = data.templates.map(t => `
                <div class="template-menu-item" onclick="applyTemplate(${t.id})">
                    <span></span>
                    <span class="template-name">${t.name}</span>
                    <span class="template-amount">$${formatMoney(t.amount)}</span>
                </div>
            `).join('') + `
                <div class="template-menu-divider"></div>
                <div class="template-menu-item" style="font-size:0.8rem;color:var(--text-muted);" onclick="manageTemplates()">
                     <span>Manage Templates</span>
                </div>`;
        }

        function toggleTemplateDropdown() {
            const menu = document.getElementById('templateDropdownMenu');
            if (!menu) return;
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) renderTemplateDropdown();
        }

        function manageTemplates() {
            const menu = document.getElementById('templateDropdownMenu');
            if (menu) menu.classList.remove('active');

            if (!data.templates || data.templates.length === 0) {
                showToast('No templates to manage', 'info');
                return;
            }

            // Show a simple management toast for each template
            let msg = 'Templates: ' + data.templates.map(t => t.name).join(', ');
            showToast(msg, 'info', { timeout: 5000 });
        }

        // 
        // Phase 5C: Merge Import (v2.0)
        // 
        function importDataMerge() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedObj = JSON.parse(e.target.result);
                        let importedData;

                        if (importedObj.version && importedObj.data) {
                            importedData = importedObj.data;
                        } else if (importedObj.payments) {
                            importedData = importedObj;
                        } else {
                            throw new Error('Invalid data format');
                        }

                        if (!Array.isArray(importedData.payments)) {
                            throw new Error('Invalid payments data');
                        }

                        // Deduplicate by description + person + amount + dueDate
                        let newCount = 0;
                        let skipCount = 0;

                        importedData.payments.forEach(imp => {
                            const isDuplicate = data.payments.some(existing =>
                                existing.description === imp.description &&
                                existing.person === imp.person &&
                                parseFloat(existing.amount) === parseFloat(imp.amount) &&
                                existing.dueDate === imp.dueDate
                            );

                            if (!isDuplicate) {
                                // Ensure required fields
                                if (imp.isFlagged === undefined) imp.isFlagged = false;
                                if (!imp.category) imp.category = 'Personal';
                                if (!imp.type) imp.type = 'i-owe';
                                if (!imp.status) imp.status = 'pending';
                                data.payments.push(imp);
                                newCount++;
                            } else {
                                skipCount++;
                            }
                        });

                        saveData();
                        smartRefresh();
                        EventBus.emit('data:imported', {});
                        showToast(`Merge complete: ${newCount} new, ${skipCount} duplicates skipped`, 'success');
                    } catch (error) {
                        console.error('Merge import error:', error);
                        showToast(`Error importing: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }

        // 
        // Phase 5D: Mobile Payment Card Rendering (v2.0)
        // 
        function renderMobilePaymentCards(payments, today) {
            if (!payments || payments.length === 0) return '<div style="padding:2rem;text-align:center;color:var(--text-muted);">No payments found</div>';

            return payments.map(payment => {
                const isPaid = payment.status === 'paid';
                const isOverdue = !isPaid && payment.dueDate < today;
                const amount = payment.isPartialPayment
                    ? (parseFloat(payment.totalAmount) - parseFloat(payment.amountPaid))
                    : parseFloat(payment.amount);

                let statusIcon = '';
                if (isPaid) statusIcon = '';
                else if (isOverdue) statusIcon = '';

                const dueDate = new Date(payment.dueDate + 'T00:00:00');
                const dateStr = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="mobile-payment-card ${isOverdue ? 'overdue' : ''} ${isPaid ? 'paid' : ''}">
                        <div class="mobile-card-top">
                            <div class="mobile-card-desc">
                                ${statusIcon} ${payment.isFlagged ? '' : ''} ${payment.description}
                            </div>
                            <div class="mobile-card-amount" style="color: ${isPaid ? 'var(--success)' : isOverdue ? 'var(--danger)' : 'var(--text-primary)'}">
                                ${payment.type === 'owed-to-me' ? '+' : ''}$${formatMoney(amount)}
                            </div>
                        </div>
                        <div class="mobile-card-meta">
                            <span> ${dateStr}</span>
                            <span> ${payment.person}</span>
                            ${payment.subcategory ? `<span>${payment.subcategory}</span>` : ''}
                        </div>
                        <div class="mobile-card-actions">
                            ${isPaid ?
                                `<button onclick="markAsUnpaid(${payment.id})">Mark Unpaid</button>` :
                                `<button onclick="markAsPaid(${payment.id})"> Mark Paid</button>`
                            }
                            <button onclick="editPayment(${payment.id})"> Edit</button>
                            <button onclick="deletePayment(${payment.id})"></button>
                        </div>
                    </div>`;
            }).join('');
        }

        // 
        // Phase 2B + Integration: Enhanced init() and Event Listeners (v2.0)
        // 

        // Override init to add new v2.0 features
        const originalInit = init;
        function initV2() {
            // Register keyboard shortcuts
            document.addEventListener('keydown', handleGlobalKeyboard);

            // Setup EventBus listeners for dashboard chart updates
            const chartEvents = ['payment:added', 'payment:updated', 'payment:deleted', 'payment:statusChanged', 'data:imported'];
            chartEvents.forEach(evt => {
                EventBus.on(evt, () => {
                    // Debounce chart re-renders
                    clearTimeout(window._chartRenderTimeout);
                    window._chartRenderTimeout = setTimeout(() => {
                        if (currentActiveTab === 'dashboard') renderCharts();
                    }, 300);
                });
            });
        }

        // Initialize on load
        window.addEventListener('load', () => {
            init();
            initV2();
        });
    </script>
</body>
</html>