<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Inventory Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    .modal-overlay { background: rgba(0,0,0,0.5); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.95); } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .animate-fade { animation: fadeIn 0.2s ease-out; }
    .animate-tap { animation: pulse 0.15s ease-out; }
    .animate-pop { animation: pop 0.2s ease-out; }
    .product-card { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    .product-card:active { transform: scale(0.97); }
    .pin-digit { width: 56px; height: 64px; font-size: 24px; }
    .numpad-btn { min-height: 64px; font-size: 24px; }
    * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    .camera-container { position: relative; width: 100%; max-width: 280px; aspect-ratio: 1; border-radius: 50%; overflow: hidden; }
    .camera-container video, .camera-container img { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    /* Table card styles */
    @keyframes statusPulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0); } }
    .status-pulse { animation: statusPulse 2s ease-in-out infinite; }
    .table-card { transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .table-card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15); }
    .table-card:active { transform: scale(0.98); }
    .table-number-badge { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 700; font-size: 1.25rem; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app"></div>

  <script>
    // ===== CATEGORIES =====
    const CATEGORIES = [
      { id: 'liquor', name: 'Liquor', color: 'purple', bgColor: 'bg-purple-100', textColor: 'text-purple-700', borderColor: 'border-purple-300', darkBg: 'bg-purple-600' },
      { id: 'beer', name: 'Beer', color: 'amber', bgColor: 'bg-amber-100', textColor: 'text-amber-700', borderColor: 'border-amber-300', darkBg: 'bg-amber-500' },
      { id: 'fountain', name: 'Fountain Drinks', color: 'cyan', bgColor: 'bg-cyan-100', textColor: 'text-cyan-700', borderColor: 'border-cyan-300', darkBg: 'bg-cyan-500' }
    ];

    // ===== STATE MANAGEMENT =====
    const state = {
      inventory: [],
      changeLog: [],
      todaySales: [],
      staffProfiles: [], // Array of { id, name, pin, photo, role, createdAt } - role: 'foh'|'boh'|'admin'
      tables: [], // Array of { id, number, name, orders: [], total, createdAt, isActive, closedAt, logs: [] }
      tableLogs: [], // All table activity logs (read-only history)
      bohDisbursements: [], // Array of { id, timestamp, productId, productName, category, quantity, staffId, staffName, date }
      currentStaff: null, // Currently logged in staff
      isAuthenticated: false,
      isStaffAuthenticated: false,
      showCost: false,
      searchTerm: '',
      categoryFilter: 'all',
      staffCategoryFilter: 'all',
      bohCategoryFilter: 'all', // BOH category filter
      bohPendingCart: [], // Pending items before confirmation: { productId, productName, category, quantity, image }
      bohShowHistory: false, // Toggle to show today's history
      bohSelectingFoh: false, // Show FOH selection modal
      bohShowSuccess: false, // Show success animation
      bohLastConfirmedFoh: null, // Last FOH employee confirmed to
      currentTab: 'inventory',
      staffView: 'products', // 'products', 'tables', or 'history'
      bohView: 'products', // 'products' or 'history'
      showClosedTables: false, // toggle to show closed tables
      currentModal: null,
      editingItem: null,
      error: '',
      staffPinInput: '',
      lastTappedId: null,
      lastBohTappedId: null, // For BOH tap feedback
      // Staff setup wizard
      setupStep: 'name', // 'name', 'camera', 'pin', 'role', 'confirm'
      newStaffName: '',
      newStaffPhoto: null,
      newStaffPin: '',
      newStaffRole: 'foh', // Default role for new staff
      cameraStream: null,
      // Sale confirmation
      pendingSale: null, // { item, quantity, tableId }
      saleQuantity: 1,
      selectedTableId: null,
      viewingTableId: null,
      // New table creation
      newTableName: '',
      newTableGuestCount: 0,
      // Table editing
      editingTableField: null, // 'name', 'guests', 'notes'
      editTableValue: '',
      // Admin confirmation for protected actions
      pendingAdminAction: null, // { type: 'reopen'|'removeItem', data: {...} }
      adminPasswordInput: '',
      // Order editing
      editingOrderId: null,
      editingOrderQty: 0,
      // Staff management
      editingStaffId: null,
      editingStaffField: null, // 'name', 'photo', 'pin', 'role'
      // Currency settings
      showUSD: false,
      exchangeRate: null, // COP to USD rate
      exchangeRateLastFetch: null
    };

    // ===== UTILITIES =====
    const hashPassword = (password) => {
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString();
    };

    // Format currency - COP is base, USD is converted
    const formatCurrency = (num) => {
      const value = Number(num || 0);
      if (state.showUSD && state.exchangeRate) {
        const usdValue = value / state.exchangeRate;
        return 'US$ ' + usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      // Colombian Peso format: $4.000.000 COP (periods as thousand separators)
      const formatted = value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      return '$' + formatted + ' COP';
    };

    // Fetch live exchange rate from API
    const fetchExchangeRate = async () => {
      try {
        // Check if we fetched recently (cache for 1 hour)
        const lastFetch = state.exchangeRateLastFetch;
        if (lastFetch && (Date.now() - lastFetch) < 3600000 && state.exchangeRate) {
          return state.exchangeRate;
        }

        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await response.json();
        state.exchangeRate = data.rates.COP; // How many COP per 1 USD
        state.exchangeRateLastFetch = Date.now();
        localStorage.setItem('exchangeRate', state.exchangeRate);
        localStorage.setItem('exchangeRateLastFetch', state.exchangeRateLastFetch);
        return state.exchangeRate;
      } catch (error) {
        console.error('Failed to fetch exchange rate:', error);
        // Fallback rate if API fails
        if (!state.exchangeRate) {
          state.exchangeRate = 4100; // Approximate fallback
        }
        return state.exchangeRate;
      }
    };

    // Toggle currency display
    window.toggleCurrency = async () => {
      if (!state.showUSD) {
        // Switching to USD - fetch rate first
        await fetchExchangeRate();
      }
      state.showUSD = !state.showUSD;
      localStorage.setItem('showUSD', state.showUSD);
      render();
    };
    const formatDate = (iso) => new Date(iso).toLocaleDateString();
    const formatDateTime = (iso) => new Date(iso).toLocaleString();
    const formatTime = (iso) => new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Relative time formatter (e.g., "2h 15m ago")
    const formatRelativeTime = (iso) => {
      if (!iso) return '';
      const now = new Date();
      const then = new Date(iso);
      const diffMs = now - then;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) {
        const mins = diffMins % 60;
        return mins > 0 ? `${diffHours}h ${mins}m ago` : `${diffHours}h ago`;
      }
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      return formatDate(iso);
    };

    // Get full timestamp for tooltip
    const getFullTimestamp = (iso) => {
      if (!iso) return '';
      return new Date(iso).toLocaleString([], {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    const getCategoryInfo = (categoryId) => {
      return CATEGORIES.find(c => c.id === categoryId) || CATEGORIES[0];
    };

    const calculateFields = (item) => {
      const totalUnits = (Number(item.numBoxes) || 0) * (Number(item.perBox) || 0);
      const remaining = totalUnits - (Number(item.sold) || 0);
      const expectedValue = (Number(item.sold) || 0) * (Number(item.pricePerUnit) || 0);
      const profit = (Number(item.pricePerUnit) - Number(item.costPerUnit || 0)) * Number(item.sold);
      return { totalUnits, remaining, expectedValue, profit };
    };

    const getTodayKey = () => new Date().toISOString().split('T')[0];

    // ===== LOCAL STORAGE =====
    const saveData = () => {
      localStorage.setItem('inventory_data', JSON.stringify(state.inventory));
      localStorage.setItem('inventory_changelog', JSON.stringify(state.changeLog));
    };

    const saveStaffProfiles = () => {
      localStorage.setItem('staff_profiles', JSON.stringify(state.staffProfiles));
    };

    const saveTodaySales = () => {
      const key = `sales_${getTodayKey()}`;
      localStorage.setItem(key, JSON.stringify(state.todaySales));
    };

    const saveTables = () => {
      const key = `tables_${getTodayKey()}`;
      localStorage.setItem(key, JSON.stringify(state.tables));
    };

    const saveTableLogs = () => {
      const key = `table_logs_${getTodayKey()}`;
      localStorage.setItem(key, JSON.stringify(state.tableLogs));
    };

    // BOH Disbursements persistence
    const saveBohDisbursements = () => {
      const key = `boh_disbursements_${getTodayKey()}`;
      localStorage.setItem(key, JSON.stringify(state.bohDisbursements));
    };

    const loadBohDisbursements = () => {
      const key = `boh_disbursements_${getTodayKey()}`;
      const data = localStorage.getItem(key);
      if (data) state.bohDisbursements = JSON.parse(data);
    };

    const loadTables = () => {
      const key = `tables_${getTodayKey()}`;
      const tables = localStorage.getItem(key);
      if (tables) state.tables = JSON.parse(tables);

      const logsKey = `table_logs_${getTodayKey()}`;
      const logs = localStorage.getItem(logsKey);
      if (logs) state.tableLogs = JSON.parse(logs);
    };

    const addTableLog = (tableNumber, tableName, action, details = '') => {
      const logEntry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        tableNumber,
        tableName: tableName || '',
        action,
        details,
        staffName: state.currentStaff?.name || 'Admin'
      };
      state.tableLogs.unshift(logEntry);
      saveTableLogs();
    };

    const getNextTableNumber = () => {
      if (state.tables.length === 0) return 1;
      const maxNum = Math.max(...state.tables.map(t => t.number));
      return maxNum + 1;
    };

    const addNewTable = (name = '', guestCount = 0) => {
      const newTable = {
        id: Date.now(),
        number: getNextTableNumber(),
        name: name.trim(),
        guestCount: guestCount || 0,
        notes: '',
        orders: [],
        total: 0,
        createdAt: new Date().toISOString(),
        isActive: true,
        closedAt: null,
        // Staff who opened this table
        openedBy: {
          id: state.currentStaff?.id || null,
          name: state.currentStaff?.name || 'Admin',
          photo: state.currentStaff?.photo || null
        }
      };
      state.tables.push(newTable);
      saveTables();
      addTableLog(newTable.number, newTable.name, 'Opened', `Table created${guestCount ? ` for ${guestCount} guests` : ''}`);
      return newTable;
    };

    const updateTable = (tableId, updates) => {
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        const oldName = table.name;
        Object.assign(table, updates);
        saveTables();
        if (updates.name !== undefined && updates.name !== oldName) {
          addTableLog(table.number, table.name, 'Updated', `Name changed to "${updates.name || 'none'}"`);
        }
        if (updates.guestCount !== undefined) {
          addTableLog(table.number, table.name, 'Updated', `Guest count: ${updates.guestCount}`);
        }
        if (updates.notes !== undefined) {
          addTableLog(table.number, table.name, 'Note', updates.notes ? `"${updates.notes}"` : 'Note cleared');
        }
      }
    };

    const removeOrderItem = (tableId, orderId) => {
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        const order = table.orders.find(o => o.id === orderId);
        if (order) {
          // Remove from table orders
          table.orders = table.orders.filter(o => o.id !== orderId);
          table.total = table.orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);

          // Update inventory (add back the sold items)
          state.inventory = state.inventory.map(inv => {
            if (inv.id === order.productId) {
              return { ...inv, sold: Math.max(0, Number(inv.sold || 0) - order.quantity), updatedAt: new Date().toISOString() };
            }
            return inv;
          });

          // Remove from today's sales
          for (let i = 0; i < order.quantity; i++) {
            const saleIndex = state.todaySales.findIndex(s => s.productId === order.productId && s.tableNumber === table.number);
            if (saleIndex !== -1) {
              state.todaySales.splice(saleIndex, 1);
            }
          }

          saveTables();
          saveData();
          saveTodaySales();
          addTableLog(table.number, table.name, 'Removed', `${order.quantity}x ${order.productName} - ${formatCurrency(order.total)}`);
        }
      }
    };

    const reduceOrderQuantity = (tableId, orderId, reduction) => {
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        const order = table.orders.find(o => o.id === orderId);
        if (order && reduction > 0 && reduction < order.quantity) {
          const oldQty = order.quantity;
          const pricePerUnit = Number(order.pricePerUnit) || 0;
          const removedValue = reduction * pricePerUnit;

          // Update order quantity and total
          order.quantity = oldQty - reduction;
          order.total = order.quantity * pricePerUnit;

          // Update table total
          table.total = table.orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);

          // Update inventory (add back the reduced items)
          state.inventory = state.inventory.map(inv => {
            if (inv.id === order.productId) {
              return { ...inv, sold: Math.max(0, Number(inv.sold || 0) - reduction), updatedAt: new Date().toISOString() };
            }
            return inv;
          });

          // Remove from today's sales
          for (let i = 0; i < reduction; i++) {
            const saleIndex = state.todaySales.findIndex(s => s.productId === order.productId && s.tableNumber === table.number);
            if (saleIndex !== -1) {
              state.todaySales.splice(saleIndex, 1);
            }
          }

          saveTables();
          saveData();
          saveTodaySales();
          addTableLog(table.number, table.name, 'Adjusted', `${order.productName}: ${oldQty} â†’ ${order.quantity} (-${reduction})`);
        }
      }
    };

    const getTableDuration = (table) => {
      const start = new Date(table.createdAt);
      const end = table.closedAt ? new Date(table.closedAt) : new Date();
      const diffMs = end - start;
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      if (hours > 0) {
        return `${hours}h ${mins}m`;
      }
      return `${mins}m`;
    };

    const reopenTable = (tableId) => {
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        table.isActive = true;
        table.closedAt = null;
        saveTables();
        addTableLog(table.number, table.name, 'Reopened', `Reopened with ${formatCurrency(table.total)} balance`);
      }
    };

    const getActiveTables = () => {
      return state.tables.filter(t => t.isActive);
    };

    const getClosedTables = () => {
      return state.tables.filter(t => !t.isActive);
    };

    const loadData = () => {
      const inv = localStorage.getItem('inventory_data');
      const log = localStorage.getItem('inventory_changelog');
      const profiles = localStorage.getItem('staff_profiles');

      if (inv) state.inventory = JSON.parse(inv);
      if (log) state.changeLog = JSON.parse(log);
      if (profiles) state.staffProfiles = JSON.parse(profiles);

      const salesKey = `sales_${getTodayKey()}`;
      const sales = localStorage.getItem(salesKey);
      if (sales) state.todaySales = JSON.parse(sales);

      // Load currency settings
      const showUSD = localStorage.getItem('showUSD');
      const exchangeRate = localStorage.getItem('exchangeRate');
      const exchangeRateLastFetch = localStorage.getItem('exchangeRateLastFetch');
      if (showUSD) state.showUSD = showUSD === 'true';
      if (exchangeRate) state.exchangeRate = parseFloat(exchangeRate);
      if (exchangeRateLastFetch) state.exchangeRateLastFetch = parseInt(exchangeRateLastFetch);

      // Load tables
      loadTables();

      // Load BOH disbursements
      loadBohDisbursements();
    };

    const addLogEntry = (action, itemName, details = '') => {
      state.changeLog.unshift({
        id: Date.now(),
        timestamp: new Date().toISOString(),
        action, itemName, details,
        staffName: state.currentStaff?.name || 'Admin'
      });
      state.changeLog = state.changeLog.slice(0, 100);
      saveData();
    };

    // ===== CAMERA FUNCTIONS =====
    const startCamera = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 640 } },
          audio: false
        });
        state.cameraStream = stream;
        render();
        // Need to set video source after render
        setTimeout(() => {
          const video = document.getElementById('cameraPreview');
          if (video) {
            video.srcObject = stream;
            video.play();
          }
        }, 100);
      } catch (err) {
        console.error('Camera error:', err);
        state.error = 'Could not access camera. Please allow camera permissions.';
        render();
      }
    };

    const stopCamera = () => {
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(track => track.stop());
        state.cameraStream = null;
      }
    };

    const capturePhoto = () => {
      const video = document.getElementById('cameraPreview');
      if (!video) return;

      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');

      // Mirror the image horizontally (selfie mode)
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);

      // Calculate crop to make it square (center crop)
      const size = Math.min(video.videoWidth, video.videoHeight);
      const x = (video.videoWidth - size) / 2;
      const y = (video.videoHeight - size) / 2;

      ctx.drawImage(video, x, y, size, size, 0, 0, canvas.width, canvas.height);

      state.newStaffPhoto = canvas.toDataURL('image/jpeg', 0.8);
      stopCamera();
      // If PIN already set (from newPinDetected flow), go to confirm
      state.setupStep = state.newStaffPin ? 'confirm' : 'pin';
      render();
    };

    // ===== ICONS (SVG) =====
    const icons = {
      package: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>`,
      lock: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
      unlock: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>`,
      plus: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>`,
      minus: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>`,
      edit: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>`,
      trash: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`,
      download: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>`,
      search: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>`,
      eye: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>`,
      eyeOff: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>`,
      x: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`,
      check: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`,
      alert: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
      settings: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`,
      wine: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 2h6l1 7c0 3-2.5 5-4 5s-4-2-4-5l1-7zm3 12v8m-3 0h6"/></svg>`,
      beer: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 6h12a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2zm0 0V4h12v2m2 4h2a1 1 0 011 1v4a1 1 0 01-1 1h-2"/></svg>`,
      cup: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 2h8l-1 9c0 2.5-1.5 4-3 4s-3-1.5-3-4L8 2zm4 13v5m-4 0h8"/></svg>`,
      cart: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>`,
      clipboard: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>`,
      backspace: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414-6.414a2 2 0 011.414-.586H19a2 2 0 012 2v10a2 2 0 01-2 2h-8.172a2 2 0 01-1.414-.586L3 12z"/></svg>`,
      camera: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`,
      user: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`,
      userPlus: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>`,
      arrowRight: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>`,
      refresh: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`,
      table: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>`,
      receipt: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/></svg>`,
      checkCircle: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
    };

    // ===== EXCEL EXPORT =====
    const exportToExcel = () => {
      const exportData = state.inventory.map(item => {
        const calc = calculateFields(item);
        const cat = getCategoryInfo(item.category);
        const row = {
          'Category': cat.name,
          'Name': item.name,
          'Initial Amount': item.amount,
          'Bottle Size': item.bottleSize,
          '# of Boxes': item.numBoxes,
          'Per Box': item.perBox,
          'Total Units': calc.totalUnits,
          'Sold': item.sold,
          'Remaining': calc.remaining,
          'Price/Unit': formatCurrency(item.pricePerUnit),
          'Expected Value (Sold)': formatCurrency(calc.expectedValue),
          'Last Updated': formatDateTime(item.updatedAt)
        };
        if (state.isAuthenticated && state.showCost) {
          row['Cost/Unit'] = formatCurrency(item.costPerUnit);
          row['Profit (Sold)'] = formatCurrency(calc.profit);
        }
        return row;
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventory');

      const categorySummary = CATEGORIES.map(cat => {
        const items = state.inventory.filter(i => i.category === cat.id);
        const totals = items.reduce((acc, item) => {
          const calc = calculateFields(item);
          return {
            count: acc.count + 1,
            totalUnits: acc.totalUnits + calc.totalUnits,
            remaining: acc.remaining + calc.remaining,
            expectedValue: acc.expectedValue + calc.expectedValue
          };
        }, { count: 0, totalUnits: 0, remaining: 0, expectedValue: 0 });

        return {
          'Category': cat.name,
          'Products': totals.count,
          'Total Units': totals.totalUnits,
          'Remaining': totals.remaining,
          'Expected Revenue': formatCurrency(totals.expectedValue)
        };
      });
      const catWs = XLSX.utils.json_to_sheet(categorySummary);
      XLSX.utils.book_append_sheet(wb, catWs, 'Category Summary');

      if (state.todaySales.length > 0) {
        const salesData = state.todaySales.map(sale => ({
          'Time': formatTime(sale.timestamp),
          'Product': sale.productName,
          'Category': getCategoryInfo(sale.category).name,
          'Table': sale.tableNumber ? `Table ${sale.tableNumber}` : '-',
          'Price': formatCurrency(sale.price),
          'Staff': sale.staffName || 'Unknown'
        }));
        const salesWs = XLSX.utils.json_to_sheet(salesData);
        XLSX.utils.book_append_sheet(wb, salesWs, "Today's Sales");
      }

      // Add Tables sheet
      if (state.tables.length > 0) {
        const tablesData = state.tables.map(table => ({
          'Table #': table.number,
          'Name': table.name || '-',
          'Guests': table.guestCount || 0,
          'Notes': table.notes || '-',
          'Status': table.isActive ? 'Active' : 'Closed',
          'Orders': table.orders.length,
          'Total': formatCurrency(table.total),
          'Duration': getTableDuration(table),
          'Opened By': table.openedBy?.name || 'Admin',
          'Opened': formatTime(table.createdAt),
          'Closed': table.closedAt ? formatTime(table.closedAt) : '-'
        }));
        const tablesWs = XLSX.utils.json_to_sheet(tablesData);
        XLSX.utils.book_append_sheet(wb, tablesWs, 'Tables');
      }

      // Add Table Logs sheet (read-only history)
      if (state.tableLogs.length > 0) {
        const logsData = state.tableLogs.map(log => ({
          'Time': formatTime(log.timestamp),
          'Table #': log.tableNumber,
          'Table Name': log.tableName || '-',
          'Action': log.action,
          'Details': log.details,
          'Staff': log.staffName
        }));
        const logsWs = XLSX.utils.json_to_sheet(logsData);
        XLSX.utils.book_append_sheet(wb, logsWs, 'Activity Log');
      }

      const today = new Date();
      const todayTotal = state.todaySales.reduce((sum, s) => sum + Number(s.price), 0);
      const summaryData = [{
        'Export Date': today.toLocaleDateString(),
        'Export Time': today.toLocaleTimeString(),
        'Total Products': state.inventory.length,
        'Total Units in Stock': state.inventory.reduce((sum, item) => sum + calculateFields(item).remaining, 0),
        'Total Expected Revenue': formatCurrency(state.inventory.reduce((sum, item) => sum + calculateFields(item).expectedValue, 0)),
        "Today's Sales Count": state.todaySales.length,
        "Today's Sales Total": formatCurrency(todayTotal)
      }];
      const summaryWs = XLSX.utils.json_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Daily Summary');

      const dateStr = today.toISOString().split('T')[0];
      XLSX.writeFile(wb, `inventory_${dateStr}.xlsx`);
      addLogEntry('Export', 'All Items', `Excel export for ${state.inventory.length} items`);
    };

    // ===== STAFF ORDER FUNCTIONS =====
    const showSaleConfirmation = (item) => {
      state.pendingSale = item;
      state.saleQuantity = 1;
      // Keep pre-selected table if valid, otherwise auto-select first active table
      const activeTables = getActiveTables();
      const preSelectedValid = state.selectedTableId && activeTables.some(t => t.id === state.selectedTableId);
      if (!preSelectedValid) {
        state.selectedTableId = activeTables.length > 0 ? activeTables[0].id : null;
      }
      state.currentModal = 'saleConfirm';
      render();
    };

    const confirmSale = () => {
      const item = state.pendingSale;
      if (!item) return;

      const quantity = state.saleQuantity;
      let tableId = state.selectedTableId;

      // Create new table if none selected
      if (!tableId) {
        const newTable = addNewTable();
        tableId = newTable.id;
      }

      // Update inventory
      state.inventory = state.inventory.map(inv => {
        if (inv.id === item.id) {
          return { ...inv, sold: Number(inv.sold || 0) + quantity, updatedAt: new Date().toISOString() };
        }
        return inv;
      });

      // Add to table's orders
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        const pricePerUnit = Number(item.pricePerUnit) || 0;
        const orderTotal = pricePerUnit * quantity;
        table.orders.push({
          id: Date.now(),
          timestamp: new Date().toISOString(),
          productId: item.id,
          productName: item.name,
          category: item.category,
          pricePerUnit: pricePerUnit,
          quantity: quantity,
          total: orderTotal,
          staffId: state.currentStaff?.id,
          staffName: state.currentStaff?.name
        });
        table.total = table.orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
        saveTables();
        addTableLog(table.number, table.name, 'Sale', `${quantity}x ${item.name} - ${formatCurrency(orderTotal)}`);
      }

      // Add to today's sales (one entry per quantity for compatibility)
      for (let i = 0; i < quantity; i++) {
        state.todaySales.push({
          id: Date.now() + i,
          timestamp: new Date().toISOString(),
          productId: item.id,
          productName: item.name,
          category: item.category,
          price: item.pricePerUnit,
          tableNumber: table?.number,
          staffId: state.currentStaff?.id,
          staffName: state.currentStaff?.name
        });
      }

      state.lastTappedId = item.id;
      setTimeout(() => { state.lastTappedId = null; render(); }, 300);

      // Reset and close modal
      state.pendingSale = null;
      state.saleQuantity = 1;
      state.currentModal = null;

      saveData();
      saveTodaySales();
      render();
    };

    const recordSale = (item) => {
      showSaleConfirmation(item);
    };

    const undoLastSale = (item) => {
      const currentSold = Number(item.sold || 0);
      if (currentSold <= 0) return;

      state.inventory = state.inventory.map(inv => {
        if (inv.id === item.id) {
          return { ...inv, sold: currentSold - 1, updatedAt: new Date().toISOString() };
        }
        return inv;
      });

      const lastSaleIndex = state.todaySales.map(s => s.productId).lastIndexOf(item.id);
      if (lastSaleIndex !== -1) {
        state.todaySales.splice(lastSaleIndex, 1);
      }

      saveData();
      saveTodaySales();
      render();
    };

    // ===== BOH DISBURSEMENT FUNCTIONS =====

    // Add item to pending cart
    const addToBohCart = (item) => {
      const existing = state.bohPendingCart.find(c => c.productId === item.id);
      if (existing) {
        existing.quantity += 1;
      } else {
        state.bohPendingCart.push({
          productId: item.id,
          productName: item.name,
          category: item.category,
          image: item.image || '',
          quantity: 1
        });
      }

      // Visual feedback
      state.lastBohTappedId = item.id;
      render();
      setTimeout(() => {
        state.lastBohTappedId = null;
        render();
      }, 300);
    };

    // Remove item from pending cart
    const removeFromBohCart = (productId) => {
      const existing = state.bohPendingCart.find(c => c.productId === productId);
      if (existing) {
        if (existing.quantity > 1) {
          existing.quantity -= 1;
        } else {
          state.bohPendingCart = state.bohPendingCart.filter(c => c.productId !== productId);
        }
      }
      render();
    };

    // Clear entire pending cart
    const clearBohCart = () => {
      state.bohPendingCart = [];
      render();
    };

    // Show FOH selection modal before confirming
    const confirmBohCart = () => {
      if (state.bohPendingCart.length === 0) return;
      state.bohSelectingFoh = true;
      render();
    };

    // Get FOH staff members
    const getFohStaff = () => {
      return state.staffProfiles.filter(s => s.role === 'foh' || !s.role);
    };

    // Actually submit cart after FOH selection
    const submitBohCartToFoh = (fohStaffId) => {
      const fohStaff = state.staffProfiles.find(s => s.id === fohStaffId);
      if (!fohStaff) return;

      const timestamp = new Date().toISOString();
      const today = getTodayKey();

      state.bohPendingCart.forEach(item => {
        const disbursement = {
          id: Date.now() + Math.random(),
          timestamp: timestamp,
          productId: item.productId,
          productName: item.productName,
          category: item.category,
          quantity: item.quantity,
          staffId: state.currentStaff?.id,
          staffName: state.currentStaff?.name || 'BOH Staff',
          fohStaffId: fohStaff.id,
          fohStaffName: fohStaff.name,
          date: today
        };
        state.bohDisbursements.push(disbursement);
      });

      saveBohDisbursements();
      state.bohPendingCart = [];
      state.bohSelectingFoh = false;
      state.bohLastConfirmedFoh = fohStaff;
      state.bohShowSuccess = true;
      render();

      // Hide success after 2 seconds
      setTimeout(() => {
        state.bohShowSuccess = false;
        state.bohLastConfirmedFoh = null;
        render();
      }, 2000);
    };

    // Cancel FOH selection
    const cancelBohFohSelection = () => {
      state.bohSelectingFoh = false;
      render();
    };

    // Remove a confirmed disbursement (from today's history)
    const removeBohDisbursement = (disbursementId) => {
      state.bohDisbursements = state.bohDisbursements.filter(d => d.id !== disbursementId);
      saveBohDisbursements();
      render();
    };

    // Get pending cart total
    const getBohCartTotal = () => {
      return state.bohPendingCart.reduce((sum, item) => sum + item.quantity, 0);
    };

    // Get cart quantity for a specific product
    const getBohCartQuantity = (productId) => {
      const item = state.bohPendingCart.find(c => c.productId === productId);
      return item ? item.quantity : 0;
    };

    const getBohTodayCount = (productId) => {
      const today = getTodayKey();
      return state.bohDisbursements
        .filter(d => d.productId === productId && d.date === today)
        .reduce((sum, d) => sum + d.quantity, 0);
    };

    const getBohTodayTotal = () => {
      const today = getTodayKey();
      return state.bohDisbursements
        .filter(d => d.date === today)
        .reduce((sum, d) => sum + d.quantity, 0);
    };

    const getBohTodayHistory = () => {
      const today = getTodayKey();
      return state.bohDisbursements
        .filter(d => d.date === today)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    };

    // ===== RENDER FUNCTIONS =====
    const render = () => {
      const app = document.getElementById('app');

      if (state.currentTab === 'orders') {
        app.innerHTML = renderOrdersTab();
      } else {
        app.innerHTML = renderInventoryTab();
      }
    };

    const renderOrdersTab = () => {
      // If in staff setup flow (adding new staff or new PIN detected), show setup wizard
      const setupSteps = ['name', 'camera', 'pin', 'confirm', 'newPinDetected'];
      if (setupSteps.includes(state.setupStep)) {
        return renderStaffSetup();
      }

      // If no staff profiles exist, show setup
      if (state.staffProfiles.length === 0) {
        state.setupStep = 'name';
        return renderStaffSetup();
      }

      // If not authenticated, show login
      if (!state.isStaffAuthenticated) {
        return renderStaffLogin();
      }

      // Route based on staff role
      const staffRole = state.currentStaff?.role || 'foh';
      if (staffRole === 'boh') {
        return renderBohView();
      }

      // Show FOH orders interface
      let products = state.inventory.filter(item => {
        const calc = calculateFields(item);
        return calc.remaining > 0;
      });

      if (state.staffCategoryFilter !== 'all') {
        products = products.filter(item => item.category === state.staffCategoryFilter);
      }

      const todayTotal = state.todaySales.reduce((sum, s) => sum + (Number(s.price) || 0), 0);
      const todayCount = state.todaySales.length;
      const activeTables = getActiveTables();
      const activeTablesTotal = activeTables.reduce((sum, t) => sum + (Number(t.total) || 0), 0);

      return `
        <!-- Staff Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0 z-40">
          <div class="px-4 py-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                ${state.currentStaff?.photo ? `
                  <img src="${state.currentStaff.photo}" class="w-10 h-10 rounded-full border-2 border-white/30 object-cover" />
                ` : `<span>${icons.cart}</span>`}
                <div>
                  <h1 class="text-lg font-bold">${state.currentStaff?.name || 'Staff'}</h1>
                  <p class="text-xs text-blue-200">${activeTables.length} active table${activeTables.length !== 1 ? 's' : ''}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <!-- Currency Toggle -->
                <button onclick="toggleCurrency()" class="px-2 py-1 rounded-lg text-xs font-bold transition ${state.showUSD ? 'bg-green-400 text-green-900' : 'bg-white/20 text-white'}" title="${state.showUSD ? 'USD (Live Rate)' : 'Colombian Pesos'}">
                  ${state.showUSD ? 'USD' : 'COP'}
                </button>
                <div class="text-right">
                  <div class="text-lg font-bold">${todayCount} sales today</div>
                </div>
              </div>
            </div>
          </div>

        </header>

        <!-- View Toggle: Products / Tables / History -->
        <div class="sticky top-[64px] z-30 bg-gray-50 px-3 py-2 border-b border-gray-200">
          <div class="flex gap-2 mb-2">
            <button onclick="switchStaffView('products')" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${state.staffView === 'products' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
              ${icons.cart}
              Products
            </button>
            <button onclick="switchStaffView('tables')" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${state.staffView === 'tables' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
              ${icons.table}
              Tables
              ${activeTables.length > 0 ? `<span class="px-1.5 py-0.5 rounded-full text-xs ${state.staffView === 'tables' ? 'bg-white/20' : 'bg-blue-100 text-blue-600'}">${activeTables.length}</span>` : ''}
            </button>
            <button onclick="switchStaffView('history')" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${state.staffView === 'history' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
              ${icons.receipt}
              History
            </button>
          </div>
          ${state.staffView === 'products' ? `
            <div class="flex gap-2 overflow-x-auto pb-1">
              <button onclick="setStaffCategory('all')" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition ${state.staffCategoryFilter === 'all' ? 'bg-gray-900 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
                All
              </button>
              ${CATEGORIES.map(cat => `
                <button onclick="setStaffCategory('${cat.id}')" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition ${state.staffCategoryFilter === cat.id ? `${cat.darkBg} text-white` : 'bg-white text-gray-600 border border-gray-200'}">
                  ${cat.id === 'liquor' ? icons.wine.replace('w-5 h-5', 'w-4 h-4') : cat.id === 'beer' ? icons.beer.replace('w-5 h-5', 'w-4 h-4') : icons.cup.replace('w-5 h-5', 'w-4 h-4')}
                  ${cat.name}
                </button>
              `).join('')}
            </div>
          ` : ''}
          ${state.staffView === 'tables' ? `
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">${activeTables.length} active, ${getClosedTables().length} closed</span>
              <button onclick="toggleClosedTables()" class="text-sm text-blue-600 font-medium">
                ${state.showClosedTables ? 'Hide Closed' : 'Show Closed'}
              </button>
            </div>
          ` : ''}
        </div>

        <!-- Content Area -->
        <main class="p-3 pb-24">
          ${state.staffView === 'history' ? `
            <!-- History / Logs View -->
            <div class="space-y-2">
              <h3 class="text-sm font-semibold text-gray-700 mb-3">Today's Activity Log</h3>
              ${state.tableLogs.length === 0 ? `
                <div class="text-center py-12 text-gray-500">
                  <div class="text-6xl mb-4">ðŸ“‹</div>
                  <p class="font-medium">No activity yet</p>
                  <p class="text-sm">Table actions will be logged here</p>
                </div>
              ` : `
                <div class="space-y-2 max-h-[60vh] overflow-y-auto">
                  ${state.tableLogs.map(log => `
                    <div class="bg-white rounded-xl p-3 border border-gray-100 shadow-sm">
                      <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                          <span class="px-2 py-0.5 rounded-full text-xs font-medium ${
                            log.action === 'Opened' ? 'bg-blue-100 text-blue-700' :
                            log.action === 'Closed' ? 'bg-gray-100 text-gray-700' :
                            log.action === 'Reopened' ? 'bg-purple-100 text-purple-700' :
                            log.action === 'Sale' ? 'bg-green-100 text-green-700' :
                            log.action === 'Removed' ? 'bg-red-100 text-red-700' :
                            log.action === 'Adjusted' ? 'bg-orange-100 text-orange-700' :
                            log.action === 'Updated' ? 'bg-amber-100 text-amber-700' :
                            log.action === 'Note' ? 'bg-yellow-100 text-yellow-700' :
                            'bg-gray-100 text-gray-700'
                          }">${log.action}</span>
                          <span class="font-semibold text-gray-900">Table ${log.tableNumber}${log.tableName ? ` Â· ${log.tableName}` : ''}</span>
                        </div>
                        <span class="text-xs text-gray-400">${formatTime(log.timestamp)}</span>
                      </div>
                      <p class="text-sm text-gray-600">${log.details}</p>
                      <p class="text-xs text-gray-400 mt-1">by ${log.staffName}</p>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          ` : state.staffView === 'tables' ? `
            <!-- Active Tables Grid -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
              <!-- Add New Table Button -->
              <button onclick="addNewTableFromView()" class="table-card bg-white rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50/50" style="min-height: 140px;">
                <div class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center mb-2">
                  <span class="text-2xl">+</span>
                </div>
                <span class="text-sm font-medium">New Table</span>
              </button>

              ${activeTables.map(table => `
                <button onclick="viewTable(${table.id})" class="table-card bg-white rounded-2xl border border-gray-200 flex flex-col relative overflow-hidden" style="min-height: 140px;">
                  <!-- Top status bar with pulse -->
                  <div class="absolute top-0 left-0 right-0 h-1 bg-green-500 status-pulse"></div>

                  <!-- Main content area -->
                  <div class="flex-1 p-3 pt-4">
                    <div class="flex items-start gap-3">
                      <!-- Table number badge -->
                      <div class="table-number-badge bg-green-500 text-white shadow-md">
                        ${table.number}
                      </div>

                      <!-- Table info -->
                      <div class="flex-1 min-w-0 pt-1">
                        <div class="flex items-center gap-1.5">
                          ${table.name ? `
                            <span class="font-semibold text-gray-900 truncate text-sm">${table.name}</span>
                          ` : `
                            <span class="font-medium text-gray-400 text-sm">Table ${table.number}</span>
                          `}
                          ${table.notes ? `<span class="w-2 h-2 rounded-full bg-amber-400 flex-shrink-0" title="Has notes"></span>` : ''}
                        </div>
                        <!-- Total amount - prominent -->
                        <div class="mt-1">
                          <span class="text-lg font-bold text-green-600">${formatCurrency(table.total)}</span>
                        </div>
                      </div>

                      <!-- Staff photo -->
                      ${table.openedBy?.photo ? `
                        <img src="${table.openedBy.photo}" class="w-8 h-8 rounded-full object-cover border-2 border-white shadow-md flex-shrink-0" title="Opened by ${table.openedBy.name}" />
                      ` : `
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-bold border-2 border-white shadow-md flex-shrink-0">
                          ${(table.openedBy?.name || 'A').charAt(0).toUpperCase()}
                        </div>
                      `}
                    </div>
                  </div>

                  <!-- Footer stats -->
                  <div class="px-3 pb-2.5 pt-2 border-t border-gray-100 bg-gray-50/50">
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-2 text-gray-500">
                        ${table.guestCount ? `<span class="flex items-center gap-0.5">ðŸ‘¥ ${table.guestCount}</span>` : ''}
                        <span class="flex items-center gap-0.5">ðŸ“¦ ${table.orders.length}</span>
                      </div>
                      <span class="font-medium text-gray-600 bg-white px-2 py-0.5 rounded-full border border-gray-200">â± ${getTableDuration(table)}</span>
                    </div>
                  </div>
                </button>
              `).join('')}
            </div>

            ${activeTables.length === 0 && !state.showClosedTables ? `
              <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">ðŸ½ï¸</div>
                <p class="font-medium">No active tables</p>
                <p class="text-sm">Tap "New Table" to start or add items from Products</p>
              </div>
            ` : ''}

            <!-- Closed Tables Section -->
            ${state.showClosedTables && getClosedTables().length > 0 ? `
              <div class="mt-6">
                <h4 class="text-sm font-semibold text-gray-500 mb-3">Closed Tables</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                  ${getClosedTables().map(table => `
                    <button onclick="viewTable(${table.id})" class="table-card bg-gray-100 rounded-2xl border border-gray-200 flex flex-col relative overflow-hidden" style="min-height: 140px;">
                      <!-- Top status bar -->
                      <div class="absolute top-0 left-0 right-0 h-1 bg-gray-400"></div>

                      <!-- Main content area -->
                      <div class="flex-1 p-3 pt-4">
                        <div class="flex items-start gap-3">
                          <!-- Table number badge -->
                          <div class="table-number-badge bg-gray-400 text-white shadow">
                            ${table.number}
                          </div>

                          <!-- Table info -->
                          <div class="flex-1 min-w-0 pt-1">
                            <div class="flex items-center gap-1.5">
                              ${table.name ? `
                                <span class="font-semibold text-gray-600 truncate text-sm">${table.name}</span>
                              ` : `
                                <span class="font-medium text-gray-400 text-sm">Table ${table.number}</span>
                              `}
                            </div>
                            <!-- Total amount -->
                            <div class="mt-1">
                              <span class="text-lg font-bold text-gray-500">${formatCurrency(table.total)}</span>
                            </div>
                          </div>

                          <!-- Closed by photo -->
                          ${table.closedBy?.photo ? `
                            <img src="${table.closedBy.photo}" class="w-8 h-8 rounded-full object-cover border-2 border-white shadow flex-shrink-0 grayscale" title="Closed by ${table.closedBy.name}" />
                          ` : `
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-xs font-bold border-2 border-white shadow flex-shrink-0">
                              ${(table.closedBy?.name || 'A').charAt(0).toUpperCase()}
                            </div>
                          `}
                        </div>
                      </div>

                      <!-- Footer - closed info -->
                      <div class="px-3 pb-2.5 pt-2 border-t border-gray-200 bg-gray-200/50">
                        <div class="flex items-center justify-between text-xs text-gray-500">
                          <span class="truncate">by ${table.closedBy?.name || 'Admin'}</span>
                          <span class="font-medium bg-white px-2 py-0.5 rounded-full border border-gray-300">âœ“ ${formatTime(table.closedAt)}</span>
                        </div>
                      </div>
                    </button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          ` : `
            <!-- Products Grid -->
            ${products.length === 0 ? `
              <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">ðŸ“¦</div>
                <p class="font-medium">No products available</p>
                <p class="text-sm">Add products in the Inventory tab</p>
              </div>
            ` : `
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                ${products.map(item => {
                  const calc = calculateFields(item);
                  const cat = getCategoryInfo(item.category);
                  const isLowStock = calc.remaining <= 5;
                  const justTapped = state.lastTappedId === item.id;

                  return `
                    <div class="product-card bg-white rounded-2xl shadow-md border-2 ${justTapped ? 'border-green-500 animate-pop' : 'border-gray-100 hover:border-gray-200 hover:shadow-lg'} overflow-hidden transition-all duration-150 relative"
                         onclick="recordSale(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                      <!-- Product Image Area -->
                      <div class="relative">
                        <div class="absolute top-0 left-0 right-0 ${cat.darkBg} h-1"></div>
                        ${item.image ? `
                          <div class="w-full h-32 bg-gradient-to-b from-gray-50 to-white flex items-center justify-center p-3">
                            <img src="${item.image}" class="max-w-full max-h-full object-contain drop-shadow-md" alt="${item.name}" />
                          </div>
                        ` : `
                          <div class="w-full h-28 bg-gradient-to-b from-gray-100 to-gray-50 flex items-center justify-center">
                            <span class="text-5xl opacity-20">${item.category === 'liquor' ? 'ðŸ¥ƒ' : item.category === 'beer' ? 'ðŸº' : 'ðŸ¥¤'}</span>
                          </div>
                        `}
                        ${isLowStock ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full font-medium">Low</span>` : ''}
                      </div>
                      <!-- Product Info -->
                      <div class="p-3 border-t border-gray-100 text-center">
                        <h3 class="font-bold text-gray-900 text-base leading-snug mb-2 line-clamp-2" style="min-height: 2.75rem;">
                          ${item.name}
                        </h3>
                        <div class="flex items-center justify-center gap-3">
                          <div class="text-xl font-bold text-green-600">
                            ${formatCurrency(item.pricePerUnit)}
                          </div>
                          <span class="text-xs ${isLowStock ? 'text-red-500' : 'text-gray-400'}">
                            ${calc.remaining} left
                          </span>
                        </div>
                      </div>
                      ${justTapped ? `
                        <div class="absolute inset-0 bg-green-500/20 flex items-center justify-center pointer-events-none">
                          <span class="text-5xl">âœ“</span>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          `}
        </main>

        <!-- Bottom Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
          <div class="px-4 py-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-500">${activeTables.length} Active Tables</div>
                <div class="font-bold text-lg">${formatCurrency(activeTablesTotal)}</div>
              </div>
              <button onclick="staffLogout()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">
                Lock
              </button>
            </div>
          </div>
        </div>

        ${renderModal()}
      `;
    };

    // ===== BOH VIEW =====
    const renderBohView = () => {
      const bohTodayTotal = getBohTodayTotal();
      const cartTotal = getBohCartTotal();
      const history = getBohTodayHistory();

      let products = [...state.inventory];
      if (state.bohCategoryFilter !== 'all') {
        products = products.filter(item => item.category === state.bohCategoryFilter);
      }

      return `
        <div class="min-h-screen bg-gray-50 ${cartTotal > 0 ? 'pb-48' : 'pb-24'}">
          <!-- BOH Header -->
          <header class="bg-gradient-to-r from-amber-600 to-amber-700 text-white sticky top-0 z-40">
            <div class="px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  ${state.currentStaff?.photo ? `
                    <img src="${state.currentStaff.photo}" class="w-10 h-10 rounded-full border-2 border-white/30 object-cover" />
                  ` : `<span class="w-10 h-10 rounded-full bg-amber-500 flex items-center justify-center text-xl">ðŸº</span>`}
                  <div>
                    <h1 class="text-lg font-bold">${state.currentStaff?.name || 'BOH Staff'}</h1>
                    <p class="text-xs text-amber-200">Back of House</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold">${bohTodayTotal}</div>
                  <div class="text-xs text-amber-200">confirmed today</div>
                </div>
              </div>
            </div>
          </header>

          <!-- View Toggle & Category Filter -->
          <div class="sticky top-[64px] z-30 bg-gray-50 px-3 py-2 border-b border-gray-200">
            <!-- View Toggle -->
            <div class="flex gap-2 mb-2">
              <button onclick="setBohShowHistory(false)" class="flex-1 py-2 rounded-lg text-sm font-medium transition ${!state.bohShowHistory ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
                ðŸº Products
              </button>
              <button onclick="setBohShowHistory(true)" class="flex-1 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${state.bohShowHistory ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
                ðŸ“‹ History
                ${bohTodayTotal > 0 ? `<span class="px-1.5 py-0.5 rounded-full text-xs ${state.bohShowHistory ? 'bg-white/20' : 'bg-amber-100 text-amber-600'}">${bohTodayTotal}</span>` : ''}
              </button>
            </div>

            ${!state.bohShowHistory ? `
              <!-- Category Filter -->
              <div class="flex gap-2 overflow-x-auto pb-1">
                <button onclick="setBohCategoryFilter('all')" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition ${state.bohCategoryFilter === 'all' ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
                  All
                </button>
                ${CATEGORIES.map(cat => `
                  <button onclick="setBohCategoryFilter('${cat.id}')" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-1.5 ${state.bohCategoryFilter === cat.id ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 border border-gray-200'}">
                    ${cat.id === 'liquor' ? 'ðŸ¥ƒ' : cat.id === 'beer' ? 'ðŸº' : 'ðŸ¥¤'}
                    ${cat.name}
                  </button>
                `).join('')}
              </div>
            ` : ''}
          </div>

          <main class="p-3">
            ${state.bohShowHistory ? `
              <!-- History View -->
              ${history.length === 0 ? `
                <div class="text-center py-12 text-gray-500">
                  <div class="text-6xl mb-4">ðŸ“‹</div>
                  <p class="font-medium">No disbursements today</p>
                  <p class="text-sm mt-1">Tap products to add items</p>
                </div>
              ` : `
                <div class="space-y-2">
                  ${history.map(d => `
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center text-amber-600 font-bold">
                        ${d.quantity}
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">${d.productName}</p>
                        <p class="text-xs text-gray-500">
                          ${formatTime(d.timestamp)}
                          ${d.fohStaffName ? `<span class="text-blue-500">â†’ ${d.fohStaffName}</span>` : ''}
                        </p>
                      </div>
                      ${state.currentStaff?.role === 'admin' ? `
                        <button onclick="removeBohDisbursementConfirm(${d.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove">
                          ${icons.trash}
                        </button>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              `}
            ` : `
              <!-- Products Grid -->
              ${products.length === 0 ? `
                <div class="text-center py-12 text-gray-500">
                  <div class="text-6xl mb-4">ðŸ“¦</div>
                  <p class="font-medium">No products available</p>
                </div>
              ` : `
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                  ${products.map(item => {
                    const bohCount = getBohTodayCount(item.id);
                    const cartQty = getBohCartQuantity(item.id);
                    const cat = getCategoryInfo(item.category);
                    const justTapped = state.lastBohTappedId === item.id;

                    return `
                      <div class="product-card bg-white rounded-2xl shadow-md border-2 ${cartQty > 0 ? 'border-amber-400 ring-2 ring-amber-200' : justTapped ? 'border-amber-500 animate-pop' : 'border-gray-100 hover:border-amber-200 hover:shadow-lg'} overflow-hidden transition-all duration-150 relative"
                           onclick="addToBohCart(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <!-- Product Image Area -->
                        <div class="relative">
                          <div class="absolute top-0 left-0 right-0 ${cat.darkBg} h-1"></div>
                          ${item.image ? `
                            <div class="w-full h-32 bg-gradient-to-b from-gray-50 to-white flex items-center justify-center p-3">
                              <img src="${item.image}" class="max-w-full max-h-full object-contain drop-shadow-md" alt="${item.name}" />
                            </div>
                          ` : `
                            <div class="w-full h-28 bg-gradient-to-b from-gray-100 to-gray-50 flex items-center justify-center">
                              <span class="text-5xl opacity-20">${item.category === 'liquor' ? 'ðŸ¥ƒ' : item.category === 'beer' ? 'ðŸº' : 'ðŸ¥¤'}</span>
                            </div>
                          `}
                          ${cartQty > 0 ? `
                            <span class="absolute top-2 right-2 bg-amber-500 text-white text-sm w-8 h-8 rounded-full font-bold flex items-center justify-center shadow-lg animate-pop">
                              ${cartQty}
                            </span>
                          ` : bohCount > 0 ? `
                            <span class="absolute top-2 right-2 bg-gray-400 text-white text-xs px-2 py-1 rounded-full font-medium">${bohCount}</span>
                          ` : ''}
                        </div>
                        <!-- Product Info -->
                        <div class="p-3 border-t border-gray-100 text-center">
                          <h3 class="font-bold text-gray-900 text-base leading-snug mb-2 line-clamp-2" style="min-height: 2.75rem;">
                            ${item.name}
                          </h3>
                          <div class="text-sm font-medium ${bohCount > 0 ? 'text-gray-500' : 'text-gray-400'}">
                            ${bohCount > 0 ? `âœ“ ${bohCount} confirmed` : 'Tap to add'}
                          </div>
                        </div>
                        ${justTapped ? `
                          <div class="absolute inset-0 bg-amber-500/20 flex items-center justify-center pointer-events-none">
                            <span class="text-5xl">+1</span>
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            `}
          </main>

          <!-- Floating Cart (when items pending) - Compact Bottom Right -->
          ${cartTotal > 0 && !state.bohSelectingFoh && !state.bohShowSuccess ? `
            <div class="fixed bottom-20 right-3 w-56 bg-white rounded-xl shadow-2xl border border-amber-300 z-40 overflow-hidden">
              <!-- Header -->
              <div class="bg-amber-500 px-3 py-2 flex items-center justify-between">
                <span class="font-bold text-white text-sm">Order (${cartTotal})</span>
                <button onclick="clearBohCart()" class="text-amber-100 hover:text-white text-xs">âœ• Clear</button>
              </div>
              <!-- Items List -->
              <div class="max-h-40 overflow-y-auto">
                ${state.bohPendingCart.map(item => `
                  <div class="flex items-center justify-between px-3 py-2 border-b border-gray-100 last:border-0">
                    <span class="text-sm text-gray-800 truncate flex-1">${item.productName}</span>
                    <div class="flex items-center gap-2 ml-2">
                      <span class="font-bold text-amber-600 w-6 text-center">${item.quantity}</span>
                      <button onclick="event.stopPropagation(); removeFromBohCart(${item.productId})" class="w-5 h-5 rounded bg-gray-100 hover:bg-red-100 hover:text-red-600 flex items-center justify-center text-gray-400 text-xs">
                        âˆ’
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
              <!-- Confirm Button -->
              <button onclick="confirmBohCart()" class="w-full py-3 bg-amber-500 text-white font-bold text-sm hover:bg-amber-600 transition">
                âœ“ Confirm
              </button>
            </div>
          ` : ''}

          <!-- FOH Staff Selection Modal -->
          ${state.bohSelectingFoh ? `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade">
              <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden animate-pop">
                <div class="bg-amber-500 px-4 py-3 text-white">
                  <h3 class="font-bold text-lg">Who received the order?</h3>
                  <p class="text-amber-100 text-sm">${cartTotal} item${cartTotal !== 1 ? 's' : ''} to hand off</p>
                </div>
                <div class="p-4 max-h-64 overflow-y-auto">
                  ${getFohStaff().length === 0 ? `
                    <p class="text-gray-500 text-center py-4">No FOH staff registered</p>
                  ` : `
                    <div class="grid grid-cols-2 gap-3">
                      ${getFohStaff().map(staff => `
                        <button onclick="submitBohCartToFoh(${staff.id})" class="flex flex-col items-center p-3 rounded-xl border-2 border-gray-200 hover:border-amber-400 hover:bg-amber-50 transition">
                          ${staff.photo ? `
                            <img src="${staff.photo}" class="w-14 h-14 rounded-full border-2 border-blue-400 object-cover mb-2" />
                          ` : `
                            <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xl font-bold mb-2">
                              ${staff.name.charAt(0).toUpperCase()}
                            </div>
                          `}
                          <span class="font-medium text-gray-900 text-sm">${staff.name}</span>
                          <span class="text-xs text-blue-500">FOH</span>
                        </button>
                      `).join('')}
                    </div>
                  `}
                </div>
                <div class="px-4 pb-4">
                  <button onclick="cancelBohFohSelection()" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- Success Animation -->
          ${state.bohShowSuccess ? `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade">
              <div class="bg-white rounded-3xl shadow-2xl p-8 text-center animate-pop">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <h3 class="font-bold text-xl text-gray-900 mb-2">Order Confirmed!</h3>
                ${state.bohLastConfirmedFoh ? `
                  <p class="text-gray-600">Handed to <span class="font-semibold text-blue-600">${state.bohLastConfirmedFoh.name}</span></p>
                ` : ''}
              </div>
            </div>
          ` : ''}

          <!-- Bottom Bar -->
          <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30">
            <div class="px-4 py-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm text-gray-500">Confirmed Today</div>
                  <div class="font-bold text-lg text-amber-600">${bohTodayTotal} items</div>
                </div>
                <button onclick="bohLogout()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">
                  Lock
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    };

    const renderStaffSetup = () => {
      // Multi-step wizard: name -> camera -> pin
      if (state.setupStep === 'name') {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
              <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                ${icons.user}
              </div>
              <h2 class="text-xl font-bold text-gray-900 mb-2">New Staff Setup</h2>
              <p class="text-gray-500 mb-6">Enter your name to get started</p>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <input
                type="text"
                id="staffNameInput"
                value="${state.newStaffName}"
                oninput="state.newStaffName = this.value"
                placeholder="Enter your name"
                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-center mb-4"
                autofocus
              />

              <!-- Role Selection -->
              <div class="mb-4">
                <p class="text-sm text-gray-500 mb-2">Select your role:</p>
                <div class="flex gap-2">
                  <button onclick="state.newStaffRole = 'foh'; render();" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition border-2 ${state.newStaffRole === 'foh' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 text-gray-600'}">
                    ðŸ½ï¸ Server (FOH)
                  </button>
                  <button onclick="state.newStaffRole = 'boh'; render();" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition border-2 ${state.newStaffRole === 'boh' ? 'border-amber-500 bg-amber-50 text-amber-700' : 'border-gray-200 text-gray-600'}">
                    ðŸº Bar (BOH)
                  </button>
                </div>
              </div>

              <button onclick="goToCamera()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                Next: Take Photo
                ${icons.arrowRight}
              </button>

              <button onclick="switchTab('inventory')" class="mt-4 text-gray-500 text-sm">
                â† Back to Inventory
              </button>
            </div>
          </div>
        `;
      }

      if (state.setupStep === 'camera') {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
              <h2 class="text-xl font-bold text-gray-900 mb-2">Hi, ${state.newStaffName}!</h2>
              <p class="text-gray-500 mb-4">Take a quick selfie for your profile</p>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <!-- Camera Preview -->
              <div class="camera-container mx-auto mb-4 bg-gray-900 border-4 border-blue-200">
                ${state.cameraStream ? `
                  <video id="cameraPreview" autoplay playsinline muted class="w-full h-full"></video>
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                      ${icons.camera}
                      <p class="text-sm mt-2">Loading camera...</p>
                    </div>
                  </div>
                `}
              </div>

              <div class="flex gap-3">
                <button onclick="goBackToName()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Back
                </button>
                <button onclick="capturePhoto()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2" ${!state.cameraStream ? 'disabled' : ''}>
                  ${icons.camera.replace('w-8 h-8', 'w-5 h-5')}
                  Capture
                </button>
              </div>

              <button onclick="skipPhoto()" class="mt-4 text-gray-500 text-sm">
                Skip photo for now
              </button>
            </div>
          </div>
        `;
      }

      if (state.setupStep === 'pin') {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
              <!-- Profile Preview -->
              <div class="mb-4">
                ${state.newStaffPhoto ? `
                  <img src="${state.newStaffPhoto}" class="w-20 h-20 rounded-full mx-auto border-4 border-blue-200 object-cover" />
                ` : `
                  <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto text-blue-600">
                    ${icons.user}
                  </div>
                `}
                <h3 class="font-bold text-gray-900 mt-2">${state.newStaffName}</h3>
              </div>

              <p class="text-gray-500 mb-6">Create your 4-digit PIN</p>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <!-- PIN Display -->
              <div class="flex justify-center gap-3 mb-6">
                ${[0,1,2,3].map(i => `
                  <div class="pin-digit border-2 ${state.staffPinInput.length > i ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-xl flex items-center justify-center font-bold text-2xl text-blue-600">
                    ${state.staffPinInput.length > i ? 'â€¢' : ''}
                  </div>
                `).join('')}
              </div>

              ${renderNumpad('setupPin')}

              <button onclick="goBackToCamera()" class="mt-4 text-gray-500 text-sm">
                â† Back
              </button>
            </div>
          </div>
        `;
      }

      if (state.setupStep === 'confirm') {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
              <!-- Profile Preview -->
              <div class="mb-4">
                ${state.newStaffPhoto ? `
                  <img src="${state.newStaffPhoto}" class="w-20 h-20 rounded-full mx-auto border-4 border-blue-200 object-cover" />
                ` : `
                  <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto text-blue-600">
                    ${icons.user}
                  </div>
                `}
                <h3 class="font-bold text-gray-900 mt-2">${state.newStaffName}</h3>
              </div>

              <p class="text-gray-500 mb-6">Confirm your PIN</p>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <!-- PIN Display -->
              <div class="flex justify-center gap-3 mb-6">
                ${[0,1,2,3].map(i => `
                  <div class="pin-digit border-2 ${state.staffPinInput.length > i ? 'border-green-500 bg-green-50' : 'border-gray-200'} rounded-xl flex items-center justify-center font-bold text-2xl text-green-600">
                    ${state.staffPinInput.length > i ? 'â€¢' : ''}
                  </div>
                `).join('')}
              </div>

              ${renderNumpad('confirmPin')}

              <button onclick="goBackFromConfirm()" class="mt-4 text-gray-500 text-sm">
                â† Back
              </button>
            </div>
          </div>
        `;
      }

      // New PIN detected - prompt to create account
      if (state.setupStep === 'newPinDetected') {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
              <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                ${icons.userPlus}
              </div>
              <h2 class="text-xl font-bold text-gray-900 mb-2">New PIN Detected</h2>
              <p class="text-gray-500 mb-6">This PIN isn't registered yet. Would you like to create a new staff account?</p>

              <div class="bg-blue-50 rounded-xl p-4 mb-6">
                <div class="flex justify-center gap-3">
                  ${[0,1,2,3].map(i => `
                    <div class="w-12 h-14 border-2 border-blue-300 bg-white rounded-xl flex items-center justify-center font-bold text-xl text-blue-600">
                      â€¢
                    </div>
                  `).join('')}
                </div>
                <p class="text-xs text-blue-600 mt-2">Your PIN is saved</p>
              </div>

              <button onclick="continueNewAccountSetup()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition flex items-center justify-center gap-2 mb-3">
                ${icons.userPlus.replace('w-6 h-6', 'w-5 h-5')}
                Yes, Create Account
              </button>

              <button onclick="cancelNewAccount()" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                Cancel
              </button>
            </div>
          </div>
        `;
      }

      return '';
    };

    const renderStaffLogin = () => {
      return `
        <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
              ${icons.lock.replace('w-4 h-4', 'w-10 h-10')}
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Staff Login</h2>
            <p class="text-gray-500 mb-6">Enter your 4-digit PIN</p>

            ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

            <!-- PIN Display -->
            <div class="flex justify-center gap-3 mb-6">
              ${[0,1,2,3].map(i => `
                <div class="pin-digit border-2 ${state.staffPinInput.length > i ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-xl flex items-center justify-center font-bold text-2xl text-blue-600">
                  ${state.staffPinInput.length > i ? 'â€¢' : ''}
                </div>
              `).join('')}
            </div>

            ${renderNumpad('staffLogin')}

            <!-- Staff Profiles -->
            ${state.staffProfiles.length > 0 ? `
              <div class="mt-6 pt-4 border-t border-gray-100">
                <p class="text-xs text-gray-400 mb-3">Registered Staff</p>
                <div class="flex justify-center gap-3 flex-wrap">
                  ${state.staffProfiles.map(staff => `
                    <div class="flex flex-col items-center">
                      <div class="relative">
                        ${staff.photo ? `
                          <img src="${staff.photo}" class="w-12 h-12 rounded-full border-2 ${staff.role === 'boh' ? 'border-amber-400' : 'border-blue-400'} object-cover" />
                        ` : `
                          <div class="w-12 h-12 rounded-full ${staff.role === 'boh' ? 'bg-amber-100' : 'bg-blue-100'} flex items-center justify-center ${staff.role === 'boh' ? 'text-amber-600' : 'text-blue-600'} text-sm font-bold">
                            ${staff.name.charAt(0).toUpperCase()}
                          </div>
                        `}
                        <span class="absolute -bottom-1 -right-1 text-xs ${staff.role === 'boh' ? 'bg-amber-500' : 'bg-blue-500'} text-white px-1.5 py-0.5 rounded-full font-medium">
                          ${staff.role === 'boh' ? 'BOH' : 'FOH'}
                        </span>
                      </div>
                      <span class="text-xs text-gray-500 mt-1.5">${staff.name.split(' ')[0]}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="flex gap-3 mt-4">
              <button onclick="switchTab('inventory')" class="flex-1 text-gray-500 text-sm py-2">
                â† Inventory
              </button>
              <button onclick="startAddNewStaff()" class="flex-1 text-blue-600 text-sm py-2 font-medium flex items-center justify-center gap-1">
                ${icons.userPlus.replace('w-6 h-6', 'w-4 h-4')}
                Add Staff
              </button>
            </div>
          </div>
        </div>
      `;
    };

    const renderNumpad = (action) => {
      const nums = [1,2,3,4,5,6,7,8,9,'',0,'back'];
      return `
        <div class="grid grid-cols-3 gap-3">
          ${nums.map(n => {
            if (n === '') return '<div></div>';
            if (n === 'back') {
              return `
                <button onclick="pinBackspace()" class="numpad-btn bg-gray-100 hover:bg-gray-200 rounded-xl flex items-center justify-center text-gray-600 transition active:scale-95">
                  ${icons.backspace}
                </button>
              `;
            }
            return `
              <button onclick="pinInput('${n}', '${action}')" class="numpad-btn bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-800 transition active:scale-95 active:bg-gray-300">
                ${n}
              </button>
            `;
          }).join('')}
        </div>
      `;
    };

    const renderInventoryTab = () => {
      let filteredInventory = state.inventory;
      if (state.categoryFilter !== 'all') {
        filteredInventory = filteredInventory.filter(item => item.category === state.categoryFilter);
      }
      filteredInventory = filteredInventory.filter(item =>
        item.name.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
        (item.bottleSize || '').toLowerCase().includes(state.searchTerm.toLowerCase())
      );

      const calculateTotals = (items) => {
        return items.reduce((acc, item) => {
          const calc = calculateFields(item);
          return {
            totalUnits: acc.totalUnits + calc.totalUnits,
            totalRemaining: acc.totalRemaining + calc.remaining,
            totalExpectedValue: acc.totalExpectedValue + calc.expectedValue
          };
        }, { totalUnits: 0, totalRemaining: 0, totalExpectedValue: 0 });
      };

      const totals = calculateTotals(filteredInventory);
      const categoryCounts = CATEGORIES.map(cat => ({
        ...cat,
        count: state.inventory.filter(i => i.category === cat.id).length
      }));

      return `
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
          <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-blue-600">${icons.package}</span>
                <div>
                  <h1 class="text-xl font-bold text-gray-900">Inventory Tracker</h1>
                  <p class="text-sm text-gray-500">Daily Stock Management</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <!-- Currency Toggle -->
                <button onclick="toggleCurrency()" class="flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition ${state.showUSD ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}" title="${state.showUSD ? 'Showing USD - Click for COP' : 'Showing COP - Click for USD'}">
                  <span class="font-bold">${state.showUSD ? 'USD' : 'COP'}</span>
                  <span class="text-xs opacity-70">â‡„</span>
                </button>
                ${state.isAuthenticated ? `
                  <button onclick="toggleCost()" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition ${state.showCost ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                    ${state.showCost ? icons.eye : icons.eyeOff}
                    <span class="hidden sm:inline">Cost</span>
                  </button>
                  <button onclick="logout()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                    ${icons.unlock}
                    <span class="hidden sm:inline">Logout</span>
                  </button>
                ` : `
                  <button onclick="showLoginModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                    ${icons.lock}
                    <span class="hidden sm:inline">Unlock</span>
                  </button>
                `}
              </div>
            </div>
          </div>

          <div class="flex border-t border-gray-200">
            <button class="flex-1 py-3 text-sm font-medium bg-blue-50 text-blue-600 border-b-2 border-blue-600 flex items-center justify-center gap-2">
              ${icons.clipboard}
              Inventory
            </button>
            <button onclick="switchTab('orders')" class="flex-1 py-3 text-sm font-medium text-gray-500 hover:bg-gray-50 transition flex items-center justify-center gap-2">
              ${icons.cart}
              Staff Orders
            </button>
          </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
          <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="setCategory('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${state.categoryFilter === 'all' ? 'bg-gray-900 text-white' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}">
              All Items
              <span class="ml-2 px-2 py-0.5 rounded-full text-xs ${state.categoryFilter === 'all' ? 'bg-gray-700' : 'bg-gray-100'}">${state.inventory.length}</span>
            </button>
            ${categoryCounts.map(cat => `
              <button onclick="setCategory('${cat.id}')" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${state.categoryFilter === cat.id ? `${cat.bgColor} ${cat.textColor} border ${cat.borderColor}` : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}">
                ${cat.id === 'liquor' ? icons.wine : cat.id === 'beer' ? icons.beer : icons.cup}
                ${cat.name}
                <span class="px-2 py-0.5 rounded-full text-xs ${state.categoryFilter === cat.id ? 'bg-white/50' : 'bg-gray-100'}">${cat.count}</span>
              </button>
            `).join('')}
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <p class="text-sm text-gray-500 mb-1">Products</p>
              <p class="text-2xl font-bold text-gray-900">${filteredInventory.length}</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <p class="text-sm text-gray-500 mb-1">Total Units</p>
              <p class="text-2xl font-bold text-gray-900">${totals.totalUnits.toLocaleString()}</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <p class="text-sm text-gray-500 mb-1">Remaining</p>
              <p class="text-2xl font-bold text-blue-600">${totals.totalRemaining.toLocaleString()}</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <p class="text-sm text-gray-500 mb-1">Expected Revenue</p>
              <p class="text-2xl font-bold text-green-600">${formatCurrency(totals.totalExpectedValue)}</p>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <div class="relative flex-1">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.search}</span>
              <input
                type="text"
                placeholder="Search products..."
                value="${state.searchTerm}"
                oninput="updateSearch(this.value)"
                class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div class="flex gap-2">
              <button onclick="exportToExcel()" ${state.inventory.length === 0 ? 'disabled' : ''} class="flex items-center gap-2 px-3 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                ${icons.download}
                Export
              </button>
              ${state.isAuthenticated ? `
                <button onclick="resetInventoryToCOP()" class="flex items-center gap-2 px-3 py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition text-sm" title="Reset inventory to COP prices">
                  ${icons.refresh}
                  Reset COP
                </button>
                <button onclick="applyDefaultImages()" class="flex items-center gap-2 px-3 py-2.5 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600 transition text-sm" title="Add product images">
                  ðŸ“·
                  Add Images
                </button>
                <button onclick="openStaffManagement()" class="flex items-center gap-2 px-3 py-2.5 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition text-sm">
                  ${icons.userPlus.replace('w-6 h-6', 'w-4 h-4')}
                  Staff
                </button>
                <button onclick="showAddModal()" class="flex items-center gap-2 px-3 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition text-sm">
                  ${icons.plus}
                  Add
                </button>
              ` : ''}
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Product</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Category</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Size</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Boxes</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Per Box</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Total</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Sold</th>
                    <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Left</th>
                    <th class="text-right px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Price</th>
                    ${state.isAuthenticated && state.showCost ? '<th class="text-right px-3 py-3 text-xs font-semibold text-amber-600 uppercase">Cost</th>' : ''}
                    <th class="text-right px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Value</th>
                    ${state.isAuthenticated ? '<th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase">Actions</th>' : ''}
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  ${filteredInventory.length === 0 ? `
                    <tr>
                      <td colspan="${state.isAuthenticated ? 12 : 10}" class="px-4 py-12 text-center text-gray-500">
                        ${state.inventory.length === 0 ? `
                          <div class="text-gray-300 mb-3">${icons.package.replace('w-8 h-8', 'w-12 h-12 mx-auto')}</div>
                          <p class="font-medium">No inventory items yet</p>
                          <p class="text-sm mt-1">${state.isAuthenticated ? 'Click "Add" to get started' : 'Unlock to add items'}</p>
                        ` : '<p>No items match your search</p>'}
                      </td>
                    </tr>
                  ` : filteredInventory.map(item => {
                    const calc = calculateFields(item);
                    const isLowStock = calc.remaining < calc.totalUnits * 0.2 && calc.totalUnits > 0;
                    const cat = getCategoryInfo(item.category);
                    return `
                      <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3">
                          <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden bg-gray-50 flex-shrink-0">
                              ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover" />` : `<span class="text-gray-300 text-lg">ðŸ“¦</span>`}
                            </div>
                            <div>
                              <div class="font-medium text-gray-900">${item.name}</div>
                              <div class="text-xs text-gray-400">Updated ${formatDate(item.updatedAt)}</div>
                            </div>
                          </div>
                        </td>
                        <td class="text-center px-3 py-3">
                          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${cat.bgColor} ${cat.textColor}">
                            ${cat.name}
                          </span>
                        </td>
                        <td class="text-center px-3 py-3 text-gray-600">${item.bottleSize || '-'}</td>
                        <td class="text-center px-3 py-3 text-gray-600">${item.numBoxes}</td>
                        <td class="text-center px-3 py-3 text-gray-600">${item.perBox}</td>
                        <td class="text-center px-3 py-3 font-medium text-gray-900">${calc.totalUnits}</td>
                        <td class="text-center px-3 py-3 text-gray-600">${item.sold}</td>
                        <td class="text-center px-3 py-3">
                          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm font-medium ${isLowStock ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                            ${isLowStock ? icons.alert : ''}
                            ${calc.remaining}
                          </span>
                        </td>
                        <td class="text-right px-3 py-3 text-gray-900">${formatCurrency(item.pricePerUnit)}</td>
                        ${state.isAuthenticated && state.showCost ? `<td class="text-right px-3 py-3 text-amber-600 font-medium">${formatCurrency(item.costPerUnit)}</td>` : ''}
                        <td class="text-right px-3 py-3 font-semibold text-green-600">${formatCurrency(calc.expectedValue)}</td>
                        ${state.isAuthenticated ? `
                          <td class="text-center px-3 py-3">
                            <div class="flex items-center justify-center gap-1">
                              <button onclick="showEditModal(${item.id})" class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">
                                ${icons.edit}
                              </button>
                              <button onclick="deleteItem(${item.id})" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                                ${icons.trash}
                              </button>
                            </div>
                          </td>
                        ` : ''}
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            ${CATEGORIES.map(cat => {
              const items = state.inventory.filter(i => i.category === cat.id);
              const catTotals = calculateTotals(items);
              return `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="${cat.textColor}">${cat.id === 'liquor' ? icons.wine : cat.id === 'beer' ? icons.beer : icons.cup}</span>
                    <h3 class="font-semibold text-gray-900">${cat.name}</h3>
                    <span class="ml-auto px-2 py-0.5 rounded-full text-xs font-medium ${cat.bgColor} ${cat.textColor}">${items.length}</span>
                  </div>
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><span class="text-gray-500">Stock:</span> <span class="font-medium">${catTotals.totalRemaining}</span></div>
                    <div><span class="text-gray-500">Revenue:</span> <span class="font-medium text-green-600">${formatCurrency(catTotals.totalExpectedValue)}</span></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          ${state.changeLog.length > 0 ? `
            <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
              <h3 class="font-semibold text-gray-900 mb-3">Recent Activity</h3>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                ${state.changeLog.slice(0, 10).map(log => `
                  <div class="flex items-center gap-3 text-sm">
                    <span class="text-gray-400 text-xs w-32 flex-shrink-0">${formatDateTime(log.timestamp)}</span>
                    <span class="px-2 py-0.5 rounded text-xs font-medium ${
                      log.action === 'Added' ? 'bg-green-100 text-green-700' :
                      log.action === 'Updated' ? 'bg-blue-100 text-blue-700' :
                      log.action === 'Deleted' ? 'bg-red-100 text-red-700' :
                      'bg-gray-100 text-gray-700'
                    }">${log.action}</span>
                    <span class="text-gray-700 font-medium">${log.itemName}</span>
                    <span class="text-gray-400">${log.details}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </main>

        ${renderModal()}
      `;
    };

    const renderModal = () => {
      if (state.currentModal === 'setup') {
        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
              <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                  ${icons.settings}
                </div>
                <h2 class="text-xl font-bold text-gray-900">Set Up Admin Password</h2>
                <p class="text-gray-500 mt-2">Create a master password for inventory management</p>
              </div>
              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="newPassword" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter password" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                  <input type="password" id="confirmPassword" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Confirm password" />
                </div>
                <button onclick="setupPassword()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                  Set Password
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'login') {
        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2 class="text-xl font-bold text-gray-900">Admin Login</h2>
                  <p class="text-gray-500 mt-1">Unlock to manage inventory</p>
                </div>
                <button onclick="closeModal()" class="p-1 text-gray-400 hover:text-gray-600">${icons.x}</button>
              </div>
              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}
              <div class="space-y-4">
                <input type="password" id="loginPassword" onkeydown="if(event.key==='Enter')login()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter password" autofocus />
                <button onclick="login()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                  Unlock
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'item') {
        const item = state.editingItem || {};
        const numBoxes = Number(item.numBoxes) || 0;
        const perBox = Number(item.perBox) || 0;
        const sold = Number(item.sold) || 0;
        const pricePerUnit = Number(item.pricePerUnit) || 0;
        const totalUnits = numBoxes * perBox;
        const remaining = totalUnits - sold;
        const expectedValue = sold * pricePerUnit;

        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-start mb-6">
                <h2 class="text-xl font-bold text-gray-900">${state.editingItem?.id ? 'Edit Item' : 'Add New Item'}</h2>
                <button onclick="closeModal()" class="p-1 text-gray-400 hover:text-gray-600">${icons.x}</button>
              </div>
              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}
              <div class="grid grid-cols-2 gap-4">
                <!-- Product Image -->
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
                  <div class="flex items-center gap-4">
                    <div id="itemImagePreview" class="w-20 h-20 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50">
                      ${item.image ? `
                        <img src="${item.image}" class="w-full h-full object-cover" />
                      ` : `
                        <span class="text-gray-400 text-2xl">ðŸ“¦</span>
                      `}
                    </div>
                    <div class="flex-1">
                      <input type="file" id="itemImageInput" accept="image/*" onchange="handleItemImageUpload(event)" class="hidden" />
                      <button type="button" onclick="document.getElementById('itemImageInput').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                        ${item.image ? 'Change Image' : 'Upload Image'}
                      </button>
                      ${item.image ? `
                        <button type="button" onclick="clearItemImage()" class="ml-2 px-3 py-2 text-red-600 text-sm font-medium hover:bg-red-50 rounded-lg transition">
                          Remove
                        </button>
                      ` : ''}
                      <p class="text-xs text-gray-400 mt-1">PNG, JPG up to 2MB</p>
                    </div>
                  </div>
                  <input type="hidden" id="itemImage" value="${item.image || ''}" />
                </div>

                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                  <input type="text" id="itemName" value="${item.name || ''}" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Jack Daniels" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                  <div class="flex gap-2">
                    ${CATEGORIES.map(cat => `
                      <button type="button" onclick="selectCategory('${cat.id}')" id="catBtn_${cat.id}" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg border-2 transition ${(item.category || 'liquor') === cat.id ? `${cat.bgColor} ${cat.textColor} ${cat.borderColor}` : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}">
                        ${cat.id === 'liquor' ? icons.wine : cat.id === 'beer' ? icons.beer : icons.cup}
                        <span class="font-medium text-sm">${cat.name}</span>
                      </button>
                    `).join('')}
                  </div>
                  <input type="hidden" id="itemCategory" value="${item.category || 'liquor'}" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Initial Amount</label>
                  <input type="number" id="itemAmount" value="${item.amount || ''}" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Starting qty" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Container Size</label>
                  <input type="text" id="itemBottleSize" value="${item.bottleSize || ''}" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="750ml, 12oz" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"># of Boxes</label>
                  <input type="number" id="itemNumBoxes" value="${item.numBoxes || ''}" oninput="updateItemPreview()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Boxes" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Per Box</label>
                  <input type="number" id="itemPerBox" value="${item.perBox || ''}" oninput="updateItemPreview()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Units" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Sold</label>
                  <input type="number" id="itemSold" value="${item.sold || 0}" oninput="updateItemPreview()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Price/Unit ($)</label>
                  <input type="number" step="0.01" id="itemPricePerUnit" value="${item.pricePerUnit || ''}" oninput="updateItemPreview()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-amber-700 mb-1">Cost/Unit ($) <span class="text-xs text-gray-400">â€” Admin only</span></label>
                  <input type="number" step="0.01" id="itemCostPerUnit" value="${item.costPerUnit || ''}" class="w-full px-4 py-2.5 border border-amber-200 bg-amber-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" />
                </div>
                <div class="col-span-2 p-4 bg-gray-50 rounded-lg">
                  <div class="grid grid-cols-3 gap-4 text-sm">
                    <div><span class="text-gray-500">Total:</span> <span class="font-medium" id="previewTotal">${totalUnits}</span></div>
                    <div><span class="text-gray-500">Left:</span> <span class="font-medium" id="previewRemaining">${remaining}</span></div>
                    <div><span class="text-gray-500">Value:</span> <span class="font-medium text-green-600" id="previewValue">${formatCurrency(expectedValue)}</span></div>
                  </div>
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition">Cancel</button>
                <button onclick="saveItem()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                  ${state.editingItem?.id ? 'Update' : 'Add Item'}
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'saleConfirm' && state.pendingSale) {
        const item = state.pendingSale;
        const activeTables = getActiveTables();
        const quantity = state.saleQuantity;
        const itemTotal = Number(item.pricePerUnit) * quantity;
        const calc = calculateFields(item);

        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-md p-5 max-h-[85vh] overflow-y-auto">
              <!-- Product Info -->
              <div class="flex items-start gap-4 mb-5">
                <div class="w-14 h-14 ${getCategoryInfo(item.category).darkBg} rounded-xl flex items-center justify-center text-white flex-shrink-0">
                  ${item.category === 'liquor' ? icons.wine : item.category === 'beer' ? icons.beer : icons.cup}
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="font-bold text-gray-900 text-lg leading-tight">${item.name}</h3>
                  <p class="text-green-600 font-semibold text-xl">${formatCurrency(item.pricePerUnit)}</p>
                  <p class="text-gray-400 text-sm">${calc.remaining} in stock</p>
                </div>
                <button onclick="closeSaleModal()" class="p-2 text-gray-400 hover:text-gray-600 -mr-2 -mt-1">
                  ${icons.x}
                </button>
              </div>

              <!-- Quantity Selector -->
              <div class="mb-5">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                <div class="flex items-center justify-center gap-4 bg-gray-50 rounded-xl p-3">
                  <button onclick="adjustQuantity(-1)" class="w-12 h-12 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-100 transition active:scale-95 text-2xl font-bold" ${quantity <= 1 ? 'disabled style="opacity:0.4"' : ''}>
                    âˆ’
                  </button>
                  <span class="text-3xl font-bold text-gray-900 w-16 text-center">${quantity}</span>
                  <button onclick="adjustQuantity(1)" class="w-12 h-12 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-100 transition active:scale-95 text-2xl font-bold" ${quantity >= calc.remaining ? 'disabled style="opacity:0.4"' : ''}>
                    +
                  </button>
                </div>
              </div>

              <!-- Table Selection -->
              <div class="mb-5">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-sm font-medium text-gray-700">Select Table</label>
                  <button onclick="addTableFromModal()" class="text-sm text-blue-600 font-medium flex items-center gap-1 hover:text-blue-700">
                    ${icons.plus} New Table
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto p-1">
                  ${activeTables.length === 0 ? `
                    <div class="col-span-3 text-center py-4 text-gray-400">
                      <p class="text-sm">No active tables</p>
                      <p class="text-xs">Click "New Table" to start</p>
                    </div>
                  ` : activeTables.map(table => `
                    <button onclick="selectTable(${table.id})" class="p-2 rounded-xl border-2 transition text-center ${state.selectedTableId === table.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'}">
                      <div class="font-bold text-lg">${table.number}</div>
                      ${table.name ? `<div class="text-xs truncate ${state.selectedTableId === table.id ? 'text-blue-600' : 'text-gray-500'}">${table.name}</div>` : ''}
                      <div class="text-xs ${state.selectedTableId === table.id ? 'text-blue-500' : 'text-gray-400'}">${formatCurrency(table.total)}</div>
                    </button>
                  `).join('')}
                </div>
              </div>

              <!-- Total & Confirm -->
              <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Total</span>
                  <span class="text-2xl font-bold text-green-600">${formatCurrency(itemTotal)}</span>
                </div>
                ${state.selectedTableId ? `
                  ${(() => {
                    const selectedTable = activeTables.find(t => t.id === state.selectedTableId);
                    const tableDisplay = selectedTable?.name
                      ? `Table ${selectedTable.number} (${selectedTable.name})`
                      : `Table ${selectedTable?.number || 'New'}`;
                    return `<div class="text-sm text-gray-500 mt-1">Adding to ${tableDisplay}</div>`;
                  })()}
                ` : `
                  <div class="text-sm text-gray-500 mt-1">Will create new table</div>
                `}
              </div>

              <div class="flex gap-3">
                <button onclick="closeSaleModal()" class="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="confirmSale()" class="flex-1 py-3.5 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                  ${icons.check}
                  Confirm Sale
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'tableDetail' && state.viewingTableId) {
        const table = state.tables.find(t => t.id === state.viewingTableId);
        if (!table) return '';
        const duration = getTableDuration(table);

        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-md p-5 max-h-[90vh] overflow-y-auto">
              <!-- Header with Table Number and Status -->
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 flex-wrap">
                    <h3 class="font-bold text-xl text-gray-900">Table ${table.number}</h3>
                    ${!table.isActive ? `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-600">Closed</span>` : ''}
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">â± ${duration}</span>
                  </div>
                </div>
                <button onclick="closeModal()" class="p-2 text-gray-400 hover:text-gray-600 -mr-2 -mt-1">
                  ${icons.x}
                </button>
              </div>

              <!-- Opened By Staff -->
              <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-xl">
                ${table.openedBy?.photo ? `
                  <img src="${table.openedBy.photo}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200" />
                ` : `
                  <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-sm">
                    ${(table.openedBy?.name || 'A').charAt(0).toUpperCase()}
                  </div>
                `}
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">Opened by ${table.openedBy?.name || 'Admin'}</p>
                  <p class="text-xs text-gray-500">${formatTime(table.createdAt)}${table.closedAt ? ` Â· Closed ${formatTime(table.closedAt)}` : ''}</p>
                </div>
              </div>

              <!-- Quick Add Item Button (for active tables) -->
              ${table.isActive ? `
                <button onclick="goToAddItemForTable(${table.id})" class="w-full mb-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm">
                  ${icons.plus}
                  Add Item to Order
                </button>
              ` : ''}

              <!-- Editable Info Section (only for active tables) -->
              ${table.isActive ? `
                <div class="grid grid-cols-2 gap-3 mb-4">
                  <!-- Table Name -->
                  <div class="col-span-2">
                    <label class="text-xs font-medium text-gray-500 mb-1 block">Table Name</label>
                    ${state.editingTableField === 'name' ? `
                      <div class="flex gap-2">
                        <input type="text" id="editTableName" value="${table.name || ''}" class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg text-sm focus:outline-none" placeholder="Add a name..." autofocus />
                        <button onclick="saveTableField('name')" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">Save</button>
                        <button onclick="cancelEditTableField()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">âœ•</button>
                      </div>
                    ` : `
                      <button onclick="startEditTableField('name', '${(table.name || '').replace(/'/g, "\\'")}')" class="w-full text-left px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-gray-300 transition flex items-center justify-between">
                        <span class="${table.name ? 'text-gray-900' : 'text-gray-400'}">${table.name || 'Add name...'}</span>
                        ${icons.edit}
                      </button>
                    `}
                  </div>

                  <!-- Guest Count -->
                  <div>
                    <label class="text-xs font-medium text-gray-500 mb-1 block">Guests</label>
                    <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-2">
                      <button onclick="adjustTableGuests(${table.id}, -1)" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 text-lg font-bold" ${(table.guestCount || 0) <= 0 ? 'disabled style="opacity:0.4"' : ''}>âˆ’</button>
                      <span class="flex-1 text-center font-bold text-gray-900">${table.guestCount || 0}</span>
                      <button onclick="adjustTableGuests(${table.id}, 1)" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 text-lg font-bold">+</button>
                    </div>
                  </div>

                  <!-- Time Open -->
                  <div>
                    <label class="text-xs font-medium text-gray-500 mb-1 block">Time Open</label>
                    <div class="px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-center">
                      <span class="font-bold text-blue-700">${duration}</span>
                    </div>
                  </div>
                </div>

                <!-- Notes -->
                <div class="mb-4">
                  <label class="text-xs font-medium text-gray-500 mb-1 block">Notes</label>
                  ${state.editingTableField === 'notes' ? `
                    <div class="space-y-2">
                      <textarea id="editTableNotes" class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg text-sm focus:outline-none resize-none" rows="2" placeholder="Special requests, allergies, etc...">${table.notes || ''}</textarea>
                      <div class="flex gap-2">
                        <button onclick="saveTableField('notes')" class="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">Save Note</button>
                        <button onclick="cancelEditTableField()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">âœ•</button>
                      </div>
                    </div>
                  ` : `
                    <button onclick="startEditTableField('notes', '')" class="w-full text-left px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-gray-300 transition ${table.notes ? '' : 'text-gray-400'}">
                      ${table.notes || 'Add notes (allergies, special requests...)'}
                    </button>
                  `}
                </div>
              ` : `
                <!-- Read-only info for closed tables -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                  ${table.name ? `
                    <div class="col-span-2 px-3 py-2 bg-gray-50 rounded-lg">
                      <span class="text-xs text-gray-500">Name:</span>
                      <span class="ml-2 text-sm font-medium text-gray-900">${table.name}</span>
                    </div>
                  ` : ''}
                  ${table.guestCount ? `
                    <div class="px-3 py-2 bg-gray-50 rounded-lg">
                      <span class="text-xs text-gray-500">Guests:</span>
                      <span class="ml-2 font-medium text-gray-900">${table.guestCount}</span>
                    </div>
                  ` : ''}
                  <div class="px-3 py-2 bg-gray-50 rounded-lg">
                    <span class="text-xs text-gray-500">Duration:</span>
                    <span class="ml-2 font-medium text-gray-900">${duration}</span>
                  </div>

                  <!-- Closed By Info -->
                  <div class="col-span-2 px-3 py-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center gap-3">
                      ${table.closedBy?.photo ? `
                        <img src="${table.closedBy.photo}" class="w-10 h-10 rounded-full object-cover border-2 border-green-300" alt="${table.closedBy.name}" />
                      ` : `
                        <div class="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-bold text-lg">
                          ${(table.closedBy?.name || 'A').charAt(0).toUpperCase()}
                        </div>
                      `}
                      <div class="flex-1">
                        <div class="text-xs text-green-600 font-medium">Closed By</div>
                        <div class="text-sm font-semibold text-green-800">${table.closedBy?.name || 'Admin'}</div>
                        <div class="text-xs text-green-600">${table.closedAt ? formatTime(table.closedAt) : 'Unknown time'}</div>
                      </div>
                      <div class="text-green-500 text-2xl">âœ“</div>
                    </div>
                  </div>

                  ${table.notes ? `
                    <div class="col-span-2 px-3 py-2 bg-amber-50 rounded-lg">
                      <span class="text-xs text-amber-600">Notes:</span>
                      <p class="text-sm text-amber-800 mt-1">${table.notes}</p>
                    </div>
                  ` : ''}
                </div>
              `}

              <!-- Orders List -->
              <div class="border-t border-gray-100 pt-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">Orders</span>
                  <span class="text-xs text-gray-400">${table.orders.length} items</span>
                </div>
                ${table.orders.length === 0 ? `
                  <p class="text-center text-gray-400 py-6">No orders yet</p>
                ` : `
                  <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${table.orders.map(order => `
                      <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-2">
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-gray-900 text-sm truncate">${order.productName}</p>
                          <p class="text-xs text-gray-500">${order.quantity}x ${formatCurrency(order.pricePerUnit)} Â· ${formatTime(order.timestamp)}</p>
                        </div>
                        <span class="font-bold text-gray-900 text-sm">${formatCurrency(order.total)}</span>
                        ${table.isActive ? `
                          <button onclick="startEditOrder(${order.id})" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-blue-100 hover:text-blue-600 transition" title="Edit quantity">
                            ${icons.edit}
                          </button>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>

              <!-- Total -->
              <div class="${table.isActive ? 'bg-green-50' : 'bg-gray-50'} rounded-xl p-4 mb-4">
                <div class="flex justify-between items-center">
                  <span class="${table.isActive ? 'text-green-700' : 'text-gray-700'} font-medium">Table Total</span>
                  <span class="text-2xl font-bold ${table.isActive ? 'text-green-700' : 'text-gray-700'}">${formatCurrency(table.total)}</span>
                </div>
              </div>

              <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Back
                </button>
                ${table.isActive ? `
                  <button onclick="closeOutTable(${table.id})" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    ${icons.checkCircle}
                    Close Out
                  </button>
                ` : `
                  <button onclick="reopenTableAction(${table.id})" class="flex-1 py-3.5 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition flex items-center justify-center gap-2">
                    ${icons.refresh}
                    Reopen
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'newTable') {
        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-sm p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-xl text-gray-900">New Table</h3>
                <button onclick="closeModal()" class="p-2 text-gray-400 hover:text-gray-600">
                  ${icons.x}
                </button>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Table Name (optional)</label>
                <input
                  type="text"
                  id="newTableNameInput"
                  value="${state.newTableName}"
                  oninput="state.newTableName = this.value"
                  placeholder="e.g., Patio, VIP, Birthday Party"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500"
                  autofocus
                />
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Guests</label>
                <div class="flex items-center gap-3">
                  <button onclick="adjustNewTableGuests(-1)" class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition text-xl font-bold" ${state.newTableGuestCount <= 0 ? 'disabled style="opacity:0.4"' : ''}>âˆ’</button>
                  <span class="text-2xl font-bold text-gray-900 w-12 text-center">${state.newTableGuestCount || 0}</span>
                  <button onclick="adjustNewTableGuests(1)" class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition text-xl font-bold">+</button>
                </div>
              </div>

              <div class="bg-blue-50 rounded-xl p-3 mb-4 flex items-center gap-3">
                ${state.currentStaff?.photo ? `
                  <img src="${state.currentStaff.photo}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-200" />
                ` : `
                  <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-600 font-bold">
                    ${(state.currentStaff?.name || 'A').charAt(0).toUpperCase()}
                  </div>
                `}
                <div>
                  <p class="text-sm font-semibold text-blue-700">Table ${getNextTableNumber()}</p>
                  <p class="text-xs text-blue-600">Opened by ${state.currentStaff?.name || 'Admin'}</p>
                </div>
              </div>

              <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="createTableWithName()" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">
                  Create Table
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'newTableQuick') {
        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-sm p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-xl text-gray-900">New Table</h3>
                <button onclick="cancelNewTableQuick()" class="p-2 text-gray-400 hover:text-gray-600">
                  ${icons.x}
                </button>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Table Name (optional)</label>
                <input
                  type="text"
                  id="newTableNameQuickInput"
                  value="${state.newTableName}"
                  oninput="state.newTableName = this.value"
                  placeholder="e.g., Patio, VIP, Birthday Party"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500"
                  autofocus
                />
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Guests</label>
                <div class="flex items-center gap-3">
                  <button onclick="adjustNewTableGuests(-1)" class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition text-lg font-bold" ${state.newTableGuestCount <= 0 ? 'disabled style="opacity:0.4"' : ''}>âˆ’</button>
                  <span class="text-xl font-bold text-gray-900 w-10 text-center">${state.newTableGuestCount || 0}</span>
                  <button onclick="adjustNewTableGuests(1)" class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition text-lg font-bold">+</button>
                </div>
              </div>

              <div class="bg-blue-50 rounded-xl p-3 mb-4 flex items-center gap-3">
                ${state.currentStaff?.photo ? `
                  <img src="${state.currentStaff.photo}" class="w-8 h-8 rounded-full object-cover border-2 border-blue-200" />
                ` : ''}
                <p class="text-sm text-blue-700">
                  <span class="font-semibold">Table ${getNextTableNumber()}</span> will be created
                </p>
              </div>

              <div class="flex gap-3">
                <button onclick="cancelNewTableQuick()" class="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="createTableFromSale()" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">
                  Create & Select
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'adminConfirm' && state.pendingAdminAction) {
        const action = state.pendingAdminAction;
        let title = 'Admin Authorization Required';
        let description = 'Enter admin password to continue.';

        if (action.type === 'reopen') {
          title = 'Reopen Table';
          description = `Admin password required to reopen Table ${action.data.tableNumber}.`;
        } else if (action.type === 'removeItem') {
          title = 'Remove Item';
          description = `Admin password required to remove ${action.data.productName} from Table ${action.data.tableNumber}.`;
        } else if (action.type === 'editStaff') {
          const staff = state.staffProfiles.find(s => s.id === action.data.staffId);
          title = 'Edit Staff';
          description = `Admin password required to edit ${staff?.name || 'staff'}'s ${action.data.field}.`;
        } else if (action.type === 'deleteStaff') {
          title = 'Delete Staff';
          description = `Admin password required to delete ${action.data.staffName}'s account.`;
        }

        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6">
              <div class="text-center mb-4">
                <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3 text-amber-600">
                  ${icons.lock.replace('w-4 h-4', 'w-8 h-8')}
                </div>
                <h3 class="font-bold text-xl text-gray-900">${title}</h3>
                <p class="text-gray-500 text-sm mt-1">${description}</p>
              </div>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <input
                type="password"
                id="adminPasswordInput"
                value="${state.adminPasswordInput}"
                oninput="state.adminPasswordInput = this.value; state.error = ''"
                onkeydown="if(event.key === 'Enter') verifyAdminAndExecute()"
                placeholder="Enter admin password"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-amber-500 text-center mb-4"
                autofocus
              />

              <div class="flex gap-3">
                <button onclick="cancelAdminAction()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="verifyAdminAndExecute()" class="flex-1 py-3 bg-amber-600 text-white rounded-xl font-medium hover:bg-amber-700 transition">
                  Authorize
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'editOrder' && state.editingOrderId) {
        const table = state.tables.find(t => t.id === state.viewingTableId);
        const order = table?.orders.find(o => o.id === state.editingOrderId);
        if (!table || !order) return '';

        const isFullRemoval = state.editingOrderQty <= 0;

        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-sm p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-xl text-gray-900">Edit Order</h3>
                <button onclick="cancelEditOrder()" class="p-2 text-gray-400 hover:text-gray-600">
                  ${icons.x}
                </button>
              </div>

              <div class="bg-gray-50 rounded-xl p-3 mb-4">
                <p class="font-medium text-gray-900">${order.productName}</p>
                <p class="text-sm text-gray-500">Original: ${order.quantity} Ã— ${formatCurrency(order.pricePerUnit)}</p>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">New Quantity</label>
                <div class="flex items-center justify-center gap-4 bg-gray-50 rounded-xl p-3">
                  <button onclick="adjustEditQty(-1)" class="w-12 h-12 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-100 transition text-2xl font-bold">âˆ’</button>
                  <span class="text-3xl font-bold ${state.editingOrderQty <= 0 ? 'text-red-600' : 'text-gray-900'} w-16 text-center">${state.editingOrderQty}</span>
                  <button onclick="adjustEditQty(1)" class="w-12 h-12 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-100 transition text-2xl font-bold" ${state.editingOrderQty >= order.quantity ? 'disabled style="opacity:0.4"' : ''}>+</button>
                </div>
              </div>

              ${isFullRemoval ? `
                <div class="bg-red-50 rounded-xl p-3 mb-4 flex items-center gap-2">
                  <span class="text-red-600">${icons.alert.replace('w-3 h-3', 'w-5 h-5')}</span>
                  <div>
                    <p class="font-medium text-red-700">Full Removal</p>
                    <p class="text-sm text-red-600">Requires admin approval</p>
                  </div>
                </div>
              ` : `
                <div class="bg-blue-50 rounded-xl p-3 mb-4">
                  <p class="text-sm text-blue-700">
                    Reducing by <strong>${order.quantity - state.editingOrderQty}</strong> Â· New total: <strong>${formatCurrency(state.editingOrderQty * (Number(order.pricePerUnit) || 0))}</strong>
                  </p>
                </div>
              `}

              <div class="flex gap-3">
                <button onclick="cancelEditOrder()" class="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="confirmEditOrder()" class="flex-1 py-3.5 ${isFullRemoval ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-xl font-medium transition">
                  ${isFullRemoval ? 'Remove (Admin)' : 'Update'}
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'staffManagement') {
        return `
          <div class="fixed inset-0 modal-overlay flex items-end sm:items-center justify-center z-50 animate-fade">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-xl w-full sm:max-w-md p-5 max-h-[85vh] overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="font-bold text-xl text-gray-900">Staff Management</h3>
                  <p class="text-sm text-gray-500">${state.staffProfiles.length} staff member${state.staffProfiles.length !== 1 ? 's' : ''}</p>
                </div>
                <button onclick="closeModal()" class="p-2 text-gray-400 hover:text-gray-600">
                  ${icons.x}
                </button>
              </div>

              ${state.staffProfiles.length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                  <div class="text-5xl mb-3">ðŸ‘¥</div>
                  <p class="font-medium">No staff members yet</p>
                  <p class="text-sm">Staff accounts are created when logging in with a new PIN</p>
                </div>
              ` : `
                <div class="space-y-3">
                  ${state.staffProfiles.map(staff => `
                    <div class="bg-gray-50 rounded-xl p-4">
                      <div class="flex items-center gap-3 mb-3">
                        ${staff.photo ? `
                          <img src="${staff.photo}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-200" />
                        ` : `
                          <div class="w-14 h-14 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-xl">
                            ${staff.name.charAt(0).toUpperCase()}
                          </div>
                        `}
                        <div class="flex-1 min-w-0">
                          ${state.editingStaffId === staff.id && state.editingStaffField === 'name' ? `
                            <div class="flex gap-2">
                              <input type="text" id="editStaffNameInput" value="${staff.name}" class="flex-1 px-2 py-1 border-2 border-blue-500 rounded-lg text-sm" autofocus />
                              <button onclick="confirmEditStaffField()" class="px-2 py-1 bg-blue-600 text-white rounded-lg text-xs">Save</button>
                              <button onclick="cancelEditStaffField()" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-lg text-xs">âœ•</button>
                            </div>
                          ` : `
                            <p class="font-bold text-gray-900 truncate">${staff.name}</p>
                            <p class="text-xs text-gray-500">Since ${new Date(staff.createdAt).toLocaleDateString()}</p>
                          `}
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="editStaff(${staff.id}, 'name')" class="flex-1 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition flex items-center justify-center gap-1">
                          ${icons.edit} Name
                        </button>
                        <button onclick="editStaff(${staff.id}, 'photo')" class="flex-1 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition flex items-center justify-center gap-1">
                          ${icons.camera.replace('w-8 h-8', 'w-4 h-4')} Photo
                        </button>
                        <button onclick="editStaff(${staff.id}, 'pin')" class="flex-1 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition flex items-center justify-center gap-1">
                          ${icons.lock} PIN
                        </button>
                        <button onclick="deleteStaff(${staff.id})" class="py-2 px-3 bg-red-50 border border-red-200 rounded-lg text-xs font-medium text-red-600 hover:bg-red-100 transition">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}

              <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                Done
              </button>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'editStaffPhoto') {
        const staff = state.staffProfiles.find(s => s.id === state.editingStaffId);
        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
              <h3 class="font-bold text-xl text-gray-900 mb-2">Update Photo</h3>
              <p class="text-gray-500 mb-4">${staff?.name || 'Staff'}</p>

              <div class="camera-container mx-auto mb-4 bg-gray-900 border-4 border-blue-200">
                ${state.cameraStream ? `
                  <video id="cameraPreview" autoplay playsinline muted class="w-full h-full"></video>
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                      ${icons.camera}
                      <p class="text-sm mt-2">Loading camera...</p>
                    </div>
                  </div>
                `}
              </div>

              <div class="flex gap-3">
                <button onclick="cancelEditStaffPhoto()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="captureNewStaffPhoto()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition" ${!state.cameraStream ? 'disabled' : ''}>
                  Capture
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'resetStaffPin') {
        const staff = state.staffProfiles.find(s => s.id === state.editingStaffId);
        return `
          <div class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 animate-fade">
            <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
              <h3 class="font-bold text-xl text-gray-900 mb-2">Reset PIN</h3>
              <p class="text-gray-500 mb-4">${staff?.name || 'Staff'}</p>

              ${state.error ? `<div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm">${state.error}</div>` : ''}

              <div class="flex justify-center gap-3 mb-6">
                ${[0,1,2,3].map(i => `
                  <div class="pin-digit border-2 ${state.staffPinInput.length > i ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-xl flex items-center justify-center font-bold text-2xl text-blue-600">
                    ${state.staffPinInput.length > i ? 'â€¢' : ''}
                  </div>
                `).join('')}
              </div>

              ${renderNumpad('resetPin')}

              <div class="flex gap-3 mt-4">
                <button onclick="cancelResetPin()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                  Cancel
                </button>
                <button onclick="confirmResetPin()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition" ${state.staffPinInput.length !== 4 ? 'disabled style="opacity:0.5"' : ''}>
                  Save PIN
                </button>
              </div>
            </div>
          </div>
        `;
      }

      return '';
    };

    // ===== EVENT HANDLERS =====
    window.switchTab = (tab) => {
      state.currentTab = tab;
      state.staffPinInput = '';
      state.error = '';
      state.setupStep = ''; // Reset setup step
      state.newStaffName = '';
      state.newStaffPhoto = null;
      state.newStaffPin = '';
      stopCamera();
      render();
    };

    window.goToCamera = () => {
      if (!state.newStaffName.trim()) {
        state.error = 'Please enter your name';
        render();
        return;
      }
      state.error = '';
      state.setupStep = 'camera';
      render();
      startCamera();
    };

    window.goBackToName = () => {
      stopCamera();
      state.setupStep = 'name';
      state.error = '';
      render();
    };

    window.goBackToCamera = () => {
      state.setupStep = 'camera';
      state.staffPinInput = '';
      state.error = '';
      render();
      startCamera();
    };

    window.goBackToPin = () => {
      state.setupStep = 'pin';
      state.staffPinInput = '';
      state.error = '';
      render();
    };

    window.goBackFromConfirm = () => {
      state.staffPinInput = '';
      state.error = '';
      // If we came from newPinDetected flow, go back to camera (PIN already set)
      // Otherwise go back to pin step
      state.setupStep = 'camera';
      render();
      startCamera();
    };

    window.skipPhoto = () => {
      stopCamera();
      state.newStaffPhoto = null;
      // If PIN already set (from newPinDetected flow), go to confirm
      state.setupStep = state.newStaffPin ? 'confirm' : 'pin';
      render();
    };

    window.startAddNewStaff = () => {
      state.setupStep = 'name';
      state.newStaffName = '';
      state.newStaffPhoto = null;
      state.newStaffPin = '';
      state.staffPinInput = '';
      state.error = '';
      render();
    };

    window.continueNewAccountSetup = () => {
      // PIN is already saved in state.newStaffPin, go to name step
      state.setupStep = 'name';
      state.newStaffName = '';
      state.newStaffPhoto = null;
      state.error = '';
      render();
    };

    window.cancelNewAccount = () => {
      state.setupStep = ''; // Reset to show login screen
      state.newStaffName = '';
      state.newStaffPhoto = null;
      state.newStaffPin = '';
      state.staffPinInput = '';
      state.error = '';
      render();
    };

    // Staff management functions
    window.openStaffManagement = () => {
      state.currentModal = 'staffManagement';
      render();
    };

    window.editStaff = (staffId, field) => {
      // Require admin approval
      state.pendingAdminAction = {
        type: 'editStaff',
        data: { staffId, field }
      };
      state.adminPasswordInput = '';
      state.error = '';
      state.currentModal = 'adminConfirm';
      render();
    };

    window.deleteStaff = (staffId) => {
      const staff = state.staffProfiles.find(s => s.id === staffId);
      if (!staff) return;

      state.pendingAdminAction = {
        type: 'deleteStaff',
        data: { staffId, staffName: staff.name }
      };
      state.adminPasswordInput = '';
      state.error = '';
      state.currentModal = 'adminConfirm';
      render();
    };

    window.confirmEditStaffField = () => {
      const staff = state.staffProfiles.find(s => s.id === state.editingStaffId);
      if (!staff) return;

      if (state.editingStaffField === 'name') {
        const input = document.getElementById('editStaffNameInput');
        if (input && input.value.trim()) {
          staff.name = input.value.trim();
          saveStaffProfiles();
        }
      }

      state.editingStaffId = null;
      state.editingStaffField = null;
      render();
    };

    window.cancelEditStaffField = () => {
      state.editingStaffId = null;
      state.editingStaffField = null;
      render();
    };

    window.startEditStaffPhoto = (staffId) => {
      state.editingStaffId = staffId;
      state.editingStaffField = 'photo';
      state.currentModal = 'editStaffPhoto';
      render();
      setTimeout(() => startCamera(), 100);
    };

    window.captureNewStaffPhoto = () => {
      const video = document.getElementById('cameraPreview');
      const canvas = document.createElement('canvas');
      canvas.width = 320;
      canvas.height = 320;
      const ctx = canvas.getContext('2d');

      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);

      const size = Math.min(video.videoWidth, video.videoHeight);
      const x = (video.videoWidth - size) / 2;
      const y = (video.videoHeight - size) / 2;
      ctx.drawImage(video, x, y, size, size, 0, 0, canvas.width, canvas.height);

      const photo = canvas.toDataURL('image/jpeg', 0.8);
      const staff = state.staffProfiles.find(s => s.id === state.editingStaffId);
      if (staff) {
        staff.photo = photo;
        saveStaffProfiles();
      }

      stopCamera();
      state.editingStaffId = null;
      state.editingStaffField = null;
      state.currentModal = 'staffManagement';
      render();
    };

    window.resetStaffPin = (staffId) => {
      state.editingStaffId = staffId;
      state.editingStaffField = 'pin';
      state.staffPinInput = '';
      state.currentModal = 'resetStaffPin';
      render();
    };

    window.confirmResetPin = () => {
      if (state.staffPinInput.length !== 4) {
        state.error = 'Please enter a 4-digit PIN';
        render();
        return;
      }

      const staff = state.staffProfiles.find(s => s.id === state.editingStaffId);
      if (staff) {
        staff.pin = hashPassword(state.staffPinInput);
        saveStaffProfiles();
      }

      state.editingStaffId = null;
      state.editingStaffField = null;
      state.staffPinInput = '';
      state.currentModal = 'staffManagement';
      render();
    };

    window.cancelResetPin = () => {
      state.editingStaffId = null;
      state.editingStaffField = null;
      state.staffPinInput = '';
      state.currentModal = 'staffManagement';
      render();
    };

    window.cancelEditStaffPhoto = () => {
      stopCamera();
      state.editingStaffId = null;
      state.editingStaffField = null;
      state.currentModal = 'staffManagement';
      render();
    };

    window.updateSearch = (value) => {
      state.searchTerm = value;
      render();
    };

    window.setCategory = (category) => {
      state.categoryFilter = category;
      render();
    };

    window.setStaffCategory = (category) => {
      state.staffCategoryFilter = category;
      render();
    };

    window.selectCategory = (categoryId) => {
      document.getElementById('itemCategory').value = categoryId;
      CATEGORIES.forEach(cat => {
        const btn = document.getElementById(`catBtn_${cat.id}`);
        if (btn) {
          if (cat.id === categoryId) {
            btn.className = `flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg border-2 transition ${cat.bgColor} ${cat.textColor} ${cat.borderColor}`;
          } else {
            btn.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg border-2 transition bg-white text-gray-600 border-gray-200 hover:bg-gray-50';
          }
        }
      });
    };

    window.toggleCost = () => {
      state.showCost = !state.showCost;
      render();
    };

    window.logout = () => {
      state.isAuthenticated = false;
      state.showCost = false;
      render();
    };

    window.staffLogout = () => {
      state.isStaffAuthenticated = false;
      state.currentStaff = null;
      state.staffPinInput = '';
      render();
    };

    // BOH Functions
    window.bohLogout = () => {
      state.isStaffAuthenticated = false;
      state.currentStaff = null;
      state.staffPinInput = '';
      state.bohPendingCart = [];
      state.bohShowHistory = false;
      render();
    };

    window.setBohCategoryFilter = (category) => {
      state.bohCategoryFilter = category;
      render();
    };

    window.setBohShowHistory = (show) => {
      state.bohShowHistory = show;
      render();
    };

    window.addToBohCart = (item) => {
      addToBohCart(item);
    };

    window.removeFromBohCart = (productId) => {
      removeFromBohCart(productId);
    };

    window.clearBohCart = () => {
      if (confirm('Clear all pending items?')) {
        clearBohCart();
      }
    };

    window.confirmBohCart = () => {
      confirmBohCart();
    };

    window.submitBohCartToFoh = (fohStaffId) => {
      submitBohCartToFoh(fohStaffId);
    };

    window.cancelBohFohSelection = () => {
      cancelBohFohSelection();
    };

    window.removeBohDisbursementConfirm = (id) => {
      // Only admins can delete BOH history entries
      if (state.currentStaff?.role !== 'admin') {
        alert('Only administrators can delete history entries.');
        return;
      }
      if (confirm('Remove this item from today\'s count?')) {
        removeBohDisbursement(id);
      }
    };

    window.showLoginModal = () => {
      state.currentModal = 'login';
      state.error = '';
      render();
      setTimeout(() => document.getElementById('loginPassword')?.focus(), 100);
    };

    window.showAddModal = () => {
      state.editingItem = { sold: 0, category: state.categoryFilter !== 'all' ? state.categoryFilter : 'liquor' };
      state.currentModal = 'item';
      state.error = '';
      render();
    };

    window.showEditModal = (id) => {
      state.editingItem = { ...state.inventory.find(i => i.id === id) };
      state.currentModal = 'item';
      state.error = '';
      render();
    };

    window.closeModal = () => {
      state.currentModal = null;
      state.editingItem = null;
      state.error = '';
      render();
    };

    window.pinInput = (digit, action) => {
      if (state.staffPinInput.length >= 4) return;
      state.staffPinInput += digit;

      if (state.staffPinInput.length === 4) {
        setTimeout(() => {
          if (action === 'setupPin') {
            state.newStaffPin = state.staffPinInput;
            state.staffPinInput = '';
            state.setupStep = 'confirm';
          } else if (action === 'confirmPin') {
            if (state.staffPinInput === state.newStaffPin) {
              // Save new staff profile
              const newProfile = {
                id: Date.now(),
                name: state.newStaffName.trim(),
                pin: hashPassword(state.newStaffPin),
                photo: state.newStaffPhoto,
                role: state.newStaffRole || 'foh',
                createdAt: new Date().toISOString()
              };
              state.staffProfiles.push(newProfile);
              saveStaffProfiles();

              // Auto-login
              state.currentStaff = newProfile;
              state.isStaffAuthenticated = true;

              // Reset setup state
              state.newStaffName = '';
              state.newStaffPhoto = null;
              state.newStaffPin = '';
              state.newStaffRole = 'foh';
              state.staffPinInput = '';
              state.setupStep = 'name';
            } else {
              state.error = 'PINs do not match. Try again.';
              state.staffPinInput = '';
              state.setupStep = 'pin';
            }
          } else if (action === 'staffLogin') {
            const hashedInput = hashPassword(state.staffPinInput);
            const matchingStaff = state.staffProfiles.find(s => s.pin === hashedInput);

            if (matchingStaff) {
              state.currentStaff = matchingStaff;
              state.isStaffAuthenticated = true;
              state.staffPinInput = '';
              state.error = '';
            } else {
              // New PIN - prompt to create account
              state.newStaffPin = state.staffPinInput;
              state.staffPinInput = '';
              state.setupStep = 'newPinDetected';
              state.error = '';
            }
          } else if (action === 'resetPin') {
            // Just collecting PIN for reset, don't auto-submit
          }
          render();
        }, 200);
      }
      render();
    };

    window.pinBackspace = () => {
      state.staffPinInput = state.staffPinInput.slice(0, -1);
      render();
    };

    window.setupPassword = () => {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword.length < 4) {
        state.error = 'Password must be at least 4 characters';
        render();
        return;
      }
      if (newPassword !== confirmPassword) {
        state.error = 'Passwords do not match';
        render();
        return;
      }

      localStorage.setItem('inventory_password', hashPassword(newPassword));
      state.isAuthenticated = true;
      state.currentModal = null;
      state.error = '';
      render();
    };

    window.login = () => {
      const password = document.getElementById('loginPassword').value;
      const savedPassword = localStorage.getItem('inventory_password');

      if (hashPassword(password) === savedPassword) {
        state.isAuthenticated = true;
        state.currentModal = null;
        state.error = '';
      } else {
        state.error = 'Incorrect password';
      }
      render();
    };

    // Image upload handlers for products
    window.handleItemImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      // Check file size (2MB max)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be less than 2MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const imageData = e.target.result;
        document.getElementById('itemImage').value = imageData;

        // Update preview
        const preview = document.getElementById('itemImagePreview');
        preview.innerHTML = `<img src="${imageData}" class="w-full h-full object-cover" />`;

        // Update editingItem so it persists
        if (state.editingItem) {
          state.editingItem.image = imageData;
        }
      };
      reader.readAsDataURL(file);
    };

    window.clearItemImage = () => {
      document.getElementById('itemImage').value = '';
      document.getElementById('itemImagePreview').innerHTML = '<span class="text-gray-400 text-2xl">ðŸ“¦</span>';
      if (state.editingItem) {
        state.editingItem.image = '';
      }
    };

    window.saveItem = () => {
      const name = document.getElementById('itemName').value.trim();
      if (!name) {
        state.error = 'Product name is required';
        render();
        return;
      }

      const itemData = {
        id: state.editingItem?.id || Date.now(),
        name,
        image: document.getElementById('itemImage').value || state.editingItem?.image || '',
        category: document.getElementById('itemCategory').value,
        amount: document.getElementById('itemAmount').value,
        bottleSize: document.getElementById('itemBottleSize').value,
        numBoxes: document.getElementById('itemNumBoxes').value,
        perBox: document.getElementById('itemPerBox').value,
        sold: document.getElementById('itemSold').value || 0,
        pricePerUnit: document.getElementById('itemPricePerUnit').value,
        costPerUnit: document.getElementById('itemCostPerUnit').value,
        updatedAt: new Date().toISOString(),
        createdAt: state.editingItem?.createdAt || new Date().toISOString()
      };

      const cat = getCategoryInfo(itemData.category);
      if (state.editingItem?.id) {
        state.inventory = state.inventory.map(item =>
          item.id === state.editingItem.id ? itemData : item
        );
        addLogEntry('Updated', name, `${cat.name}`);
      } else {
        state.inventory.push(itemData);
        addLogEntry('Added', name, `${cat.name}`);
      }

      saveData();
      closeModal();
    };

    window.deleteItem = (id) => {
      const item = state.inventory.find(i => i.id === id);
      if (confirm(`Delete "${item.name}"?`)) {
        state.inventory = state.inventory.filter(i => i.id !== id);
        addLogEntry('Deleted', item.name, '');
        saveData();
        render();
      }
    };

    window.recordSale = (item) => {
      recordSale(item);
    };

    window.undoSale = (id) => {
      const item = state.inventory.find(i => i.id === id);
      if (item) undoLastSale(item);
    };

    window.adjustQuantity = (delta) => {
      const item = state.pendingSale;
      if (!item) return;
      const calc = calculateFields(item);
      const newQty = state.saleQuantity + delta;
      if (newQty >= 1 && newQty <= calc.remaining) {
        state.saleQuantity = newQty;
        render();
      }
    };

    window.selectTable = (tableId) => {
      state.selectedTableId = tableId;
      render();
    };

    window.addTableFromModal = () => {
      const newTable = addNewTable();
      state.selectedTableId = newTable.id;
      render();
    };

    window.closeSaleModal = () => {
      state.pendingSale = null;
      state.saleQuantity = 1;
      state.selectedTableId = null;
      state.currentModal = null;
      render();
    };

    window.confirmSale = confirmSale;

    window.switchStaffView = (view) => {
      state.staffView = view;
      render();
    };

    window.viewTable = (tableId) => {
      state.viewingTableId = tableId;
      state.currentModal = 'tableDetail';
      render();
    };

    window.goToAddItemForTable = (tableId) => {
      // Pre-select this table for the next order
      state.selectedTableId = tableId;
      state.currentModal = null;
      state.viewingTableId = null;
      state.staffView = 'products';
      render();
    };

    window.closeOutTable = (tableId) => {
      const table = state.tables.find(t => t.id === tableId);
      if (!table) return;

      const tableDisplay = table.name ? `Table ${table.number} (${table.name})` : `Table ${table.number}`;
      if (confirm(`Close out ${tableDisplay}?\nTotal: ${formatCurrency(table.total)}`)) {
        table.isActive = false;
        table.closedAt = new Date().toISOString();
        // Store who closed the table
        table.closedBy = {
          id: state.currentStaff?.id || null,
          name: state.currentStaff?.name || 'Admin',
          photo: state.currentStaff?.photo || null
        };
        saveTables();
        addTableLog(table.number, table.name, 'Closed', `Total: ${formatCurrency(table.total)} - ${table.orders.length} items`);
        state.currentModal = null;
        state.viewingTableId = null;
        render();
      }
    };

    window.reopenTableAction = (tableId) => {
      const table = state.tables.find(t => t.id === tableId);
      if (!table) return;

      // Require admin password to reopen
      state.pendingAdminAction = {
        type: 'reopen',
        data: {
          tableId: tableId,
          tableNumber: table.number,
          tableName: table.name
        }
      };
      state.adminPasswordInput = '';
      state.error = '';
      state.currentModal = 'adminConfirm';
      render();
      setTimeout(() => document.getElementById('adminPasswordInput')?.focus(), 100);
    };

    window.verifyAdminAndExecute = () => {
      const savedPassword = localStorage.getItem('inventory_password');
      const inputHash = hashPassword(state.adminPasswordInput);

      if (inputHash !== savedPassword) {
        state.error = 'Incorrect admin password';
        state.adminPasswordInput = '';
        render();
        return;
      }

      // Password verified, execute the pending action
      const action = state.pendingAdminAction;
      if (action.type === 'reopen') {
        reopenTable(action.data.tableId);
        state.currentModal = null;
        state.viewingTableId = null;
      } else if (action.type === 'removeItem') {
        removeOrderItem(action.data.tableId, action.data.orderId);
        state.currentModal = 'tableDetail';
      } else if (action.type === 'editStaff') {
        // Authorized to edit staff
        state.editingStaffId = action.data.staffId;
        state.editingStaffField = action.data.field;
        if (action.data.field === 'photo') {
          state.currentModal = 'editStaffPhoto';
          setTimeout(() => startCamera(), 100);
        } else if (action.data.field === 'pin') {
          state.staffPinInput = '';
          state.currentModal = 'resetStaffPin';
        } else {
          state.currentModal = 'staffManagement';
        }
      } else if (action.type === 'deleteStaff') {
        // Delete the staff member
        state.staffProfiles = state.staffProfiles.filter(s => s.id !== action.data.staffId);
        saveStaffProfiles();
        state.currentModal = 'staffManagement';
      }

      // Clean up
      state.pendingAdminAction = null;
      state.adminPasswordInput = '';
      state.error = '';
      render();
    };

    window.cancelAdminAction = () => {
      state.pendingAdminAction = null;
      state.adminPasswordInput = '';
      state.error = '';
      // Go back to previous modal if there was one
      if (state.viewingTableId) {
        state.currentModal = 'tableDetail';
      } else {
        state.currentModal = null;
      }
      render();
    };

    window.toggleClosedTables = () => {
      state.showClosedTables = !state.showClosedTables;
      render();
    };

    window.addNewTableFromView = () => {
      state.newTableName = '';
      state.currentModal = 'newTable';
      render();
    };

    window.createTableWithName = () => {
      addNewTable(state.newTableName, state.newTableGuestCount);
      state.newTableName = '';
      state.newTableGuestCount = 0;
      state.currentModal = null;
      render();
    };

    window.addTableFromModal = () => {
      // Quick add from sale confirmation - opens new table modal
      state.newTableGuestCount = 0;
      state.currentModal = 'newTableQuick';
      render();
    };

    window.createTableFromSale = () => {
      const newTable = addNewTable(state.newTableName, state.newTableGuestCount);
      state.selectedTableId = newTable.id;
      state.newTableName = '';
      state.newTableGuestCount = 0;
      state.currentModal = 'saleConfirm';
      render();
    };

    window.cancelNewTableQuick = () => {
      state.newTableName = '';
      state.newTableGuestCount = 0;
      state.currentModal = 'saleConfirm';
      render();
    };

    window.adjustNewTableGuests = (delta) => {
      state.newTableGuestCount = Math.max(0, (state.newTableGuestCount || 0) + delta);
      render();
    };

    window.adjustTableGuests = (tableId, delta) => {
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        const newCount = Math.max(0, (table.guestCount || 0) + delta);
        updateTable(tableId, { guestCount: newCount });
        render();
      }
    };

    window.startEditTableField = (field, currentValue) => {
      state.editingTableField = field;
      state.editTableValue = currentValue;
      render();
      setTimeout(() => {
        const input = document.getElementById(field === 'name' ? 'editTableName' : 'editTableNotes');
        if (input) input.focus();
      }, 50);
    };

    window.saveTableField = (field) => {
      const table = state.tables.find(t => t.id === state.viewingTableId);
      if (!table) return;

      if (field === 'name') {
        const input = document.getElementById('editTableName');
        updateTable(table.id, { name: input?.value || '' });
      } else if (field === 'notes') {
        const textarea = document.getElementById('editTableNotes');
        updateTable(table.id, { notes: textarea?.value || '' });
      }
      state.editingTableField = null;
      state.editTableValue = '';
      render();
    };

    window.cancelEditTableField = () => {
      state.editingTableField = null;
      state.editTableValue = '';
      render();
    };

    window.startEditOrder = (orderId) => {
      const table = state.tables.find(t => t.id === state.viewingTableId);
      const order = table?.orders.find(o => o.id === orderId);
      if (!order) return;

      state.editingOrderId = orderId;
      state.editingOrderQty = order.quantity;
      state.currentModal = 'editOrder';
      render();
    };

    window.adjustEditQty = (delta) => {
      const table = state.tables.find(t => t.id === state.viewingTableId);
      const order = table?.orders.find(o => o.id === state.editingOrderId);
      if (!order) return;

      const newQty = state.editingOrderQty + delta;
      if (newQty >= 0 && newQty <= order.quantity) {
        state.editingOrderQty = newQty;
        render();
      }
    };

    window.confirmEditOrder = () => {
      const table = state.tables.find(t => t.id === state.viewingTableId);
      const order = table?.orders.find(o => o.id === state.editingOrderId);
      if (!table || !order) return;

      const newQty = state.editingOrderQty;
      const reduction = order.quantity - newQty;

      if (newQty <= 0) {
        // Full removal requires admin approval
        state.pendingAdminAction = {
          type: 'removeItem',
          data: {
            tableId: table.id,
            tableNumber: table.number,
            orderId: order.id,
            productName: order.productName
          }
        };
        state.adminPasswordInput = '';
        state.error = '';
        state.editingOrderId = null;
        state.editingOrderQty = 0;
        state.currentModal = 'adminConfirm';
        render();
        setTimeout(() => document.getElementById('adminPasswordInput')?.focus(), 100);
      } else if (reduction > 0) {
        // Partial reduction - staff can do this
        reduceOrderQuantity(table.id, order.id, reduction);
        state.editingOrderId = null;
        state.editingOrderQty = 0;
        state.currentModal = 'tableDetail';
        render();
      } else {
        // No change
        cancelEditOrder();
      }
    };

    window.cancelEditOrder = () => {
      state.editingOrderId = null;
      state.editingOrderQty = 0;
      state.currentModal = 'tableDetail';
      render();
    };

    // Legacy function - now redirects to edit flow
    window.confirmRemoveItem = (tableId, orderId, productName, quantity) => {
      state.viewingTableId = tableId;
      startEditOrder(orderId);
    };

    window.updateItemPreview = () => {
      const numBoxes = Number(document.getElementById('itemNumBoxes')?.value) || 0;
      const perBox = Number(document.getElementById('itemPerBox')?.value) || 0;
      const sold = Number(document.getElementById('itemSold')?.value) || 0;
      const pricePerUnit = Number(document.getElementById('itemPricePerUnit')?.value) || 0;

      const totalUnits = numBoxes * perBox;
      const remaining = totalUnits - sold;
      const expectedValue = sold * pricePerUnit;

      const previewTotal = document.getElementById('previewTotal');
      const previewRemaining = document.getElementById('previewRemaining');
      const previewValue = document.getElementById('previewValue');

      if (previewTotal) previewTotal.textContent = totalUnits;
      if (previewRemaining) previewRemaining.textContent = remaining;
      if (previewValue) previewValue.textContent = formatCurrency(expectedValue);
    };

    window.exportToExcel = exportToExcel;

    // ===== DEFAULT INVENTORY FROM PORKYS SPREADSHEET (All prices in COP) =====
    // Cost per unit = PRECIO POR CAJA / # POR CAJA
    // Selling price = cost + markup (~50-80%)
    const seedDefaultInventory = () => {
      const defaultItems = [
        // LICOR - Exact data from spreadsheet
        { id: 1, name: 'Aguardiente Tradicional', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '28000', costPerUnit: '18667' },
        { id: 2, name: 'Aguardiente T. Amarilla', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '26000', costPerUnit: '17000' },
        { id: 3, name: 'Aguardiente T. Verde', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '24000', costPerUnit: '15667' },
        { id: 4, name: 'Buchanan Master 1/2', category: 'liquor', amount: '', bottleSize: '375ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '50000', costPerUnit: '32667' },
        { id: 5, name: 'Buchanan Master', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '100000', costPerUnit: '65000' },
        { id: 6, name: 'Buchanan Original', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '85000', costPerUnit: '56000' },
        { id: 7, name: 'Ron MedellÃ­n', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '30000', costPerUnit: '19000' },
        { id: 8, name: 'Ron MedellÃ­n 8 AÃ±os', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '48000', costPerUnit: '30667' },
        { id: 9, name: 'J.W. Sello Negro', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '3', perBox: '3', sold: 0, pricePerUnit: '80000', costPerUnit: '52333' },
        { id: 10, name: 'J.W. Sello Rojo', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '40000', costPerUnit: '26000' },
        { id: 11, name: 'Tequila JosÃ© Cuervo', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '50000', costPerUnit: '32000' },
        { id: 12, name: 'Vodka Lulo', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '25000', costPerUnit: '16667' },
        { id: 13, name: 'Vodka Tamarindo', category: 'liquor', amount: '', bottleSize: '750ml', numBoxes: '1', perBox: '3', sold: 0, pricePerUnit: '25000', costPerUnit: '16667' },

        // CERVEZA - Exact data from spreadsheet
        { id: 20, name: 'Aguila Negra Botella', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '5000', costPerUnit: '2833', image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Cerveza_Aguila_-_Colombia.jpg/100px-Cerveza_Aguila_-_Colombia.jpg' },
        { id: 21, name: 'Ãguila Negra Lata', category: 'beer', amount: '', bottleSize: 'Lata', numBoxes: '1', perBox: '30', sold: 0, pricePerUnit: '3000', costPerUnit: '1567' },
        { id: 22, name: 'Andina Lata', category: 'beer', amount: '', bottleSize: 'Lata', numBoxes: '1', perBox: '30', sold: 0, pricePerUnit: '3000', costPerUnit: '1400' },
        { id: 23, name: 'Club Colombia Botella', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '6000', costPerUnit: '3583', image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/Botella_Club_Colombia.jpg/100px-Botella_Club_Colombia.jpg' },
        { id: 24, name: 'Club Colombia Lata', category: 'beer', amount: '', bottleSize: 'Lata', numBoxes: '1', perBox: '30', sold: 0, pricePerUnit: '4500', costPerUnit: '2433' },
        { id: 25, name: 'Corona PequeÃ±a', category: 'beer', amount: '', bottleSize: 'PequeÃ±a', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '6000', costPerUnit: '2917', image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Corona_Extra_beer_bottle_%282019%29.png/80px-Corona_Extra_beer_bottle_%282019%29.png' },
        { id: 26, name: 'CosteÃ±a Bacana', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '4000', costPerUnit: '1833' },
        { id: 27, name: 'CosteÃ±ita', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '38', sold: 0, pricePerUnit: '3500', costPerUnit: '1789' },
        { id: 28, name: 'Smirnoff Ice', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '15000', costPerUnit: '8333' },
        { id: 29, name: 'Poker', category: 'beer', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '5000', costPerUnit: '2750' },

        // BEBIDAS - Exact data from spreadsheet
        { id: 40, name: 'Agua', category: 'fountain', amount: '', bottleSize: 'Botella plÃ¡stica', numBoxes: '1', perBox: '24', sold: 0, pricePerUnit: '2500', costPerUnit: '1167' },
        { id: 41, name: 'Coca-Cola Personal', category: 'fountain', amount: '', bottleSize: 'Botella', numBoxes: '1', perBox: '12', sold: 0, pricePerUnit: '4000', costPerUnit: '2583' },
        { id: 42, name: 'Gatorade', category: 'fountain', amount: '', bottleSize: 'Botella plÃ¡stica', numBoxes: '1', perBox: '12', sold: 0, pricePerUnit: '5000', costPerUnit: '3167' },
      ];

      // Add timestamps
      const now = new Date().toISOString();
      defaultItems.forEach(item => {
        item.createdAt = now;
        item.updatedAt = now;
      });

      return defaultItems;
    };

    // Function to load default inventory (can be called manually)
    window.loadDefaultInventory = () => {
      if (confirm('This will add the default Porkys inventory items (COP prices). Continue?')) {
        const defaults = seedDefaultInventory();
        const existingNames = state.inventory.map(i => i.name.toLowerCase());

        // Only add items that don't already exist
        let added = 0;
        defaults.forEach(item => {
          if (!existingNames.includes(item.name.toLowerCase())) {
            item.id = Date.now() + added + Math.floor(Math.random() * 1000);
            state.inventory.push(item);
            added++;
          }
        });

        saveData();
        render();
        alert(`Added ${added} new items to inventory.`);
      }
    };

    // Function to reset inventory to default COP prices
    window.resetInventoryToCOP = () => {
      if (confirm('âš ï¸ This will REPLACE your entire inventory with the default Porkys items (COP prices).\n\nAll current inventory data will be lost!\n\nContinue?')) {
        state.inventory = seedDefaultInventory();
        saveData();
        render();
        alert('Inventory reset to default COP prices!');
      }
    };

    // Function to apply default images to existing inventory
    window.applyDefaultImages = () => {
      const imageMap = {
        'Aguila Negra Botella': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Cerveza_Aguila_-_Colombia.jpg/100px-Cerveza_Aguila_-_Colombia.jpg',
        'Club Colombia Botella': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/Botella_Club_Colombia.jpg/100px-Botella_Club_Colombia.jpg',
        'Corona PequeÃ±a': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Corona_Extra_beer_bottle_%282019%29.png/80px-Corona_Extra_beer_bottle_%282019%29.png'
      };

      let updated = 0;
      state.inventory.forEach(item => {
        if (imageMap[item.name] && !item.image) {
          item.image = imageMap[item.name];
          updated++;
        }
      });

      if (updated > 0) {
        saveData();
        render();
        alert(`Added images to ${updated} product(s)!`);
      } else {
        alert('No products to update (images already added or products not found)');
      }
    };

    // ===== INIT =====
    loadData();

    // Auto-seed inventory if completely empty (first time users)
    if (state.inventory.length === 0) {
      state.inventory = seedDefaultInventory();
      saveData();
    }

    if (!localStorage.getItem('inventory_password')) {
      state.currentModal = 'setup';
    }
    render();
  </script>
</body>
</html>
