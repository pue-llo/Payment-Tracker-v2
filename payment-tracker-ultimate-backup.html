<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tracker Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: white;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --green: #10b981;
            --orange: #f59e0b;
            --blue: #3b82f6;
            --red: #ef4444;
            --purple: #667eea;
            --indigo: #6366f1;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-gradient-start: #4c1d95;
            --bg-gradient-end: #5b21b6;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle, .templates-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover, .templates-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .profile-switcher {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            overflow: hidden;
        }

        .profile-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-btn.active {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: var(--purple);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.green { border-left: 5px solid var(--green); }
        .stat-card.orange { border-left: 5px solid var(--orange); }
        .stat-card.blue { border-left: 5px solid var(--blue); }
        .stat-card.red { border-left: 5px solid var(--red); }
        .stat-card.indigo { border-left: 5px solid var(--indigo); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .main-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 1.8em;
        }

        .bulk-actions {
            display: none;
            gap: 10px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .bulk-actions.active {
            display: flex;
        }

        .search-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .filter-select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--purple);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--green);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: var(--red);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-edit {
            background: var(--blue);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-warning {
            background: var(--orange);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .payment-list {
            display: grid;
            gap: 15px;
        }

        .payment-item {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--border-color);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
            transition: all 0.3s;
        }

        .payment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .payment-item.owed-to-me { border-left-color: var(--green); }
        .payment-item.i-owe { border-left-color: var(--orange); }
        .payment-item.overdue { border-left-color: var(--red); }
        .payment-item.income { border-left-color: var(--blue); }
        .payment-item.split { border-left-color: var(--indigo); }

        .payment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-info h3 {
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .payment-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .payment-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge.green { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .badge.orange { background: rgba(245, 158, 11, 0.2); color: var(--orange); }
        .badge.red { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .badge.yellow { background: rgba(251, 191, 36, 0.2); color: #d97706; }
        .badge.blue { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .badge.indigo { background: rgba(99, 102, 241, 0.2); color: var(--indigo); }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--green);
            transition: width 0.3s;
        }

        .partial-payments {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .partial-payment-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .partial-payment-item:last-child {
            border-bottom: none;
        }

        .payment-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .payment-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .payment-date {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--purple);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions .btn {
            flex: 1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .audit-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .audit-entry {
            padding: 15px;
            background: var(--bg-primary);
            border-left: 3px solid var(--blue);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .audit-entry .timestamp {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .audit-entry .action {
            font-weight: 600;
            color: var(--text-primary);
        }

        .template-list {
            display: grid;
            gap: 15px;
        }

        .template-item {
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .split-people {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .split-person {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .split-person input {
            flex: 1;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .payment-item {
                grid-template-columns: auto 1fr;
            }

            .payment-actions {
                grid-column: 1 / -1;
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>ðŸ’° Payment Tracker Ultimate</h1>
                    <p>Complete financial management solution</p>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon">ðŸŒ™</span> <span id="themeText">Dark</span>
                    </button>
                    <button class="templates-btn" onclick="showTemplates()">
                        ðŸ“‹ Templates
                    </button>
                    <div class="profile-switcher">
                        <button class="profile-btn active" onclick="switchProfile('personal')">ðŸ‘¤ Personal</button>
                        <button class="profile-btn" onclick="switchProfile('business')">ðŸ’¼ Business</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">ðŸ“Š Overview</button>
            <button class="nav-tab" onclick="switchTab('payments')">ðŸ’³ Payments</button>
            <button class="nav-tab" onclick="switchTab('income')">ðŸ’µ Income</button>
            <button class="nav-tab" onclick="switchTab('analytics')">ðŸ“ˆ Analytics</button>
            <button class="nav-tab" onclick="switchTab('history')">ðŸ“œ History</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card green">
                    <div class="stat-label">Owed to Me</div>
                    <div class="stat-value" id="totalOwedToMe">$0.00</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">I Owe</div>
                    <div class="stat-value" id="totalIOwe">$0.00</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" id="netBalance">$0.00</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Overdue</div>
                    <div class="stat-value" id="overdueCount">0</div>
                </div>
                <div class="stat-card indigo">
                    <div class="stat-label">Partial Payments</div>
                    <div class="stat-value" id="partialCount">0</div>
                </div>
            </div>

            <div class="main-content">
                <div class="section-header">
                    <h2>Recent Activity</h2>
                </div>
                <div id="recentPayments"></div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div id="payments-tab" class="tab-content">
            <div class="main-content">
                <div class="section-header">
                    <h2>All Payments</h2>
                    <button class="btn btn-primary" onclick="showAddModal()">+ Add Payment</button>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <span id="selectedCount">0 selected</span>
                    <button class="btn btn-success" onclick="bulkMarkPaid()">âœ“ Mark Paid</button>
                    <button class="btn btn-danger" onclick="bulkDelete()">ðŸ—‘ Delete</button>
                    <button class="btn" onclick="clearSelection()" style="background: var(--border-color);">Clear</button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="ðŸ” Search..." onkeyup="filterPayments()">
                    <select class="filter-select" id="typeFilter" onchange="filterPayments()">
                        <option value="">All Types</option>
                        <option value="owed_to_me">Owed to Me</option>
                        <option value="i_owe">I Owe</option>
                        <option value="income">Income</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterPayments()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partial</option>
                    </select>
                </div>

                <div id="paymentList" class="payment-list"></div>
            </div>
        </div>

        <!-- Income Tracker Tab -->
        <div id="income-tab" class="tab-content">
            <div class="main-content">
                <div class="section-header">
                    <h2>Monthly Income Tracker</h2>
                    <button class="btn btn-primary" onclick="showAddIncomeModal()">+ Add Income</button>
                </div>

                <div class="stats">
                    <div class="stat-card blue">
                        <div class="stat-label">This Month's Income</div>
                        <div class="stat-value" id="monthlyIncome">$0.00</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">This Month's Expenses</div>
                        <div class="stat-value" id="monthlyExpenses">$0.00</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Net This Month</div>
                        <div class="stat-value" id="monthlyNet">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="stats">
                <div class="stat-card blue">
                    <div class="stat-label">Average Payment</div>
                    <div class="stat-value" id="avgPayment">$0.00</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Top Person</div>
                    <div class="stat-value" id="topPerson" style="font-size: 1.2em;">-</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Most Common Category</div>
                    <div class="stat-value" id="topCategory" style="font-size: 1.2em;">-</div>
                </div>
                <div class="stat-card indigo">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-value" id="totalTransactions">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Balance by Person</h3>
                    <canvas id="personChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>By Type</h3>
                    <canvas id="typeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Weekly Trend</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Category Breakdown</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div class="main-content">
                <div class="section-header">
                    <h2>Payment History & Audit Log</h2>
                </div>
                <div id="auditLog" class="audit-log"></div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Payment</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="paymentForm" onsubmit="savePayment(event)">
                <div class="form-group">
                    <label>Payment Name *</label>
                    <input type="text" id="paymentName" required>
                </div>

                <div class="form-group">
                    <label>Person *</label>
                    <input type="text" id="paymentPerson" required>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enablePartial" onchange="togglePartialPayments()">
                        Enable Partial Payments
                    </label>
                </div>

                <div class="form-group">
                    <label id="amountLabel">Amount ($) *</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Due Date *</label>
                    <input type="date" id="paymentDueDate" required>
                </div>

                <div class="form-group">
                    <label>Type *</label>
                    <select id="paymentType" required onchange="toggleSplitOptions()">
                        <option value="owed_to_me">Owed to Me</option>
                        <option value="i_owe">I Owe</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableSplit" onchange="toggleSplitPeople()">
                        Split Payment Among Multiple People
                    </label>
                </div>

                <div id="splitPeopleContainer" style="display: none;">
                    <div id="splitPeople" class="split-people"></div>
                    <button type="button" class="btn btn-primary" onclick="addSplitPerson()" style="margin-top: 10px;">+ Add Person</button>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="paymentCategory">
                </div>

                <div class="form-group">
                    <label>Recurring</label>
                    <select id="paymentRecurring">
                        <option value="none">None</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="paymentStatus">
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="paymentNotes" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="saveAsTemplate">
                        Save as Template
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background: var(--border-color);">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Partial Payment Modal -->
    <div id="partialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Partial Payment</h2>
                <button class="close-btn" onclick="closePartialModal()">&times;</button>
            </div>

            <div id="partialInfo" style="margin-bottom: 20px;"></div>

            <div class="form-group">
                <label>Payment Amount ($) *</label>
                <input type="number" id="partialAmount" step="0.01" required>
            </div>

            <div class="form-group">
                <label>Payment Date</label>
                <input type="date" id="partialDate" required>
            </div>

            <div class="form-group">
                <label>Notes</label>
                <input type="text" id="partialNotes">
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="savePartialPayment()">Add Payment</button>
                <button class="btn" onclick="closePartialModal()" style="background: var(--border-color);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Templates</h2>
                <button class="close-btn" onclick="closeTemplatesModal()">&times;</button>
            </div>

            <div id="templatesList" class="template-list"></div>
        </div>
    </div>

    <script>
        let currentProfile = 'personal';
        let currentTab = 'overview';
        let editingId = null;
        let currentPartialPaymentId = null;
        let selectedPayments = new Set();
        let charts = {};

        let data = {
            personal: {
                payments: [],
                templates: [],
                auditLog: [],
                theme: 'light'
            },
            business: {
                payments: [],
                templates: [],
                auditLog: [],
                theme: 'light'
            }
        };

        // Audit log
        function addAuditEntry(action, details) {
            const entry = {
                timestamp: new Date().toISOString(),
                action,
                details,
                profile: currentProfile
            };
            data[currentProfile].auditLog.unshift(entry);
            if (data[currentProfile].auditLog.length > 100) {
                data[currentProfile].auditLog.pop();
            }
        }

        function renderAuditLog() {
            const container = document.getElementById('auditLog');
            const logs = data[currentProfile].auditLog;

            if (logs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No history yet</p></div>';
                return;
            }

            container.innerHTML = logs.map(entry => `
                <div class="audit-entry">
                    <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                    <div class="action">${entry.action}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">${entry.details}</div>
                </div>
            `).join('');
        }

        // Load/Save
        function loadData() {
            const saved = localStorage.getItem('paymentTrackerUltimate');
            if (saved) {
                data = JSON.parse(saved);
            }
            applyTheme();
        }

        function saveData() {
            localStorage.setItem('paymentTrackerUltimate', JSON.stringify(data));
        }

        function getPayments() {
            return data[currentProfile].payments;
        }

        // Theme
        function toggleTheme() {
            const newTheme = data[currentProfile].theme === 'light' ? 'dark' : 'light';
            data[currentProfile].theme = newTheme;
            applyTheme();
            saveData();
        }

        function applyTheme() {
            const theme = data[currentProfile].theme;
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').textContent = theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
            document.getElementById('themeText').textContent = theme === 'light' ? 'Dark' : 'Light';
        }

        // Profile
        function switchProfile(profile) {
            currentProfile = profile;
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            clearSelection();
            applyTheme();
            updateAll();
        }

        // Tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'analytics') setTimeout(renderCharts, 100);
            if (tab === 'income') updateIncomeTracker();
            if (tab === 'history') renderAuditLog();
        }

        // Stats
        function updateStats() {
            const payments = getPayments();
            const totalOwedToMe = payments.filter(p => p.type === 'owed_to_me' && p.status !== 'paid')
                .reduce((sum, p) => sum + (parseFloat(p.totalAmount || p.amount) - (p.amountPaid || 0)), 0);
            const totalIOwe = payments.filter(p => p.type === 'i_owe' && p.status !== 'paid')
                .reduce((sum, p) => sum + (parseFloat(p.totalAmount || p.amount) - (p.amountPaid || 0)), 0);
            const netBalance = totalOwedToMe - totalIOwe;
            const overdueCount = payments.filter(p => p.status !== 'paid' && new Date(p.dueDate) < new Date()).length;
            const partialCount = payments.filter(p => p.partialPaymentsEnabled && p.status === 'partial').length;

            document.getElementById('totalOwedToMe').textContent = '$' + totalOwedToMe.toFixed(2);
            document.getElementById('totalIOwe').textContent = '$' + totalIOwe.toFixed(2);
            document.getElementById('netBalance').textContent = '$' + netBalance.toFixed(2);
            document.getElementById('overdueCount').textContent = overdueCount;
            document.getElementById('partialCount').textContent = partialCount;

            // Advanced analytics
            const amounts = payments.map(p => parseFloat(p.amount));
            const avgPayment = amounts.length > 0 ? amounts.reduce((a, b) => a + b, 0) / amounts.length : 0;

            const personCounts = {};
            payments.forEach(p => personCounts[p.person] = (personCounts[p.person] || 0) + 1);
            const topPerson = Object.entries(personCounts).sort((a, b) => b[1] - a[1])[0];

            const categoryCounts = {};
            payments.forEach(p => p.category && (categoryCounts[p.category] = (categoryCounts[p.category] || 0) + 1));
            const topCategory = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0];

            document.getElementById('avgPayment').textContent = '$' + avgPayment.toFixed(2);
            document.getElementById('topPerson').textContent = topPerson ? topPerson[0] : '-';
            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';
            document.getElementById('totalTransactions').textContent = payments.length;
        }

        // Render payments
        function renderPayments(filtered = null) {
            const payments = filtered || getPayments();
            const container = document.getElementById('paymentList');

            if (payments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No payments found</h3></div>';
                return;
            }

            const sorted = [...payments].sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            container.innerHTML = sorted.map(payment => {
                const isOverdue = payment.status !== 'paid' && new Date(payment.dueDate) < new Date();
                const classes = ['payment-item', payment.type];
                if (isOverdue) classes.push('overdue');
                if (payment.split) classes.push('split');

                let statusBadge = '';
                if (payment.status === 'paid') {
                    statusBadge = '<span class="badge green">Paid</span>';
                } else if (payment.status === 'partial') {
                    statusBadge = '<span class="badge yellow">Partial</span>';
                } else if (isOverdue) {
                    statusBadge = '<span class="badge red">Overdue</span>';
                } else {
                    statusBadge = '<span class="badge yellow">Pending</span>';
                }

                const typeBadge = payment.type === 'owed_to_me' ? '<span class="badge green">Owed to Me</span>' :
                    payment.type === 'i_owe' ? '<span class="badge orange">I Owe</span>' : '<span class="badge blue">Income</span>';

                const recurringBadge = payment.recurring !== 'none' ?
                    `<span class="badge indigo">ðŸ”„ ${payment.recurring}</span>` : '';

                const splitBadge = payment.split ? '<span class="badge indigo">ðŸ‘¥ Split</span>' : '';

                let amountDisplay = '';
                if (payment.partialPaymentsEnabled) {
                    const total = parseFloat(payment.totalAmount);
                    const paid = payment.amountPaid || 0;
                    const remaining = total - paid;
                    const progress = (paid / total) * 100;

                    amountDisplay = `
                        <div class="payment-amount">$${remaining.toFixed(2)}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                            of $${total.toFixed(2)}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    `;
                } else {
                    amountDisplay = `<div class="payment-amount">$${parseFloat(payment.amount).toFixed(2)}</div>`;
                }

                let partialPaymentsDisplay = '';
                if (payment.partialPayments && payment.partialPayments.length > 0) {
                    partialPaymentsDisplay = `
                        <div class="partial-payments">
                            <strong>Payments Made:</strong>
                            ${payment.partialPayments.map(pp => `
                                <div class="partial-payment-item">
                                    <span>${new Date(pp.date).toLocaleDateString()}</span>
                                    <span>$${parseFloat(pp.amount).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                let splitDisplay = '';
                if (payment.split && payment.splitPeople) {
                    const perPerson = parseFloat(payment.amount) / payment.splitPeople.length;
                    splitDisplay = `
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            <strong>Split between:</strong> ${payment.splitPeople.join(', ')}
                            <br><span style="color: var(--text-secondary);">($${perPerson.toFixed(2)} each)</span>
                        </div>
                    `;
                }

                return `
                    <div class="${classes.join(' ')}">
                        <input type="checkbox" class="payment-checkbox" ${selectedPayments.has(payment.id) ? 'checked' : ''}
                            onchange="togglePaymentSelection('${payment.id}')">
                        <div class="payment-info">
                            <h3>${payment.name}</h3>
                            <p>${payment.person}</p>
                            <div class="payment-meta">
                                ${typeBadge}
                                ${statusBadge}
                                ${recurringBadge}
                                ${splitBadge}
                                ${payment.category ? '<span class="badge blue">' + payment.category + '</span>' : ''}
                            </div>
                            ${payment.notes ? '<p style="margin-top: 10px; font-style: italic;">' + payment.notes + '</p>' : ''}
                            ${partialPaymentsDisplay}
                            ${splitDisplay}
                        </div>
                        <div class="payment-actions">
                            ${amountDisplay}
                            <div class="payment-date">Due: ${new Date(payment.dueDate).toLocaleDateString()}</div>
                            <div class="action-buttons">
                                ${payment.partialPaymentsEnabled && payment.status !== 'paid' ?
                                    `<button class="btn btn-warning" onclick="showPartialModal('${payment.id}')">+ Partial</button>` : ''}
                                ${payment.status !== 'paid' ?
                                    `<button class="btn btn-success" onclick="markAsPaid('${payment.id}')">âœ“ Paid</button>` : ''}
                                <button class="btn btn-edit" onclick="editPayment('${payment.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deletePayment('${payment.id}')">Delete</button>
                                <button class="btn btn-primary" onclick="useAsTemplate('${payment.id}')">ðŸ“‹ Use</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Bulk actions
        function togglePaymentSelection(id) {
            if (selectedPayments.has(id)) {
                selectedPayments.delete(id);
            } else {
                selectedPayments.add(id);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const count = selectedPayments.size;
            document.getElementById('selectedCount').textContent = count + ' selected';
            document.getElementById('bulkActions').classList.toggle('active', count > 0);
        }

        function clearSelection() {
            selectedPayments.clear();
            updateBulkActions();
            renderPayments();
        }

        function bulkMarkPaid() {
            if (!confirm(`Mark ${selectedPayments.size} payments as paid?`)) return;
            selectedPayments.forEach(id => {
                const payment = getPayments().find(p => p.id === id);
                if (payment) payment.status = 'paid';
            });
            addAuditEntry('Bulk Mark Paid', `Marked ${selectedPayments.size} payments as paid`);
            clearSelection();
            saveData();
            updateAll();
        }

        function bulkDelete() {
            if (!confirm(`Delete ${selectedPayments.size} payments?`)) return;
            data[currentProfile].payments = getPayments().filter(p => !selectedPayments.has(p.id));
            addAuditEntry('Bulk Delete', `Deleted ${selectedPayments.size} payments`);
            clearSelection();
            saveData();
            updateAll();
        }

        // Filter
        function filterPayments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = getPayments().filter(payment => {
                const matchesSearch = payment.name.toLowerCase().includes(searchTerm) ||
                    payment.person.toLowerCase().includes(searchTerm) ||
                    (payment.category && payment.category.toLowerCase().includes(searchTerm));
                const matchesType = !typeFilter || payment.type === typeFilter;
                const matchesStatus = !statusFilter || payment.status === statusFilter;
                return matchesSearch && matchesType && matchesStatus;
            });

            renderPayments(filtered);
        }

        // Partial payments
        function togglePartialPayments() {
            const enabled = document.getElementById('enablePartial').checked;
            document.getElementById('amountLabel').textContent = enabled ? 'Total Amount ($) *' : 'Amount ($) *';
        }

        function showPartialModal(paymentId) {
            currentPartialPaymentId = paymentId;
            const payment = getPayments().find(p => p.id === paymentId);
            const total = parseFloat(payment.totalAmount);
            const paid = payment.amountPaid || 0;
            const remaining = total - paid;

            document.getElementById('partialInfo').innerHTML = `
                <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px;">
                    <strong>${payment.name}</strong><br>
                    Total: $${total.toFixed(2)}<br>
                    Paid: $${paid.toFixed(2)}<br>
                    <span style="color: var(--orange); font-weight: bold;">Remaining: $${remaining.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('partialAmount').value = '';
            document.getElementById('partialDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('partialNotes').value = '';
            document.getElementById('partialModal').classList.add('active');
        }

        function closePartialModal() {
            document.getElementById('partialModal').classList.remove('active');
            currentPartialPaymentId = null;
        }

        function savePartialPayment() {
            const payment = getPayments().find(p => p.id === currentPartialPaymentId);
            const amount = parseFloat(document.getElementById('partialAmount').value);
            const date = document.getElementById('partialDate').value;
            const notes = document.getElementById('partialNotes').value;

            if (!payment.partialPayments) payment.partialPayments = [];
            payment.partialPayments.push({ amount, date, notes });
            payment.amountPaid = (payment.amountPaid || 0) + amount;

            if (payment.amountPaid >= parseFloat(payment.totalAmount)) {
                payment.status = 'paid';
                addAuditEntry('Payment Completed', `${payment.name} - ${payment.person}: Paid in full`);
            } else {
                payment.status = 'partial';
                addAuditEntry('Partial Payment', `${payment.name} - ${payment.person}: $${amount.toFixed(2)}`);
            }

            closePartialModal();
            saveData();
            updateAll();
        }

        // Split payments
        function toggleSplitOptions() {
            const type = document.getElementById('paymentType').value;
            document.getElementById('enableSplit').disabled = type === 'income';
            if (type === 'income') {
                document.getElementById('enableSplit').checked = false;
                toggleSplitPeople();
            }
        }

        function toggleSplitPeople() {
            const enabled = document.getElementById('enableSplit').checked;
            document.getElementById('splitPeopleContainer').style.display = enabled ? 'block' : 'none';
            if (enabled && document.getElementById('splitPeople').children.length === 0) {
                addSplitPerson();
                addSplitPerson();
            }
        }

        function addSplitPerson() {
            const container = document.getElementById('splitPeople');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'split-person';
            div.innerHTML = `
                <input type="text" placeholder="Person name" required>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(div);
        }

        // Templates
        function showTemplates() {
            renderTemplates();
            document.getElementById('templatesModal').classList.add('active');
        }

        function closeTemplatesModal() {
            document.getElementById('templatesModal').classList.remove('active');
        }

        function renderTemplates() {
            const templates = data[currentProfile].templates;
            const container = document.getElementById('templatesList');

            if (templates.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No templates saved</p></div>';
                return;
            }

            container.innerHTML = templates.map((template, index) => `
                <div class="template-item">
                    <div>
                        <strong>${template.name}</strong><br>
                        <span style="color: var(--text-secondary); font-size: 0.9em;">
                            ${template.person} - $${template.amount}
                        </span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="useTemplate(${index})">Use</button>
                        <button class="btn btn-danger" onclick="deleteTemplate(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function useAsTemplate(id) {
            const payment = getPayments().find(p => p.id === id);
            const template = { ...payment };
            delete template.id;
            delete template.status;
            delete template.partialPayments;
            delete template.amountPaid;

            data[currentProfile].templates.push(template);
            addAuditEntry('Template Created', `Template saved: ${template.name}`);
            saveData();
            alert('Template saved!');
        }

        function useTemplate(index) {
            const template = data[currentProfile].templates[index];
            showAddModal();

            document.getElementById('paymentName').value = template.name;
            document.getElementById('paymentPerson').value = template.person;
            document.getElementById('paymentAmount').value = template.amount;
            document.getElementById('paymentType').value = template.type;
            document.getElementById('paymentCategory').value = template.category || '';
            document.getElementById('paymentRecurring').value = template.recurring || 'none';
            document.getElementById('paymentNotes').value = template.notes || '';

            if (template.partialPaymentsEnabled) {
                document.getElementById('enablePartial').checked = true;
                togglePartialPayments();
            }

            closeTemplatesModal();
        }

        function deleteTemplate(index) {
            if (!confirm('Delete this template?')) return;
            data[currentProfile].templates.splice(index, 1);
            saveData();
            renderTemplates();
        }

        // Modal functions
        function showAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Payment';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentDueDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('enablePartial').checked = false;
            document.getElementById('enableSplit').checked = false;
            togglePartialPayments();
            toggleSplitPeople();
            document.getElementById('paymentModal').classList.add('active');
        }

        function showAddIncomeModal() {
            showAddModal();
            document.getElementById('paymentType').value = 'income';
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.remove('active');
            editingId = null;
        }

        function savePayment(event) {
            event.preventDefault();

            const partialEnabled = document.getElementById('enablePartial').checked;
            const splitEnabled = document.getElementById('enableSplit').checked;

            const payment = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('paymentName').value,
                person: document.getElementById('paymentPerson').value,
                amount: document.getElementById('paymentAmount').value,
                dueDate: document.getElementById('paymentDueDate').value,
                type: document.getElementById('paymentType').value,
                category: document.getElementById('paymentCategory').value,
                recurring: document.getElementById('paymentRecurring').value,
                status: document.getElementById('paymentStatus').value,
                notes: document.getElementById('paymentNotes').value,
                partialPaymentsEnabled: partialEnabled,
                split: splitEnabled
            };

            if (partialEnabled) {
                payment.totalAmount = payment.amount;
                payment.amountPaid = 0;
                payment.partialPayments = [];
                payment.status = 'partial';
            }

            if (splitEnabled) {
                const people = Array.from(document.querySelectorAll('#splitPeople input'))
                    .map(inp => inp.value.trim())
                    .filter(v => v);
                payment.splitPeople = people;
            }

            if (editingId) {
                const index = getPayments().findIndex(p => p.id === editingId);
                data[currentProfile].payments[index] = payment;
                addAuditEntry('Payment Updated', `${payment.name} - ${payment.person}`);
            } else {
                data[currentProfile].payments.push(payment);
                addAuditEntry('Payment Created', `${payment.name} - ${payment.person}: $${payment.amount}`);
            }

            if (document.getElementById('saveAsTemplate').checked) {
                const template = { ...payment };
                delete template.id;
                delete template.status;
                data[currentProfile].templates.push(template);
            }

            saveData();
            updateAll();
            closeModal();
        }

        function editPayment(id) {
            const payment = getPayments().find(p => p.id === id);
            if (!payment) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Payment';
            document.getElementById('paymentName').value = payment.name;
            document.getElementById('paymentPerson').value = payment.person;
            document.getElementById('paymentAmount').value = payment.totalAmount || payment.amount;
            document.getElementById('paymentDueDate').value = payment.dueDate;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentCategory').value = payment.category || '';
            document.getElementById('paymentRecurring').value = payment.recurring || 'none';
            document.getElementById('paymentStatus').value = payment.status;
            document.getElementById('paymentNotes').value = payment.notes || '';

            if (payment.partialPaymentsEnabled) {
                document.getElementById('enablePartial').checked = true;
                togglePartialPayments();
            }

            document.getElementById('paymentModal').classList.add('active');
        }

        function deletePayment(id) {
            if (!confirm('Delete this payment?')) return;
            const payment = getPayments().find(p => p.id === id);
            data[currentProfile].payments = getPayments().filter(p => p.id !== id);
            addAuditEntry('Payment Deleted', `${payment.name} - ${payment.person}`);
            saveData();
            updateAll();
        }

        function markAsPaid(id) {
            const payment = getPayments().find(p => p.id === id);
            if (payment) {
                payment.status = 'paid';
                if (payment.partialPaymentsEnabled) {
                    payment.amountPaid = parseFloat(payment.totalAmount);
                }
                addAuditEntry('Payment Marked Paid', `${payment.name} - ${payment.person}`);
                saveData();
                updateAll();
            }
        }

        // Charts
        function renderCharts() {
            const payments = getPayments();
            Object.values(charts).forEach(chart => chart && chart.destroy());

            // By Person
            const byPerson = {};
            payments.filter(p => p.status !== 'paid').forEach(p => {
                if (!byPerson[p.person]) byPerson[p.person] = { owedToMe: 0, iOwe: 0 };
                const amount = parseFloat(p.totalAmount || p.amount) - (p.amountPaid || 0);
                if (p.type === 'owed_to_me') byPerson[p.person].owedToMe += amount;
                if (p.type === 'i_owe') byPerson[p.person].iOwe += amount;
            });

            charts.person = new Chart(document.getElementById('personChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(byPerson),
                    datasets: [
                        { label: 'Owed to Me', data: Object.values(byPerson).map(v => v.owedToMe), backgroundColor: '#10b981' },
                        { label: 'I Owe', data: Object.values(byPerson).map(v => v.iOwe), backgroundColor: '#f59e0b' }
                    ]
                }
            });

            // Type Chart
            const typeCounts = { owed_to_me: 0, i_owe: 0, income: 0 };
            payments.forEach(p => typeCounts[p.type]++);

            charts.type = new Chart(document.getElementById('typeChart'), {
                type: 'pie',
                data: {
                    labels: ['Owed to Me', 'I Owe', 'Income'],
                    datasets: [{
                        data: [typeCounts.owed_to_me, typeCounts.i_owe, typeCounts.income],
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6']
                    }]
                }
            });

            // Weekly Trend (last 8 weeks)
            const weeklyData = {};
            for (let i = 7; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - (i * 7));
                const week = 'Week ' + (8 - i);
                weeklyData[week] = { income: 0, expenses: 0 };
            }

            payments.forEach(p => {
                const date = new Date(p.dueDate);
                const weeksAgo = Math.floor((new Date() - date) / (7 * 24 * 60 * 60 * 1000));
                if (weeksAgo >= 0 && weeksAgo < 8) {
                    const week = 'Week ' + (8 - weeksAgo);
                    if (weeklyData[week]) {
                        if (p.type === 'income') weeklyData[week].income += parseFloat(p.amount);
                        if (p.type === 'i_owe' && p.status === 'paid') weeklyData[week].expenses += parseFloat(p.amount);
                    }
                }
            });

            charts.weekly = new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(weeklyData),
                    datasets: [
                        { label: 'Income', data: Object.values(weeklyData).map(v => v.income), borderColor: '#10b981', tension: 0.4 },
                        { label: 'Expenses', data: Object.values(weeklyData).map(v => v.expenses), borderColor: '#f59e0b', tension: 0.4 }
                    ]
                }
            });

            // Category Chart
            const categoryData = {};
            payments.forEach(p => {
                if (p.category) {
                    categoryData[p.category] = (categoryData[p.category] || 0) + parseFloat(p.amount);
                }
            });

            charts.category = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1']
                    }]
                }
            });
        }

        // Income tracker
        function updateIncomeTracker() {
            const now = new Date();
            const payments = getPayments().filter(p => {
                const date = new Date(p.dueDate);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            });

            const income = payments.filter(p => p.type === 'income').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const expenses = payments.filter(p => p.type === 'i_owe' && p.status === 'paid').reduce((sum, p) => sum + parseFloat(p.amount), 0);

            document.getElementById('monthlyIncome').textContent = '$' + income.toFixed(2);
            document.getElementById('monthlyExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('monthlyNet').textContent = '$' + (income - expenses).toFixed(2);
        }

        // Recent payments
        function renderRecentPayments() {
            const payments = getPayments().slice(-5).reverse();
            const container = document.getElementById('recentPayments');

            if (payments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
                return;
            }

            container.innerHTML = '<div class="payment-list">' +
                payments.map(payment => `
                    <div class="payment-item ${payment.type}">
                        <div></div>
                        <div class="payment-info">
                            <h3>${payment.name}</h3>
                            <p>${payment.person} â€¢ ${new Date(payment.dueDate).toLocaleDateString()}</p>
                        </div>
                        <div class="payment-amount">$${parseFloat(payment.amount).toFixed(2)}</div>
                    </div>
                `).join('') + '</div>';
        }

        function updateAll() {
            updateStats();
            renderPayments();
            renderRecentPayments();
            if (currentTab === 'analytics') renderCharts();
            if (currentTab === 'income') updateIncomeTracker();
            if (currentTab === 'history') renderAuditLog();
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Initialize
        loadData();
        updateAll();
    </script>
</body>
</html>