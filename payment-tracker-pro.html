<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: white;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --green: #10b981;
            --orange: #f59e0b;
            --blue: #3b82f6;
            --red: #ef4444;
            --purple: #667eea;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-gradient-start: #4c1d95;
            --bg-gradient-end: #5b21b6;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .profile-switcher {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            overflow: hidden;
        }

        .profile-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-btn.active {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: var(--purple);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.green { border-left: 5px solid var(--green); }
        .stat-card.orange { border-left: 5px solid var(--orange); }
        .stat-card.blue { border-left: 5px solid var(--blue); }
        .stat-card.red { border-left: 5px solid var(--red); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .main-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 1.8em;
        }

        .search-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .filter-select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--purple);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--green);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: var(--red);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-edit {
            background: var(--blue);
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .payment-list {
            display: grid;
            gap: 15px;
        }

        .payment-item {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            transition: all 0.3s;
        }

        .payment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .payment-item.owed-to-me { border-left-color: var(--green); }
        .payment-item.i-owe { border-left-color: var(--orange); }
        .payment-item.overdue { border-left-color: var(--red); }
        .payment-item.income { border-left-color: var(--blue); }

        .payment-info h3 {
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .payment-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .payment-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge.green { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .badge.orange { background: rgba(245, 158, 11, 0.2); color: var(--orange); }
        .badge.red { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .badge.yellow { background: rgba(251, 191, 36, 0.2); color: #d97706; }
        .badge.blue { background: rgba(59, 130, 246, 0.2); color: var(--blue); }

        .payment-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .payment-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .payment-date {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--purple);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions .btn {
            flex: 1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .income-tracker {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .month-btn {
            background: var(--purple);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .current-month {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .payment-item {
                grid-template-columns: 1fr;
            }

            .payment-actions {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>ðŸ’° Payment Tracker Pro</h1>
                    <p>Manage your finances with style</p>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon">ðŸŒ™</span> <span id="themeText">Dark</span>
                    </button>
                    <div class="profile-switcher">
                        <button class="profile-btn active" onclick="switchProfile('personal')">ðŸ‘¤ Personal</button>
                        <button class="profile-btn" onclick="switchProfile('business')">ðŸ’¼ Business</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">ðŸ“Š Overview</button>
            <button class="nav-tab" onclick="switchTab('payments')">ðŸ’³ Payments</button>
            <button class="nav-tab" onclick="switchTab('income')">ðŸ’µ Income Tracker</button>
            <button class="nav-tab" onclick="switchTab('analytics')">ðŸ“ˆ Analytics</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card green">
                    <div class="stat-label">Owed to Me</div>
                    <div class="stat-value" id="totalOwedToMe">$0.00</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">I Owe</div>
                    <div class="stat-value" id="totalIOwe">$0.00</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" id="netBalance">$0.00</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Overdue</div>
                    <div class="stat-value" id="overdueCount">0</div>
                </div>
            </div>

            <div class="main-content">
                <div class="section-header">
                    <h2>Recent Activity</h2>
                </div>
                <div id="recentPayments"></div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div id="payments-tab" class="tab-content">
            <div class="main-content">
                <div class="section-header">
                    <h2>All Payments</h2>
                    <button class="btn btn-primary" onclick="showAddModal()">+ Add Payment</button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="ðŸ” Search payments..." onkeyup="filterPayments()">
                    <select class="filter-select" id="typeFilter" onchange="filterPayments()">
                        <option value="">All Types</option>
                        <option value="owed_to_me">Owed to Me</option>
                        <option value="i_owe">I Owe</option>
                        <option value="income">Income</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterPayments()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <div id="paymentList" class="payment-list"></div>
            </div>
        </div>

        <!-- Income Tracker Tab -->
        <div id="income-tab" class="tab-content">
            <div class="income-tracker">
                <div class="section-header">
                    <h2>Monthly Income Tracker</h2>
                    <button class="btn btn-primary" onclick="showAddIncomeModal()">+ Add Income</button>
                </div>

                <div class="month-selector">
                    <button class="month-btn" onclick="changeMonth(-1)">â—€</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="month-btn" onclick="changeMonth(1)">â–¶</button>
                </div>

                <div class="stats">
                    <div class="stat-card blue">
                        <div class="stat-label">This Month's Income</div>
                        <div class="stat-value" id="monthlyIncome">$0.00</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">This Month's Expenses</div>
                        <div class="stat-value" id="monthlyExpenses">$0.00</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Net This Month</div>
                        <div class="stat-value" id="monthlyNet">$0.00</div>
                    </div>
                </div>

                <div id="monthlyBreakdown" class="payment-list" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Balance by Person</h3>
                    <canvas id="personChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Payments by Type</h3>
                    <canvas id="typeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Monthly Trend</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Status Overview</h3>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Payment</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="paymentForm" onsubmit="savePayment(event)">
                <div class="form-group">
                    <label>Payment Name *</label>
                    <input type="text" id="paymentName" required placeholder="e.g., Dinner money">
                </div>

                <div class="form-group">
                    <label>Person *</label>
                    <input type="text" id="paymentPerson" required placeholder="e.g., John Doe">
                </div>

                <div class="form-group">
                    <label>Amount ($) *</label>
                    <input type="number" id="paymentAmount" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Due Date *</label>
                    <input type="date" id="paymentDueDate" required>
                </div>

                <div class="form-group">
                    <label>Type *</label>
                    <select id="paymentType" required>
                        <option value="owed_to_me">Owed to Me</option>
                        <option value="i_owe">I Owe</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="paymentCategory" placeholder="e.g., Personal, Business, Salary">
                </div>

                <div class="form-group">
                    <label>Recurring</label>
                    <select id="paymentRecurring">
                        <option value="none">None</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="paymentStatus">
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background: var(--border-color);">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentProfile = 'personal';
        let currentTab = 'overview';
        let editingId = null;
        let currentMonthOffset = 0;
        let charts = {};

        // Data structure
        let data = {
            personal: {
                payments: [],
                theme: 'light'
            },
            business: {
                payments: [],
                theme: 'light'
            }
        };

        // Load data
        function loadData() {
            const saved = localStorage.getItem('paymentTrackerPro');
            if (saved) {
                data = JSON.parse(saved);
            }
            applyTheme();
        }

        // Save data
        function saveData() {
            localStorage.setItem('paymentTrackerPro', JSON.stringify(data));
        }

        // Get current payments
        function getPayments() {
            return data[currentProfile].payments;
        }

        // Theme toggle
        function toggleTheme() {
            const newTheme = data[currentProfile].theme === 'light' ? 'dark' : 'light';
            data[currentProfile].theme = newTheme;
            applyTheme();
            saveData();
        }

        function applyTheme() {
            const theme = data[currentProfile].theme;
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').textContent = theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
            document.getElementById('themeText').textContent = theme === 'light' ? 'Dark' : 'Light';
        }

        // Profile switching
        function switchProfile(profile) {
            currentProfile = profile;
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            applyTheme();
            updateAll();
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'analytics') {
                setTimeout(renderCharts, 100);
            }
            if (tab === 'income') {
                updateIncomeTracker();
            }
        }

        // Process recurring payments
        function processRecurring() {
            const payments = getPayments();
            const today = new Date();
            const newPayments = [];

            payments.forEach(payment => {
                if (payment.recurring !== 'none' && payment.status === 'paid') {
                    const dueDate = new Date(payment.dueDate);
                    const nextDue = new Date(dueDate);

                    switch (payment.recurring) {
                        case 'weekly':
                            nextDue.setDate(dueDate.getDate() + 7);
                            break;
                        case 'monthly':
                            nextDue.setMonth(dueDate.getMonth() + 1);
                            break;
                        case 'yearly':
                            nextDue.setFullYear(dueDate.getFullYear() + 1);
                            break;
                    }

                    if (nextDue <= today) {
                        newPayments.push({
                            ...payment,
                            id: Date.now() + Math.random(),
                            dueDate: nextDue.toISOString().split('T')[0],
                            status: 'pending'
                        });
                    }
                }
            });

            if (newPayments.length > 0) {
                data[currentProfile].payments.push(...newPayments);
                saveData();
            }
        }

        // Update statistics
        function updateStats() {
            const payments = getPayments();

            const totalOwedToMe = payments
                .filter(p => p.type === 'owed_to_me' && p.status !== 'paid')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);

            const totalIOwe = payments
                .filter(p => p.type === 'i_owe' && p.status !== 'paid')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);

            const netBalance = totalOwedToMe - totalIOwe;

            const overdueCount = payments.filter(p => {
                if (p.status === 'paid') return false;
                const today = new Date();
                const dueDate = new Date(p.dueDate);
                return dueDate < today;
            }).length;

            document.getElementById('totalOwedToMe').textContent = '$' + totalOwedToMe.toFixed(2);
            document.getElementById('totalIOwe').textContent = '$' + totalIOwe.toFixed(2);
            document.getElementById('netBalance').textContent = '$' + netBalance.toFixed(2);
            document.getElementById('overdueCount').textContent = overdueCount;
        }

        // Render payments
        function renderPayments(filtered = null) {
            const payments = filtered || getPayments();
            const container = document.getElementById('paymentList');

            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No payments found</h3>
                        <p>Click "Add Payment" to get started!</p>
                    </div>
                `;
                return;
            }

            const sorted = [...payments].sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            container.innerHTML = sorted.map(payment => {
                const isOverdue = payment.status !== 'paid' && new Date(payment.dueDate) < new Date();
                const classes = ['payment-item', payment.type];
                if (isOverdue) classes.push('overdue');

                let statusBadge = payment.status === 'paid'
                    ? '<span class="badge green">Paid</span>'
                    : isOverdue
                        ? '<span class="badge red">Overdue</span>'
                        : '<span class="badge yellow">Pending</span>';

                const typeBadge = payment.type === 'owed_to_me'
                    ? '<span class="badge green">Owed to Me</span>'
                    : payment.type === 'i_owe'
                        ? '<span class="badge orange">I Owe</span>'
                        : '<span class="badge blue">Income</span>';

                const recurringBadge = payment.recurring !== 'none'
                    ? `<span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #7c3aed;">ðŸ”„ ${payment.recurring}</span>`
                    : '';

                return `
                    <div class="${classes.join(' ')}">
                        <div class="payment-info">
                            <h3>${payment.name}</h3>
                            <p>${payment.person}</p>
                            <div class="payment-meta">
                                ${typeBadge}
                                ${statusBadge}
                                ${recurringBadge}
                                ${payment.category ? '<span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">' + payment.category + '</span>' : ''}
                            </div>
                            ${payment.notes ? '<p style="margin-top: 10px; font-style: italic;">' + payment.notes + '</p>' : ''}
                        </div>
                        <div class="payment-actions">
                            <div class="payment-amount">$${parseFloat(payment.amount).toFixed(2)}</div>
                            <div class="payment-date">Due: ${new Date(payment.dueDate).toLocaleDateString()}</div>
                            <div class="action-buttons">
                                ${payment.status !== 'paid' ? `<button class="btn btn-success" onclick="markAsPaid('${payment.id}')">âœ“ Paid</button>` : ''}
                                <button class="btn btn-edit" onclick="editPayment('${payment.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deletePayment('${payment.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter payments
        function filterPayments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = getPayments().filter(payment => {
                const matchesSearch = payment.name.toLowerCase().includes(searchTerm) ||
                                     payment.person.toLowerCase().includes(searchTerm) ||
                                     (payment.category && payment.category.toLowerCase().includes(searchTerm));

                const matchesType = !typeFilter || payment.type === typeFilter;
                const matchesStatus = !statusFilter || payment.status === statusFilter;

                return matchesSearch && matchesType && matchesStatus;
            });

            renderPayments(filtered);
        }

        // Recent payments for overview
        function renderRecentPayments() {
            const payments = getPayments().slice(-5).reverse();
            const container = document.getElementById('recentPayments');

            if (payments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
                return;
            }

            container.innerHTML = '<div class="payment-list">' +
                payments.map(payment => {
                    const isOverdue = payment.status !== 'paid' && new Date(payment.dueDate) < new Date();
                    return `
                        <div class="payment-item ${payment.type} ${isOverdue ? 'overdue' : ''}">
                            <div class="payment-info">
                                <h3>${payment.name}</h3>
                                <p>${payment.person} â€¢ ${new Date(payment.dueDate).toLocaleDateString()}</p>
                            </div>
                            <div class="payment-amount">$${parseFloat(payment.amount).toFixed(2)}</div>
                        </div>
                    `;
                }).join('') + '</div>';
        }

        // Income tracker
        function updateIncomeTracker() {
            const targetMonth = new Date();
            targetMonth.setMonth(targetMonth.getMonth() + currentMonthOffset);

            document.getElementById('currentMonth').textContent =
                targetMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const payments = getPayments();
            const monthPayments = payments.filter(p => {
                const paymentDate = new Date(p.dueDate);
                return paymentDate.getMonth() === targetMonth.getMonth() &&
                       paymentDate.getFullYear() === targetMonth.getFullYear();
            });

            const income = monthPayments
                .filter(p => p.type === 'income')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);

            const expenses = monthPayments
                .filter(p => p.type === 'i_owe' && p.status === 'paid')
                .reduce((sum, p) => sum + parseFloat(p.amount), 0);

            const net = income - expenses;

            document.getElementById('monthlyIncome').textContent = '$' + income.toFixed(2);
            document.getElementById('monthlyExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('monthlyNet').textContent = '$' + net.toFixed(2);

            // Render month breakdown
            const container = document.getElementById('monthlyBreakdown');
            if (monthPayments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions this month</p></div>';
            } else {
                renderPayments(monthPayments);
            }
        }

        function changeMonth(offset) {
            currentMonthOffset += offset;
            updateIncomeTracker();
        }

        // Charts
        function renderCharts() {
            const payments = getPayments();

            // Destroy existing charts
            Object.values(charts).forEach(chart => chart && chart.destroy());

            // By Person Chart
            const byPerson = {};
            payments.filter(p => p.status !== 'paid').forEach(p => {
                if (!byPerson[p.person]) byPerson[p.person] = { owedToMe: 0, iOwe: 0 };
                if (p.type === 'owed_to_me') byPerson[p.person].owedToMe += parseFloat(p.amount);
                if (p.type === 'i_owe') byPerson[p.person].iOwe += parseFloat(p.amount);
            });

            const ctx1 = document.getElementById('personChart');
            if (ctx1) {
                charts.person = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(byPerson),
                        datasets: [
                            {
                                label: 'Owed to Me',
                                data: Object.values(byPerson).map(v => v.owedToMe),
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'I Owe',
                                data: Object.values(byPerson).map(v => v.iOwe),
                                backgroundColor: '#f59e0b'
                            }
                        ]
                    }
                });
            }

            // Type Chart
            const typeCounts = { owed_to_me: 0, i_owe: 0, income: 0 };
            payments.forEach(p => typeCounts[p.type]++);

            const ctx2 = document.getElementById('typeChart');
            if (ctx2) {
                charts.type = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Owed to Me', 'I Owe', 'Income'],
                        datasets: [{
                            data: [typeCounts.owed_to_me, typeCounts.i_owe, typeCounts.income],
                            backgroundColor: ['#10b981', '#f59e0b', '#3b82f6']
                        }]
                    }
                });
            }

            // Trend Chart (last 6 months)
            const monthlyData = {};
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[key] = { income: 0, expenses: 0 };
            }

            payments.forEach(p => {
                const date = new Date(p.dueDate);
                const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                if (monthlyData[key]) {
                    if (p.type === 'income') monthlyData[key].income += parseFloat(p.amount);
                    if (p.type === 'i_owe' && p.status === 'paid') monthlyData[key].expenses += parseFloat(p.amount);
                }
            });

            const ctx3 = document.getElementById('trendChart');
            if (ctx3) {
                charts.trend = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: Object.keys(monthlyData),
                        datasets: [
                            {
                                label: 'Income',
                                data: Object.values(monthlyData).map(v => v.income),
                                borderColor: '#10b981',
                                tension: 0.4
                            },
                            {
                                label: 'Expenses',
                                data: Object.values(monthlyData).map(v => v.expenses),
                                borderColor: '#f59e0b',
                                tension: 0.4
                            }
                        ]
                    }
                });
            }

            // Status Chart
            const statusCounts = { pending: 0, paid: 0 };
            payments.forEach(p => statusCounts[p.status]++);

            const ctx4 = document.getElementById('statusChart');
            if (ctx4) {
                charts.status = new Chart(ctx4, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Paid'],
                        datasets: [{
                            data: [statusCounts.pending, statusCounts.paid],
                            backgroundColor: ['#f59e0b', '#10b981']
                        }]
                    }
                });
            }
        }

        // Modal functions
        function showAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Payment';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentModal').classList.add('active');
        }

        function showAddIncomeModal() {
            showAddModal();
            document.getElementById('paymentType').value = 'income';
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.remove('active');
            editingId = null;
        }

        function savePayment(event) {
            event.preventDefault();

            const payment = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('paymentName').value,
                person: document.getElementById('paymentPerson').value,
                amount: document.getElementById('paymentAmount').value,
                dueDate: document.getElementById('paymentDueDate').value,
                type: document.getElementById('paymentType').value,
                category: document.getElementById('paymentCategory').value,
                recurring: document.getElementById('paymentRecurring').value,
                status: document.getElementById('paymentStatus').value,
                notes: document.getElementById('paymentNotes').value
            };

            if (editingId) {
                const index = getPayments().findIndex(p => p.id === editingId);
                data[currentProfile].payments[index] = payment;
            } else {
                data[currentProfile].payments.push(payment);
            }

            saveData();
            updateAll();
            closeModal();
        }

        function editPayment(id) {
            const payment = getPayments().find(p => p.id === id);
            if (!payment) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Payment';
            document.getElementById('paymentName').value = payment.name;
            document.getElementById('paymentPerson').value = payment.person;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentDueDate').value = payment.dueDate;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentCategory').value = payment.category || '';
            document.getElementById('paymentRecurring').value = payment.recurring || 'none';
            document.getElementById('paymentStatus').value = payment.status;
            document.getElementById('paymentNotes').value = payment.notes || '';

            document.getElementById('paymentModal').classList.add('active');
        }

        function deletePayment(id) {
            if (!confirm('Are you sure you want to delete this payment?')) return;
            data[currentProfile].payments = getPayments().filter(p => p.id !== id);
            saveData();
            updateAll();
        }

        function markAsPaid(id) {
            const payment = getPayments().find(p => p.id === id);
            if (payment) {
                payment.status = 'paid';
                saveData();
                updateAll();
            }
        }

        function updateAll() {
            processRecurring();
            updateStats();
            renderPayments();
            renderRecentPayments();
            if (currentTab === 'analytics') renderCharts();
            if (currentTab === 'income') updateIncomeTracker();
        }

        // Close modal on outside click
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Initialize
        loadData();
        updateAll();
        updateIncomeTracker();
    </script>
</body>
</html>